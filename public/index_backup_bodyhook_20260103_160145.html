
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NewsGenie Digital Producer</title>
<link rel="icon" href="data:,">

  <style>
    body { font-family: system-ui, Arial; margin: 16px; }
    .row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
    label { font-size: 12px; opacity: .8; display:block; margin-bottom:4px; }
    input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
    button { padding: 10px 14px; border: 0; border-radius: 10px; cursor: pointer; }
    button.primary { background: #111; color: #fff; }
    button.secondary { background: #eee; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .panel { margin-top: 12px; padding: 12px; border: 1px solid #ddd; border-radius: 12px; }
    pre { white-space: pre-wrap; word-wrap: break-word; margin: 0; }
    .status { font-size: 13px; }
    .muted { font-size:12px; opacity:.75; margin-top:6px; }
#btnBytesJSON { display: none !important; }
#ng-dp-actions{
  position: sticky;
  top: 10px;
  z-index: 50;
  background: #fff;
  padding: 8px;
  border-radius: 12px;
  border: 1px solid #e5e5e5;
}


  </style>
<style>
#ngQuick{ white-space:pre-wrap; overflow:auto; max-height:220px; }
</style>

</head>

<body>


<h2>NewsGenie Digital Producer</h2>

  <form id="digi-pack-form" onsubmit="return false;">
    <div class="row">
      <div>
        <label>Topic</label>
        <input name="topic" id="topic" placeholder="E.g., à¤¸à¤‚à¤¸à¤¦ à¤ªà¥à¤°à¤¦à¥‚à¤·à¤£ à¤µà¤¿à¤µà¤¾à¤¦" required />
      </div>

      <div>
        <label>Platform</label>
        <select name="platform" id="platform">
          <option value="Digital">Digital</option>
          <option value="Both">Both</option>
          <option value="TV">TV</option>
        </select>
      </div>

      <div>
        <label>Angle (optional)</label>
        <input name="angle" id="angle" placeholder="E.g., à¤µà¤¿à¤ªà¤•à¥à¤· à¤¬à¤¨à¤¾à¤® à¤¸à¤°à¤•à¤¾à¤°" />
      </div>
    </div>
<!-- ========================= -->
<!-- Transcript JSON Loader -->
<!-- ========================= -->
<section style="margin-top:12px; padding:12px; border:1px solid #ddd; border-radius:12px;">
  <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
    <h3 style="margin:0; font-size:14px;">Load Transcript JSON (Reverie)</h3>
    <button type="button" id="btn-load-transcript-json" class="primary">Load</button>
  </div>

  <p style="margin:8px 0 10px; font-size:12px; opacity:.8;">
    Paste Reverie output JSON here (display_text à¤¯à¤¾ text). Load à¤•à¤°à¤¨à¥‡ à¤ªà¤° localStorage à¤®à¥‡à¤‚ save à¤­à¥€ à¤¹à¥‹à¤—à¤¾.
  </p>

  <textarea id="ta-transcript-json" rows="8"
    style="width:100%; padding:10px; border:1px solid #ccc; border-radius:10px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px;"
    placeholder='Paste JSON here...'></textarea>

  <div style="display:flex; gap:8px; margin-top:10px;">
    <button type="button" id="btn-clear-transcript-json">Clear Saved</button>
    <span id="transcript-load-hint" style="font-size:12px; opacity:.75;"></span>
  </div>
</section>

    <div style="margin-top:10px;">
      <label>Story Type</label>
      <select name="storyType" id="storyType" required>
        <option value="">Select</option>
        <option value="breaking">Breaking</option>
        <option value="developing">Developing</option>
        <option value="explainer">Explainer</option>
        <option value="debate">Debate</option>
      </select>
    </div>

    <div style="margin-top:10px;">
      <label>What Happened (mandatory)</label>
      <textarea name="whatHappened" id="whatHappened" rows="3" placeholder="2â€“4 lines à¤®à¥‡à¤‚ à¤•à¥à¤¯à¤¾ à¤¹à¥à¤†?" required></textarea>
    </div>

    <div style="margin-top:10px;">
      <label>Sources / References (mandatory)</label>
      <textarea name="sources" id="sources" rows="3" placeholder="Links / documents / official statements" required></textarea>
    </div>

    <div style="margin-top:10px;">
      <label>Background (optional but counts)</label>
      <textarea name="background" id="background" rows="3" placeholder="Context / past events / why it matters"></textarea>
    </div>

    <!-- BYTES -->
    <div class="panel">
      <b>Bytes (Speaker + Designation)</b>

      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-top:8px;">
        <div style="font-size:12px;opacity:.75;">
          Multiple bytes à¤œà¥‹à¤¡à¤¼ à¤¸à¤•à¤¤à¥‡ à¤¹à¥ˆà¤‚. Transcript AI generate à¤•à¤°à¥‡à¤—à¤¾.
        </div>
        <button type="button" class="btn" id="addByteBtn">+ Add Byte</button>
      </div>

      <div id="bytesWrap" style="margin-top:10px;"></div>
    </div>

    <!-- VISUALS -->
    <div class="panel" id="step-visuals">
      <b>Visuals</b>
      <div class="muted">B-roll / archive / location visuals (multiple rows)</div>

      <div id="visuals-wrap"></div>

      <div style="margin-top:8px;">
        <button type="button" id="add-visual">+ Add Visual</button>
      </div>
    </div>

    <div style="margin-top:10px; display:flex; gap:8px; align-items:center;">
      <button id="btnGenerate" type="button" class="primary" onclick="generateDigiPack(event)" disabled>
        Generate DIGI_PACK
      </button>

      <button type="button" class="secondary" onclick="clearUI()">Clear</button>

      <span id="genStatus" style="font-size:13px; opacity:.8;"></span>
    </div>
  </form>
<!-- Editorial Extraction : Suggestions ONLY -->
<section id="editorial-extraction" style="margin-top:16px;">
  <h3 style="margin:0 0 8px 0;">Editorial Extraction</h3>

  <div id="ee-empty" style="opacity:.7;font-size:13px;padding:10px;border:1px dashed #bbb;border-radius:10px;">
    NG_TRANSCRIPT à¤¸à¥‡ suggested bytes à¤¯à¤¹à¤¾à¤ à¤¦à¤¿à¤–à¥‡à¤‚à¤—à¥‡.
  </div>

  <div id="ee-list" style="display:flex;flex-direction:column;gap:10px;margin-top:10px;"></div>

  <div style="display:flex;gap:10px;margin-top:12px;flex-wrap:wrap;">
    <button type="button" id="ee-push">Push selected to Bytes</button>
    <button type="button" id="ee-clear">Discard / Clear suggestions</button>
  </div>
</section>


  <div class="panel">
    <div class="status"><b>Status:</b> <span id="ngStatus">Idle</span></div>
    <div style="margin-top:8px;"><b>Log</b></div>
    <pre id="ngLog"></pre>
  </div>

  <div class="panel">
    <div><b>Quick View</b></div>
    <div id="ngQuick" style="white-space:pre-wrap; overflow:auto; max-height:220px;">(no quick view)</div>

  </div>

  <div class="panel">
    <div><b>Response</b></div>
    <pre id="ngResponse">(no response yet)</pre>
  </div>
<div class="panel">
  <div style="display:flex;align-items:center;justify-content:space-between;">
    <b>Preview Prompt (will be sent)</b>
    <button type="button" id="copy-prompt"
      style="padding:6px 10px;border-radius:8px;border:1px solid #ccc;background:#fff;cursor:pointer;">
      Copy
    </button>
  </div>

  <textarea id="prompt-preview" readonly
    style="width:100%;min-height:160px;margin-top:8px;padding:10px;
           border:1px solid #ccc;border-radius:10px;
           font-family:ui-monospace,Consolas,monospace;
           font-size:12px;"></textarea>
</div>

<script>
  const $ = (id) => document.getElementById(id);
  let NG_BUSY = false;

  function logLine(msg) {
    const el = $("ngLog");
    if (el) el.textContent += (msg + "\n");
  }
  function setStatus(status) {
    const el = $("ngStatus");
    if (el) el.textContent = status;
  }

  function setGenStatus(txt, busy = false) {
    const btn = $("btnGenerate");
    const st = $("genStatus");
    if (btn) btn.disabled = busy;
    if (st) st.textContent = txt;
  }

  function renderResponse(data) {
    const pre = document.getElementById("ngResponse");
    if (!pre) return;
    pre.textContent = (typeof data === "string") ? data : JSON.stringify(data, null, 2);
  }

  function safeTrim(v) { return (v ?? "").toString().trim(); }

  function updatePromptPreview(promptObj) {
    const box = document.getElementById("prompt-preview");
    if (!box) return;
    box.value = JSON.stringify(promptObj, null, 2);
  }

  // ---------- FormData helpers (getAll compatible) ----------
  function collectBytes(fd) {
    const speakers = fd.getAll("byte_speaker[]").map(safeTrim);
    const designations = fd.getAll("byte_designation[]").map(safeTrim);
const texts = fd.getAll("byte_text[]").map(safeTrim);


    const out = [];
   const n = Math.max(speakers.length, designations.length, texts.length);
    for (let i = 0; i < n; i++) {
      const speaker = speakers[i] || "";
      const designation = designations[i] || "";
      const text = texts[i] || "";
if (speaker || designation || text) out.push({ speaker, designation, text });

    }
    return out;
  }
window.NG_getBytesJSON = function () {
  const form = document.querySelector("#digi-pack-form");

  if (!form) return [];
  return collectBytes(new FormData(form));
};


  function collectVisuals(fd) {
    const shotTypes = fd.getAll("visual_shot_type[]").map(safeTrim);
    const sources   = fd.getAll("visual_source[]").map(safeTrim);
    const whats     = fd.getAll("visual_what[]").map(safeTrim);
    const notes     = fd.getAll("visual_notes[]").map(safeTrim);

    const out = [];
    const n = Math.max(shotTypes.length, sources.length, whats.length, notes.length);
    for (let i = 0; i < n; i++) {
      const shot_type = shotTypes[i] || "";
      const source = sources[i] || "";
      const what = whats[i] || "";
      const note = notes[i] || "";
      if (shot_type || source || what || note) out.push({ shot_type, source, what, note });
    }
    return out;
  }

  function buildPromptFromForm() {
    const form = document.getElementById("digi-pack-form");
    if (!form) throw new Error("Form not found: digi-pack-form");

    const fd = new FormData(form);

    const topic = safeTrim(fd.get("topic"));
    const platform = safeTrim(fd.get("platform")) || "Digital";
    const angle = safeTrim(fd.get("angle"));

    const story_type = safeTrim(
      fd.get("story_type") ||
      fd.get("storyType") ||
      fd.get("story") ||
      fd.get("type")
    );

    const what_happened = safeTrim(fd.get("what_happened") || fd.get("whatHappened"));
    const sources = safeTrim(fd.get("sources"));
    const background = safeTrim(fd.get("background"));

    const bytes = collectBytes(fd);
    const visuals = collectVisuals(fd);

    return {
      topic,
      platform,
      angle: angle || null,
      story_type: story_type || null,
      what_happened,
      sources,
      background: background || null,
      bytes,
      visuals
    };
  }

  async function generateDigiPack(e) {
    e?.preventDefault?.();

    const genBtn = document.getElementById("btnGenerate") || document.getElementById("btn-generate");
    if (genBtn) genBtn.disabled = true;

    try {
      const promptObj = buildPromptFromForm();
      console.log("FINAL PROMPT â†’", promptObj);

      if (!safeTrim(promptObj.topic)) throw new Error("Topic is required.");
      if (!safeTrim(promptObj.what_happened)) throw new Error("What Happened is required.");
      if (!safeTrim(promptObj.sources)) throw new Error("Sources is required.");

      updatePromptPreview(promptObj);

      const payload = { prompt: JSON.stringify(promptObj) };

      setStatus("Calling /api/digi-pack ...");
      logLine("POST /api/digi-pack");
      logLine("Prompt chars: " + payload.prompt.length);

      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 60000);

      const res = await fetch("/api/digi-pack", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify(payload),
  signal: controller.signal
});

if (!res.ok) {
  const t = await res.text().catch(function () { return ""; });
  throw new Error("HTTP " + res.status + " " + t);
}

const data = await res.json();

// âœ… prefer V2 "generated" object
var g = (data && data.generated) ? data.generated : (data || {});
window.NG_LAST_DIGIPACK = g;

// âœ… Quick View auto-fill into <div id="ngQuick">
(function () {
  var el = document.getElementById("ngQuick");
  if (!el) return;

  function toLines(v) {
    if (!v) return [];
    if (Array.isArray(v)) {
      var a = [];
      for (var i = 0; i < v.length; i++) {
        var s = String(v[i] == null ? "" : v[i]).trim();
        if (s) a.push(s);
      }
      return a;
    }
    if (typeof v === "string") {
      var parts = v.replace(/\r\n/g, "\n").split(/\n+/);
      var out = [];
      for (var j = 0; j < parts.length; j++) {
        var t = parts[j].trim();
        if (t) out.push(t);
      }
      return out;
    }
    return [String(v)];
  }

  var headline = String(g.headline || "").trim();
  var dek      = String(g.dek || "").trim();
  var bullets  = toLines(g.bullet_points);
  var vo       = toLines(g.vo_lines);
  var hashtags = toLines(g.hashtags).join(" ");
  var caution  = String(g.caution || "").trim();

  var q = "";
  if (headline) q += "Headline: " + headline + "\n";
  if (dek)      q += "Dek: " + dek + "\n";
  if (bullets.length) {
    q += "Key Points:\n";
    for (var k = 0; k < bullets.length; k++) q += "- " + bullets[k] + "\n";
  }
  if (vo.length) {
    q += "VO Lines:\n";
    for (var m = 0; m < vo.length; m++) q += "â€¢ " + vo[m] + "\n";
  }
  if (hashtags) q += "Hashtags: " + hashtags + "\n";
    // ...
  if (caution)  q += "Caution: " + caution + "\n";

  window.__NG_LAST_QUICKVIEW = q.trim() || "(no quick view)";
  el.textContent = window.__NG_LAST_QUICKVIEW;
})();


// âœ… store last response for copy buttons etc.
window.__NG_LAST_API_RESPONSE = data;
if (!data || data.ok !== true) {
  var q = document.getElementById("ngQuick");
  if (q) q.textContent = "âš  Generate failed. Check Response panel / logs.";
}

// âœ… re-apply Quick View at end (prevents header-only overwrite)
setTimeout(function(){
  var el2 = document.getElementById("ngQuick");
  if (el2 && window.__NG_LAST_QUICKVIEW) {
    el2.textContent = window.__NG_LAST_QUICKVIEW;
  }
}, 0);



// âœ… ensure Quick View UI exists (idempotent)
try { if (window.ensureDigiPackUI) window.ensureDigiPackUI(); } catch (e) { console.warn("ensureDigiPackUI failed", e); }

// âœ… render response panel
if (typeof setResponse === "function") setResponse(data);
else renderResponse(data);

// âœ… render Quick View (prefer window.*)
try {
  if (window.renderQuickView) window.renderQuickView(data);
} catch (e2) {
  console.warn("renderQuickView failed", e2);
}

setStatus("Done");
logLine("Done âœ…");
} catch (err) {
  var msg = (err && err.message) ? err.message : String(err);
  var isAbort =
  (err && err.name === "AbortError") ||
  (String(msg).toLowerCase().indexOf("aborted") !== -1) ||
  (String(msg).toLowerCase().indexOf("abort") !== -1);

if (isAbort) {
  setStatus("Cancelled/Timeout");
  logLine("Cancelled/Timeout");
  // âœ… Abort à¤ªà¤° alert à¤¨à¤¹à¥€à¤‚
} else {
  setStatus("Error");
  logLine("Error: " + msg);
  alert(msg);
}

} finally {
  try { if (timeout) { clearTimeout(timeout); timeout = null; } } catch(e) {}
  if (genBtn) genBtn.disabled = false;
}
}


  function getVal(name) {
    const el = document.querySelector(`[name="${name}"]`);
    return el ? (el.value || "").trim() : "";
  }

  function setGenerateState(enabled, msg) {
    const btn = $("btnGenerate") || document.getElementById("btn-generate");
    if (btn) btn.disabled = !enabled;
    const s = $("genStatus");
    if (s) s.textContent = msg || "";
  }

  function validateGenerate() {
    const topic = getVal("topic");
    const ok = !!topic;
    if (!ok) { setGenerateState(false, "Topic required"); return false; }
    setGenerateState(true, "Ready");
    return true;
  }

  document.addEventListener("input", validateGenerate);
  document.addEventListener("change", validateGenerate);

  /* =========================
     /* =========================
   BYTES UI (Speaker + Designation)
========================= */
const MAX_BYTES = 8;

function byteRowTemplate(i) {
  return `
    <div class="byte-row" data-byte-row="${i}">
      <div class="row" style="grid-template-columns: 1fr 1fr auto; gap: 8px;">
        <div>
          <label>Speaker Name</label>
          <input
            type="text"
            name="byte_speaker[]"
            data-byte-field="speaker"
            placeholder="E.g., à¤œà¤¯à¤°à¤¾à¤® à¤°à¤®à¥‡à¤¶"
            autocomplete="off"
          />
        </div>
        <div>
          <label>Designation</label>
          <input
            type="text"
            name="byte_designation[]"
            data-byte-field="designation"
            placeholder="à¤•à¤¾à¤‚à¤—à¥à¤°à¥‡à¤¸ à¤¨à¥‡à¤¤à¤¾"
            autocomplete="off"
          />
        </div>
<div style="grid-column: 1 / -1;">
  <label>Text / Quote</label>
  <textarea
    name="byte_text[]"
    data-byte-field="text"
    placeholder="à¤¯à¤¹à¤¾à¤ à¤¬à¤¾à¤‡à¤Ÿ à¤•à¤¾ actual quote à¤²à¤¿à¤–à¥‡à¤‚"
    rows="2"
    autocomplete="off"
    style="width:100%; resize:vertical;"
  ></textarea>
</div>

        <div style="display:flex;align-items:flex-end;">
          <button
            type="button"
            class="danger"
            data-remove-byte="${i}"
            title="Remove this byte"
          >Remove</button>
        </div>
      </div>
    </div>
  `;
}

function initBytesUI() {
  // âœ… prevent double init
  if (window.__NG_BYTES_INIT_DONE) return;
  window.__NG_BYTES_INIT_DONE = true;

  // âœ… FIX: your real IDs (from your console)
  const wrap = document.getElementById("bytesWrap");
  const addBtn = document.getElementById("addByteBtn");
  if (!wrap || !addBtn) {
    console.warn("[BYTES] Missing bytesWrap/addByteBtn", { wrap: !!wrap, addBtn: !!addBtn });
    return;
  }

  // âœ… ensure button is usable
  addBtn.disabled = false;

  function getCount() {
    return wrap.querySelectorAll("[data-byte-row]").length;
  }

  function updateRemoveButtonsState() {
    const rows = Array.from(wrap.querySelectorAll("[data-byte-row]"));
    const disable = rows.length <= 1;

    rows.forEach((row) => {
      const btn = row.querySelector("[data-remove-byte]");
      if (!btn) return;

      btn.disabled = disable;
      btn.style.opacity = disable ? "0.5" : "1";
      btn.style.cursor = disable ? "not-allowed" : "pointer";
      btn.title = disable ? "At least 1 byte is required" : "Remove this byte";
    });
  }

  function renumber() {
    const rows = Array.from(wrap.querySelectorAll("[data-byte-row]"));
    rows.forEach((row, idx) => {
      const n = idx + 1;
      row.setAttribute("data-byte-row", String(n));

      const btn = row.querySelector("[data-remove-byte]");
      if (btn) btn.setAttribute("data-remove-byte", String(n));
    });

    updateRemoveButtonsState();
  }

  function addByteRow() {
    const n = getCount() + 1;
    if (typeof MAX_BYTES !== "undefined" && n > MAX_BYTES) return;

    // assumes byteRowTemplate(n) exists and creates:
    // - a container with data-byte-row
    // - inputs name="byte_speaker[]" and name="byte_designation[]"
    // - a remove button having data-remove-byte
    wrap.insertAdjacentHTML("beforeend", byteRowTemplate(n));
    renumber();
  }

  // âœ… ensure 1st row exists
  if (getCount() === 0) addByteRow();

  // âœ… expose helpers for pushToBytes()
  window.NG_addByteRow = addByteRow;
  window.NG_getByteCount = getCount;

  // âœ… add row button
  addBtn.addEventListener("click", (e) => {
    e.preventDefault();
    addByteRow();
  });

  // âœ… remove (event delegation)
  wrap.addEventListener("click", (e) => {
    const btn = e.target.closest("[data-remove-byte]");
    if (!btn) return;

    e.preventDefault();

    const row = btn.closest("[data-byte-row]");
    if (!row) return;

    if (getCount() <= 1) return; // keep minimum 1 row
    row.remove();
    renumber();
  });

  // initial state
  renumber();
}


  /* =========================
     VISUALS UI (FormData.getAll compatible)
  ========================= */
  function visualRowTemplate(i) {
    return `
      <div class="visual-row" data-visual-row="${i}" style="border:1px solid #e6e6e6;border-radius:12px;padding:10px;margin-top:10px;">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
          <div class="v-row-label" style="font-weight:600;">Visual ${i}</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button type="button" data-action="gen-visual">Generate</button>
            <button type="button" data-action="clear-visual">Clear</button>
            <button type="button" data-action="remove-visual">Remove</button>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px;">
          <div>
            <label style="font-size:12px;opacity:.8;display:block;margin-bottom:4px;">Shot Type</label>
            <select name="visual_shot_type[]" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;">
              <option value="BROLL">B-roll</option>
              <option value="ARCHIVE">Archive</option>
              <option value="LOCATION">Location</option>
              <option value="GRAPHIC">Graphic</option>
              <option value="SCREEN">Screen</option>
            </select>
          </div>

          <div>
            <label style="font-size:12px;opacity:.8;display:block;margin-bottom:4px;">Source</label>
            <input type="text" name="visual_source[]" placeholder="Reporter / Agency / Archive"
              style="width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;" />
          </div>
        </div>

        <div style="margin-top:8px;">
          <label style="font-size:12px;opacity:.8;display:block;margin-bottom:4px;">What to show</label>
          <input type="text" name="visual_what[]" placeholder="E.g., à¤¦à¥à¤•à¤¾à¤¨ à¤ªà¤° à¤›à¤¾à¤ªà¤¾, à¤¸à¥€à¤² à¤ªà¥ˆà¤•, à¤…à¤¸à¥à¤ªà¤¤à¤¾à¤², à¤²à¥ˆà¤¬, à¤¦à¤¸à¥à¤¤à¤¾à¤µà¥‡à¤œà¤¼"
            style="width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;" />
        </div>

        <div style="margin-top:8px;">
          <label style="font-size:12px;opacity:.8;display:block;margin-bottom:4px;">Notes (optional)</label>
          <input type="text" name="visual_notes[]" placeholder="E.g., 3-5 sec, blur face, avoid brand"
            style="width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;" />
        </div>
      </div>
    `;
  }

  function initVisualsUI() {
    const wrap = document.getElementById("visuals-wrap");
    const addBtn = document.getElementById("add-visual");
    if (!wrap || !addBtn) return;

    function getCount() {
      return wrap.querySelectorAll("[data-visual-row]").length;
    }

    function renumber() {
      const rows = Array.from(wrap.querySelectorAll("[data-visual-row]"));
      rows.forEach((row, idx) => {
        row.setAttribute("data-visual-row", String(idx + 1));
        const label = row.querySelector(".v-row-label");
        if (label) label.textContent = "Visual " + (idx + 1);
        const rm = row.querySelector('button[data-action="remove-visual"]');
        if (rm) rm.disabled = (idx === 0);
      });
    }

    function addVisualRow() {
      const n = getCount() + 1;
      wrap.insertAdjacentHTML("beforeend", visualRowTemplate(n));
      renumber();
    }

    if (getCount() === 0) addVisualRow();
    addBtn.addEventListener("click", addVisualRow);

    // event delegation (ONLY visuals actions)
    wrap.addEventListener("click", (e) => {
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;

      const row = btn.closest("[data-visual-row]");
      if (!row) return;

      const action = btn.getAttribute("data-action");

      if (action === "remove-visual") {
        if (getCount() <= 1) return;
        row.remove();
        renumber();
        return;
      }

      if (action === "clear-visual") {
        row.querySelectorAll("input").forEach(i => (i.value = ""));
        const sel = row.querySelector('select[name="visual_shot_type[]"]');
        if (sel) sel.value = "BROLL";
        return;
      }

      if (action === "gen-visual") {
        const sel  = row.querySelector('select[name="visual_shot_type[]"]');
        const what = row.querySelector('input[name="visual_what[]"]');
        const src  = row.querySelector('input[name="visual_source[]"]');

        const type = sel ? sel.value : "BROLL";

        if (what && !what.value.trim()) {
          what.value =
            type === "ARCHIVE"  ? "à¤«à¤¾à¤‡à¤² à¤«à¥à¤Ÿà¥‡à¤œ / à¤ªà¥à¤°à¤¾à¤¨à¥€ à¤•à¥à¤²à¤¿à¤ª" :
            type === "LOCATION" ? "à¤²à¥‹à¤•à¥‡à¤¶à¤¨ à¤¶à¥‰à¤Ÿ / à¤¸à¤¾à¤‡à¤¨à¤¬à¥‹à¤°à¥à¤¡ / à¤à¤°à¤¿à¤¯à¤¾ à¤µà¤¿à¤œà¥à¤…à¤²" :
            type === "GRAPHIC"  ? "à¤Ÿà¤¾à¤‡à¤®à¤²à¤¾à¤‡à¤¨ / à¤¨à¤‚à¤¬à¤° / à¤®à¥ˆà¤ª à¤ªà¥à¤²à¥‡à¤Ÿ" :
            type === "SCREEN"   ? "à¤µà¥‡à¤¬à¤¸à¤¾à¤‡à¤Ÿ/à¤¦à¤¸à¥à¤¤à¤¾à¤µà¥‡à¤œà¤¼ à¤¸à¥à¤•à¥à¤°à¥€à¤¨" :
                                  "B-roll (à¤œà¤¾à¤‚à¤š/à¤°à¤¿à¤à¤•à¥à¤¶à¤¨/à¤¡à¤¿à¤Ÿà¥‡à¤² à¤¶à¥‰à¤Ÿ)";
        }
        if (src && !src.value.trim()) src.value = "Reporter/Archive";
        return;
      }
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    validateGenerate();
    initBytesUI();
    initVisualsUI();
  });

  ;(function initPromptPreviewCopy() {
    const btn = document.getElementById("copy-prompt");
    const box = document.getElementById("prompt-preview");
    if (!btn || !box) return;

    btn.addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(box.value || "");
        if (typeof logLine === "function") logLine("Preview prompt copied âœ…");
      } catch {
        box.focus();
        box.select();
        document.execCommand("copy");
        if (typeof logLine === "function") logLine("Preview prompt copied (fallback) âœ…");
      }
    });
  })();
</script>

<script>
/* === Editorial Extraction : Suggestions Panel + Transcript Auto-Ingest (Clean V3) === */

  "use strict";

  // ---------------- utils ----------------
  function esc(s) {
    return String(s ?? "").replace(/[&<>"']/g, (m) => ({
      "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
    }[m]));
  }
  function norm(s) { return String(s ?? "").replace(/\s+/g, " ").trim(); }
  function normKey(s) {
    return norm(s).toLowerCase()
      .replace(/[â€œâ€"']/g, "")
      .replace(/[^\p{L}\p{N}\s]/gu, "")
      .replace(/\s+/g, " ")
      .trim();
  }

  // optional speakerâ†’designation map
  window.__NG_SPEAKER_MAP = window.__NG_SPEAKER_MAP || {
    "à¤•à¤¿à¤°à¤£ à¤°à¤¿à¤œà¤¿à¤œà¥‚": "à¤•à¥‡à¤‚à¤¦à¥à¤°à¥€à¤¯ à¤®à¤‚à¤¤à¥à¤°à¥€",
    "à¤œà¤¯à¤°à¤¾à¤® à¤°à¤®à¥‡à¤¶": "à¤•à¤¾à¤‚à¤—à¥à¤°à¥‡à¤¸ à¤¨à¥‡à¤¤à¤¾"
  };

  // ---------------- extraction helpers ----------------
  function guessSpeakerFromText(text) {
    const t = norm(text);

    // "à¤¨à¤¾à¤® (à¤ªà¤¦): à¤¬à¤¯à¤¾à¤¨..."
    const m2 = t.match(/^(.{2,40})\s*\((.{2,40})\)\s*[:ï¼š]\s*(.+)$/);
    if (m2) return { speaker: norm(m2[1]), designation: norm(m2[2]), text: norm(m2[3]) };

    // "à¤¨à¤¾à¤®: à¤¬à¤¯à¤¾à¤¨..."
    const m = t.match(/^([^:ï¼š]{2,40})\s*[:ï¼š]\s*(.+)$/);
    if (m) return { speaker: norm(m[1]), text: norm(m[2]) };

    // "à¤¨à¤¾à¤® à¤¨à¥‡ à¤•à¤¹à¤¾/à¤¬à¤¤à¤¾à¤¯à¤¾... (à¤•à¤¿) ..."
    const m3 = t.match(
      /^([^\s:ï¼š]{2,20}(?:\s+[^\s:ï¼š]{2,20}){0,2})\s+(?:à¤¨à¥‡\s+(?:à¤•à¤¹à¤¾|à¤¬à¥‹à¤²à¥‡|à¤¬à¤¤à¤¾à¤¯à¤¾|à¤†à¤°à¥‹à¤ª\s+à¤²à¤—à¤¾à¤¯à¤¾|à¤¦à¤¾à¤µà¤¾\s+à¤•à¤¿à¤¯à¤¾|à¤¤à¤‚à¤œ\s+à¤•à¤¸à¤¾)|à¤•à¤¾\s+à¤•à¤¹à¤¨à¤¾\s+à¤¹à¥ˆ)\s*(?:à¤•à¤¿\s*)?(.+)$/
    );
    if (m3) {
      const sp = norm(m3[1]);
      const rest = norm(m3[2] || "");
      if (sp && !/^(à¤‰à¤¨à¥à¤¹à¥‹à¤‚à¤¨à¥‡|à¤‰à¤¸à¤¨à¥‡|à¤¹à¤®à¤¨à¥‡|à¤†à¤ªà¤¨à¥‡|à¤‡à¤¨à¥à¤¹à¥‹à¤‚à¤¨à¥‡|à¤‰à¤¨à¤•à¤¾|à¤‰à¤¸à¤•à¤¾)$/u.test(sp)) {
        return { speaker: sp, text: rest || t };
      }
    }

    return { text: t };
  }

  function scoreLine(line) {
    const t = (line.text || "").trim();
    const len = t.length;
    let score = 0;

    if (len >= 18 && len <= 140) score += 3;
    else if (len >= 10 && len <= 220) score += 1.5;
    else if (len < 8) score -= 4;
    else score -= 0.2;

    if (line.speaker) score += 1.6;
    if (/[â€œâ€"']/.test(t)) score += 1.2;
    if (/[?!]/.test(t)) score += 0.4;

    if (/(à¤•à¤¹à¤¾|à¤¬à¥‹à¤²à¥‡|à¤¬à¤¤à¤¾à¤¯à¤¾|à¤¸à¥à¤ªà¤·à¥à¤Ÿ|à¤¸à¤¾à¤«|à¤œà¤µà¤¾à¤¬|à¤¤à¥ˆà¤¯à¤¾à¤°|à¤†à¤°à¥‹à¤ª|à¤¤à¤‚à¤œ|à¤¸à¤°à¤•à¤¾à¤°|à¤µà¤¿à¤ªà¤•à¥à¤·|à¤œà¤¾à¤‚à¤š|à¤¸à¤µà¤¾à¤²|à¤šà¥à¤¨à¤¾à¤µ|à¤¸à¤‚à¤¸à¤¦|à¤¦à¥‡à¤¶|à¤œà¤¨à¤¤à¤¾)/.test(t)) score += 2;
    if (/(à¤¨à¤¹à¥€à¤‚|à¤—à¤²à¤¤|à¤à¥‚à¤ |à¤¸à¤¬à¥‚à¤¤|à¤•à¤¾à¤°à¥à¤°à¤µà¤¾à¤ˆ|à¤®à¤¾à¤‚à¤—|à¤‡à¤¸à¥à¤¤à¥€à¤«à¤¾|à¤¹à¤®à¤²à¤¾|à¤¬à¤šà¤¾à¤µ)/.test(t)) score += 1;
    if (/[0-9à¥¦-à¥¯]/.test(t)) score += 0.6;

    if (/(à¤§à¤¨à¥à¤¯à¤µà¤¾à¤¦|à¤¨à¤®à¤¸à¥à¤•à¤¾à¤°|à¤¸à¥à¤µà¤¾à¤—à¤¤|à¤†à¤ª à¤¦à¥‡à¤– à¤°à¤¹à¥‡|à¤¦à¥‡à¤–à¤¿à¤|à¤¦à¥‹à¤¸à¥à¤¤à¥‹à¤‚|à¤šà¤²à¤¿à¤¯à¥‡|à¤…à¤¬ à¤¹à¤®)/.test(t)) score -= 4;

    return score;
  }

  function extractReverieText(root) {
    if (!root) return "";
    if (typeof root === "string") return root.trim();

    const cands = [
      root.display_text, root.text,
      root.result?.display_text, root.result?.text,
      root.output?.display_text, root.output?.text,
      root.data?.display_text, root.data?.text,
      root.response?.display_text, root.response?.text,
      root.success && root.text ? root.text : null
    ];
    for (const c of cands) if (typeof c === "string" && c.trim()) return c.trim();
    return "";
  }

  function mapArrToLines(arr) {
    const out = [];
    for (const it of arr || []) {
      let txt = "";
      if (typeof it === "string") txt = it;
      else if (it && typeof it === "object") {
        txt = it.text || it.transcript || it.utterance || it.sentence || it.content || it.line || "";
      }
      txt = norm(txt);
      if (!txt) continue;

      const g = guessSpeakerFromText(txt);
      let speaker = norm(g.speaker || it?.speaker || it?.name || "");
      let designation = norm(g.designation || it?.designation || it?.title || "");
      let text = norm(g.text || txt);

      if (speaker && !designation) designation = window.__NG_SPEAKER_MAP[speaker] || "";

      out.push({ speaker, designation, text });
    }
    return out;
  }

  function looksLikeTranscriptArr(arr) {
    let hits = 0, totalLen = 0;
    for (const it of arr || []) {
      const txt = (typeof it === "string")
        ? it
        : (it?.text || it?.transcript || it?.utterance || it?.sentence || it?.content || it?.line);
      if (typeof txt === "string" && txt.trim()) {
        hits++;
        totalLen += txt.trim().length;
      }
    }
    const avg = hits ? totalLen / hits : 0;
    return hits >= 2 && avg >= 10;
  }

  function collectCandidateLines(root, opts) {
    const maxNodes = Number(opts?.maxNodes || 9000);

    // Prefer full text
    const fullText = extractReverieText(root);
    if (fullText) {
      const normalized = String(fullText)
        .replace(/\r/g, "\n")
        .replace(/[ \t]+/g, " ")
        .replace(/\n{3,}/g, "\n\n")
        .replace(/([à¥¤.?!])\s+/g, "$1\n")
        .trim();

      const parts = normalized
        .split("\n")
        .map(s => (s || "").trim())
        .filter(s => s.length >= 12)
        .slice(0, 80);

      return parts.map(p => {
        const g = guessSpeakerFromText(p);
        const speaker = norm(g.speaker || "");
        const designation = norm(g.designation || (speaker ? (window.__NG_SPEAKER_MAP[speaker] || "") : ""));
        const text = norm(g.text || p);
        return { speaker, designation, text };
      });
    }

    // Direct arrays
    const directCandidates = [];
    if (Array.isArray(root?.segments)) directCandidates.push(root.segments);
    if (Array.isArray(root?.result?.segments)) directCandidates.push(root.result.segments);
    if (Array.isArray(root?.data?.segments)) directCandidates.push(root.data.segments);
    if (Array.isArray(root?.utterances)) directCandidates.push(root.utterances);
    if (Array.isArray(root?.sentences)) directCandidates.push(root.sentences);
    if (Array.isArray(root?.results)) directCandidates.push(root.results);

    for (const arr of directCandidates) {
      if (Array.isArray(arr) && looksLikeTranscriptArr(arr)) return mapArrToLines(arr);
    }

    // BFS scan for best transcript-like array
    const queue = [root];
    let nodes = 0;
    const arrays = [];

    while (queue.length && nodes < maxNodes) {
      const v = queue.shift();
      nodes++;
      if (!v) continue;

      if (Array.isArray(v)) {
        if (looksLikeTranscriptArr(v)) arrays.push(v);
        for (const it of v) if (it && typeof it === "object") queue.push(it);
        continue;
      }
      if (typeof v === "object") {
        for (const k in v) {
          if (!Object.prototype.hasOwnProperty.call(v, k)) continue;
          const it = v[k];
          if (it && typeof it === "object") queue.push(it);
        }
      }
    }

    return mapArrToLines(arrays[0] || []);
  }

  function pickBestLines(lines, min = 6, max = 10) {
    const seenText = new Set();
    const bestPerSpeaker = new Map();
    const rest = [];

    for (const ln of (lines || [])) {
      const tKey = normKey(ln.text);
      if (!tKey || tKey.length < 8) continue;
      if (seenText.has(tKey)) continue;
      seenText.add(tKey);

      const scored = { ...ln, __score: scoreLine(ln) };
      if (scored.__score < -2.5) continue;

      const sp = norm(scored.speaker);
      if (sp) {
        const prev = bestPerSpeaker.get(sp);
        if (!prev || scored.__score > prev.__score) bestPerSpeaker.set(sp, scored);
        else rest.push(scored);
      } else {
        rest.push(scored);
      }
    }

    const picked = Array.from(bestPerSpeaker.values()).sort((a, b) => b.__score - a.__score);
    rest.sort((a, b) => b.__score - a.__score);

    for (const r of rest) {
      if (picked.length >= max) break;
      picked.push(r);
    }
    return picked.slice(0, Math.max(min, Math.min(max, picked.length)));
  }

  // ---------------- BYTES helpers (used by push) ----------------
  function getAddByteButton() {
    return (
      document.getElementById("addByteBtn") ||
      document.getElementById("add-byte") ||
      document.querySelector('[data-action="add-byte"]')
    );
  }

  function getByteFields() {
    const wrap = document.getElementById("bytesWrap") || document;
    const speakers = [...wrap.querySelectorAll('input[name="byte_speaker[]"]')];
    const desigs   = [...wrap.querySelectorAll('input[name="byte_designation[]"]')];
    const texts    = [...wrap.querySelectorAll('textarea[name="byte_text[]"], input[name="byte_text[]"]')];
    return { wrap, speakers, desigs, texts };
  }

  function ensureByteRows(targetCount) {
    const addBtn = getAddByteButton();
    if (!addBtn) return;

    let safety = 40;
    while (safety-- > 0) {
      const { speakers } = getByteFields();
      if (speakers.length >= targetCount) break;

      if (typeof window.NG_addByteRow === "function") window.NG_addByteRow();
      else addBtn.click();
    }
  }

  function existingByteSet() {
    const { speakers, desigs, texts } = getByteFields();
    const set = new Set();
    const n = Math.max(speakers.length, desigs.length, texts.length);

    for (let i = 0; i < n; i++) {
      const sp = normKey(speakers[i]?.value || "");
      const ds = normKey(desigs[i]?.value || "");
      const tx = normKey(texts[i]?.value || "");
      if (sp || ds || tx) set.add(`${sp}|${ds}|${tx}`);
    }
    return set;
  }

  function findFirstEmptySlot() {
    const { speakers, desigs, texts } = getByteFields();
    const n = Math.max(speakers.length, desigs.length, texts.length);

    for (let i = 0; i < n; i++) {
      const sp = norm(speakers[i]?.value || "");
      const ds = norm(desigs[i]?.value || "");
      const tx = norm(texts[i]?.value || "");
      if (!sp && !ds && !tx) return i;
      if (!sp && !ds) return i;
    }
    return n;
  }

  function fillSlot(i, item) {
    ensureByteRows(i + 1);
    const f = getByteFields();
    if (f.speakers[i]) f.speakers[i].value = item?.speaker || "";
    if (f.desigs[i])   f.desigs[i].value   = item?.designation || "";
    if (f.texts[i])    f.texts[i].value    = item?.text || "";
  }

  // ---------------- UI init ----------------
function initEditorialExtraction() {
  if (window.__NG_EE_INIT_DONE) return;
  window.__NG_EE_INIT_DONE = true;

  const eeList  = document.getElementById("ee-list");
  const eeEmpty = document.getElementById("ee-empty");
  const btnPush = document.getElementById("ee-push");
  const btnClear= document.getElementById("ee-clear");

  if (!eeList || !btnPush || !btnClear) {
    console.warn("[EE] Missing ee-list/ee-push/ee-clear");
    return;
  }

  let suggestions = [];

  function showEmpty(on) {
    if (!eeEmpty) return;
    eeEmpty.style.display = on ? "block" : "none";
  }

  function updateButtons() {
    const total   = eeList.querySelectorAll('input[type="checkbox"][data-i]').length;
    const checked = eeList.querySelectorAll('input[type="checkbox"][data-i]:checked').length;
    btnPush.disabled  = (checked === 0);
    btnClear.disabled = (total === 0);
  }

  // --- Bytes helpers (bulletproof, DOM-driven) ---
  function bytesWrapEl() {
    return document.getElementById("bytesWrap") || document.getElementById("bytes-wrap");
  }

  function addByteButtonEl() {
    return (
      document.getElementById("addByteBtn") ||
      document.getElementById("add-byte") ||
      document.getElementById("addByte")
    );
  }

  function getByteInputs() {
    const wrap = bytesWrapEl();
    if (!wrap) return { sp: [], ds: [], tx: [] };
    const sp = Array.from(wrap.querySelectorAll('input[name="byte_speaker[]"]'));
    const ds = Array.from(wrap.querySelectorAll('input[name="byte_designation[]"]'));
    const tx = Array.from(wrap.querySelectorAll('textarea[name="byte_text[]"], input[name="byte_text[]"]'));
    return { sp, ds, tx };
  }

  function ensureByteRows(minRows) {
    let { sp, ds } = getByteInputs();
    let n = Math.max(sp.length, ds.length);
    let safety = 0;

    while (n < minRows && safety++ < 30) {
      if (typeof window.NG_addByteRow === "function") {
        window.NG_addByteRow();
      } else {
        const addBtn = addByteButtonEl();
        if (addBtn) addBtn.click();
        else break;
      }
      ({ sp, ds } = getByteInputs());
      n = Math.max(sp.length, ds.length);
    }
    return n;
  }

  function findFirstEmptySlot() {
    const { sp, ds } = getByteInputs();
    const n = Math.max(sp.length, ds.length);
    for (let i = 0; i < n; i++) {
      const a = (sp[i]?.value || "").trim();
      const b = (ds[i]?.value || "").trim();
      if (!a && !b) return i;
    }
    return n; // append
  }

  function normKeyLocal(s) {
    return (s || "")
      .toString()
      .trim()
      .replace(/\s+/g, " ")
      .toLowerCase();
  }

  function existingByteSet() {
    const set = new Set();
    const { sp, ds, tx } = getByteInputs();
    const n = Math.max(sp.length, ds.length, tx.length);
    for (let i = 0; i < n; i++) {
      const speaker = (sp[i]?.value || "").trim();
      const desig   = (ds[i]?.value || "").trim();
      const text    = (tx[i]?.value || "").trim();
      if (!speaker && !desig && !text) continue;
      set.add(`${normKeyLocal(speaker)}|${normKeyLocal(desig)}|${normKeyLocal(text)}`);
    }
    return set;
  }

  // âœ… return true/false
  function fillSlot(slotIndex, item) {
    ensureByteRows(slotIndex + 1);

    const { sp, ds, tx } = getByteInputs();
    if (!sp[slotIndex] || !ds[slotIndex]) return false;

    const speaker = (item?.speaker || "").toString().trim();
    const desig   = (item?.designation || "").toString().trim();
    const text    = (item?.text || "").toString().trim();

    if (!speaker || !desig) return false;

    const spWas = (sp[slotIndex].value || "").trim();
    const dsWas = (ds[slotIndex].value || "").trim();

    // don't overwrite
    if (spWas || dsWas) return false;

    sp[slotIndex].value = speaker;
    ds[slotIndex].value = desig;

    if (tx && tx[slotIndex] && !((tx[slotIndex].value || "").trim()) && text) {
      tx[slotIndex].value = text;
    }

    // trigger input events
    try { sp[slotIndex].dispatchEvent(new Event("input", { bubbles: true })); } catch(e){}
    try { ds[slotIndex].dispatchEvent(new Event("input", { bubbles: true })); } catch(e){}
    if (tx && tx[slotIndex]) { try { tx[slotIndex].dispatchEvent(new Event("input", { bubbles: true })); } catch(e){} }

    return true;
  }

  function render(list) {
    suggestions = Array.isArray(list) ? list : [];

    // âœ… keep suggestions in memory for pushToBytes
    window.__NG_EE_SUGGEST = suggestions;
    window.__NG_EE_SUGGESTIONS = suggestions; // backward alias

    eeList.innerHTML = "";

    if (!suggestions.length) {
      showEmpty(true);
      btnPush.disabled = true;
      btnClear.disabled = true;
      return;
    }

    showEmpty(false);

    suggestions.forEach((b, i) => {
      const speaker = esc(b.speaker || "Unknown");
      const desig   = esc(b.designation || "");
      const text    = esc(b.text || "");

      const card = document.createElement("label");
      card.style.cssText =
        "border:1px solid #ddd;border-radius:12px;padding:10px;display:block;margin:10px 0;cursor:pointer;";

      card.innerHTML = `
        <div style="display:flex;gap:10px;align-items:flex-start;">
          <input type="checkbox" data-i="${i}" style="margin-top:3px;">
          <div style="flex:1;">
            <div style="font-weight:700;">${speaker}</div>
            <div style="opacity:.75;font-size:12px;margin-top:2px;">${desig}</div>
            <div style="margin-top:8px;line-height:1.35;">${text}</div>
          </div>
        </div>
      `;
      eeList.appendChild(card);
    });

    updateButtons();
  }

  function clearAll() {
    render([]);
  }

  function getCheckedIndices() {
    return [...eeList.querySelectorAll('input[type="checkbox"][data-i]:checked')]
      .map(cb => Number(cb.getAttribute("data-i")))
      .filter(n => Number.isFinite(n) && n >= 0);
  }

  function pushToBytes() {
    const idxs = getCheckedIndices();
    if (!idxs.length) return;

    const dupeSet = existingByteSet();
    const pushedRun = new Set();
    let pushed = 0;

    for (const idx of idxs) {
      const item = suggestions[idx];
      if (!item) continue;

      const speaker = (item.speaker || "").toString().trim();
      const desig   = (item.designation || "").toString().trim();
      const text    = (item.text || "").toString().trim();

      const key = `${normKeyLocal(speaker)}|${normKeyLocal(desig)}|${normKeyLocal(text)}`;

      // âœ… no duplicates: already in bytes OR already pushed in this click
      if (dupeSet.has(key) || pushedRun.has(key)) continue;

      // find next empty slot and ensure rows
      const slot = findFirstEmptySlot();
      ensureByteRows(slot + 1);

      const ok = fillSlot(slot, { speaker, designation: desig, text });

      // âœ… only if filled successfully: uncheck + count + add to sets
      if (ok) {
        const cb = eeList.querySelector(`input[type="checkbox"][data-i="${idx}"]`);
        if (cb) cb.checked = false;

        dupeSet.add(key);
        pushedRun.add(key);
        pushed++;
      }
    }

    if (pushed) console.log("[EE] Pushed to Bytes:", pushed);
    updateButtons();
  }

  // bind once
  if (!window.__NG_EE_WIRED) {
    window.__NG_EE_WIRED = true;

    eeList.addEventListener("change", updateButtons);

    btnPush.addEventListener("click", (e) => {
      e.preventDefault();
      pushToBytes();
    });

    btnClear.addEventListener("click", (e) => {
      e.preventDefault();
      clearAll();
    });
  }

  // expose renderer
  window.NG_setEditorialSuggestions = render;

  // initial empty
  render([]);
  console.log("[EE] initEditorialExtraction READY");
}

  // ---------------- ingest + hook NG_TRANSCRIPT ----------------
  window.NG_ingestTranscript = function (reverieJsonOrText) {
    const rawLines = collectCandidateLines(reverieJsonOrText, { maxNodes: 9000 });
    const best = pickBestLines(rawLines, 6, 10).map(x => ({
      speaker: x.speaker || "",
      designation: x.designation || "",
      text: x.text || ""
    }));

    // âœ… keep latest suggestions in memory (for pushToBytes fallback)
window.__NG_EE_SUGGEST = Array.isArray(best) ? best : [];

if (typeof window.NG_setEditorialSuggestions === "function") {
  window.NG_setEditorialSuggestions(best);
}

// âœ… after render, ensure push button state is correct
syncEePushBtn();

console.log("[EE] Transcript â†’ suggestions:", best.length);
return best;


  (function hookTranscriptSetter() {
    if (window.__NG_TRANSCRIPT_HOOKED) return;
    window.__NG_TRANSCRIPT_HOOKED = true;

    let _t = window.NG_TRANSCRIPT;
    let _lastSig = "";

    function sigOf(v) {
      try {
        if (v == null) return "";
        if (typeof v === "string") return "str:" + v.slice(0, 120);
        return "obj:" + JSON.stringify(v).slice(0, 240);
      } catch {
        return "unk";
      }
    }

    function ingestSoon(v, reason) {
      const sig = sigOf(v);
      if (!sig || sig === _lastSig) return;
      _lastSig = sig;

      setTimeout(() => {
        try {
          if (typeof window.NG_ingestTranscript === "function") window.NG_ingestTranscript(v);
        } catch (e) {
          console.error("[EE] ingest error:", e);
        }
      }, 0);

      console.log("[EE] NG_TRANSCRIPT ingest (" + reason + ")");
    }

    try {
      Object.defineProperty(window, "NG_TRANSCRIPT", {
        configurable: true,
        get: function () { return _t; },
        set: function (v) { _t = v; ingestSoon(v, "setter"); }
      });
    } catch (e) {
      console.warn("[EE] NG_TRANSCRIPT hook failed (non-configurable).", e);
    }

    if (_t) ingestSoon(_t, "boot");
  })();

  // ---------------- Transcript JSON Loader ----------------
  (function initTranscriptJsonLoader() {
    const LS_KEY = "NG_REVERIE_TRANSCRIPT_JSON_V1";
    function $(id){ return document.getElementById(id); }

    function extractTranscriptText(obj) {
      if (typeof obj === "string") return obj;

      if (obj && typeof obj.display_text === "string" && obj.display_text.trim()) return obj.display_text;
      if (obj && typeof obj.text === "string" && obj.text.trim()) return obj.text;

      const cands = [obj?.result, obj?.output, obj?.data, obj?.transcript, obj?.transcription].filter(Boolean);
      for (const c of cands) {
        if (typeof c?.display_text === "string" && c.display_text.trim()) return c.display_text;
        if (typeof c?.text === "string" && c.text.trim()) return c.text;
      }

      const segs =
        obj?.segments || obj?.result?.segments || obj?.output?.segments || obj?.data?.segments ||
        obj?.utterances || obj?.result?.utterances || obj?.items;

      if (Array.isArray(segs) && segs.length) {
        const parts = segs.map(s =>
          (typeof s?.display_text === "string" && s.display_text.trim()) ? s.display_text :
          (typeof s?.text === "string" && s.text.trim()) ? s.text :
          (typeof s?.utterance === "string" && s.utterance.trim()) ? s.utterance :
          ""
        ).filter(Boolean);
        if (parts.length) return parts.join("\n");
      }

      return "";
    }

    function loadFromTextarea() {
      const ta = $("ta-transcript-json");
      if (!ta) return;

      const raw = (ta.value || "").trim();
      if (!raw) return;

      try { localStorage.setItem(LS_KEY, raw); } catch {}

      let parsed;
      try { parsed = JSON.parse(raw); } catch { parsed = raw; }

      const text = extractTranscriptText(parsed) || (typeof parsed === "string" ? parsed : "");
      window.NG_TRANSCRIPT = text; // âœ… sets extracted text
      console.log("[TL] NG_TRANSCRIPT set. chars:", (text || "").length);
    }

    function boot() {
      const ta = $("ta-transcript-json");
      const btn = $("btn-load-transcript-json");

      try {
        const saved = localStorage.getItem(LS_KEY);
        if (ta && saved && !ta.value.trim()) ta.value = saved;
      } catch {}

      if (btn && !btn.__NG_BOUND) {
        btn.__NG_BOUND = true;
        btn.addEventListener("click", (e) => {
          e.preventDefault();
          loadFromTextarea();
        });
      }
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", boot, { once: true });
    } else {
      boot();
    }
})();  // âœ… close Transcript Loader IIFE


  // ---------------- export global + auto init ----------------
  window.initEditorialExtraction = initEditorialExtraction;

 if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", initEditorialExtraction, { once: true });
} else {
  initEditorialExtraction();
}

}  // âœ… added: missing closing brace for script #2
</script>
<script src="/ng_transcript_hook_patch.js"></script>
<script>
/* =========================
   Bytes JSON Button (V1)
   - Adds "Copy Bytes JSON" button inside #bytesWrap
   - Uses existing window.NG_getBytesJSON()
========================= */
(function initBytesJSONButton(){
  function $(id){ return document.getElementById(id); }

  function safeStringify(obj){
    try { return JSON.stringify(obj, null, 2); }
    catch(e){ return String(obj); }
  }

  function copyText(text){
    if (navigator && navigator.clipboard && typeof navigator.clipboard.writeText === "function") {
      return navigator.clipboard.writeText(text);
    }
    return new Promise(function(resolve){
      var ta = document.createElement("textarea");
      ta.value = text;
      ta.setAttribute("readonly", "readonly");
      ta.style.position = "fixed";
      ta.style.top = "-1000px";
      ta.style.left = "-1000px";
      document.body.appendChild(ta);
      ta.focus();
      ta.select();
      try { document.execCommand("copy"); } catch(e) {}
      document.body.removeChild(ta);
      resolve();
    });
  }
function ensureBytesJSONUI(){

    var wrap = $("bytesWrap");   // <-- à¤…à¤—à¤° à¤†à¤ªà¤•à¥‡ HTML à¤®à¥‡à¤‚ id à¤…à¤²à¤— à¤¹à¥ˆ à¤¤à¥‹ à¤¯à¤¹à¥€à¤‚ à¤¬à¤¦à¤²à¥‡à¤‚
    if (!wrap) return false;

    if ($("bytesJSONBox")) return true;

    var box = document.createElement("div");
    box.id = "bytesJSONBox";
    box.style.margin = "10px 0";
    box.style.padding = "10px";
    box.style.border = "1px solid #e5e5e5";
    box.style.borderRadius = "10px";
    box.style.background = "#fafafa";

    var bar = document.createElement("div");
    bar.style.display = "flex";
    bar.style.gap = "8px";
    bar.style.alignItems = "center";
    bar.style.flexWrap = "wrap";

    var btn = document.createElement("button");
    btn.type = "button";
    btn.id = "btnBytesJSON";
    btn.textContent = "Copy Bytes JSON";
    btn.style.padding = "8px 10px";
    btn.style.cursor = "pointer";

    var btnToggle = document.createElement("button");
    btnToggle.type = "button";
    btnToggle.id = "btnBytesJSONToggle";
    btnToggle.textContent = "Show";
    btnToggle.style.padding = "8px 10px";
    btnToggle.style.cursor = "pointer";

    var hint = document.createElement("span");
    hint.id = "bytesJSONHint";
    hint.textContent = "";
    hint.style.fontSize = "12px";
    hint.style.opacity = "0.8";

    var out = document.createElement("textarea");
    out.id = "bytesJSONOut";
    out.readOnly = true;
    out.rows = 8;
    out.style.width = "100%";
    out.style.marginTop = "10px";
    out.style.display = "none";
    out.style.fontFamily = "ui-monospace, Menlo, Consolas, monospace";

    bar.appendChild(btn);
    bar.appendChild(btnToggle);
    bar.appendChild(hint);

    box.appendChild(bar);
    box.appendChild(out);

    wrap.insertBefore(box, wrap.firstChild);

    btn.addEventListener("click", function(){
      var getFn = window.NG_getBytesJSON;
      if (typeof getFn !== "function") {
        hint.textContent = "NG_getBytesJSON() not found";
        console.warn("[BYTES JSON] NG_getBytesJSON() not found");
        return;
      }

      var data = getFn();
      var json = safeStringify(data);

      out.value = json;
      out.style.display = "block";
      btnToggle.textContent = "Hide";

      try { localStorage.setItem("NG_LAST_BYTES_JSON_V1", json); } catch(e) {}

      var old = btn.textContent;
      btn.textContent = "Copyingâ€¦";

      copyText(json).then(function(){
        btn.textContent = "Copied âœ“";
        hint.textContent = "Copied to clipboard";
        setTimeout(function(){
          btn.textContent = old;
          hint.textContent = "";
        }, 1200);
      });
    });

    btnToggle.addEventListener("click", function(){
      var isHidden = (out.style.display === "none");
      out.style.display = isHidden ? "block" : "none";
      btnToggle.textContent = isHidden ? "Hide" : "Show";
    });

    return true;
  }
if (typeof ensureDigiPackUI === "function") window.ensureDigiPackUI = ensureDigiPackUI;






  function boot(){
    var tries = 0;
    var t = setInterval(function(){
      tries++;
      if (ensureBytesJSONUI() || tries >= 20) clearInterval(t);

    }, 200);
  }

    // âœ… force-create Bytes JSON UI once
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", ensureBytesJSONUI, { once: true });
  } else {
    ensureBytesJSONUI();
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", boot);
  } else {
    boot();
  }
})();
</script>

<script>
/* =========================
   DIGI_PACK Draft + Library + Published (V1) â€” CLEAN REPLACE
   - Restores: Copy Bytes JSON, Save Draft, Library, Mark Published, New Story
   - Stores form + bytes JSON in localStorage
========================= */
(function initDigiPackDrafts(){
  var LS_DRAFTS   = "NG_DIGIPACK_DRAFTS_V1";
  var LS_CURRENT  = "NG_DIGIPACK_CURRENT_ID_V1";

  function $(id){ return document.getElementById(id); }

  function safeJSONParse(s, fallback){
    try { return JSON.parse(s); } catch(e){ return fallback; }
  }
  function safeJSONStringify(o, fallback){
    try { return JSON.stringify(o, null, 2); } catch(e){ return fallback || ""; }
  }
  function nowISO(){
    try { return new Date().toISOString(); } catch(e){ return String(Date.now()); }
  }

  function copyText(txt){
    txt = (txt == null) ? "" : String(txt);
    if (!txt) return false;

    if (navigator && navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(txt).catch(function(){});
      return true;
    }
    // fallback
    var ta = document.createElement("textarea");
    ta.value = txt;
    ta.style.position = "fixed";
    ta.style.left = "-9999px";
    document.body.appendChild(ta);
    ta.select();
    try { document.execCommand("copy"); } catch(e){}
    document.body.removeChild(ta);
    return true;
  }
function fillQuickViewV2(g){
  function pick(selList){
    for (var i=0;i<selList.length;i++){
      var el = document.querySelector(selList[i]);
      if (el) return el;
    }
    return null;
  }
  function toLines(v){
    if (!v) return [];
    if (Array.isArray(v)) return v.map(function(x){ return String(x || "").trim(); }).filter(Boolean);
    if (typeof v === "string") return v.split(/\n+/).map(function(s){ return s.trim(); }).filter(Boolean);
    return [String(v)];
  }

  var headline = (g.headline || "").trim();
  var dek      = (g.dek || "").trim();
  var bullets  = toLines(g.bullet_points);
  var vo       = toLines(g.vo_lines);
  var tags     = toLines(g.hashtags).join(" ");
  var caution  = (g.caution || "").trim();

  var out = "";
  if (headline) out += "Headline: " + headline + "\n";
  if (dek)      out += "Dek: " + dek + "\n";
  if (bullets.length){
    out += "Key Points:\n" + bullets.map(function(x){ return "- " + x; }).join("\n") + "\n";
  }
  if (vo.length){
    out += "VO Lines:\n" + vo.map(function(x){ return "â€¢ " + x; }).join("\n") + "\n";
  }
  if (tags)     out += "Hashtags: " + tags + "\n";
  if (caution)  out += "Caution: " + caution + "\n";

  // âœ… Try common Quick View targets (works even if your id differs)
  var qv = pick(["#quickView", "#quick-view", "#ta-quick-view", "#taQuickView", "textarea[name='quick_view']"]);
  if (qv){
    if ("value" in qv) qv.value = out.trim();
    else qv.textContent = out.trim();
  }
}

  function getDrafts(){
    return safeJSONParse(localStorage.getItem(LS_DRAFTS) || "[]", []);
  }
  function setDrafts(arr){
    localStorage.setItem(LS_DRAFTS, safeJSONStringify(arr, "[]"));
  }
  function getCurrentId(){
    return localStorage.getItem(LS_CURRENT) || "";
  }
  function setCurrentId(id){
    if (!id) localStorage.removeItem(LS_CURRENT);
    else localStorage.setItem(LS_CURRENT, id);
  }

  function formToObject(form){
    var out = {};
    if (!form) return out;

    var fd = new FormData(form);
    fd.forEach(function(v, k){
      // handle repeated fields
      if (out.hasOwnProperty(k)) {
        if (!Array.isArray(out[k])) out[k] = [out[k]];
        out[k].push(String(v));
      } else {
        out[k] = String(v);
      }
    });
    return out;
  }

  function getBytesJSON(){
    try {
      if (typeof window.NG_getBytesJSON === "function") {
        return window.NG_getBytesJSON(); // expected object
      }
    } catch(e){}
    return null;
  }

  function clearBytesUI(){
    try {
      // clear common bytes fields if present
      var sp = document.querySelectorAll('input[name="byte_speaker[]"]');
      var ds = document.querySelectorAll('input[name="byte_designation[]"]');
      var tx = document.querySelectorAll('input[name="byte_text[]"], textarea[name="byte_text[]"]');
      var i;
      for(i=0;i<sp.length;i++) sp[i].value = "";
      for(i=0;i<ds.length;i++) ds[i].value = "";
      for(i=0;i<tx.length;i++) tx[i].value = "";
    } catch(e){}
  }

  function clearForm(form){
    if (!form) return;
    try { form.reset(); } catch(e){}
    // also clear textareas explicitly (some UIs keep them)
    try {
      var tas = form.querySelectorAll("textarea");
      for (var i=0;i<tas.length;i++) tas[i].value = "";
    } catch(e){}
  }

  function ensureActionBar(){
    // If buttons already exist, don't duplicate. Just bind later.
    if ($("btn-copy-bytes-json") || $("btn-save-draft") || $("btn-open-library") || $("btn-mark-published") || $("btn-new-story")) {
      return;
    }

    var form = $("digi-pack-form");
    if (!form) return;

    var bar = document.createElement("div");
    bar.id = "ng-dp-actions";
    bar.style.display = "flex";
    bar.style.gap = "8px";
    bar.style.flexWrap = "wrap";
    bar.style.margin = "10px 0";
    bar.style.alignItems = "center";

    function mkBtn(id, label){
      var b = document.createElement("button");
      b.type = "button";
      b.id = id;
      b.textContent = label;
      b.style.padding = "8px 10px";
      b.style.border = "1px solid #999";
      b.style.borderRadius = "8px";
      b.style.cursor = "pointer";
      b.style.background = "#f7f7f7";
      return b;
    }

    bar.appendChild(mkBtn("btn-copy-bytes-json", "Copy Bytes JSON"));
    bar.appendChild(mkBtn("btn-save-draft", "Save Draft"));
    bar.appendChild(mkBtn("btn-open-library", "Library"));
    bar.appendChild(mkBtn("btn-mark-published", "Mark Published"));
    bar.appendChild(mkBtn("btn-new-story", "New Story"));

    // insert before form
    form.parentNode.insertBefore(bar, form);
  }

  function showLibraryModal(){
    var drafts = getDrafts();

    // overlay
    var ov = document.createElement("div");
    ov.id = "ng-dp-lib-ov";
    ov.style.position = "fixed";
    ov.style.left = "0";
    ov.style.top = "0";
    ov.style.right = "0";
    ov.style.bottom = "0";
    ov.style.background = "rgba(0,0,0,0.35)";
    ov.style.zIndex = "9999";
    ov.style.display = "flex";
    ov.style.alignItems = "center";
    ov.style.justifyContent = "center";
    ov.addEventListener("click", function(e){
      if (e && e.target === ov) document.body.removeChild(ov);
    });

    var box = document.createElement("div");
    box.style.width = "min(900px, 92vw)";
    box.style.maxHeight = "80vh";
    box.style.overflow = "auto";
    box.style.background = "#fff";
    box.style.borderRadius = "14px";
    box.style.padding = "14px";
    box.style.boxShadow = "0 10px 30px rgba(0,0,0,0.25)";

    var h = document.createElement("div");
    h.style.display = "flex";
    h.style.justifyContent = "space-between";
    h.style.alignItems = "center";

    var title = document.createElement("div");
    title.textContent = "Draft Library";
    title.style.fontWeight = "700";
    title.style.fontSize = "16px";

    var close = document.createElement("button");
    close.type = "button";
    close.textContent = "Close";
    close.style.padding = "6px 10px";
    close.style.border = "1px solid #999";
    close.style.borderRadius = "10px";
    close.style.cursor = "pointer";
    close.addEventListener("click", function(){ document.body.removeChild(ov); });

    h.appendChild(title);
    h.appendChild(close);

    var list = document.createElement("div");
    list.style.marginTop = "10px";

    if (!drafts.length) {
      var empty = document.createElement("div");
      empty.textContent = "No drafts saved yet.";
      empty.style.opacity = "0.8";
      list.appendChild(empty);
    } else {
      for (var i=0;i<drafts.length;i++){
        (function(d){
          var row = document.createElement("div");
          row.style.display = "flex";
          row.style.gap = "10px";
          row.style.alignItems = "center";
          row.style.border = "1px solid #ddd";
          row.style.borderRadius = "12px";
          row.style.padding = "10px";
          row.style.marginBottom = "8px";

          var meta = document.createElement("div");
          meta.style.flex = "1";
          meta.innerHTML =
            "<div style='font-weight:700'>" + (d.title || ("Draft " + d.id)) + "</div>" +
            "<div style='opacity:.75;font-size:12px'>Saved: " + (d.updated_at || d.created_at || "") +
            (d.status ? (" â€¢ " + d.status) : "") + "</div>";

          function btn(lbl){
            var b = document.createElement("button");
            b.type = "button";
            b.textContent = lbl;
            b.style.padding = "6px 10px";
            b.style.border = "1px solid #999";
            b.style.borderRadius = "10px";
            b.style.cursor = "pointer";
            return b;
          }

          var bLoad = btn("Load");
          bLoad.addEventListener("click", function(){
            var form = $("digi-pack-form");
            if (form && d.form) {
              // restore via name= keys
              Object.keys(d.form).forEach(function(k){
                var v = d.form[k];
                // support array fields
                if (Array.isArray(v)) {
                  var els = form.querySelectorAll('[name="'+k+'"]');
                  for (var j=0;j<els.length && j<v.length;j++){
                    try { els[j].value = String(v[j]); } catch(e){}
                  }
                } else {
                  var el = form.querySelector('[name="'+k+'"]');
                  if (el) { try { el.value = String(v); } catch(e){} }
                }
              });
            }
            setCurrentId(d.id || "");
            document.body.removeChild(ov);
            alert("Draft loaded.");
          });

          var bDel = btn("Delete");
          bDel.addEventListener("click", function(){
            var all = getDrafts();
            var kept = [];
            for (var x=0;x<all.length;x++){
              if (all[x] && all[x].id !== d.id) kept.push(all[x]);
            }
            setDrafts(kept);
            document.body.removeChild(ov);
            showLibraryModal();
          });

          row.appendChild(meta);
          row.appendChild(bLoad);
          row.appendChild(bDel);
          list.appendChild(row);
        })(drafts[i]);
      }
    }

    box.appendChild(h);
    box.appendChild(list);
    ov.appendChild(box);
    document.body.appendChild(ov);
  }

  function bindButtons(){
    var form = $("digi-pack-form");

    var btnCopy = $("btn-copy-bytes-json");
    if (btnCopy) btnCopy.addEventListener("click", function(){
      var bj = getBytesJSON();
      var txt = safeJSONStringify(bj || {}, "{}");
      copyText(txt);
      alert("Bytes JSON copied.");
    });

    var btnSave = $("btn-save-draft");
    if (btnSave) btnSave.addEventListener("click", function(){
      var drafts = getDrafts();
      var id = getCurrentId();
      var formObj = formToObject(form);
      var bytesObj = getBytesJSON();
      var title = (formObj.topic || formObj.Topic || formObj.title || formObj.headline || "").trim();
      if (!title) title = "Untitled Draft";

      var found = null;
      for (var i=0;i<drafts.length;i++){
        if (drafts[i] && drafts[i].id === id) { found = drafts[i]; break; }
      }
      if (!found) {
        id = "D" + Date.now();
        found = { id: id, created_at: nowISO() };
        drafts.unshift(found);
      }
      found.title = title;
      found.form = formObj;
      found.bytes = bytesObj;
      found.updated_at = nowISO();
      found.status = found.status || "draft";

      setDrafts(drafts);
      setCurrentId(id);
      alert("Draft saved.");
    });

    var btnLib = $("btn-open-library");
    if (btnLib) btnLib.addEventListener("click", function(){
      showLibraryModal();
    });

    var btnPub = $("btn-mark-published");
    if (btnPub) btnPub.addEventListener("click", function(){
      var drafts = getDrafts();
      var id = getCurrentId();
      if (!id) { alert("No current draft. Save first."); return; }
      for (var i=0;i<drafts.length;i++){
        if (drafts[i] && drafts[i].id === id) {
          drafts[i].status = "published";
          drafts[i].published_at = nowISO();
          drafts[i].updated_at = nowISO();
          setDrafts(drafts);
          alert("Marked published.");
          return;
        }
      }
      alert("Draft not found. Save first.");
    });

    var btnNew = $("btn-new-story");
    if (btnNew) btnNew.addEventListener("click", function(){
      setCurrentId("");
      clearForm(form);
      clearBytesUI();
      alert("New story started.");
    });
  }

  function boot(){
    ensureActionBar();
    bindButtons();
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", boot, { once: true });
  } else {
    boot();
  }
})();
</script>

<script>
(function(){
  function esc(s){
    s = (s == null) ? "" : String(s);
    return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;");
  }

  function pickPack(data){
    if (data && data.digi_pack) return data.digi_pack;
    return data || {};
  }

  function ensureQuickBox(){
    var quick = document.getElementById("ngQuick");
    if (!quick) {
      quick = document.createElement("div");
      quick.id = "ngQuick";
      quick.style.border = "1px solid #ddd";
      quick.style.padding = "12px";
      quick.style.borderRadius = "10px";
      quick.style.margin = "12px 0";
      quick.style.background = "#fff";

      var where =
        document.getElementById("ngResponse") ||
        document.getElementById("ngStatus") ||
        document.body;

      where.insertAdjacentElement("beforebegin", quick);
    }

    var body = document.getElementById("ngQuickBody");
    if (!body) {
      quick.innerHTML =
        "<div style='font-weight:700; margin-bottom:8px;'>Quick View</div>" +
        "<div id='ngQuickBody' style='opacity:.75'>(no quick view)</div>";
      body = document.getElementById("ngQuickBody");
    }
    return body;
  }

  // âœ… GLOBAL: this is what your fetch-block will call
  window.renderQuickView = function(data){
    window.__NG_LAST_API_RESPONSE = data;

    var pack = pickPack(data);
    var web = pack.web || {};
    var video = pack.video || {};
    var social = pack.social || {};

    var body = ensureQuickBox();
    if (!body) return;

    body.innerHTML =
      "<div style='display:flex;gap:10px;flex-wrap:wrap;margin-bottom:8px;'>" +
        "<div><span style='opacity:.7'>Topic:</span> <b>" + esc(pack.topic||"") + "</b></div>" +
        "<div><span style='opacity:.7'>Angle:</span> <b>" + esc(pack.angle||"") + "</b></div>" +
        "<div><span style='opacity:.7'>Type:</span> <b>" + esc(pack.story_type||"") + "</b></div>" +
      "</div>" +

      "<div style='margin-top:10px;font-weight:700;'>WEB</div>" +
      "<div><b>Headline:</b> " + esc(web.headline||"") + "</div>" +
      "<div style='margin-top:4px;'><b>Dek:</b> " + esc(web.dek||"") + "</div>" +
      "<div style='margin-top:4px;'><b>Sources:</b> " + esc(web.sources||"") + "</div>" +

      "<div style='margin-top:10px;font-weight:700;'>VIDEO</div>" +
      "<div><b>Hook:</b> " + esc(video.hook||"") + "</div>" +

      "<div style='margin-top:10px;font-weight:700;'>SOCIAL</div>" +
      "<div><b>Caption:</b> " + esc(social.caption||"") + "</div>";
  };
})();
</script>
<script>
/* =========================
   New Story Reset Handler (V2 CLEAN)
   Fixes: script#7 Unexpected end of input
   Purpose: New Story -> clear form, bytes, previews, current draft id
========================= */
(function bindNewStoryOnce(){
  if (window.__NG_NEW_STORY_BOUND) return;
  window.__NG_NEW_STORY_BOUND = true;

  function qs(sel){ try { return document.querySelector(sel); } catch(e){ return null; } }
  function qsa(sel){ try { return document.querySelectorAll(sel); } catch(e){ return []; } }

  function clearControl(el){
    if (!el) return;
    try {
      if (el.type === "checkbox" || el.type === "radio") el.checked = false;
      else el.value = "";
    } catch(e){}
  }

  function clearBySelector(sel){
    var els = qsa(sel);
    for (var i=0;i<els.length;i++) clearControl(els[i]);
  }

  function clearDigiForm(){
    // IDs (if present)
    clearBySelector("#topic");
    clearBySelector("#angle");
    clearBySelector("#whatHappened");
    clearBySelector("#sources");
    clearBySelector("#background");

    // Common name= fields (if present)
    clearBySelector('input[name="topic"]');
    clearBySelector('input[name="angle"]');
    clearBySelector('textarea[name="what_happened"]');
    clearBySelector('textarea[name="sources"]');
    clearBySelector('textarea[name="background"]');

    // Transcript JSON textarea (if present)
    clearBySelector("#ta-transcript-json");

    // Previews / response panes
    var pre = document.getElementById("ngResponse");
    if (pre) pre.textContent = "(no response yet)";
    var qb = document.getElementById("ngQuickBody");
    if (qb) qb.innerHTML = "(no quick view)";
  }

  function clearBytesUI(){
    // If you already have a bytes reset helper, prefer it
    try {
      if (typeof window.NG_clearBytesUI === "function") { window.NG_clearBytesUI(); return; }
    } catch(e){}

    // Otherwise clear common bytes inputs
    clearBySelector('input[name="byte_speaker[]"]');
    clearBySelector('input[name="byte_designation[]"]');
    clearBySelector('input[name="byte_text[]"]');
    clearBySelector('textarea[name="byte_text[]"]');
  }

  function resetDraftState(){
    try { localStorage.removeItem("NG_DIGIPACK_CURRENT_ID_V1"); } catch(e){}
    try { localStorage.removeItem("NG_DP_FORM_SNAPSHOT_V1"); } catch(e){}
    window.__NG_LAST_API_RESPONSE = null;
  }

  function doNewStory(){
    clearDigiForm();
    clearBytesUI();
    resetDraftState();
    try { window.scrollTo(0,0); } catch(e){}
    try { console.log("[NG] New Story: cleared form + bytes + previews"); } catch(e){}
  }

  function findButtonFromTarget(t){
    var el = t;
    for (var i=0;i<6 && el;i++){
      if (el.tagName === "BUTTON") return el;
      el = el.parentNode;
    }
    return null;
  }

  function bindDirectButton(){
    // Prefer IDs used by your UI
    var btn =
      document.getElementById("btn-new-story") ||
      document.getElementById("newStoryBtn") ||
      document.getElementById("btnNewStory") ||
      null;

    if (btn && !btn.__ng_new_story_bound) {
      btn.__ng_new_story_bound = true;
      btn.addEventListener("click", function(e){
        try { if (e && e.preventDefault) e.preventDefault(); } catch(_e){}
        doNewStory();
      });
    }
  }

  // Capture click so it works even if button is injected later
  document.addEventListener("click", function(e){
    var t = e && e.target;
    if (!t) return;

    var btn = findButtonFromTarget(t);
    if (!btn) return;

    var id = btn.id || "";
    if (id === "btn-new-story" || id === "newStoryBtn" || id === "btnNewStory") {
      try { if (e && e.preventDefault) e.preventDefault(); } catch(_e){}
      doNewStory();
    }
  }, true);

  function boot(){
    bindDirectButton();
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", boot, { once: true });
  } else {
    boot();
  }

  // Expose manual rebind (optional)
  window.bindNewStoryOnce = function(){ try { bindDirectButton(); return true; } catch(e){ return false; } };

})();

/* === NG DigiPack Capture + SaveDraft Patch + Library Download FULL DIGIPACK (V2) === */
(function () {
  if (window.__NG_DIGIPACK_V2) {
    console.log("[NG_DIGIPACK_V2] already installed OK");
    return;
  }
  window.__NG_DIGIPACK_V2 = true;

  function safeStr(v) { return (v == null) ? "" : String(v); }
  function safeTrim(v) { return safeStr(v).replace(/^\s+|\s+$/g, ""); }
  function nowISO() { try { return new Date().toISOString(); } catch (e) { return ""; } }

  function lsGet(key, fallback) {
    try {
      var raw = localStorage.getItem(key);
      if (!raw) return fallback;
      return JSON.parse(raw);
    } catch (e) { return fallback; }
  }
  function lsSet(key, val) {
    try { localStorage.setItem(key, JSON.stringify(val)); return true; }
    catch (e) { return false; }
  }

  function slug(s) {
    s = safeTrim(s).toLowerCase();
    s = s.replace(/[^a-z0-9\u0900-\u097f]+/g, "_");
    s = s.replace(/^_+|_+$/g, "");
    return s || "story";
  }

  /* -----------------------------
     A) Capture last DigiPack reliably
     - Prefer response from /api/digi-pack (fetch wrapper)
     - Fallback: scan DOM for "FULL DIGIPACK"
  ------------------------------ */

  function normalizePack(obj) {
    if (!obj) return null;

    // if obj is already a string
    if (typeof obj === "string") {
      return { raw: obj, blocks: { full_digipack: obj }, source: "string", ts: nowISO() };
    }

    // pick likely locations
    var blocks =
      (obj && obj.blocks) ||
      (obj && obj.digipack && obj.digipack.blocks) ||
      (obj && obj.digipack) ||
      obj;

    var raw =
      (obj && obj.raw) ||
      (obj && obj.digipack && obj.digipack.raw) ||
      "";

    // if still no raw, stringify blocks
    if (!raw) {
      try { raw = JSON.stringify(blocks, null, 2); } catch (e) { raw = ""; }
    }

    return { raw: safeStr(raw), blocks: blocks || {}, source: "object", ts: nowISO() };
  }

  // Fetch wrapper: capture /api/digi-pack response JSON into window.NG_LAST_DIGIPACK*
  (function wrapFetch() {
    var _fetch = window.fetch;
    if (typeof _fetch !== "function") return;

    window.fetch = function (input, init) {
      var p = _fetch.apply(this, arguments);

      try {
        var url = "";
        if (typeof input === "string") url = input;
        else if (input && input.url) url = input.url;

        if (url && /\/api\/digi-pack\b/.test(url)) {
          p.then(function (res) {
            try {
              var clone = res.clone();
              clone.json().then(function (j) {
                var cap = normalizePack(j);
                if (!cap) return;
                window.NG_LAST_DIGIPACK = j;
                window.NG_LAST_DIGIPACK_CAP = cap;
                window.NG_LAST_DIGIPACK_TS = cap.ts;
                // convenience
                window.NG_LAST_DIGIPACK_RAW = cap.raw;
                console.log("[NG_DIGIPACK_V2] captured from fetch", {
                  rawLen: cap.raw ? cap.raw.length : 0
                });
              }).catch(function () {});
            } catch (e) {}
          }).catch(function () {});
        }
      } catch (e) {}

      return p;
    };

    console.log("[NG_DIGIPACK_V2] fetch wrapper installed OK");
  })();

  function pickText(selector) {
    var el = document.querySelector(selector);
    if (!el) return "";
    if (typeof el.value !== "undefined") return safeStr(el.value);
    return safeStr(el.textContent);
  }

  // Heuristic: find "FULL DIGIPACK" label and capture nearest pre/textarea block
  function captureFromDOMHeuristic() {
    var nodes = document.querySelectorAll("h1,h2,h3,h4,div,span,strong,b");
    var i, t;
    for (i = 0; i < nodes.length; i++) {
      t = safeTrim(nodes[i].textContent || "");
      if (!t) continue;
      if (t.toUpperCase().indexOf("FULL DIGIPACK") !== -1) {
        // try next sibling
        var sib = nodes[i].nextElementSibling;
        if (sib) {
          var cand = sib.querySelector ? sib.querySelector("pre,textarea") : null;
          if (cand) {
            var raw = safeTrim(pickText("pre,textarea"));
            if (raw) return { raw: raw, blocks: { full_digipack: raw }, source: "dom_heading", ts: nowISO() };
          }
          var raw2 = safeTrim(sib.textContent || "");
          if (raw2) return { raw: raw2, blocks: { full_digipack: raw2 }, source: "dom_heading_text", ts: nowISO() };
        }
        // try within same parent
        var p = nodes[i].parentNode;
        if (p && p.querySelector) {
          var cand2 = p.querySelector("pre,textarea");
          if (cand2) {
            var raw3 = safeTrim(cand2.value || cand2.textContent || "");
            if (raw3) return { raw: raw3, blocks: { full_digipack: raw3 }, source: "dom_parent", ts: nowISO() };
          }
        }
      }
    }

    // extra direct IDs (safe)
    var rawX =
      safeTrim(pickText("#full-digipack")) ||
      safeTrim(pickText("#digipack-raw")) ||
      safeTrim(pickText("#out-digipack")) ||
      "";

    if (rawX) return { raw: rawX, blocks: { full_digipack: rawX }, source: "dom_ids", ts: nowISO() };
    return null;
  }

  function captureDigiPackNow() {
    // Prefer fetch-captured pack (most reliable)
    if (window.NG_LAST_DIGIPACK_CAP && window.NG_LAST_DIGIPACK_CAP.raw) return window.NG_LAST_DIGIPACK_CAP;
    // Fallback: dom heuristic
    var domCap = captureFromDOMHeuristic();
    if (domCap && domCap.raw) return domCap;
    return null;
  }

  /* -----------------------------
     B) On Save Draft: patch NG_DRAFTS[last].story.digipack.raw/blocks
  ------------------------------ */

  function patchLastDraft(cap) {
    if (!cap) return false;

    var drafts = lsGet("NG_DRAFTS", []);
    if (!drafts || !drafts.length) return false;

    var idx = drafts.length - 1;
    var last = drafts[idx];
    if (!last) return false;

    if (!last.story) last.story = {};
    if (!last.story.digipack) last.story.digipack = {};

    last.story.digipack.raw = safeStr(cap.raw || "");
    last.story.digipack.blocks = cap.blocks || {};
    last.story.digipack.ts = cap.ts || nowISO();
    last.story.digipack.source = cap.source || "unknown";

    // helpful mirrors (old exporters often read these)
    last.story.full_digipack = safeStr(cap.raw || "");
    last.story.digipack_raw = safeStr(cap.raw || "");

    drafts[idx] = last;
    return lsSet("NG_DRAFTS", drafts);
  }

  document.addEventListener("click", function (e) {
    var t = e && e.target;
    if (!t) return;

    // recognize click on the Save Draft button or its children
    var btn = document.getElementById("btn-save-draft");
    if (!btn) return;
    if (!(t === btn || (btn.contains && btn.contains(t)))) return;

    var cap = captureDigiPackNow();
    window.__NG_PENDING_DIGIPACK = cap;

    // let app save draft first, then patch localStorage
    setTimeout(function () {
      var ok = patchLastDraft(window.__NG_PENDING_DIGIPACK);
      console.log("[NG_DIGIPACK_V2] SaveDraft patched =", ok, {
        hasCap: !!window.__NG_PENDING_DIGIPACK,
        rawLen: window.__NG_PENDING_DIGIPACK ? safeStr(window.__NG_PENDING_DIGIPACK.raw).length : 0,
        source: window.__NG_PENDING_DIGIPACK ? window.__NG_PENDING_DIGIPACK.source : ""
      });
    }, 350);
  }, true);

  window.NG_debugLastDraftDigipack = function () {
    var drafts = lsGet("NG_DRAFTS", []);
    var last = (drafts && drafts.length) ? drafts[drafts.length - 1] : null;
    var raw = "";
    if (last && last.story && last.story.digipack) raw = safeStr(last.story.digipack.raw);
    return { drafts: drafts.length, rawLen: raw.length, last: last };
  };

  /* -----------------------------
     C) Library Download TXT/JSON: export FULL DIGIPACK per selected story
     - Intercepts clicks on any "Download TXT/JSON" button/link inside Library
  ------------------------------ */

  function findSelectedDraftIndex() {
    // Common selection markers
    var sel =
      document.querySelector('[data-draft-index].selected') ||
      document.querySelector('[data-draft-idx].selected') ||
      document.querySelector('.draft-row.selected') ||
      document.querySelector('.draft-row.active') ||
      document.querySelector('[aria-selected="true"][data-draft-index]') ||
      document.querySelector('[aria-selected="true"][data-draft-idx]') ||
      null;

    if (sel) {
      var v = sel.getAttribute("data-draft-index");
      if (v == null) v = sel.getAttribute("data-draft-idx");
      var n = parseInt(v, 10);
      if (!isNaN(n)) return n;
    }

    // Common radio patterns
    var r =
      document.querySelector('input[type="radio"][name="draft_pick"]:checked') ||
      document.querySelector('input[type="radio"][name="ng_draft_pick"]:checked') ||
      document.querySelector('input[type="radio"][name*="draft"]:checked') ||
      null;

    if (r && r.value != null) {
      var n2 = parseInt(r.value, 10);
      if (!isNaN(n2)) return n2;
    }

    return null; // unknown
  }

  function getDraftByIndex(idxMaybe) {
    var drafts = lsGet("NG_DRAFTS", []);
    if (!drafts || !drafts.length) return null;
    var idx = idxMaybe;
    if (idx == null || idx < 0 || idx >= drafts.length) idx = drafts.length - 1;
    return drafts[idx] || null;
  }

  function ensureDraftHasDigipack(draft) {
    if (!draft) return draft;
    if (!draft.story) draft.story = {};
    if (!draft.story.digipack) draft.story.digipack = {};

    var raw = safeStr(draft.story.digipack.raw || draft.story.full_digipack || "");
    if (!raw) {
      // last fallback: current captured pack (NOT ideal, but better than empty)
      var cap = captureDigiPackNow();
      if (cap && cap.raw) {
        raw = cap.raw;
        draft.story.digipack.raw = raw;
        draft.story.digipack.blocks = cap.blocks || {};
        draft.story.digipack.ts = cap.ts || nowISO();
        draft.story.digipack.source = "fallback_current";
      }
    }
    return draft;
  }

  function makeTXT(draft) {
    draft = ensureDraftHasDigipack(draft);

    var story = draft && draft.story ? draft.story : {};
    var headline = safeTrim(story.headline || draft.headline || story.title || draft.title || "");
    var status = safeTrim(draft.status || story.status || "");
    var saved = safeTrim(draft.saved || draft.ts || draft.saved_at || "");

    var out = [];
    out.push("NEWSGENIE DIGIPACK");
    out.push("--------------------------------");
    out.push("Headline: " + (headline || "(no headline)"));
    if (status) out.push("Status: " + status);
    if (saved) out.push("Saved: " + saved);

    // Quotes/SOT if present
    var quotes = story.quotes || story.sot || story.sots || [];
    var qn = (quotes && quotes.length) ? quotes.length : 0;
    out.push("");
    out.push("QUOTES / SOT (" + qn + ")");
    if (!qn) out.push("(No SOT saved)");
    else {
      for (var i = 0; i < quotes.length; i++) {
        var q = quotes[i] || {};
        var line = "- " + safeTrim(q.speaker || q.name || "Speaker") + ": " + safeTrim(q.text || q.quote || "");
        out.push(line);
      }
    }

    out.push("");
    out.push("FULL DIGIPACK");
    out.push("--------------------------------");

    var raw = safeTrim(story.digipack && story.digipack.raw);
    if (!raw && story.digipack && story.digipack.blocks) {
      try { raw = JSON.stringify(story.digipack.blocks, null, 2); } catch (e) { raw = ""; }
    }
    out.push(raw || "(No generated pack saved yet. Generate outputs, then click Save Draft.)");

    return out.join("\n");
  }

  function makeJSON(draft) {
    draft = ensureDraftHasDigipack(draft);
    try { return JSON.stringify(draft, null, 2); }
    catch (e) { return JSON.stringify({ error: "stringify_failed" }); }
  }

  function downloadFile(filename, content, mime) {
    try {
      var blob = new Blob([content], { type: mime || "text/plain;charset=utf-8" });
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(function () {
        try { URL.revokeObjectURL(url); } catch (e) {}
        try { document.body.removeChild(a); } catch (e2) {}
      }, 200);
      return true;
    } catch (e) {
      console.warn("[NG_DIGIPACK_V2] download failed", e);
      return false;
    }
  }

  function isDownloadCandidate(el) {
    if (!el) return false;
    var tag = el.tagName;
    if (tag !== "BUTTON" && tag !== "A") return false;

    var id = (el.id || "").toLowerCase();
    var tx = (el.textContent || "").toLowerCase();

    // Must look like a download action
    if (id.indexOf("download") === -1 && tx.indexOf("download") === -1) return false;

    // Must mention txt/json somewhere
    if (tx.indexOf("txt") !== -1) return "txt";
    if (tx.indexOf("json") !== -1) return "json";
    if (id.indexOf("txt") !== -1) return "txt";
    if (id.indexOf("json") !== -1) return "json";

    return false;
  }

  // Intercept downloads in capture-phase so existing handler doesn't override
  document.addEventListener("click", function (e) {
    var t = e && e.target;
    if (!t) return;

    // climb up a few levels (svg/span inside button)
    var el = t, kind = false, i;
    for (i = 0; i < 5 && el && el !== document; i++) {
      kind = isDownloadCandidate(el);
      if (kind) break;
      el = el.parentNode;
    }
    if (!kind) return;

    // stop old handler and do our export
    if (e.preventDefault) e.preventDefault();
    if (e.stopImmediatePropagation) e.stopImmediatePropagation();
    if (e.stopPropagation) e.stopPropagation();

    var idx = findSelectedDraftIndex();
    var draft = getDraftByIndex(idx);

    if (!draft) {
      console.warn("[NG_DIGIPACK_V2] No drafts found for download");
      return;
    }

    var story = draft.story || {};
    var headline = safeTrim(story.headline || draft.headline || story.title || draft.title || "");
    var base = "NG_" + slug(headline) + "_" + safeStr((draft.saved || draft.ts || "").slice(0, 10));

    if (kind === "txt") {
      var txt = makeTXT(draft);
      downloadFile(base + "_DIGIPACK.txt", txt, "text/plain;charset=utf-8");
      console.log("[NG_DIGIPACK_V2] Download TXT exported", { idx: idx, rawLen: txt.length });
    } else {
      var js = makeJSON(draft);
      downloadFile(base + "_STORY.json", js, "application/json;charset=utf-8");
      console.log("[NG_DIGIPACK_V2] Download JSON exported", { idx: idx, jsonLen: js.length });
    }
  }, true);

  // Debug helper: lists download-like buttons currently in DOM
  window.NG_listDownloadButtons = function () {
    var els = Array.from(document.querySelectorAll("button,a"));
    var hits = [];
    for (var i = 0; i < els.length; i++) {
      var id = (els[i].id || "").toLowerCase();
      var tx = (els[i].textContent || "").toLowerCase();
      if ((id.indexOf("download") !== -1) || (tx.indexOf("download") !== -1)) {
        hits.push({ tag: els[i].tagName, id: els[i].id || "", text: safeTrim(els[i].textContent || "").slice(0, 80) });
      }
    }
    console.log(hits);
    return hits;
  };

  console.log("[NG_DIGIPACK_V2] ready");
})();

/* === NG Library UI: Download TXT/JSON + Preview + Load Auto-Scroll (V1) === */
(function () {
  if (window.__NG_LIBRARY_UI_V1) {
    console.log("[NG_LIBRARY_UI_V1] already installed OK");
    return;
  }
  window.__NG_LIBRARY_UI_V1 = true;

  function safeStr(v){ return (v==null) ? "" : String(v); }
  function safeTrim(s){ return safeStr(s).replace(/^\s+|\s+$/g,""); }
  function slug(s){
    s = safeTrim(s).toLowerCase().replace(/[^a-z0-9\u0900-\u097f]+/g,"_").replace(/^_+|_+$/g,"");
    return s || "story";
  }

  function lsGet(key, fb){
    try { var raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fb; }
    catch(e){ return fb; }
  }

  function downloadFile(filename, content, mime){
    try{
      var blob = new Blob([content], { type: mime || "text/plain;charset=utf-8" });
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click();
      setTimeout(function(){
        try{ URL.revokeObjectURL(url); }catch(e){}
        try{ document.body.removeChild(a); }catch(e2){}
      }, 200);
      return true;
    } catch(e){
      console.warn("[NG_LIBRARY_UI_V1] download failed", e);
      return false;
    }
  }

  function findSelectedIndex(){
    var sel =
      document.querySelector('[data-draft-index].selected') ||
      document.querySelector('[data-draft-idx].selected') ||
      document.querySelector('.draft-row.selected') ||
      document.querySelector('.draft-row.active') ||
      document.querySelector('[aria-selected="true"][data-draft-index]') ||
      document.querySelector('[aria-selected="true"][data-draft-idx]') ||
      document.querySelector('input[type="radio"][name*="draft"]:checked') ||
      null;

    if (!sel) return null;

    var v = null;
    if (sel.getAttribute) v = sel.getAttribute("data-draft-index") || sel.getAttribute("data-draft-idx");
    if (v == null && sel.value != null) v = sel.value;

    var n = parseInt(v, 10);
    return isNaN(n) ? null : n;
  }

  function getDraftByIndex(idx){
    var drafts = lsGet("NG_DRAFTS", []);
    if (!drafts || !drafts.length) return { drafts: drafts, idx: null, draft: null };
    if (idx == null || idx < 0 || idx >= drafts.length) idx = drafts.length - 1;
    return { drafts: drafts, idx: idx, draft: drafts[idx] };
  }

  function makeTXT(draft){
    var story = (draft && draft.story) ? draft.story : {};
    var headline = safeTrim(story.headline || draft.headline || story.title || draft.title || "");
    var status = safeTrim(draft.status || story.status || "");
    var saved  = safeTrim(draft.saved || draft.ts || draft.saved_at || "");

    var raw = "";
    if (story.digipack && story.digipack.raw) raw = safeStr(story.digipack.raw);
    if (!raw && story.full_digipack) raw = safeStr(story.full_digipack);

    var out = [];
    out.push("NEWSGENIE DIGIPACK");
    out.push("--------------------------------");
    out.push("Headline: " + (headline || "(no headline)"));
    if (status) out.push("Status: " + status);
    if (saved) out.push("Saved: " + saved);
    out.push("");
    out.push("FULL DIGIPACK");
    out.push("--------------------------------");
    out.push(raw || "(No generated pack saved yet. Generate outputs, then click Save Draft.)");
    return out.join("\n");
  }

  function ensureBar() {
    if (document.getElementById("ng-lib-bar")) return;

    var bar = document.createElement("div");
    bar.id = "ng-lib-bar";
    bar.style.position = "sticky";
    bar.style.top = "0";
    bar.style.zIndex = "999999";
    bar.style.background = "#111";
    bar.style.color = "#fff";
    bar.style.padding = "10px";
    bar.style.margin = "10px";
    bar.style.borderRadius = "10px";
    bar.style.fontFamily = "system-ui, sans-serif";
    bar.style.display = "flex";
    bar.style.gap = "8px";
    bar.style.alignItems = "center";
    bar.style.flexWrap = "wrap";

    bar.innerHTML = ''
      + '<b style="margin-right:6px">Library</b>'
      + '<button id="ng-lib-dl-txt" style="cursor:pointer;border:0;border-radius:8px;padding:6px 10px">Download TXT</button>'
      + '<button id="ng-lib-dl-json" style="cursor:pointer;border:0;border-radius:8px;padding:6px 10px">Download JSON</button>'
      + '<button id="ng-lib-preview" style="cursor:pointer;border:0;border-radius:8px;padding:6px 10px">Preview DIGIPACK</button>'
      + '<span id="ng-lib-status" style="opacity:.85;margin-left:6px"></span>'
      + '<pre id="ng-lib-pre" style="display:none;width:100%;max-height:220px;overflow:auto;background:#000;margin:8px 0 0 0;padding:10px;border-radius:10px"></pre>';

    // top of page is okay (works even if library is modal)
    document.body.insertBefore(bar, document.body.firstChild);

    function refreshStatus(){
      var idx = findSelectedIndex();
      var g = getDraftByIndex(idx);
      var st = document.getElementById("ng-lib-status");
      if (!st) return;
      if (!g.draft) { st.textContent = "No drafts found"; return; }
      var story = g.draft.story || {};
      var headline = safeTrim(story.headline || g.draft.headline || story.title || g.draft.title || "");
      var raw = "";
      if (story.digipack && story.digipack.raw) raw = safeStr(story.digipack.raw);
      if (!raw && story.full_digipack) raw = safeStr(story.full_digipack);
      st.textContent = "Drafts:" + g.drafts.length + " | idx:" + g.idx + " | rawLen:" + raw.length + (headline ? (" | " + headline.slice(0,40)) : "");
    }

    document.getElementById("ng-lib-dl-txt").onclick = function(){
      var idx = findSelectedIndex();
      var g = getDraftByIndex(idx);
      if (!g.draft) return alert("No drafts found");
      var story = g.draft.story || {};
      var headline = safeTrim(story.headline || g.draft.headline || story.title || g.draft.title || "");
      downloadFile("NG_" + slug(headline) + "_DIGIPACK.txt", makeTXT(g.draft), "text/plain;charset=utf-8");
      refreshStatus();
    };

    document.getElementById("ng-lib-dl-json").onclick = function(){
      var idx = findSelectedIndex();
      var g = getDraftByIndex(idx);
      if (!g.draft) return alert("No drafts found");
      var story = g.draft.story || {};
      var headline = safeTrim(story.headline || g.draft.headline || story.title || g.draft.title || "");
      downloadFile("NG_" + slug(headline) + "_STORY.json", JSON.stringify(g.draft, null, 2), "application/json;charset=utf-8");
      refreshStatus();
    };

    document.getElementById("ng-lib-preview").onclick = function(){
      var idx = findSelectedIndex();
      var g = getDraftByIndex(idx);
      if (!g.draft) return alert("No drafts found");
      var pre = document.getElementById("ng-lib-pre");
      if (!pre) return;
      pre.style.display = (pre.style.display === "none") ? "block" : "none";
      if (pre.style.display === "block") pre.textContent = makeTXT(g.draft);
      refreshStatus();
    };

    // keep status fresh when user clicks in library list
    document.addEventListener("click", function(){ setTimeout(refreshStatus, 50); }, true);
    refreshStatus();

     console.log("[NG_LIBRARY_UI_V1] bar injected");
  }

  // When Library opens, inject bar
  document.addEventListener("click", function(e){
    var t = e && e.target;
    if (!t) return;

    // Open Library button by id
    if (t.id === "btn-open-library" || (t.closest && t.closest("#btn-open-library"))) {
      setTimeout(ensureBar, 150);
      return;
    }

    // Any button/link with "Library" text (fallback)
    var tx = safeTrim(t.textContent || "").toLowerCase();
    if (tx && tx.indexOf("library") !== -1) {
      setTimeout(ensureBar, 150);
      return;
    }

    // Load button: after load, auto-scroll to main save button so user "sees" it
    if (tx === "load" || tx.indexOf(" load") !== -1) {
      setTimeout(function(){
        var b = document.getElementById("btn-save-draft");
        if (b && b.scrollIntoView) b.scrollIntoView({behavior:"smooth", block:"center"});
      }, 250);
    }
  }, true);

  console.log("[NG_LIBRARY_UI_V1] ready");
})();

/* === NG Segmented TXT Export + Main Segments Panel (V1) === */
(function () {
  if (window.__NG_SEGMENTED_V1) return;
  window.__NG_SEGMENTED_V1 = true;

  function safeStr(v){ return (v==null) ? "" : String(v); }
  function trim(s){ return safeStr(s).replace(/^\s+|\s+$/g,""); }
  function escHTML(s){
    s = safeStr(s);
    return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  }
  function slug(s){
    s = trim(s).toLowerCase().replace(/[^a-z0-9\u0900-\u097f]+/g,"_").replace(/^_+|_+$/g,"");
    return s || "story";
  }

  function lsGet(key, fb){
    try { var raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fb; }
    catch(e){ return fb; }
  }

  function downloadFile(filename, content, mime){
    try{
      var blob = new Blob([content], { type: mime || "text/plain;charset=utf-8" });
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click();
      setTimeout(function(){
        try{ URL.revokeObjectURL(url); }catch(e){}
        try{ document.body.removeChild(a); }catch(e2){}
      }, 200);
      return true;
    } catch(e){
      console.warn("[NG_SEGMENTED_V1] download failed", e);
      return false;
    }
  }

  // -------- Extract "generated" safely from response/draft/raw ----------
  function extractGeneratedFromAny(x){
    if (!x) return null;

    // if it's the full API response
    if (x.generated && (x.generated.headline || x.generated.dek || x.generated.web_article_500_600)) return x.generated;

    // if it's already generated-like
    if (x.headline || x.dek || x.web_article_500_600 || x.vo_lines || x.shot_plan) return x;

    return null;
  }

  function extractGeneratedFromDraft(draft){
    var story = (draft && draft.story) ? draft.story : {};
    var dp = story.digipack || {};

    // blocks may be generated or full response
    var g = extractGeneratedFromAny(dp.blocks) ||
            (dp.blocks && extractGeneratedFromAny(dp.blocks.generated)) ||
            null;

    if (g) return g;

    // try parse raw
    var raw = safeStr(dp.raw || story.full_digipack || "");
    if (raw) {
      try {
        var parsed = JSON.parse(raw);
        g = extractGeneratedFromAny(parsed) || (parsed && extractGeneratedFromAny(parsed.generated)) || null;
        if (g) return g;
      } catch(e) {}
    }
    return null;
  }

  // -------- Format as HUMAN text (segments) ----------
  function formatSegmentsText(g){
    if (!g) return "(No generated pack found. Generate then Save Draft.)";

    var out = [];
    out.push("DIGIPACK (SEGMENTS)");
    out.push("--------------------------------");

    // HEADLINE / DEK
    out.push("HEADLINE: " + trim(g.headline || ""));
    if (g.dek) out.push("DEK: " + trim(g.dek));

    // KEY POINTS
    var bp = Array.isArray(g.bullet_points) ? g.bullet_points : [];
    if (bp.length) {
      out.push("");
      out.push("KEY POINTS");
      out.push("--------------------------------");
      for (var i=0;i<bp.length;i++) out.push("- " + trim(bp[i]));
    }

    // WEB ARTICLE
    if (g.web_article_500_600) {
      out.push("");
      out.push("WEB ARTICLE (500â€“600)");
      out.push("--------------------------------");
      out.push(trim(g.web_article_500_600));
    }

    // VIDEO
    out.push("");
    out.push("VIDEO");
    out.push("--------------------------------");
    if (g.video_hook) out.push("HOOK: " + trim(g.video_hook));

    var vo = Array.isArray(g.vo_lines) ? g.vo_lines : [];
    if (vo.length) {
      out.push("");
      out.push("VO LINES");
      for (var j=0;j<vo.length;j++) out.push("â€¢ " + trim(vo[j]));
    }

    var sp = Array.isArray(g.shot_plan) ? g.shot_plan : [];
    if (sp.length) {
      out.push("");
      out.push("SHOT PLAN");
      for (var k=0;k<sp.length;k++){
        var s = sp[k] || {};
        out.push(
          (k+1)+". " +
          trim(s.shot_type || "") +
          (s.what_to_show ? (" | " + trim(s.what_to_show)) : "") +
          (s.notes ? (" | " + trim(s.notes)) : "")
        );
      }
    }

    // SOCIAL
    out.push("");
    out.push("SOCIAL");
    out.push("--------------------------------");
    if (g.social_caption) out.push("CAPTION: " + trim(g.social_caption));
    if (g.social_script_20_30) out.push("SCRIPT (20â€“30s): " + trim(g.social_script_20_30));

    var ht = Array.isArray(g.hashtags) ? g.hashtags.filter(Boolean) : [];
    if (ht.length) out.push("HASHTAGS: " + ht.map(trim).filter(Boolean).join(" "));

    // YOUTUBE (auto-derived, until backend adds dedicated keys)
    out.push("");
    out.push("YOUTUBE (AUTO)");
    out.push("--------------------------------");
    var ytTitle = trim(g.video_hook || g.headline || "");
    var ytDesc = trim(g.web_article_500_600 || "");
    if (ytDesc.length > 600) ytDesc = ytDesc.slice(0, 600) + "...";
    var ytTags = ht.length ? ht.map(function(x){return trim(x).replace(/^#/,"");}).join(", ") : "";

    out.push("TITLE: " + ytTitle);
    if (ytDesc) out.push("DESCRIPTION: " + ytDesc);
    if (ytTags) out.push("TAGS: " + ytTags);

    return out.join("\n");
  }

  // -------- MAIN PAGE: Segments Panel ----------
  function ensureMainPanel(){
    if (document.getElementById("ng-seg-panel")) return;

    var wrap = document.createElement("div");
    wrap.id = "ng-seg-panel";
    wrap.style.margin = "14px 0";
    wrap.style.padding = "12px";
    wrap.style.border = "1px solid #ddd";
    wrap.style.borderRadius = "12px";
    wrap.style.background = "#fafafa";
    wrap.innerHTML =
      '<div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:8px;">' +
      '  <b>DigiPack Segments</b>' +
      '  <button id="ng-seg-copy" style="cursor:pointer;border:0;border-radius:10px;padding:6px 10px;">Copy Segments</button>' +
      '  <span id="ng-seg-meta" style="opacity:.8"></span>' +
      '</div>' +
      '<pre id="ng-seg-pre" style="white-space:pre-wrap;background:#111;color:#fff;padding:10px;border-radius:10px;max-height:420px;overflow:auto;"></pre>';

    // Add near bottom, safe
    document.body.appendChild(wrap);

    document.getElementById("ng-seg-copy").onclick = function(){
      var txt = safeStr(document.getElementById("ng-seg-pre")?.textContent || "");
      try { navigator.clipboard.writeText(txt); } catch(e){}
    };
  }

  function renderMainFromLast(){
    var resp = window.NG_LAST_DIGIPACK || null;
    if (!resp) return;
    ensureMainPanel();
    var g = extractGeneratedFromAny(resp) || extractGeneratedFromAny(resp.generated) || null;
    var txt = formatSegmentsText(g);
    var pre = document.getElementById("ng-seg-pre");
    if (pre) pre.textContent = txt;

    var meta = document.getElementById("ng-seg-meta");
    if (meta) meta.textContent = "rawLen: " + (txt.length || 0);
  }

  // Watch for new generation (NG_LAST_DIGIPACK_TS is updated by your V2 wrapper)
  var lastTs = null;
  setInterval(function(){
    try{
      var ts = window.NG_LAST_DIGIPACK_TS || null;
      if (ts && ts !== lastTs) {
        lastTs = ts;
        renderMainFromLast();
      }
    } catch(e){}
  }, 400);

  // -------- LIBRARY BAR: override TXT/Preview to segmented text ----------
  function overrideLibraryBar(){
    var btnTxt = document.getElementById("ng-lib-dl-txt");
    var btnPrev = document.getElementById("ng-lib-preview");
    var btnJson = document.getElementById("ng-lib-dl-json");
    if (!btnTxt || !btnPrev || !btnJson) return false;

    function findSelectedIndex(){
      var sel =
        document.querySelector('[data-draft-index].selected') ||
        document.querySelector('[data-draft-idx].selected') ||
        document.querySelector('.draft-row.selected') ||
        document.querySelector('.draft-row.active') ||
        document.querySelector('[aria-selected="true"][data-draft-index]') ||
        document.querySelector('[aria-selected="true"][data-draft-idx]') ||
        document.querySelector('input[type="radio"][name*="draft"]:checked') ||
        null;
      if (!sel) return null;
      var v = null;
      if (sel.getAttribute) v = sel.getAttribute("data-draft-index") || sel.getAttribute("data-draft-idx");
      if (v == null && sel.value != null) v = sel.value;
      var n = parseInt(v,10);
      return isNaN(n) ? null : n;
    }

    function getDraft(){
      var drafts = lsGet("NG_DRAFTS", []);
      if (!drafts.length) return { drafts: drafts, idx: null, draft: null };
      var idx = findSelectedIndex();
      if (idx==null || idx<0 || idx>=drafts.length) idx = drafts.length-1;
      return { drafts: drafts, idx: idx, draft: drafts[idx] };
    }

    // TXT = segmented text
    btnTxt.onclick = function(){
      var g = getDraft();
      if (!g.draft) return alert("No drafts found");
      var gen = extractGeneratedFromDraft(g.draft);
      var txt = formatSegmentsText(gen);
      var story = g.draft.story || {};
      var headline = trim(story.headline || g.draft.headline || story.title || g.draft.title || "");
      downloadFile("NG_" + slug(headline) + "_DIGIPACK.txt", txt, "text/plain;charset=utf-8");
    };

    // Preview = show segmented text
    btnPrev.onclick = function(){
      var g = getDraft();
      if (!g.draft) return alert("No drafts found");
      var pre = document.getElementById("ng-lib-pre");
      if (!pre) return;
      pre.style.display = (pre.style.display === "none") ? "block" : "none";
      if (pre.style.display === "block") {
        var gen = extractGeneratedFromDraft(g.draft);
        pre.textContent = formatSegmentsText(gen);
      }
    };

    // JSON stays JSON (unchanged)
    btnJson.onclick = function(){
      var g = getDraft();
      if (!g.draft) return alert("No drafts found");
      var story = g.draft.story || {};
      var headline = trim(story.headline || g.draft.headline || story.title || g.draft.title || "");
      downloadFile("NG_" + slug(headline) + "_STORY.json", JSON.stringify(g.draft, null, 2), "application/json;charset=utf-8");
    };

    console.log("[NG_SEGMENTED_V1] Library bar overridden (TXT/Preview segmented)");
    return true;
  }

  // retry until library bar exists
  var tries = 0;
  var t = setInterval(function(){
    tries++;
    if (overrideLibraryBar() || tries > 60) clearInterval(t);
  }, 300);

  console.log("[NG_SEGMENTED_V1] ready");
})();



</script>
  



<!-- NG_PATCH: SEGMENTED_V2 -->
<script>
/* === NG Segmented Export + Main Segments Drawer (V2) === */
(function(){
  if (window.__NG_SEGMENTED_V2) return;
  window.__NG_SEGMENTED_V2 = true;

  function safeStr(v){ return (v==null) ? "" : String(v); }
  function trim(s){ return safeStr(s).replace(/^\\s+|\\s+$/g,""); }
  function arr(a){ return Array.isArray(a) ? a : []; }
  function slug(s){
    s = trim(s).toLowerCase().replace(/[^a-z0-9\\u0900-\\u097f]+/g,"_").replace(/^_+|_+$/g,"");
    return s || "story";
  }

  function lsGet(key, fb){
    try { var raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fb; }
    catch(e){ return fb; }
  }

  function downloadFile(filename, content, mime){
    try{
      var blob = new Blob([content], { type: mime || "text/plain;charset=utf-8" });
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click();
      setTimeout(function(){
        try{ URL.revokeObjectURL(url); }catch(e){}
        try{ document.body.removeChild(a); }catch(e2){}
      }, 200);
      return true;
    } catch(e){
      console.warn("[NG_SEGMENTED_V2] download failed", e);
      return false;
    }
  }

  function pickGenerated(obj){
    if (!obj) return null;
    if (obj.generated && (obj.generated.headline || obj.generated.web_article_500_600 || obj.generated.vo_lines)) return obj.generated;
    if (obj.headline || obj.web_article_500_600 || obj.vo_lines || obj.shot_plan) return obj;
    return null;
  }

  function extractGeneratedFromDraft(draft){
    var story = (draft && draft.story) ? draft.story : {};
    var dp = story.digipack || {};
    var blocks = dp.blocks || null;

    var g = pickGenerated(blocks) || (blocks && pickGenerated(blocks.generated)) || null;
    if (g) return g;

    var raw = safeStr(dp.raw || story.full_digipack || "");
    if (raw) {
      try{
        var parsed = JSON.parse(raw);
        g = pickGenerated(parsed) || (parsed && pickGenerated(parsed.generated)) || null;
        if (g) return g;
      }catch(e){}
    }
    return null;
  }

  function formatSegments(gen){
    if (!gen) return "(No generated pack found. Generate then Save Draft.)";

    var out = [];
    out.push("DIGIPACK (SEGMENTS)");
    out.push("--------------------------------");

    if (gen.headline) out.push("HEADLINE: " + trim(gen.headline));
    if (gen.dek) out.push("DEK: " + trim(gen.dek));

    var bp = arr(gen.bullet_points).map(trim).filter(Boolean);
    if (bp.length){
      out.push("");
      out.push("KEY POINTS");
      out.push("--------------------------------");
      for (var i=0;i<bp.length;i++) out.push("- " + bp[i]);
    }

    if (gen.web_article_500_600){
      out.push("");
      out.push("WEB ARTICLE (500â€“600)");
      out.push("--------------------------------");
      out.push(trim(gen.web_article_500_600));
    }

    out.push("");
    out.push("VIDEO");
    out.push("--------------------------------");
    if (gen.video_hook) out.push("HOOK: " + trim(gen.video_hook));

    var vo = arr(gen.vo_lines).map(trim).filter(Boolean);
    if (vo.length){
      out.push("");
      out.push("VO LINES");
      for (var j=0;j<vo.length;j++) out.push("â€¢ " + vo[j]);
    }

    var sp = arr(gen.shot_plan);
    if (sp.length){
      out.push("");
      out.push("SHOT PLAN");
      for (var k=0;k<sp.length;k++){
        var s = sp[k] || {};
        out.push(
          (k+1)+". " + trim(s.shot_type||"") +
          (s.what_to_show ? (" | " + trim(s.what_to_show)) : "") +
          (s.notes ? (" | " + trim(s.notes)) : "")
        );
      }
    }

    out.push("");
    out.push("SOCIAL");
    out.push("--------------------------------");
    if (gen.social_caption) out.push("CAPTION: " + trim(gen.social_caption));
    if (gen.social_script_20_30) out.push("SCRIPT (20â€“30s): " + trim(gen.social_script_20_30));
    var ht = arr(gen.hashtags).map(trim).filter(Boolean);
    if (ht.length) out.push("HASHTAGS: " + ht.join(" "));

    out.push("");
    out.push("YOUTUBE (AUTO)");
    out.push("--------------------------------");
    var ytTitle = trim(gen.video_hook || gen.headline || "");
    var ytDesc  = trim(gen.web_article_500_600 || "");
    if (ytDesc.length > 600) ytDesc = ytDesc.slice(0,600) + "...";
    var ytTags = ht.length ? ht.map(function(x){ return trim(x).replace(/^#/, ""); }).filter(Boolean).join(", ") : "";
    out.push("TITLE: " + ytTitle);
    if (ytDesc) out.push("DESCRIPTION: " + ytDesc);
    if (ytTags) out.push("TAGS: " + ytTags);

    if (gen.caution && trim(gen.caution)) {
      out.push("");
      out.push("CAUTION");
      out.push("--------------------------------");
      out.push(trim(gen.caution));
    }

    return out.join("\\n");
  }

  // ---- MAIN PAGE: floating Segments drawer ----
  function ensureDrawer(){
    if (document.getElementById("ngSegBtnV2")) return;

    var btn = document.createElement("button");
    btn.id = "ngSegBtnV2";
    btn.textContent = "SEGMENTS";
    btn.style.cssText = "position:fixed;right:14px;bottom:14px;z-index:999999;padding:10px 12px;border:0;border-radius:12px;cursor:pointer;background:#111;color:#fff;font-family:system-ui;";
    document.body.appendChild(btn);

    var box = document.createElement("div");
    box.id = "ngSegBoxV2";
    box.style.cssText = "position:fixed;right:14px;bottom:58px;z-index:999999;width:560px;max-width:92vw;max-height:70vh;overflow:auto;background:#0b0b0b;color:#fff;border-radius:14px;padding:12px;display:none;font-family:system-ui;";
    box.innerHTML =
      '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">' +
      '<b>DigiPack Segments</b>' +
      '<div style="display:flex;gap:8px;align-items:center;">' +
      '<button id="ngSegCopyV2" style="cursor:pointer;border:0;border-radius:10px;padding:6px 10px;">Copy</button>' +
      '<button id="ngSegCloseV2" style="cursor:pointer;border:0;border-radius:10px;padding:6px 10px;">Close</button>' +
      '</div></div>' +
      '<pre id="ngSegPreV2" style="white-space:pre-wrap;margin:0;"></pre>';

    document.body.appendChild(box);

    function render(){
      var resp = window.NG_LAST_DIGIPACK || null;
      var gen = pickGenerated(resp) || (resp && pickGenerated(resp.generated)) || null;
      var pre = document.getElementById("ngSegPreV2");
      if (pre) pre.textContent = formatSegments(gen);
    }

    btn.onclick = function(){
      box.style.display = (box.style.display === "none") ? "block" : "none";
      if (box.style.display === "block") render();
    };
    document.getElementById("ngSegCloseV2").onclick = function(){ box.style.display = "none"; };
    document.getElementById("ngSegCopyV2").onclick = function(){
      try { navigator.clipboard.writeText(document.getElementById("ngSegPreV2").textContent || ""); } catch(e){}
    };

    var lastTs = null;
    setInterval(function(){
      var ts = window.NG_LAST_DIGIPACK_TS || null;
      if (ts && ts !== lastTs){
        lastTs = ts;
        if (box.style.display === "block") render();
      }
    }, 400);
  }

  // ---- LIBRARY: override Download TXT + Preview to segmented text ----
  function findSelectedIndex(){
    var sel =
      document.querySelector('[data-draft-index].selected') ||
      document.querySelector('[data-draft-idx].selected') ||
      document.querySelector('.draft-row.selected') ||
      document.querySelector('.draft-row.active') ||
      document.querySelector('[aria-selected="true"][data-draft-index]') ||
      document.querySelector('[aria-selected="true"][data-draft-idx]') ||
      document.querySelector('input[type="radio"][name*="draft"]:checked') ||
      null;

    if (!sel) return null;

    var v = null;
    if (sel.getAttribute) v = sel.getAttribute("data-draft-index") || sel.getAttribute("data-draft-idx");
    if (v == null && sel.value != null) v = sel.value;

    var n = parseInt(v,10);
    return isNaN(n) ? null : n;
  }

  function getDraft(){
    var drafts = lsGet("NG_DRAFTS", []);
    if (!drafts.length) return {drafts:drafts, idx:null, draft:null};
    var idx = findSelectedIndex();
    if (idx==null || idx<0 || idx>=drafts.length) idx = drafts.length-1;
    return {drafts:drafts, idx:idx, draft:drafts[idx]};
  }

  function overrideLibraryButtons(){
    var btnTxt  = document.getElementById("ng-lib-dl-txt");
    var btnPrev = document.getElementById("ng-lib-preview");
    var btnJson = document.getElementById("ng-lib-dl-json");
    if (!btnTxt || !btnPrev || !btnJson) return false;

    btnTxt.onclick = function(){
      var g = getDraft();
      if (!g.draft) return alert("No drafts found");
      var gen = extractGeneratedFromDraft(g.draft);
      var txt = formatSegments(gen);
      var story = g.draft.story || {};
      var headline = trim((gen && gen.headline) || story.headline || g.draft.headline || story.title || g.draft.title || "");
      downloadFile("NG_" + slug(headline) + "_DIGIPACK.txt", txt, "text/plain;charset=utf-8");
    };

    btnPrev.onclick = function(){
      var g = getDraft();
      if (!g.draft) return alert("No drafts found");
      var pre = document.getElementById("ng-lib-pre");
      if (!pre) return;
      pre.style.display = (pre.style.display === "none") ? "block" : "none";
      if (pre.style.display === "block"){
        var gen = extractGeneratedFromDraft(g.draft);
        pre.textContent = formatSegments(gen);
      }
    };

    // JSON stays JSON (no change)
    // btnJson remains whatever your library UI sets; we don't touch it.

    console.log("[NG_SEGMENTED_V2] Library TXT/Preview overridden");
    return true;
  }

  // init
  ensureDrawer();

  var tries = 0;
  var t = setInterval(function(){
    tries++;
    if (overrideLibraryButtons() || tries > 80) clearInterval(t);
  }, 300);

  console.log("[NG_SEGMENTED_V2] ready");
})();
</script>
<!-- /NG_PATCH: SEGMENTED_V2 -->


<!-- NG_PATCH: FORCE_DLTEXT_V2 -->
<script>
(function(){
  try {
    if (typeof window.__NG_FORCE_DLTEXT_HITS !== "number") window.__NG_FORCE_DLTEXT_HITS = 0;
  } catch(e) {}

(function(){
  if (window.__NG_FORCE_DLTEXT_V2) return;
  window.__NG_FORCE_DLTEXT_V2 = true;
  window.__NG_FORCE_DLTEXT_HITS = 0;

  function S(v){ return (v==null) ? "" : String(v); }
  function T(s){ return S(s).replace(/^\s+|\s+$/g,""); }
  function A(a){ return Array.isArray(a) ? a : []; }
  function slug(s){
    s = T(s).toLowerCase().replace(/[^a-z0-9\u0900-\u097f]+/g,"_").replace(/^_+|_+$/g,"");
    return s || "story";
  }

  function lsGet(key, fb){
    try { var raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fb; }
    catch(e){ return fb; }
  }

  function closestBtn(node){
    while(node && node !== document){
      var tn = (node.tagName || "").toUpperCase();
      if (tn === "BUTTON" || tn === "A") return node;
      node = node.parentNode;
    }
    return null;
  }

  function pickGenerated(obj){
    if (!obj) return null;
    if (obj.generated && (obj.generated.headline || obj.generated.web_article_500_600 || obj.generated.vo_lines)) return obj.generated;
    if (obj.headline || obj.web_article_500_600 || obj.vo_lines || obj.shot_plan) return obj;
    return null;
  }

  function extractGeneratedFromDraft(draft){
    var story = (draft && draft.story) ? draft.story : {};
    var dp = story.digipack || {};
    var blocks = dp.blocks || null;

    var g = pickGenerated(blocks) || (blocks && pickGenerated(blocks.generated)) || null;
    if (g) return g;

    var raw = S(dp.raw || story.full_digipack || "");
    if (raw) {
      try {
        var parsed = JSON.parse(raw);
        g = pickGenerated(parsed) || (parsed && pickGenerated(parsed.generated)) || null;
        if (g) return g;
      } catch(e) {}
    }
    return null;
  }

  function formatSegments(gen){
    if (!gen) return "(No generated pack found. Generate then Save Draft.)";
    var out = [];
    out.push("DIGIPACK (SEGMENTS)");
    out.push("--------------------------------");
    if (gen.headline) out.push("HEADLINE: " + T(gen.headline));
    if (gen.dek) out.push("DEK: " + T(gen.dek));

    var bp = A(gen.bullet_points).map(T).filter(Boolean);
    if (bp.length){
      out.push(""); out.push("KEY POINTS"); out.push("--------------------------------");
      for (var i=0;i<bp.length;i++) out.push("- " + bp[i]);
    }

    if (gen.web_article_500_600){
      out.push(""); out.push("WEB ARTICLE (500â€“600)"); out.push("--------------------------------");
      out.push(T(gen.web_article_500_600));
    }

    out.push(""); out.push("VIDEO"); out.push("--------------------------------");
    if (gen.video_hook) out.push("HOOK: " + T(gen.video_hook));

    var vo = A(gen.vo_lines).map(T).filter(Boolean);
    if (vo.length){
      out.push(""); out.push("VO LINES");
      for (var j=0;j<vo.length;j++) out.push("â€¢ " + vo[j]);
    }

    var sp = A(gen.shot_plan);
    if (sp.length){
      out.push(""); out.push("SHOT PLAN");
      for (var k=0;k<sp.length;k++){
        var s = sp[k] || {};
        out.push((k+1)+". "+T(s.shot_type||"")+(s.what_to_show?(" | "+T(s.what_to_show)):"")+(s.notes?(" | "+T(s.notes)):""));
      }
    }

    out.push(""); out.push("SOCIAL"); out.push("--------------------------------");
    if (gen.social_caption) out.push("CAPTION: " + T(gen.social_caption));
    if (gen.social_script_20_30) out.push("SCRIPT (20â€“30s): " + T(gen.social_script_20_30));
    var ht = A(gen.hashtags).map(T).filter(Boolean);
    if (ht.length) out.push("HASHTAGS: " + ht.join(" "));

    out.push(""); out.push("YOUTUBE (AUTO)"); out.push("--------------------------------");
    var ytTitle = T(gen.video_hook || gen.headline || "");
    var ytDesc  = T(gen.web_article_500_600 || "");
    if (ytDesc.length > 600) ytDesc = ytDesc.slice(0,600) + "...";
    var ytTags = ht.length ? ht.map(function(x){ return T(x).replace(/^#/,""); }).filter(Boolean).join(", ") : "";
    out.push("TITLE: " + ytTitle);
    if (ytDesc) out.push("DESCRIPTION: " + ytDesc);
    if (ytTags) out.push("TAGS: " + ytTags);

    return out.join("\n").replace(/\\n/g,"\n");
  }

  function getDraft(){
    var drafts = lsGet("NG_DRAFTS", []);
    if (!drafts.length) return {drafts:drafts, idx:null, draft:null};

    // best effort: selected row, else last
    var idx = null;
    var sel = document.querySelector('[data-draft-index].selected') ||
              document.querySelector('[data-draft-idx].selected') ||
              document.querySelector('[aria-selected="true"][data-draft-index]') ||
              document.querySelector('[aria-selected="true"][data-draft-idx]');
    if (sel && sel.getAttribute){
      var v = sel.getAttribute("data-draft-index") || sel.getAttribute("data-draft-idx");
      var n = parseInt(v,10);
      if (!isNaN(n)) idx = n;
    }
    if (idx==null || idx<0 || idx>=drafts.length) idx = drafts.length-1;

    return {drafts:drafts, idx:idx, draft:drafts[idx]};
  }

  function downloadTxt(){
    var g = getDraft();
    if (!g.draft) return alert("No drafts found");
    var gen = extractGeneratedFromDraft(g.draft);
    var txt = formatSegments(gen);

    var headline = (gen && gen.headline) ? T(gen.headline) : "story";
    var fname = "SEGMENTED__" + Date.now() + "__" + slug(headline) + ".txt";

    var blob = new Blob([txt], {type:"text/plain;charset=utf-8"});
    var url = URL.createObjectURL(blob);
    var a = document.createElement("a");
    a.href = url; a.download = fname;
    document.body.appendChild(a); a.click();
    setTimeout(function(){
      try{ URL.revokeObjectURL(url); }catch(e){}
      try{ document.body.removeChild(a); }catch(e2){}
    }, 200);

    console.log("[FORCE_DLTEXT_V2] downloaded", {fname: fname, idx: g.idx, headline: headline});
  }

  // âœ… WINDOW capture: cannot be blocked by document capture handlers
  window.addEventListener("click", function(e){
    var btn = closestBtn(e && e.target);
    if (!btn) return;

    var id = btn.id || "";
    var txt = T(btn.textContent || "").toLowerCase();

    var hasBar = !!document.getElementById("ng-lib-bar");
    var inBar = hasBar && (function(){
      var n = btn;
      while(n && n !== document){
        if (n.id === "ng-lib-bar") return true;
        n = n.parentNode;
      }
      return false;
    })();

    if (id === "ng-lib-dl-txt" || (inBar && txt === "download txt")) {
      window.__NG_FORCE_DLTEXT_HITS++;
      e.preventDefault();
      e.stopPropagation();
      if (e.stopImmediatePropagation) e.stopImmediatePropagation();
      downloadTxt();
    }
  }, true);

  console.log("[FORCE_DLTEXT_V2] installed OK");
})();

})();
</script>
<!-- /NG_PATCH: FORCE_DLTEXT_V2 -->







<!-- NG_PATCH: STORY_VIEW_V8 -->
<style>
  #ng-sv8-modal{display:none; position:fixed; inset:0; z-index:999999; background:rgba(0,0,0,.55);}
  #ng-sv8-card{background:#fff; width:min(1180px,96vw); height:min(92vh,96vh); margin:3vh auto; border-radius:14px; overflow:hidden;
    box-shadow:0 18px 60px rgba(0,0,0,.25); display:flex; flex-direction:column; font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial;}
  #ng-sv8-top{display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid #eee; background:#fafafa; gap:10px;}
  #ng-sv8-top strong{font-size:14px;}
  #ng-sv8-top .btn{padding:7px 10px; border:1px solid #ddd; border-radius:10px; background:#fff; font:600 12px/1 system-ui; cursor:pointer;}
  #ng-sv8-top .pill{padding:6px 10px; border:1px solid #ddd; border-radius:999px; background:#fff; font:600 11px/1 system-ui; color:#333;
    max-width:52vw; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
  #ng-sv8-body{padding:12px; overflow:auto;}
  .ng-sv8-seg{border:1px solid #eee; border-radius:12px; margin:10px 0; overflow:hidden;}
  .ng-sv8-seg h3{margin:0; padding:10px 12px; font-size:13px; background:#f6f6f6; border-bottom:1px solid #eee;}
  .ng-sv8-grid{display:grid; grid-template-columns:1fr; gap:10px; padding:10px 12px;}
  .ng-sv8-box{border:1px solid #eee; border-radius:12px; padding:10px; background:#fff;}
  .ng-sv8-box h4{margin:0 0 8px 0; font-size:12px; text-transform:uppercase; color:#444; display:flex; justify-content:space-between; align-items:center; gap:10px;}
  .ng-sv8-copy{padding:6px 8px; border:1px solid #ddd; border-radius:10px; background:#fff; cursor:pointer; font:600 11px/1 system-ui;}
  .ng-sv8-pre{white-space:pre-wrap; margin:0; font-family:ui-monospace, Menlo, Consolas, monospace; font-size:12px; line-height:1.35;}
  .ng-sv8-ul{margin:0; padding-left:18px;}
  .ng-sv8-ul li{margin:2px 0;}
  .ng-sv8-muted{color:#666; font-size:12px;}
  .ng-sv8-row{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
</style>

<div id="ng-sv8-modal">
  <div id="ng-sv8-card">
    <div id="ng-sv8-top">
      <div>
        <strong>Story View</strong>
        <div class="ng-sv8-muted" id="ng-sv8-status">V8 (Hook resp_* auto-drop)</div>
      </div>
      <div class="ng-sv8-row">
        <span class="pill" id="ng-sv8-source">Source: auto</span>
        <button class="btn" id="ng-sv8-refresh" type="button">Refresh</button>
        <button class="btn" id="ng-sv8-close" type="button">Close</button>
      </div>
    </div>
    <div id="ng-sv8-body"></div>
  </div>
</div>

<script>
(function(){
  if (window.__NG_STORY_VIEW_V8) return;
  window.__NG_STORY_VIEW_V8 = true;

  function qs(sel, root){ return (root||document).querySelector(sel); }
  function qsa(sel, root){ return Array.prototype.slice.call((root||document).querySelectorAll(sel)||[]); }
  function safe(s){ return (s==null) ? "" : String(s); }

  function deescapeMaybe(t){
    t = safe(t);
    if (t.indexOf("\\n") === -1) return t;
    var esc = (t.match(/\\n/g) || []).length;
    var real = (t.match(/\n/g) || []).length;
    if (esc >= 5 || real <= 1){
      return t.replace(/\\r\\n/g,"\n").replace(/\\n/g,"\n").replace(/\\t/g,"\t");
    }
    return t;
  }
  function norm(t){
    t = deescapeMaybe(t);
    return safe(t).replace(/\r\n/g,"\n").replace(/\r/g,"\n").trim();
  }

  function copyText(txt){
    txt = safe(txt);
    try{
      if (navigator && navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(txt).catch(function(){});
        return true;
      }
    }catch(e){}
    try{
      var ta=document.createElement("textarea");
      ta.value=txt; ta.style.position="fixed"; ta.style.left="-9999px";
      document.body.appendChild(ta); ta.select(); document.execCommand("copy");
      document.body.removeChild(ta); return true;
    }catch(e){}
    return false;
  }

  // Hide Preview Prompt section (clutter)
  (function hidePreviewPrompt(){
    try{
      var all=qsa("label,div,h3,h4,strong,span");
      for (var i=0;i<all.length;i++){
        var el=all[i], tx=safe(el && el.textContent ? el.textContent : "");
        if (tx.indexOf("Preview Prompt")!==-1){
          var p=el;
          for (var k=0;k<7;k++){
            if (!p || !p.parentElement) break;
            p=p.parentElement;
            if (p && p.tagName==="DIV" && safe(p.innerText||"").indexOf("Preview Prompt")!==-1){
              p.style.display="none"; return;
            }
          }
        }
      }
    }catch(e){}
  })();

  function isPlaceholder(t){
    t=safe(t);
    return (t.indexOf("No generated pack found")!==-1) || (t.indexOf("Generate then Save Draft")!==-1);
  }
  function isSeparatorLine(line){
    line = safe(line).trim();
    if (!line) return true;
    return (line.replace(/[-\s]/g,"") === "");
  }
  function cleanBlock(block){
    block = norm(block);
    if (!block) return "";
    var lines = block.split("\n");
    var out = [];
    var blank = 0;
    for (var i=0;i<lines.length;i++){
      var l = lines[i];
      if (isSeparatorLine(l)) { blank++; continue; }
      l = l.replace(/\s+$/,"");
      if (!l.trim()){
        blank++;
        if (blank<=1) out.push("");
        continue;
      }
      blank=0;
      out.push(l);
    }
    while(out.length && !out[0].trim()) out.shift();
    while(out.length && !out[out.length-1].trim()) out.pop();
    return out.join("\n").trim();
  }

  // âœ… Hook filter: resp_* is NOT a real hook
  function isBadHook(h){
    h = safe(h).trim();
    if (!h) return true;
    if (/^resp_[a-z0-9]{12,}$/i.test(h)) return true;
    if (/^resp-[a-z0-9]{12,}$/i.test(h)) return true;
    return false;
  }

  function firstSentenceNoHashtag(txt){
    txt = cleanBlock(txt);
    if (!txt) return "";
    // remove hashtags
    txt = txt.replace(/#\S+/g,"").replace(/\s{2,}/g," ").trim();
    if (!txt) return "";
    // take first sentence-ish
    var m = txt.match(/(.{1,120}?)([à¥¤.!?]|$)/);
    return m ? m[1].trim() : txt.slice(0,120).trim();
  }

  function extractHookAndCleanVideo(videoBlock){
    var v = norm(videoBlock);
    var hook = "";
    var lines = v.split("\n");
    var out = [];
    for (var i=0;i<lines.length;i++){
      var l = lines[i].trim();
      if (!l) continue;
      if (/^HOOK\s*:/i.test(l)){
        var h = l.replace(/^HOOK\s*:\s*/i,"").trim();
        if (!hook && h) hook = h;
        continue; // drop all HOOK lines from video body
      }
      if (isSeparatorLine(l)) continue;
      out.push(lines[i]);
    }
    var cleaned = cleanBlock(out.join("\n"));

    // âœ… If hook is resp_* etc, drop and auto-build from video
    if (isBadHook(hook)){
      hook = "";
      var auto = firstSentenceNoHashtag(cleaned);
      if (auto) hook = auto;
    }
    return { video: cleaned, hook: hook };
  }

  function parseBlocksFromText(txt){
    txt=norm(txt);

    function after(prefix){
      var i=txt.indexOf(prefix); if(i===-1) return "";
      return (txt.slice(i+prefix.length).split("\n")[0]||"").trim();
    }
    function between(start, nextArr){
      var i=txt.indexOf(start); if(i===-1) return "";
      var rest=txt.slice(i+start.length), cut=rest.length;
      for (var k=0;k<nextArr.length;k++){
        var j=rest.indexOf(nextArr[k]); if(j!==-1 && j<cut) cut=j;
      }
      return rest.slice(0,cut).trim();
    }
    function keypoints(block){
      block = norm(block);
      var lines = block.split("\n");
      var out=[];
      for (var i=0;i<lines.length;i++){
        var l = lines[i].trim();
        if (!l) continue;
        if (isSeparatorLine(l)) continue;
        l = l.replace(/^(\s*-\s*)+/, "");
        l = l.replace(/^[â€¢\u2022]\s*/,"").trim();
        if (!l) continue;
        if (isSeparatorLine(l)) continue;
        out.push(l);
      }
      out = out.filter(function(x){ return x && x.replace(/[-\s]/g,"")!==""; });
      return out;
    }

    var kpB = between("KEY POINTS",["WEB ARTICLE","VIDEO","SOCIAL","BYTES","FULL DIGIPACK"]);
    var wa  = between("WEB ARTICLE",["VIDEO","SOCIAL","BYTES","FULL DIGIPACK"]);
    var vd  = between("VIDEO",["SOCIAL","BYTES","FULL DIGIPACK"]);

    var webClean = cleanBlock(wa);
    var vidObj = extractHookAndCleanVideo(vd);

    var hook2 = after("HOOK:");
    if (isBadHook(vidObj.hook) && !isBadHook(hook2)) vidObj.hook = hook2;
    if (isBadHook(vidObj.hook)) vidObj.hook = "";

    return {
      headline: after("HEADLINE:"),
      dek: after("DEK:"),
      keypoints: kpB ? keypoints(kpB) : [],
      web: webClean,
      video: vidObj.video,
      hook: vidObj.hook
    };
  }

  function normalizeInput(raw){
    var t = safe(raw).trim();
    if (!t || isPlaceholder(t)) return {sec:{}};

    // JSON -> try minimal direct fields; else treat as text (already saved NG_LAST_PACK_TEXT in earlier versions)
    if (t[0]==="{" || t[0]==="["){
      try{
        var obj = JSON.parse(t);
        if (Array.isArray(obj) && obj.length) obj = obj[obj.length-1];
        // If JSON contains a pack-like string anywhere, stringify will still work with parser heuristics.
        return {sec: parseBlocksFromText(JSON.stringify(obj))};
      }catch(e){}
    }
    return {sec: parseBlocksFromText(t)};
  }

  function pickFromLocalStorage(){
    var keys = ["NG_LAST_PACK_TEXT","NG_LAST_DIGIPACK","NG_LAST_PACK","NG_DRAFTS","drafts","NG_LIBRARY","ng_library"];
    for (var i=0;i<keys.length;i++){
      try{
        var v = localStorage.getItem(keys[i]);
        if (v && !isPlaceholder(v) && v.length>40) return {text:v, source:"localStorage:"+keys[i]};
      }catch(e){}
    }
    try{
      var best=null, bestLen=0, bestK="";
      for (var j=0;j<localStorage.length;j++){
        var k=localStorage.key(j);
        if (!k || !/digipack|pack|draft|library/i.test(k)) continue;
        var vv=localStorage.getItem(k);
        if (vv && !isPlaceholder(vv) && vv.length>bestLen){ best=vv; bestLen=vv.length; bestK=k; }
      }
      if (best) return {text:best, source:"localStorage:scan:"+bestK};
    }catch(e){}
    return null;
  }

  function pickFromDOM(){
    var nodes=qsa("textarea").concat(qsa("pre")).concat(qsa("code"));
    var best=null, bestLen=0;
    for (var i=0;i<nodes.length;i++){
      var n=nodes[i];
      var t=(n && n.tagName==="TEXTAREA") ? safe(n.value) : safe(n && n.textContent ? n.textContent : "");
      if (!t || isPlaceholder(t)) continue;
      if (t.length>bestLen){ best=t; bestLen=t.length; }
    }
    if (best) return {text:best, source:"DOM:best"};
    return null;
  }

  function box(title, content, asList){
    var wrap=document.createElement("div"); wrap.className="ng-sv8-box";
    var h=document.createElement("h4");
    var l=document.createElement("span"); l.textContent=title;
    var b=document.createElement("button"); b.className="ng-sv8-copy"; b.type="button"; b.textContent="Copy";
    b.addEventListener("click", function(){
      var txt = asList ? (content||[]).join("\n") : safe(content);
      copyText(txt);
      b.textContent="Copied"; setTimeout(function(){ b.textContent="Copy"; }, 600);
    }, false);
    h.appendChild(l); h.appendChild(b); wrap.appendChild(h);

    if (asList){
      var ul=document.createElement("ul"); ul.className="ng-sv8-ul";
      for (var i=0;i<(content||[]).length;i++){ var li=document.createElement("li"); li.textContent=content[i]; ul.appendChild(li); }
      wrap.appendChild(ul);
    } else {
      var pre=document.createElement("pre"); pre.className="ng-sv8-pre"; pre.textContent=safe(content||""); wrap.appendChild(pre);
    }
    return wrap;
  }

  function render(rawText, src){
    var body=qs("#ng-sv8-body"); if(!body) return;
    body.innerHTML="";

    var r = normalizeInput(rawText||"");
    var s = r.sec || {};

    var card=document.createElement("div"); card.className="ng-sv8-seg";
    var h3=document.createElement("h3"); h3.textContent="STORY"; card.appendChild(h3);

    var grid=document.createElement("div"); grid.className="ng-sv8-grid";
    grid.appendChild(box("Headline", s.headline||"", false));
    grid.appendChild(box("Dek", s.dek||"", false));
    grid.appendChild(box("Key Points", s.keypoints||[], true));
    grid.appendChild(box("Web Article", s.web||"", false));
    grid.appendChild(box("Video", s.video||"", false));
    if (s.hook) grid.appendChild(box("Hook", s.hook, false)); // only if meaningful

    card.appendChild(grid);
    body.appendChild(card);

    qs("#ng-sv8-source").textContent = "Source: " + (src||"auto");
    qs("#ng-sv8-status").textContent = "Updated @ " + new Date().toLocaleTimeString() + " (V8 hook fixed)";
  }

  function openModal(){ var m=qs("#ng-sv8-modal"); if(m) m.style.display="block"; }
  function closeModal(){ var m=qs("#ng-sv8-modal"); if(m) m.style.display="none"; }

  function refresh(){
    var picked = pickFromLocalStorage() || pickFromDOM() || {text:"", source:"none"};
    render(picked.text||"", picked.source||"none");
  }

  qs("#ng-sv8-close") && qs("#ng-sv8-close").addEventListener("click", closeModal, false);
  qs("#ng-sv8-refresh") && qs("#ng-sv8-refresh").addEventListener("click", refresh, false);

  var modal=qs("#ng-sv8-modal");
  modal && modal.addEventListener("click", function(e){ if(e && e.target===modal) closeModal(); }, false);

  document.addEventListener("click", function(e){
    var t=e && e.target ? e.target : null;
    if(!t) return;
    var el=t;
    for (var i=0;i<5;i++){
      if(!el) break;
      var tx=safe(el.textContent||el.value||"").trim();
      if (tx==="SEGMENTS"){
        try{ e.preventDefault(); }catch(_){}
        try{ e.stopPropagation(); }catch(_){}
        try{ e.stopImmediatePropagation(); }catch(_){}
        openModal(); refresh(); return;
      }
      el=el.parentElement;
    }
  }, true);

  console.log("[STORY_VIEW_V8] ready");
})();
</script>
<!-- /NG_PATCH: STORY_VIEW_V8 -->

<script>
(function(){
  if (window.__NG_STORYVIEW_V9_INSTALLED) return;
  window.__NG_STORYVIEW_V9_INSTALLED = true;

  // 1) Capture /api/digi-pack response + request into localStorage
  var _fetch = window.fetch;
  if (typeof _fetch === "function") {
    window.fetch = function(input, init){
      var url = "";
      try { url = (typeof input === "string") ? input : (input && input.url) ? input.url : ""; } catch(e) {}
      var isDP = url && (url.indexOf("/api/digi-pack") !== -1);
      var reqBody = null;
      try { reqBody = init && init.body ? String(init.body) : null; } catch(e) {}

      return _fetch.apply(this, arguments).then(function(res){
        if (isDP) {
          try {
            var clone = res.clone();
            clone.json().then(function(j){
              try { localStorage.setItem("NG_LAST_DIGIPACK_RESP_V3", JSON.stringify(j)); } catch(e) {}
              if (reqBody) { try { localStorage.setItem("NG_LAST_DIGIPACK_REQ_V3", reqBody); } catch(e) {} }
            }).catch(function(){});
          } catch(e) {}
        }
        return res;
      });
    };
  }

  function normalizeHeadings(s){
    s = String(s || "");
    s = s.replace(/^\s*###\s+WEB_ARTICLE\s*$/gm, "### WEB_ARTICLE");
    s = s.replace(/^\s*###\s+VIDEO\s*$/gm, "### VIDEO");
    s = s.replace(/^\s*###\s+YOUTUBE\s*$/gm, "### YOUTUBE");
s = s.replace(/^\s*###\s+YOUTUBE\s+DESCRIPTION\s*$/gm, "### YOUTUBE");

    s = s.replace(/^\s*###\s+SOCIAL\s*$/gm, "### SOCIAL");
// âœ… Quick View heading normalization (robust)
s = s.replace(/^\s*###\s+QUICK\s+VIEW\s*$/gmi, "### QUICK_VIEW");
s = s.replace(/^\s*##\s+QUICK\s+VIEW\s*$/gmi,  "### QUICK_VIEW");
s = s.replace(/^\s*###\s+QUICKVIEW\s*$/gmi,     "### QUICK_VIEW");

    return s;
  }

  function section(all, head){
    all = normalizeHeadings(all);
var headRe = String(head || "").trim().replace(/[-\/\\^$*+?.()|[\]{}]/g, "\\$&").replace(/[_\s]+/g, "[_\\s]+");

    var re = new RegExp("^\\s*###\\s+" + headRe + "\\s*\\n([\\s\\S]*?)(?=^\\s*###\\s+|(?![\\s\\S]))", "m");

    var m = all.match(re);
    return m ? String(m[1]).trim() : "";
  }

  function getLastResp(){
    try { return JSON.parse(localStorage.getItem("NG_LAST_DIGIPACK_RESP_V3") || "null"); } catch(e) { return null; }
  }
  function getLastReqTopic(){
    try {
      var raw = localStorage.getItem("NG_LAST_DIGIPACK_REQ_V3") || "";
      var j = JSON.parse(raw);
      var p = j && j.prompt ? String(j.prompt) : "";
      // p is itself JSON string
      var k = JSON.parse(p);
      return (k && (k.topic || k.headline || k.title)) ? String(k.topic || k.headline || k.title) : "";
    } catch(e) { return ""; }
  }

  // 2) UI: Floating button + overlay
  function el(tag, attrs){
    var e = document.createElement(tag);
    if (attrs) {
      for (var k in attrs) {
        if (!attrs.hasOwnProperty(k)) continue;
        if (k === "style") e.style.cssText = attrs[k];
        else if (k === "text") e.textContent = attrs[k];
        else e.setAttribute(k, attrs[k]);
      }
    }
    return e;
  }

  var btn = el("button", {
    id: "btn-storyview-v9",
    text: "Story View V9",
    style: "position:fixed;right:16px;bottom:16px;z-index:99999;padding:10px 12px;border:1px solid #333;border-radius:10px;background:#111;color:#fff;cursor:pointer;font:14px/1.2 system-ui;"
  });

  var overlay = el("div", {
    id: "ng-storyview-v9-overlay",
    style: "display:none;position:fixed;inset:0;z-index:99998;background:rgba(0,0,0,0.72);"
  });

  var panel = el("div", {
    style: "position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:min(1100px,92vw);height:min(92vh,860px);background:#fff;border-radius:14px;overflow:hidden;display:flex;flex-direction:column;"
  });

  var header = el("div", { style: "padding:10px 12px;background:#0f172a;color:#fff;display:flex;align-items:center;gap:10px;" });
  var title = el("div", { text: "Story View V9 (Text Fields)", style: "font-weight:700;" });
  var hint  = el("div", { text: "Raw hidden by default â€¢ Pulls last /api/digi-pack response automatically", style: "opacity:.85;font-size:12px;margin-left:8px;" });
  var close = el("button", { text: "Close", style: "margin-left:auto;padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.4);background:transparent;color:#fff;cursor:pointer;" });

  header.appendChild(title); header.appendChild(hint); header.appendChild(close);

  var body = el("div", { style: "padding:12px;overflow:auto;display:grid;grid-template-columns:1fr 1fr;gap:12px;" });

  function block(label){
    var wrap = el("div", { style: "display:flex;flex-direction:column;gap:6px;" });
    var lab  = el("div", { text: label, style: "font-weight:700;font-size:13px;" });
    var ta   = el("textarea", { style: "width:100%;min-height:160px;resize:vertical;padding:10px;border:1px solid #cbd5e1;border-radius:10px;font:13px/1.35 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;" });
    wrap.appendChild(lab); wrap.appendChild(ta);
    return { wrap: wrap, ta: ta };
  }

  var qh = block("QUICK VIEW â€¢ HEADLINE");
  qh.ta.style.minHeight = "70px";
  var qb = block("QUICK VIEW â€¢ BULLETS (2â€“4)");
  qb.ta.style.minHeight = "110px";

  var wa = block("WEB_ARTICLE (500â€“600 words)");
  var vd = block("VIDEO (HOOK + 8â€“12 lines)");
  var yt = block("YOUTUBE (Title/Desc/Tags/Hashtags)");
  var so = block("SOCIAL (X/IG/FB/WA)");

  var raw = block("RAW OUTPUT (hidden by default)");
  raw.ta.style.minHeight = "140px";

  var toggleRaw = el("button", {
    text: "Show Raw",
    style: "padding:8px 10px;border-radius:10px;border:1px solid #cbd5e1;background:#f8fafc;cursor:pointer;width:max-content;"
  });
  raw.wrap.insertBefore(toggleRaw, raw.wrap.children[1]);
  raw.ta.style.display = "none";

  toggleRaw.addEventListener("click", function(){
    var on = (raw.ta.style.display !== "none");
    raw.ta.style.display = on ? "none" : "block";
    toggleRaw.textContent = on ? "Show Raw" : "Hide Raw";
  });

  body.appendChild(qh.wrap);
  body.appendChild(qb.wrap);
  body.appendChild(wa.wrap);
  body.appendChild(vd.wrap);
  body.appendChild(yt.wrap);
  body.appendChild(so.wrap);
  body.appendChild(raw.wrap);

  panel.appendChild(header);
  panel.appendChild(body);
  overlay.appendChild(panel);

  function fillFromLast(){
    var resp = getLastResp();
    var topic = getLastReqTopic();

    var txt = resp && resp.generated_text ? String(resp.generated_text) : "";
    txt = normalizeHeadings(txt);

    var web = section(txt, "WEB_ARTICLE");
    var vid = section(txt, "VIDEO");
    var ytb = section(txt, "YOUTUBE");
    var soc = section(txt, "SOCIAL");

    // Quick view heuristics
    var headline = topic || (web ? web.split("\n")[0].trim() : "");
    if (headline && headline.length > 110) headline = headline.slice(0, 110) + "â€¦";

    var bullets = "";
    if (vid) {
      var lines = vid.split("\n").map(function(s){ return s.trim(); }).filter(Boolean);
      var picks = [];
      for (var i=0;i<lines.length;i++){
        if (/^(\(?\d+\)?[.)])\s+/.test(lines[i])) picks.push(lines[i].replace(/^(\(?\d+\)?[.)])\s+/, ""));
        if (picks.length >= 4) break;
      }
      bullets = picks.join("\n");
    }
    if (!bullets && web) {
      var s1 = web.split("à¥¤");
      bullets = (s1.slice(0,4).join("à¥¤") + (s1.length>4 ? "à¥¤" : "")).replace(/\n+/g," ").trim();
    }

    qh.ta.value = headline || "";
    qb.ta.value = bullets || "";

    wa.ta.value = web || "";
    vd.ta.value = vid || "";
    yt.ta.value = ytb || "";
    so.ta.value = soc || "";
    raw.ta.value = (resp ? JSON.stringify(resp, null, 2) : "");
  }

  btn.addEventListener("click", function(){
    fillFromLast();
    overlay.style.display = "block";
  });
  close.addEventListener("click", function(){ overlay.style.display = "none"; });

  document.addEventListener("keydown", function(e){
    if (e && e.key === "Escape") overlay.style.display = "none";
  });

  document.body.appendChild(btn);
  document.body.appendChild(overlay);
})();
</script>

</body>
</html>








