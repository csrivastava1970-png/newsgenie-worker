



<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NewsGenie Digital Producer</title>
<link rel="icon" href="data:,">
  <!-- NG_STD_UI_TOOLBAR_ROW_V2_START -->

<style>
  /* NG_ADVANCED_PANELS_V1 */
  /* NG_ADV_ONLY_WRAP_V1 */
  html[data-ng-std-ui="simple"] #ng-adv-only{ display:none !important; }
  html[data-ng-std-ui="advanced"] #ng-adv-only{ display:block !important; }
#ng-preview-prompt-panel { display:none !important; }


  html[data-ng-std-ui="simple"] #ng-advanced-panels{ display:none !important; }
  html[data-ng-std-ui="simple"] #ng-byte-draft-box{ display:none !important; }
  html[data-ng-std-ui="advanced"] #ng-advanced-panels{ display:block; }

  /* NG_STD_UI_TOOLBAR_ROW_V2
     Goal: single-row toolbar (actions left, UI toggle right) — CSS-only, hang-free
     Rules: NO DOM moving, NO MutationObserver, only CSS overrides.
  */

  /* 1) Layout: make page a simple grid so toolbar can be a row */
  body{
    display: grid;
    grid-template-columns: 1fr auto;
    grid-auto-rows: auto;
    column-gap: 12px;
    row-gap: 8px;
    align-items: start;
  }

  /* Title full width */
  h2{ grid-column: 1 / -1; grid-row: 1; }


  /* 2) Actions row (left) */
  #ng-dp-actions{
  grid-column: 1 / 2;
  grid-row: 2;

    grid-column: 1 / 2;
    align-self: center;

    display: flex !important;
    flex-wrap: nowrap !important;     /* override inline wrap */
    gap: 8px !important;
    align-items: center !important;

    overflow-x: auto;
    overflow-y: hidden;
    white-space: nowrap;
    -webkit-overflow-scrolling: touch;
    min-width: 0;                    /* allow grid to size correctly */
  }

  body > #ng-dp-actions > button{
    flex: 0 0 auto;
    white-space: nowrap;
  }

  /* Hide horizontal scrollbar but keep scrolling */
  #ng-dp-actions{ scrollbar-width: none; }              /* Firefox */
  #ng-dp-actions::-webkit-scrollbar{ height: 0; }       /* Chrome/Edge */

  /* 3) If toggle is inside some wrapper, flatten that wrapper (CSS-only) */
 /* Flatten wrappers up to 4 levels so toggle becomes a grid item of body */
body *:has(> #ng-std-ui-toggle-root){ display: contents !important; }
body *:has(> * > #ng-std-ui-toggle-root){ display: contents !important; }
body *:has(> * > * > #ng-std-ui-toggle-root){ display: contents !important; }
body *:has(> * > * > * > #ng-std-ui-toggle-root){ display: contents !important; }


  /* Toggle: force normal flow + place it on toolbar row (right) */
  #ng-std-ui-toggle-root,
  #ng-std-ui-toggle-root .ngpill{
    position: static !important;
    inset: auto !important;
    top: auto !important;
    right: auto !important;
    bottom: auto !important;
    left: auto !important;
    transform: none !important;
    z-index: auto !important;
  }

  #ng-std-ui-toggle-root{
  grid-column: 2 / 3;
  grid-row: 2;

    grid-column: 2 / 3;
    align-self: center;
    justify-self: end;

    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    pointer-events: auto !important;

    margin: 10px 0 !important;
    white-space: nowrap !important;
  }

  #ng-std-ui-toggle-root .ngpill{
    display: inline-flex !important;
    align-items: center;
    gap: 6px;
    white-space: nowrap;
  }

  /* 4) Everything else should be full width below toolbar */
  /* default: anything that becomes a grid item spans full width */
body *{ grid-column: 1 / -1; }


  /* 5) Responsive: on narrower screens, drop toggle below + allow actions wrap */
 
<style>
    body { font-family: system-ui, Arial; margin: 16px; }
    .row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
    label { font-size: 12px; opacity: .8; display:block; margin-bottom:4px; }
    input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
    button { padding: 10px 14px; border: 0; border-radius: 10px; cursor: pointer; }
    button.primary { background: #111; color: #fff; }
    button.secondary { background: #eee; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .panel { margin-top: 12px; padding: 12px; border: 1px solid #ddd; border-radius: 12px; }
    pre { white-space: pre-wrap; word-wrap: break-word; margin: 0; }
    .status { font-size: 13px; }
    .muted { font-size:12px; opacity:.75; margin-top:6px; }
#btnBytesJSON { display: none !important; }
/* Force placement: Row-1 Title, Row-2 Toolbar (Actions + Toggle) */
h2{
  grid-column: 1 / -1 !important;
  grid-row: 1 !important;
}

#ng-dp-actions{
  grid-column: 1 / 2 !important;
  grid-row: 2 !important;
}

#ng-std-ui-toggle-root{
  grid-column: 2 / 3 !important;
  grid-row: 2 !important;
  justify-self: end !important;
  align-self: center !important;
}


  </style>
<style>
#ngQuick{ white-space:pre-wrap; overflow:auto; max-height:220px; }

/* NG_STD_UI_SIMPLE_HIDE_BYTES_V1_START */
body:has(#ng-std-ui-toggle-root [data-ng-mode="simple"].active) #bytesWrap {
  display: none !important;
}
body:has(#ng-std-ui-toggle-root [data-ng-mode="advanced"].active) #bytesWrap {
  display: block !important;
}
/* NG_STD_UI_SIMPLE_HIDE_BYTES_V1_END */

</style>
<style id="ng-simple-hide-bytes-v1">
  body:has(#ng-std-ui-toggle-root [data-ng-mode="simple"].active) .panel:has(#ng-sec-bytes){ display:none !important; }
body:has(#ng-std-ui-toggle-root [data-ng-mode="advanced"].active) .panel:has(#ng-sec-bytes){ display:block !important; }

</style>

<style>
/* NG_TOOLBAR_LAYOUT_FIX_V1_START */
/* Layout-only: fixes shifted toolbar buttons without touching JS */
#ng-std-ui-toolbar-row,
#ng-std-ui-toggle-root,
#ng-dp-actions,
.ng-std-ui-toolbar-row,
.ng-toolbar {
  display: flex !important;
  flex-wrap: wrap !important;
  align-items: center !important;
  justify-content: flex-start !important;
  gap: 8px !important;
}

#ng-std-ui-toolbar-row > * ,
#ng-std-ui-toggle-root > * ,
#ng-dp-actions > * {
  margin: 0 !important;
}

#ng-std-ui-toolbar-row button,
#ng-std-ui-toggle-root button,
#ng-dp-actions button {
  position: static !important;
  transform: none !important;
}
/* NG_TOOLBAR_LAYOUT_FIX_V1_END */
</style>
</head>
<!-- NG_MARKER: 2026-01-06_IST_TEST_123 -->


<body>


<h2>NewsGenie Digital Producer</h2>

  <form id="digi-pack-form" onsubmit="return false;">
    <div class="row">
      <div>
        <label>Topic</label>
        <input name="topic" id="topic" placeholder="E.g., संसद प्रदूषण विवाद" required />

      </div>

      <div>
        <label>Platform</label>
        <select name="platform" id="platform">
          <option value="Digital">Digital</option>
          <option value="Both">Both</option>
          <option value="TV">TV</option>
        </select>
      </div>

      <div>
        <label>Angle (optional)</label>
        <input id="angle" name="angle" type="text" placeholder="Angle (optional) — 3–8 words" style="width:100%; padding:8px 10px; border:1px solid #ccc; border-radius:10px;" />
        
      </div>
    </div>

    <!-- STORY BASICS (moved up) -->
      <label>Story Type</label>
      <select name="storyType" id="storyType" required>
        <option value="">Select</option>
        <option value="breaking">Breaking</option>
        <option value="developing">Developing</option>
        <option value="explainer">Explainer</option>
        <option value="debate">Debate</option>
      </select>
    </div>

    <div style="margin-top:10px;">
      <label>What Happened (mandatory)</label>
      <textarea name="whatHappened" id="whatHappened" rows="3" placeholder="2–4 lines में क्या हुआ?" required></textarea>

    </div>

    <div style="margin-top:10px;">
      <label>Sources / References (mandatory)</label>
      <textarea name="sources" id="sources" rows="3" placeholder="Links / documents / official statements" required></textarea>
    </div>

    <div style="margin-top:10px;">
      <label>Background (optional but counts)</label>
      <textarea name="background" id="background" rows="3" placeholder="Context / past events / why it matters"></textarea>
    </div>
    <!-- STORY BASICS END -->

<!-- ========================= -->
<!-- ========================= -->
<!-- Transcript JSON Loader -->
<!-- ========================= -->
<section id="ng-transcript-loader" style="margin-top:12px; padding:12px; border:1px solid #ddd; border-radius:12px;">
  <!-- Compact tools bar -->
  <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
    <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
      <h3 style="margin:0; font-size:14px;">Transcript Tools</h3>
      <button type="button" id="btn-load-transcript-json" class="primary">Load</button>
      <button type="button" id="btn-refresh-latest-transcript" style="padding:8px 10px;border:1px solid #999;border-radius:10px;cursor:pointer;background:#f7f7f7;">Refresh Latest (API)</button>
      <button type="button" id="btn-paste-transcript-json">Paste</button>
      <button type="button" id="btn-import-transcript-json">Import</button>
      <input type="file" id="file-transcript-json" accept=".json,application/json,.txt" style="display:none;">
    </div>

    <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
      <span style="font-size:12px;opacity:.7;">Status:</span>
      <span id="ng-latest-transcript-status" style="font-size:12px;opacity:.85;">(not loaded)</span>
      <span id="transcript-load-hint" style="font-size:12px; opacity:.75;"></span>
    </div>
  </div>

  <!-- Collapsible inbox (keeps UI light) -->
  <details id="ng-transcript-inbox-details" style="margin-top:10px;">
    <summary style="cursor:pointer; user-select:none; font-size:13px; opacity:.85;">Transcript Inbox</summary>

    <div style="margin-top:10px;">
      <div id="ng-transcript-inbox-hint" style="margin-top:8px;font-size:12px;opacity:.75;">Paste Reverie JSON here (display_text or text). Load saves to localStorage.</div>
      <textarea id="ta-transcript-json" rows="8"
        style="width:100%; padding:10px 12px; border:1px solid #ccc; border-radius:12px; line-height:1.35; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px;"
        placeholder="Paste JSON here..."></textarea>

      <div style="display:flex; gap:8px; margin-top:10px; align-items:center; flex-wrap:wrap;">
        <button type="button" id="btn-clear-transcript-json">Clear Saved</button>
      </div>

      <div id="ng-latest-transcript-preview"
        style="display:none;white-space:pre-wrap;max-height:160px;overflow:auto;border:1px dashed #bbb;border-radius:12px;padding:10px;font-size:13px;opacity:.9; margin-top:10px;"></div>
    </div>
  </details>
</section>

<!-- NG_SUPERLIGHT_TRANSCRIPT_TO_BYTES_V1_START -->
<div id="ng-superlight" style="margin-top:12px; display:grid; grid-template-columns: 1fr; gap:10px;">
  <div class="panel" id="ng-sec-transcript-lines">
    <b>Transcript Lines</b>
    <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:8px;">
      <button type="button" id="ng-lines-selectall">Select All</button>
      <button type="button" id="ng-lines-clear">Clear Selection</button>
      <span id="ng-lines-status" style="font-size:12px; opacity:.75;"></span>
    </div>
    <div id="ng-lines-wrap" style="margin-top:10px; display:flex; flex-direction:column; gap:8px; max-height:220px; overflow:auto; border:1px solid #eee; border-radius:12px; padding:10px;"></div>
  </div>

  </div>
</div>
<!-- NG_SUPERLIGHT_TRANSCRIPT_TO_BYTES_V1_END -->

    <div id="ng-adv-only" style="margin-top:10px;">

    <!-- BYTES -->
    <div class="panel" id="bytesWrap" data-ng-sec="bytes">
      <b>Bytes</b>
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-top:8px;flex-wrap:wrap;">
        <div style="font-size:12px;opacity:.75;">Add bytes from selection or paste/type manually.</div>
<script>
</script>
<script>
/* NG_BYTES_WRAP_HEIGHT_FIX_V1_START */
(function(){
  if (window.__NG_BYTES_WRAP_HEIGHT_FIX_V1) return;
  window.__NG_BYTES_WRAP_HEIGHT_FIX_V1 = true;

  function apply(){
    const w = document.querySelector("#bytes-wrap");
    if (!w) return false;
    // undo any accidental "height:0" style
    w.style.height = "auto";
    w.style.minHeight = "1px";
    w.style.overflow = "visible";
    return true;
  }

  if (apply()) return;
  let n=0;
  const t=setInterval(()=>{ n++; if (apply() || n>30) clearInterval(t); }, 200);
})();
 /* NG_BYTES_WRAP_HEIGHT_FIX_V1_END */
</script>
<script>
/* NG_MANUAL_BYTES_UNHIDE_ON_ADD_V1_START */
(function(){
  if (window.__NG_MANUAL_BYTES_UNHIDE_ON_ADD_V1) return;
  window.__NG_MANUAL_BYTES_UNHIDE_ON_ADD_V1 = true;

  function unhide(){
    const m = document.querySelector("#ng-manual-bytes");
    if (m) m.style.display = "block";
  }

  // unhide once on load (safe)
  setTimeout(unhide, 0);

  // and whenever + Add Byte is clicked
  document.addEventListener("click", (e)=>{
    if (e.target && e.target.id === "addByteBtn") setTimeout(unhide, 0);
  }, true);
})();
 /* NG_MANUAL_BYTES_UNHIDE_ON_ADD_V1_END */
</script>
<script>
/* NG_MOVE_ADD_FINAL_BTN_V1_START */
(function(){
  if (window.__NG_MOVE_ADD_FINAL_BTN_V1) return;
  window.__NG_MOVE_ADD_FINAL_BTN_V1 = true;

  function move(){
    const btn = document.querySelector("#ng-add-final");
    const target = document.querySelector("#ng-manual-bytes");
    const wrap = document.querySelector("#bytes-wrap");
    if (!btn || !target || !wrap) return false;

    // ensure manual bytes visible
    target.style.display = "block";

    // create a stable holder below bytes-wrap
    let holder = document.querySelector("#ng-add-final-holder");
    if (!holder){
      holder = document.createElement("div");
      holder.id = "ng-add-final-holder";
      holder.style.cssText = "margin-top:10px; display:flex; justify-content:flex-end;";
      wrap.insertAdjacentElement("afterend", holder);
    }

    // move only if not already there
    if (!holder.contains(btn)) holder.appendChild(btn);

    // ensure visible sizing
    btn.style.display = "inline-block";
    btn.style.visibility = "visible";
    btn.style.opacity = "1";
    return true;
  }

  if (move()) return;
  let n=0;
  const t=setInterval(()=>{ n++; if (move() || n>30) clearInterval(t); }, 200);
})();
 /* NG_MOVE_ADD_FINAL_BTN_V1_END */
</script>
<script>
</script>
        <button type="button" class="btn" id="addByteBtn">+ Add Byte</button>
      </div>

            <div id="ng-byte-defaults" style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <input
          id="ng-byte-default-speaker"
          type="text"
          placeholder="Default Speaker"
          style="padding:8px 10px; border:1px solid #ccc; border-radius:10px; min-width:220px;"
        >
        <input
          id="ng-byte-default-desig"
          type="text"
          placeholder="Default Designation"
          style="padding:8px 10px; border:1px solid #ccc; border-radius:10px; min-width:260px;"
        >
        <span style="font-size:12px; opacity:.7;">(Auto-fill for new byte rows)</span>
      </div>
<!-- NG_BYTES_UNIFIED_DRAFT_V1_START -->
<div id="ng-byte-draft-area" style="margin-top:10px; display:none;">
  <div id="ng-byte-draft-box" style="margin-top:10px;padding:10px;border:1px dashed #cbd5e1;border-radius:12px;">
    <div style="font-size:12px;opacity:.8;margin-bottom:6px;">Draft Byte (select transcript lines OR paste/type manually)</div>

    <textarea
      id="ng-byte-draft-text"
      rows="4"
      style="width:100%; padding:10px; border:1px solid #ccc; border-radius:10px;"
      placeholder="Selected lines will appear here... (or paste/type)"
    ></textarea>

    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
      <input
        id="ng-byte-draft-speaker"
        type="text"
        placeholder="Speaker (manual)"
        style="padding:8px 10px; border:1px solid #ccc; border-radius:10px; min-width:220px;"
      >
      <input
        id="ng-byte-draft-desig"
        type="text"
        placeholder="Designation (manual)"
        style="padding:8px 10px; border:1px solid #ccc; border-radius:10px; min-width:260px;"
      >
    </div>

    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; align-items:center;">
      <button type="button" id="ng-make-byte" class="secondary">Make Draft from Selection</button>
      <button type="button" id="ng-add-final" class="primary">Add to Bytes</button>
      <button type="button" id="ng-clear-draft">Clear Draft</button>
      <span id="ng-byte-draft-status" style="font-size:12px; opacity:.75;"></span>
    </div>
  </div>
</div>
<!-- NG_BYTES_UNIFIED_DRAFT_V1_END -->


      <!-- hidden JSON sink for Final Bytes module -->
      <textarea id="bytesJSONOut" style="display:none;"></textarea>
      <div id="ng-manual-bytes" style="margin-top:10px; display:none;"><div id="bytes-wrap"></div></div>
    </div>
    <!-- VISUALS -->
    <!-- NG_STD_VISUALS_WRAP_V1_START -->
<div id="visualsWrap" data-ng-sec="visuals">
  <div class="panel" id="step-visuals">
    <b>Visuals</b>
    <div class="muted">B-roll / archive / location visuals (multiple rows)</div>

    <div id="visuals-wrap"></div>

    <div style="margin-top:8px;">
      <button type="button" id="add-visual">+ Add Visual</button>
    </div>
  </div>
</div>
<!-- NG_STD_VISUALS_WRAP_V1_END -->


    <div style="margin-top:10px; display:flex; gap:8px; align-items:center;">
      <button id="btnGenerate" type="button" class="primary" onclick="generateDigiPack(event)" disabled>
        Generate DIGI_PACK
      </button>

      <button type="button" class="secondary" onclick="clearUI()">Clear</button>

      <span id="genStatus" style="font-size:13px; opacity:.8;"></span>
    </div>
  </form>
<!-- Editorial Extraction : Suggestions ONLY -->


<div id="ng-advanced-panels">
  <div class="panel">
    <div class="status"><b>Status:</b> <span id="ngStatus">Idle</span></div>
    <div style="margin-top:8px;"><b>Log</b></div>
    <pre id="ngLog"></pre>
  </div>

  <div class="panel">
    <div><b>Quick View</b></div>
    <div id="ngQuick" style="white-space:pre-wrap; overflow:auto; max-height:220px;">(no quick view)</div>

  </div>

  <div class="panel">
    <div><b>Response</b></div>
    <pre id="ngResponse">(no response yet)</pre>
  </div>
<div class="panel" id="ng-preview-prompt-panel">

  <div style="display:flex;align-items:center;justify-content:space-between;">
    <b>Preview Prompt (will be sent)</b>
    <button type="button" id="copy-prompt"
      style="padding:6px 10px;border-radius:8px;border:1px solid #ccc;background:#fff;cursor:pointer;">
      Copy
    </button>
  </div>

  <textarea id="prompt-preview" readonly
    style="width:100%;min-height:160px;margin-top:8px;padding:10px;
           border:1px solid #ccc;border-radius:10px;
           font-family:ui-monospace,Consolas,monospace;
           font-size:12px;"></textarea>
</div>

</div><!-- /#ng-advanced-panels -->
<script>
/* NG_ANGLE_WIRE_V1_START */
(function(){
  try{
    var el = document.getElementById('angle');
    if(!el) return;

    var key = 'ng_story_angle_v1';

    // restore
    try{
      var saved = localStorage.getItem(key) || '';
      if(saved && !el.value) el.value = saved;
    }catch(e){}

    // persist
    el.addEventListener('input', function(){
      try{ localStorage.setItem(key, el.value || ''); }catch(e){}
    });

    window.NG_getAngle = function(){ return (el && el.value ? String(el.value).trim() : ''); };

    if(typeof window.NG_getStoryMeta === 'function' && !window.NG_getStoryMeta.__ng_angle_wrapped){
      var _orig = window.NG_getStoryMeta;
      var _wrap = function(){
        var o = {};
        try { o = _orig() || {}; } catch(e){ o = {}; }
        o.angle = window.NG_getAngle();
        return o;
      };
      _wrap.__ng_angle_wrapped = true;
      window.NG_getStoryMeta = _wrap;
    } else if(typeof window.NG_getStoryMeta !== 'function'){
      window.NG_getStoryMeta = function(){ return { angle: window.NG_getAngle() }; };
    }
  }catch(e){
    console.warn('NG_ANGLE_WIRE_V1 error', e);
  }
})();
</script>
<!-- NG_ANGLE_WIRE_V1_END -->
</body>
<!-- NG_PATCH_START: AUTORUN_KILL_V1 -->
</html>


<!-- NG_FALLBACKS_CONSOLIDATED_V1_START -->
<script>
/* NG_FALLBACKS_CONSOLIDATED_V1: consolidated + executable (wrapped in script) */
/* NG_ADD_BYTE_FALLBACK_V1_START */
(function(){
  if (window.__NG_ADD_BYTE_FALLBACK_V1) return;
  window.__NG_ADD_BYTE_FALLBACK_V1 = true;

  function escAttr(s){ return String(s??"").replace(/"/g,"&quot;"); }

  function addRow(){
    const wrap = document.querySelector("#bytes-wrap");
    if (!wrap) return;

    const defSp = document.querySelector("#ng-byte-default-speaker")?.value || "";
    const defDe = document.querySelector("#ng-byte-default-desig")?.value || "";

    const row = document.createElement("div");
    row.className = "ng-byte-row";
    row.style.cssText = "display:grid;grid-template-columns:1fr 1fr auto;gap:8px;margin-top:10px;padding:10px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;align-items:start;";

    row.innerHTML = `
      <input class="ng-byte-speaker" placeholder="Speaker" value="${escAttr(defSp)}" style="padding:8px 10px;border:1px solid #e5e7eb;border-radius:10px;">
      <input class="ng-byte-desig" placeholder="Designation" value="${escAttr(defDe)}" style="padding:8px 10px;border:1px solid #e5e7eb;border-radius:10px;">
      <button type="button" class="danger ng-byte-remove" style="padding:8px 12px;border-radius:10px;border:1px solid #ef4444;background:#fff;">Remove</button>
      <textarea class="ng-byte-text" placeholder="Quote / Byte text" rows="3" style="grid-column:1 / -1; padding:10px;border:1px solid #e5e7eb;border-radius:10px;"></textarea>
    `;

    row.querySelector(".ng-byte-remove").addEventListener("click", () => row.remove());
    wrap.appendChild(row);
  }

  // bind once
  function bind(){
    const btn = document.querySelector("#addByteBtn");
    const wrap = document.querySelector("#bytes-wrap");
    if (!btn || !wrap) return false;

    if (!btn.dataset.ngBoundFallback) {
      btn.dataset.ngBoundFallback = "1";
      btn.addEventListener("click", (e) => {
        // If some other handler adds a row, fine. Otherwise ensure at least one row exists.
        setTimeout(() => {
          const any = wrap.querySelector(".ng-byte-row, textarea, input");
          if (!any) addRow();
          else {
            // If handler exists but created nothing, still add row
            const hasRow = wrap.querySelector(".ng-byte-row, textarea.ng-byte-text");
            if (!hasRow) addRow();
          }
        }, 0);
      }, true);
    }
    return true;
  }

  // try now + retry a few times (in case DOM late)
  if (bind()) return;
  let tries = 0;
  const t = setInterval(() => {
    tries++;
    if (bind() || tries > 25) clearInterval(t);
  }, 200);
})();
 /* NG_ADD_BYTE_FALLBACK_V1_END */

/* NG_ADD_FINAL_SYNC_FALLBACK_V1_START */
(function(){
  if (window.__NG_ADD_FINAL_SYNC_FALLBACK_V1) return;
  window.__NG_ADD_FINAL_SYNC_FALLBACK_V1 = true;

  function collectBytes(){
    const wrap = document.querySelector("#bytes-wrap");
    if (!wrap) return [];
    const rows = [...wrap.querySelectorAll(".ng-byte-row")];
    const out = [];
    for (const r of rows){
      const sp = (r.querySelector(".ng-byte-speaker")?.value || "").trim();
      const de = (r.querySelector(".ng-byte-desig")?.value || "").trim();
      const tx = (r.querySelector(".ng-byte-text")?.value || "").trim();
      if (!tx) continue;
      out.push({ speaker: sp, designation: de, text: tx });
    }
    return out;
  }

  async function post(bytes){
    const r = await fetch("/api/bytes/latest",{
      method:"POST",
      headers: {"content-type":"application/json"},
      body: JSON.stringify({ bytes, source:"ui_add_final_fallback_v1", ts:new Date().toISOString() })
    });
    return r.json().catch(()=>null);
  }

  async function syncNow(){
    try{
      const bytes = collectBytes();
      await post(bytes);
    }catch(e){
      console.warn("[NG_ADD_FINAL_SYNC_FALLBACK_V1] sync failed", e);
    }
  }
  window.NG_syncFinalBytesNow = syncNow;

  // Add to Bytes -> sync
  document.addEventListener("click", (e)=>{
    if (e.target && e.target.id === "ng-add-final"){
      // let existing handler run, then ensure backend matches our rows
      setTimeout(syncNow, 0);
    }
    // Remove -> sync
    if (e.target && e.target.classList && e.target.classList.contains("ng-byte-remove")){
      setTimeout(syncNow, 0);
    }
  }, true);
})();
 /* NG_ADD_FINAL_SYNC_FALLBACK_V1_END */
</script>
<!-- NG_FALLBACKS_CONSOLIDATED_V1_END -->

</body>
<script>
/* NG_FINAL_BYTES_UI_POLL_V1_START */
(function () {
  if (window.__NG_FINAL_BYTES_UI_POLL_V1_INSTALLED) return;
  window.__NG_FINAL_BYTES_UI_POLL_V1_INSTALLED = true;

  function esc(s){return String(s??"").replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}

  function ensureHost() {
    let host = document.querySelector("#ng-final-bytes-list-auto");
    if (!host) {
      const TARGET = document.querySelector("#bytesWrap") || document.querySelector("#ng-adv-only") || document.body;
      host = document.createElement("div");
      host.id = "ng-final-bytes-list-auto";
      host.style.cssText = "margin-top:10px;";
      TARGET.appendChild(host);
    }

    let label = document.querySelector("#ng-final-bytes-count-label");
    if (!label) {
      label = document.createElement("div");
      label.id = "ng-final-bytes-count-label";
      label.style.cssText = "font-size:12px;opacity:.85;margin:6px 0 10px 0;display:block;";
      host.insertBefore(label, host.firstChild);
    }

    let cards = document.querySelector("#ng-final-bytes-cards-v1");
    if (!cards) {
      cards = document.createElement("div");
      cards.id = "ng-final-bytes-cards-v1";
      cards.style.cssText = "margin-top:10px; display:flex; flex-direction:column; gap:8px;";
      host.appendChild(cards);
    }
    return { host, label, cards };
  }

  function render(bytes) {
    const ui = ensureHost();
    if (!ui) return;

    const arr = Array.isArray(bytes) ? bytes : [];
    ui.label.textContent = `Final Bytes • ${arr.length}`;

    const draftStatus = document.querySelector("#ng-byte-draft-status");
    if (draftStatus) draftStatus.textContent = `Final Bytes • ${arr.length}`;

    if (!arr.length) {
      ui.cards.innerHTML = `<div style="font-size:12px;opacity:.6;border:1px dashed #e2e8f0;border-radius:12px;padding:10px;">
        Final Bytes empty
      </div>`;
      return;
    }

    ui.cards.innerHTML = arr.map((b, i) => {
      const sp = esc(b.speaker || "");
      const des = esc(b.designation || "");
      const tx = esc(b.text || "");
      const head = (sp || des) ? `<div style="font-size:12px;opacity:.85;margin-bottom:6px;">
        <b>${sp || "—"}</b>${des ? ` • ${des}` : ""}
      </div>` : "";
      return `<div class="ng-final-card" data-idx="${i}" style="border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#fff;">
        ${head}
        <div style="font-size:14px;line-height:1.3;">${tx || "<span style='opacity:.6'>—</span>"}</div>
      </div>`;
    }).join("");
  }

  async function tick() {
    try {
      const r = await fetch("/api/bytes/latest", { method: "POST", cache: "no-store" });
      const j = await r.json();
      const bytes = (j && (j.bytes || (j.latest && j.latest.bytes))) || [];
      render(bytes);
    } catch (e) { }
  }

  tick();
  setInterval(tick, 1200);
})();
 /* NG_FINAL_BYTES_UI_POLL_V1_END */
</script>

</html>































