

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NewsGenie Digital Producer</title>
<link rel="icon" href="data:,">
  <!-- NG_STD_UI_TOOLBAR_ROW_V2_START -->

<style>
  /* NG_ADVANCED_PANELS_V1 */
  /* NG_ADV_ONLY_WRAP_V1 */
  html[data-ng-std-ui="simple"] #ng-adv-only{ display:none !important; }
  html[data-ng-std-ui="advanced"] #ng-adv-only{ display:block !important; }
#ng-preview-prompt-panel { display:none !important; }


  html[data-ng-std-ui="simple"] #ng-advanced-panels{ display:none !important; }
  html[data-ng-std-ui="simple"] #ng-byte-draft-box{ display:none !important; }
  html[data-ng-std-ui="advanced"] #ng-advanced-panels{ display:block; }

  /* NG_STD_UI_TOOLBAR_ROW_V2
     Goal: single-row toolbar (actions left, UI toggle right) — CSS-only, hang-free
     Rules: NO DOM moving, NO MutationObserver, only CSS overrides.
  */

  /* 1) Layout: make page a simple grid so toolbar can be a row */
  body{
    display: grid;
    grid-template-columns: 1fr auto;
    grid-auto-rows: auto;
    column-gap: 12px;
    row-gap: 8px;
    align-items: start;
  }

  /* Title full width */
  h2{ grid-column: 1 / -1; grid-row: 1; }


  /* 2) Actions row (left) */
  #ng-dp-actions{
  grid-column: 1 / 2;
  grid-row: 2;

    grid-column: 1 / 2;
    align-self: center;

    display: flex !important;
    flex-wrap: nowrap !important;     /* override inline wrap */
    gap: 8px !important;
    align-items: center !important;

    overflow-x: auto;
    overflow-y: hidden;
    white-space: nowrap;
    -webkit-overflow-scrolling: touch;
    min-width: 0;                    /* allow grid to size correctly */
  }

  body > #ng-dp-actions > button{
    flex: 0 0 auto;
    white-space: nowrap;
  }

  /* Hide horizontal scrollbar but keep scrolling */
  #ng-dp-actions{ scrollbar-width: none; }              /* Firefox */
  #ng-dp-actions::-webkit-scrollbar{ height: 0; }       /* Chrome/Edge */

  /* 3) If toggle is inside some wrapper, flatten that wrapper (CSS-only) */
 /* Flatten wrappers up to 4 levels so toggle becomes a grid item of body */
body *:has(> #ng-std-ui-toggle-root){ display: contents !important; }
body *:has(> * > #ng-std-ui-toggle-root){ display: contents !important; }
body *:has(> * > * > #ng-std-ui-toggle-root){ display: contents !important; }
body *:has(> * > * > * > #ng-std-ui-toggle-root){ display: contents !important; }


  /* Toggle: force normal flow + place it on toolbar row (right) */
  #ng-std-ui-toggle-root,
  #ng-std-ui-toggle-root .ngpill{
    position: static !important;
    inset: auto !important;
    top: auto !important;
    right: auto !important;
    bottom: auto !important;
    left: auto !important;
    transform: none !important;
    z-index: auto !important;
  }

  #ng-std-ui-toggle-root{
  grid-column: 2 / 3;
  grid-row: 2;

    grid-column: 2 / 3;
    align-self: center;
    justify-self: end;

    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    pointer-events: auto !important;

    margin: 10px 0 !important;
    white-space: nowrap !important;
  }

  #ng-std-ui-toggle-root .ngpill{
    display: inline-flex !important;
    align-items: center;
    gap: 6px;
    white-space: nowrap;
  }

  /* 4) Everything else should be full width below toolbar */
  /* default: anything that becomes a grid item spans full width */
body *{ grid-column: 1 / -1; }


  /* 5) Responsive: on narrower screens, drop toggle below + allow actions wrap */
 
/* NG_STD_UI_TOOLBAR_FIXED_V1_START — robust, DOM-depth independent */
:root{
  --ng_tb_edge: 12px;
  --ng_tb_pad_top: 78px;           /* body push-down */
  --ng_tb_toggle_reserve: 230px;   /* right space for toggle */
}

/* Push content down so fixed toolbar doesn't overlap */
body{
  padding-top: var(--ng_tb_pad_top) !important;
}

/* Actions bar (left) */
#ng-dp-actions{
  position: fixed !important;
  left: var(--ng_tb_edge) !important;
  top: var(--ng_tb_edge) !important;
  right: calc(var(--ng_tb_edge) + var(--ng_tb_toggle_reserve)) !important;
  z-index: 9999 !important;

  margin: 0 !important;
  padding: 6px 8px !important;
  border: 1px solid rgba(0,0,0,0.10) !important;
  border-radius: 12px !important;
  background: rgba(255,255,255,0.92) !important;
  backdrop-filter: blur(6px);

  display: flex !important;
  flex-wrap: nowrap !important;
  gap: 8px !important;
  align-items: center !important;

  overflow-x: auto;
  overflow-y: hidden;
  white-space: nowrap;
  -webkit-overflow-scrolling: touch;
}

/* Toggle (right) */
#ng-std-ui-toggle-root{
  position: fixed !important;
  right: var(--ng_tb_edge) !important;
  top: var(--ng_tb_edge) !important;
  z-index: 10000 !important;

  margin: 0 !important;
  padding: 6px 8px !important;
  border: 1px solid rgba(0,0,0,0.10) !important;
  border-radius: 12px !important;
  background: rgba(255,255,255,0.92) !important;
  backdrop-filter: blur(6px);

  display: block !important;
  visibility: visible !important;
  opacity: 1 !important;
  pointer-events: auto !important;
}

/* Hide scrollbar (still scrolls) */
#ng-dp-actions{ scrollbar-width: none; }
#ng-dp-actions::-webkit-scrollbar{ height: 0; }

/* Small screens: stack toggle under actions */
@media (max-width: 980px){
  :root{
    --ng_tb_toggle_reserve: 0px;
    --ng_tb_pad_top: 126px;
  }
  #ng-dp-actions{
    right: var(--ng_tb_edge) !important;
  }
  #ng-std-ui-toggle-root{
    top: calc(var(--ng_tb_edge) + 56px) !important;
  }
}
/* NG_STD_UI_TOOLBAR_FIXED_V1_END */



  <style>
    body { font-family: system-ui, Arial; margin: 16px; }
    .row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
    label { font-size: 12px; opacity: .8; display:block; margin-bottom:4px; }
    input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
    button { padding: 10px 14px; border: 0; border-radius: 10px; cursor: pointer; }
    button.primary { background: #111; color: #fff; }
    button.secondary { background: #eee; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .panel { margin-top: 12px; padding: 12px; border: 1px solid #ddd; border-radius: 12px; }
    pre { white-space: pre-wrap; word-wrap: break-word; margin: 0; }
    .status { font-size: 13px; }
    .muted { font-size:12px; opacity:.75; margin-top:6px; }
#btnBytesJSON { display: none !important; }
/* OLD sticky toolbar (remove/disable)
#ng-dp-actions{
  position: sticky;
  top: 10px;
  z-index: 50;
  background: #fff;
  padding: 8px;
  border-radius: 12px;
  border: 1px solid #e5e5e5;
}
*/

/* Force placement: Row-1 Title, Row-2 Toolbar (Actions + Toggle) */
h2{
  grid-column: 1 / -1 !important;
  grid-row: 1 !important;
}

#ng-dp-actions{
  grid-column: 1 / 2 !important;
  grid-row: 2 !important;
}

#ng-std-ui-toggle-root{
  grid-column: 2 / 3 !important;
  grid-row: 2 !important;
  justify-self: end !important;
  align-self: center !important;
}


  </style>
<style>
#ngQuick{ white-space:pre-wrap; overflow:auto; max-height:220px; }

/* NG_STD_UI_SIMPLE_HIDE_BYTES_V1_START */
body:has(#ng-std-ui-toggle-root [data-ng-mode="simple"].active) #bytesWrap {
  display: none !important;
}
body:has(#ng-std-ui-toggle-root [data-ng-mode="advanced"].active) #bytesWrap {
  display: block !important;
}
/* NG_STD_UI_SIMPLE_HIDE_BYTES_V1_END */

</style>
<style id="ng-simple-hide-bytes-v1">
  body:has(#ng-std-ui-toggle-root [data-ng-mode="simple"].active) .panel:has(#ng-sec-bytes){ display:none !important; }
body:has(#ng-std-ui-toggle-root [data-ng-mode="advanced"].active) .panel:has(#ng-sec-bytes){ display:block !important; }

</style>

</head>
<!-- NG_MARKER: 2026-01-06_IST_TEST_123 -->


<body>


<h2>NewsGenie Digital Producer</h2>

  <form id="digi-pack-form" onsubmit="return false;">
    <div class="row">
      <div>
        <label>Topic</label>
        <input name="topic" id="topic" placeholder="E.g., संसद प्रदूषण विवाद" required />

      </div>

      <div>
        <label>Platform</label>
        <select name="platform" id="platform">
          <option value="Digital">Digital</option>
          <option value="Both">Both</option>
          <option value="TV">TV</option>
        </select>
      </div>

      <div>
        <label>Angle (optional)</label>
        
      </div>
    </div>

    <!-- STORY BASICS (moved up) -->
      <label>Story Type</label>
      <select name="storyType" id="storyType" required>
        <option value="">Select</option>
        <option value="breaking">Breaking</option>
        <option value="developing">Developing</option>
        <option value="explainer">Explainer</option>
        <option value="debate">Debate</option>
      </select>
    </div>

    <div style="margin-top:10px;">
      <label>What Happened (mandatory)</label>
      <textarea name="whatHappened" id="whatHappened" rows="3" placeholder="2–4 lines में क्या हुआ?" required></textarea>

    </div>

    <div style="margin-top:10px;">
      <label>Sources / References (mandatory)</label>
      <textarea name="sources" id="sources" rows="3" placeholder="Links / documents / official statements" required></textarea>
    </div>

    <div style="margin-top:10px;">
      <label>Background (optional but counts)</label>
      <textarea name="background" id="background" rows="3" placeholder="Context / past events / why it matters"></textarea>
    </div>
    <!-- STORY BASICS END -->

<!-- ========================= -->
<!-- ========================= -->
<!-- Transcript JSON Loader -->
<!-- ========================= -->
<section id="ng-transcript-loader" style="margin-top:12px; padding:12px; border:1px solid #ddd; border-radius:12px;">
  <!-- Compact tools bar -->
  <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
    <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
      <h3 style="margin:0; font-size:14px;">Transcript Tools</h3>
      <button type="button" id="btn-load-transcript-json" class="primary">Load</button>
      <button type="button" id="btn-refresh-latest-transcript" style="padding:8px 10px;border:1px solid #999;border-radius:10px;cursor:pointer;background:#f7f7f7;">Refresh Latest (API)</button>
      <button type="button" id="btn-paste-transcript-json">Paste</button>
      <button type="button" id="btn-import-transcript-json">Import</button>
      <input type="file" id="file-transcript-json" accept=".json,application/json,.txt" style="display:none;">
    </div>

    <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
      <span style="font-size:12px;opacity:.7;">Status:</span>
      <span id="ng-latest-transcript-status" style="font-size:12px;opacity:.85;">(not loaded)</span>
      <span id="transcript-load-hint" style="font-size:12px; opacity:.75;"></span>
    </div>
  </div>

  <!-- Collapsible inbox (keeps UI light) -->
  <details id="ng-transcript-inbox-details" style="margin-top:10px;">
    <summary style="cursor:pointer; user-select:none; font-size:13px; opacity:.85;">Transcript Inbox</summary>

    <div style="margin-top:10px;">
      <div id="ng-transcript-inbox-hint" style="margin-top:8px;font-size:12px;opacity:.75;">Paste Reverie JSON here (display_text or text). Load saves to localStorage.</div>
      <textarea id="ta-transcript-json" rows="8"
        style="width:100%; padding:10px 12px; border:1px solid #ccc; border-radius:12px; line-height:1.35; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px;"
        placeholder="Paste JSON here..."></textarea>

      <div style="display:flex; gap:8px; margin-top:10px; align-items:center; flex-wrap:wrap;">
        <button type="button" id="btn-clear-transcript-json">Clear Saved</button>
      </div>

      <div id="ng-latest-transcript-preview"
        style="display:none;white-space:pre-wrap;max-height:160px;overflow:auto;border:1px dashed #bbb;border-radius:12px;padding:10px;font-size:13px;opacity:.9; margin-top:10px;"></div>
    </div>
  </details>
</section>

<!-- NG_SUPERLIGHT_TRANSCRIPT_TO_BYTES_V1_START -->
<div id="ng-superlight" style="margin-top:12px; display:grid; grid-template-columns: 1fr; gap:10px;">
  <div class="panel" id="ng-sec-transcript-lines">
    <b>Transcript Lines</b>
    <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:8px;">
      <button type="button" id="ng-lines-selectall">Select All</button>
      <button type="button" id="ng-lines-clear">Clear Selection</button>
      <span id="ng-lines-status" style="font-size:12px; opacity:.75;"></span>
    </div>
    <div id="ng-lines-wrap" style="margin-top:10px; display:flex; flex-direction:column; gap:8px; max-height:220px; overflow:auto; border:1px solid #eee; border-radius:12px; padding:10px;"></div>
  </div>

  </div>
</div>
<!-- NG_SUPERLIGHT_TRANSCRIPT_TO_BYTES_V1_END -->

    <div id="ng-adv-only" style="margin-top:10px;">

    <!-- BYTES -->
    <div class="panel" id="bytesWrap" data-ng-sec="bytes">
      <b>Bytes</b>
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-top:8px;flex-wrap:wrap;">
        <div style="font-size:12px;opacity:.75;">Add bytes from selection or paste/type manually.</div>
        <button type="button" class="btn" id="addByteBtn">+ Add Byte</button>
      </div>

            <div id="ng-byte-defaults" style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <input
          id="ng-byte-default-speaker"
          type="text"
          placeholder="Default Speaker"
          style="padding:8px 10px; border:1px solid #ccc; border-radius:10px; min-width:220px;"
        >
        <input
          id="ng-byte-default-desig"
          type="text"
          placeholder="Default Designation"
          style="padding:8px 10px; border:1px solid #ccc; border-radius:10px; min-width:260px;"
        >
        <span style="font-size:12px; opacity:.7;">(Auto-fill for new byte rows)</span>
      </div>
<!-- NG_BYTES_UNIFIED_DRAFT_V1_START -->
<div id="ng-byte-draft-area" style="margin-top:10px; display:none;">
  <div id="ng-byte-draft-box" style="margin-top:10px;padding:10px;border:1px dashed #cbd5e1;border-radius:12px;">
    <div style="font-size:12px;opacity:.8;margin-bottom:6px;">Draft Byte (select transcript lines OR paste/type manually)</div>

    <textarea
      id="ng-byte-draft-text"
      rows="4"
      style="width:100%; padding:10px; border:1px solid #ccc; border-radius:10px;"
      placeholder="Selected lines will appear here... (or paste/type)"
    ></textarea>

    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
      <input
        id="ng-byte-draft-speaker"
        type="text"
        placeholder="Speaker (manual)"
        style="padding:8px 10px; border:1px solid #ccc; border-radius:10px; min-width:220px;"
      >
      <input
        id="ng-byte-draft-desig"
        type="text"
        placeholder="Designation (manual)"
        style="padding:8px 10px; border:1px solid #ccc; border-radius:10px; min-width:260px;"
      >
    </div>

    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; align-items:center;">
      <button type="button" id="ng-make-byte" class="secondary">Make Draft from Selection</button>
      <button type="button" id="ng-add-final" class="primary">Add to Bytes</button>
      <button type="button" id="ng-clear-draft">Clear Draft</button>
      <span id="ng-byte-draft-status" style="font-size:12px; opacity:.75;"></span>
    </div>
  </div>
</div>
<!-- NG_BYTES_UNIFIED_DRAFT_V1_END -->


      <!-- hidden JSON sink for Final Bytes module -->
      <textarea id="bytesJSONOut" style="display:none;"></textarea>
      <div id="ng-manual-bytes" style="margin-top:10px; display:none;"><div id="bytes-wrap"></div></div>
    </div>
    <!-- VISUALS -->
    <!-- NG_STD_VISUALS_WRAP_V1_START -->
<div id="visualsWrap" data-ng-sec="visuals">
  <div class="panel" id="step-visuals">
    <b>Visuals</b>
    <div class="muted">B-roll / archive / location visuals (multiple rows)</div>

    <div id="visuals-wrap"></div>

    <div style="margin-top:8px;">
      <button type="button" id="add-visual">+ Add Visual</button>
    </div>
  </div>
</div>
<!-- NG_STD_VISUALS_WRAP_V1_END -->


    <div style="margin-top:10px; display:flex; gap:8px; align-items:center;">
      <button id="btnGenerate" type="button" class="primary" onclick="generateDigiPack(event)" disabled>
        Generate DIGI_PACK
      </button>

      <button type="button" class="secondary" onclick="clearUI()">Clear</button>

      <span id="genStatus" style="font-size:13px; opacity:.8;"></span>
    </div>
  </form>
<!-- Editorial Extraction : Suggestions ONLY -->


<div id="ng-advanced-panels">
  <div class="panel">
    <div class="status"><b>Status:</b> <span id="ngStatus">Idle</span></div>
    <div style="margin-top:8px;"><b>Log</b></div>
    <pre id="ngLog"></pre>
  </div>

  <div class="panel">
    <div><b>Quick View</b></div>
    <div id="ngQuick" style="white-space:pre-wrap; overflow:auto; max-height:220px;">(no quick view)</div>

  </div>

  <div class="panel">
    <div><b>Response</b></div>
    <pre id="ngResponse">(no response yet)</pre>
  </div>
<div class="panel" id="ng-preview-prompt-panel">

  <div style="display:flex;align-items:center;justify-content:space-between;">
    <b>Preview Prompt (will be sent)</b>
    <button type="button" id="copy-prompt"
      style="padding:6px 10px;border-radius:8px;border:1px solid #ccc;background:#fff;cursor:pointer;">
      Copy
    </button>
  </div>

  <textarea id="prompt-preview" readonly
    style="width:100%;min-height:160px;margin-top:8px;padding:10px;
           border:1px solid #ccc;border-radius:10px;
           font-family:ui-monospace,Consolas,monospace;
           font-size:12px;"></textarea>
</div>

</div><!-- /#ng-advanced-panels -->
<script>
  const $ = (id) => document.getElementById(id);
  let NG_BUSY = false;

  function logLine(msg) {
    const el = $("ngLog");
    if (el) el.textContent += (msg + "\n");
  }
  function setStatus(status) {
    const el = $("ngStatus");
    if (el) el.textContent = status;
  }

  function setGenStatus(txt, busy = false) {
    const btn = $("btnGenerate");
    const st = $("genStatus");
    if (btn) btn.disabled = busy;
    if (st) st.textContent = txt;
  }

  function renderResponse(data) {
    const pre = document.getElementById("ngResponse");
    if (!pre) return;
    pre.textContent = (typeof data === "string") ? data : JSON.stringify(data, null, 2);
  }

  function safeTrim(v) { return (v ?? "").toString().trim(); }

  function updatePromptPreview(promptObj) {
  // Preview Prompt panel is hidden; disable preview updates to save work.
  return;
}


  // ---------- FormData helpers (getAll compatible) ----------
  function collectBytes(fd) {
    const speakers = fd.getAll("byte_speaker[]").map(safeTrim);
    const designations = fd.getAll("byte_designation[]").map(safeTrim);
const texts = fd.getAll("byte_text[]").map(safeTrim);


    const out = [];
   const n = Math.max(speakers.length, designations.length, texts.length);
    for (let i = 0; i < n; i++) {
      const speaker = speakers[i] || "";
      const designation = designations[i] || "";
      const text = texts[i] || "";
if (speaker || designation || text) out.push({ speaker, designation, text });

    }
    return out;
  }
window.NG_getBytesJSON = function () {
  const form = document.querySelector("#digi-pack-form");

  if (!form) return [];
  return collectBytes(new FormData(form));
};


  function collectVisuals(fd) {
    const shotTypes = fd.getAll("visual_shot_type[]").map(safeTrim);
    const sources   = fd.getAll("visual_source[]").map(safeTrim);
    const whats     = fd.getAll("visual_what[]").map(safeTrim);
    const notes     = fd.getAll("visual_notes[]").map(safeTrim);

    const out = [];
    const n = Math.max(shotTypes.length, sources.length, whats.length, notes.length);
    for (let i = 0; i < n; i++) {
      const shot_type = shotTypes[i] || "";
      const source = sources[i] || "";
      const what = whats[i] || "";
      const note = notes[i] || "";
      if (shot_type || source || what || note) out.push({ shot_type, source, what, note });
    }
    return out;
  }

  function buildPromptFromForm() {
    const form = document.getElementById("digi-pack-form");
    if (!form) throw new Error("Form not found: digi-pack-form");

    const fd = new FormData(form);

    const topic = safeTrim(fd.get("topic"));
    const platform = safeTrim(fd.get("platform")) || "Digital";
    const angle = safeTrim(fd.get("angle"));

    const story_type = safeTrim(
      fd.get("story_type") ||
      fd.get("storyType") ||
      fd.get("story") ||
      fd.get("type")
    );

    const what_happened = safeTrim(fd.get("what_happened") || fd.get("whatHappened"));
    const sources = safeTrim(fd.get("sources"));
    const background = safeTrim(fd.get("background"));

    const bytes = collectBytes(fd);
    const visuals = collectVisuals(fd);

    return {
      topic,
      platform,
      angle: angle || null,
      story_type: story_type || null,
      what_happened,
      sources,
      background: background || null,
      bytes,
      visuals
    };
  }

  async function generateDigiPack(e) {
    e?.preventDefault?.();

    const genBtn = document.getElementById("btnGenerate") || document.getElementById("btn-generate");
    if (genBtn) genBtn.disabled = true;

    try {
      const promptObj = buildPromptFromForm();
      console.log("FINAL PROMPT â†’", promptObj);

      if (!safeTrim(promptObj.topic)) throw new Error("Topic is required.");
      if (!safeTrim(promptObj.what_happened)) throw new Error("What Happened is required.");
      if (!safeTrim(promptObj.sources)) throw new Error("Sources is required.");

      updatePromptPreview(promptObj);

      const payload = { prompt: JSON.stringify(promptObj) };

      setStatus("Calling /api/digi-pack ...");
      logLine("POST /api/digi-pack");
      logLine("Prompt chars: " + payload.prompt.length);

      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 60000);

      const res = await fetch("/api/digi-pack", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify(payload),
  signal: controller.signal
});

if (!res.ok) {
  const t = await res.text().catch(function () { return ""; });
  throw new Error("HTTP " + res.status + " " + t);
}

const data = await res.json();

// âœ… prefer V2 "generated" object
var g = (data && data.generated) ? data.generated : (data || {});
window.NG_LAST_DIGIPACK = g;

// âœ… Quick View auto-fill into <div id="ngQuick">
(function () {
  var el = document.getElementById("ngQuick");
  if (!el) return;

  function toLines(v) {
    if (!v) return [];
    if (Array.isArray(v)) {
      var a = [];
      for (var i = 0; i < v.length; i++) {
        var s = String(v[i] == null ? "" : v[i]).trim();
        if (s) a.push(s);
      }
      return a;
    }
    if (typeof v === "string") {
      var parts = v.replace(/\r\n/g, "\n").split(/\n+/);
      var out = [];
      for (var j = 0; j < parts.length; j++) {
        var t = parts[j].trim();
        if (t) out.push(t);
      }
      return out;
    }
    return [String(v)];
  }

  var headline = String(g.headline || "").trim();
  var dek      = String(g.dek || "").trim();
  var bullets  = toLines(g.bullet_points);
  var vo       = toLines(g.vo_lines);
  var hashtags = toLines(g.hashtags).join(" ");
  var caution  = String(g.caution || "").trim();

  var q = "";
  if (headline) q += "Headline: " + headline + "\n";
  if (dek)      q += "Dek: " + dek + "\n";
  if (bullets.length) {
    q += "Key Points:\n";
    for (var k = 0; k < bullets.length; k++) q += "- " + bullets[k] + "\n";
  }
  if (vo.length) {
    q += "VO Lines:\n";
    for (var m = 0; m < vo.length; m++) q += "â€¢ " + vo[m] + "\n";
  }
  if (hashtags) q += "Hashtags: " + hashtags + "\n";
    // ...
  if (caution)  q += "Caution: " + caution + "\n";

  window.__NG_LAST_QUICKVIEW = q.trim() || "(no quick view)";
  el.textContent = window.__NG_LAST_QUICKVIEW;
})();


// âœ… store last response for copy buttons etc.
window.__NG_LAST_API_RESPONSE = data;
if (!data || data.ok !== true) {
  var q = document.getElementById("ngQuick");
  if (q) q.textContent = "âš  Generate failed. Check Response panel / logs.";
}

// âœ… re-apply Quick View at end (prevents header-only overwrite)
setTimeout(function(){
  var el2 = document.getElementById("ngQuick");
  if (el2 && window.__NG_LAST_QUICKVIEW) {
    el2.textContent = window.__NG_LAST_QUICKVIEW;
  }
}, 0);



// âœ… ensure Quick View UI exists (idempotent)
try { if (window.ensureDigiPackUI) window.ensureDigiPackUI(); } catch (e) { console.warn("ensureDigiPackUI failed", e); }

// âœ… render response panel
if (typeof setResponse === "function") setResponse(data);
else renderResponse(data);

// âœ… render Quick View (prefer window.*)
try {
  if (window.renderQuickView) window.renderQuickView(data);
} catch (e2) {
  console.warn("renderQuickView failed", e2);
}

setStatus("Done");
logLine("Done âœ…");
} catch (err) {
  var msg = (err && err.message) ? err.message : String(err);
  var isAbort =
  (err && err.name === "AbortError") ||
  (String(msg).toLowerCase().indexOf("aborted") !== -1) ||
  (String(msg).toLowerCase().indexOf("abort") !== -1);

if (isAbort) {
  setStatus("Cancelled/Timeout");
  logLine("Cancelled/Timeout");
  // âœ… Abort à¤ªà¤° alert à¤¨à¤¹à¥€à¤‚
} else {
  setStatus("Error");
  logLine("Error: " + msg);
  alert(msg);
}

} finally {
  try { if (timeout) { clearTimeout(timeout); timeout = null; } } catch(e) {}
  if (genBtn) genBtn.disabled = false;
}
}


  function getVal(name) {
    const el = document.querySelector(`[name="${name}"]`);
    return el ? (el.value || "").trim() : "";
  }

  function setGenerateState(enabled, msg) {
    const btn = $("btnGenerate") || document.getElementById("btn-generate");
    if (btn) btn.disabled = !enabled;
    const s = $("genStatus");
    if (s) s.textContent = msg || "";
  }

  function validateGenerate() {
    const topic = getVal("topic");
    const ok = !!topic;
    if (!ok) { setGenerateState(false, "Topic required"); return false; }
    setGenerateState(true, "Ready");
    return true;
  }

  document.addEventListener("input", validateGenerate);
  document.addEventListener("change", validateGenerate);

  /* =========================
     /* =========================
   BYTES UI (Speaker + Designation)
========================= */
const MAX_BYTES = 8;

function byteRowTemplate(i) {
  return `
    <div class="byte-row" data-byte-row="${i}">
      <div class="row" style="grid-template-columns: 1fr 1fr auto; gap: 8px;">
        <div>
          <label>Speaker Name</label>
          <input
            type="text"
            name="byte_speaker[]"
            data-byte-field="speaker"
            placeholder="E.g., जयराम रमेश"

            autocomplete="off"
          />
        </div>
        <div>
          <label>Designation</label>
          <input
            type="text"
            name="byte_designation[]"
            data-byte-field="designation"
            placeholder="कांग्रेस नेता"

            autocomplete="off"
          />
        </div>
<div style="grid-column: 1 / -1;">
  <label>Text / Quote</label>
  <textarea
    name="byte_text[]"
    data-byte-field="text"
    placeholder="यहाँ बाइट का actual quote लिखें"
"
    rows="2"
    autocomplete="off"
    style="width:100%; resize:vertical;"
  ></textarea>
</div>

        <div style="display:flex;align-items:flex-end;">
          <button
            type="button"
            class="danger"
            data-remove-byte="${i}"
            title="Remove this byte"
          >Remove</button>
        </div>
      </div>
    </div>
  `;
}

function initBytesUI() {
  // âœ… prevent double init
  if (window.__NG_BYTES_INIT_DONE) return;
  window.__NG_BYTES_INIT_DONE = true;

  // âœ… FIX: your real IDs (from your console)
  const wrap = document.getElementById("bytesWrap");
const addBtn = document.getElementById("addByteBtn");
const rowsWrap = document.getElementById("bytes-wrap");

// ✅ real wrapper (your STEP4)
const draftBox = document.getElementById("ng-byte-draft-box");
const manual = document.getElementById("ng-manual-bytes");


if (!wrap || !addBtn || !rowsWrap || !draftBox) {
  console.warn("[BYTES] Missing bytes UI nodes", {
    wrap: !!wrap, addBtn: !!addBtn, rowsWrap: !!rowsWrap, draftBox: !!draftBox
  });
  return;
}


  // âœ… ensure button is usable
  addBtn.disabled = false;

  function getCount() {
    return rowsWrap.querySelectorAll("[data-byte-row]").length;
  }
function updateDraftBoxVisibility() {
  const n = getCount();
  draftBox.style.display = (n === 0) ? "none" : "block";
}
updateDraftBoxVisibility(); // initial state on load

  function updateRemoveButtonsState() {
    const rows = Array.from(rowsWrap.querySelectorAll("[data-byte-row]"));
    const disable = false; // allow removing last row (manual auto-hides at 0)

    rows.forEach((row) => {
      const btn = row.querySelector("[data-remove-byte]");
      if (!btn) return;

      btn.disabled = disable;
      btn.style.opacity = disable ? "0.5" : "1";
      btn.style.cursor = disable ? "not-allowed" : "pointer";
      btn.title = "Remove this byte";
    });
  }

  function renumber() {
    const rows = Array.from(rowsWrap.querySelectorAll("[data-byte-row]"));
    rows.forEach((row, idx) => {
      const n = idx + 1;
      row.setAttribute("data-byte-row", String(n));

      const btn = row.querySelector("[data-remove-byte]");
      if (btn) btn.setAttribute("data-remove-byte", String(n));
    });

    updateRemoveButtonsState();
  }

  function addByteRow() {
    const n = getCount() + 1;
    if (typeof MAX_BYTES !== "undefined" && n > MAX_BYTES) return;

    // assumes byteRowTemplate(n) exists and creates:
    // - a container with data-byte-row
    // - inputs name="byte_speaker[]" and name="byte_designation[]"
    // - a remove button having data-remove-byte
    rowsWrap.insertAdjacentHTML("beforeend", byteRowTemplate(n));
    renumber();

    // auto-fill from defaults (if empty)
    try {
      const defSp = (document.getElementById('ng-byte-default-speaker')?.value || '').trim();
      const defDs = (document.getElementById('ng-byte-default-desig')?.value || '').trim();
      const last = rowsWrap.querySelector('[data-byte-row]:last-child');
      if (last) {
        const sp = last.querySelector('input[name="byte_speaker[]"]');
        const ds = last.querySelector('input[name="byte_designation[]"]');
        if (sp && !sp.value.trim() && defSp) sp.value = defSp;
        if (ds && !ds.value.trim() && defDs) ds.value = defDs;
      }
    } catch (e) {}
  }

  // âœ… ensure 1st row exists
  // NG_PATCH_DISABLE_DEFAULT_BYTE_ROW_V1: removed auto first row
// if (getCount() === 0) addByteRow();

  // ✅ expose helpers for pushToBytes()
  window.NG_addByteRow = addByteRow;
  window.NG_getByteCount = getCount;

  // ✅ add row button (manual UI on demand)
 addBtn.addEventListener("click", (e) => {
  e.preventDefault();
  if (manual) manual.style.display = "block";
  if (draftBox) draftBox.style.display = "block";
  addByteRow();
  updateDraftBoxVisibility();
});
addBtn.addEventListener("click", () => addBtn.scrollIntoView({ block: "center" }));


  // âœ… add row button

  // âœ… remove (event delegation)
  wrap.addEventListener("click", (e) => {
    const btn = e.target.closest("[data-remove-byte]");
    if (!btn) return;

    e.preventDefault();

    const row = btn.closest("[data-byte-row]");
    if (!row) return;
    row.remove();
    renumber();
updateDraftBoxVisibility();

  });

  // initial state
  renumber();
}


  /* =========================
     VISUALS UI (FormData.getAll compatible)
  ========================= */
  function visualRowTemplate(i) {
    return `
      <div class="visual-row" data-visual-row="${i}" style="border:1px solid #e6e6e6;border-radius:12px;padding:10px;margin-top:10px;">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
          <div class="v-row-label" style="font-weight:600;">Visual ${i}</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button type="button" data-action="gen-visual">Generate</button>
            <button type="button" data-action="clear-visual">Clear</button>
            <button type="button" data-action="remove-visual">Remove</button>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px;">
          <div>
            <label style="font-size:12px;opacity:.8;display:block;margin-bottom:4px;">Shot Type</label>
            <select name="visual_shot_type[]" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;">
              <option value="BROLL">B-roll</option>
              <option value="ARCHIVE">Archive</option>
              <option value="LOCATION">Location</option>
              <option value="GRAPHIC">Graphic</option>
              <option value="SCREEN">Screen</option>
            </select>
          </div>

          <div>
            <label style="font-size:12px;opacity:.8;display:block;margin-bottom:4px;">Source</label>
            <input type="text" name="visual_source[]" placeholder="Reporter / Agency / Archive"
              style="width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;" />
          </div>
        </div>

        <div style="margin-top:8px;">
          <label style="font-size:12px;opacity:.8;display:block;margin-bottom:4px;">What to show</label>
          <input type="text" name="visual_show[]" placeholder="E.g., दुकान पर छापा, सील पैक, अस्पताल, लैब, दस्तावेज"
  style="width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;" />

        </div>

        <div style="margin-top:8px;">
          <label style="font-size:12px;opacity:.8;display:block;margin-bottom:4px;">Notes (optional)</label>
          <input type="text" name="visual_notes[]" placeholder="E.g., 3-5 sec, blur face, avoid brand"
            style="width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;" />
        </div>
      </div>
    `;
  }

  function initVisualsUI() {
    const wrap = document.getElementById("visuals-wrap");
    const addBtn = document.getElementById("add-visual");
    if (!wrap || !addBtn) return;

    function getCount() {
      return wrap.querySelectorAll("[data-visual-row]").length;
    }

    function renumber() {
      const rows = Array.from(wrap.querySelectorAll("[data-visual-row]"));
      rows.forEach((row, idx) => {
        row.setAttribute("data-visual-row", String(idx + 1));
        const label = row.querySelector(".v-row-label");
        if (label) label.textContent = "Visual " + (idx + 1);
        const rm = row.querySelector('button[data-action="remove-visual"]');
        if (rm) rm.disabled = (idx === 0);
      });
    }

    function addVisualRow() {
      const n = getCount() + 1;
      wrap.insertAdjacentHTML("beforeend", visualRowTemplate(n));
      renumber();
       
    }

    // if (getCount() === 0) addVisualRow();

    document.getElementById("add-visual")?.addEventListener("click", addVisualRow);

    // event delegation (ONLY visuals actions)
  wrap.addEventListener("click", (e) => {
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;

      const row = btn.closest("[data-visual-row]");
      if (!row) return;

      const action = btn.getAttribute("data-action");

      if (action === "remove-visual") {
        // NG_ALLOW_REMOVE_LAST_ROW_V1 (was: if (getCount() <= 1) return;)
        row.remove();
        renumber();
        return;
      }

      if (action === "clear-visual") {
        row.querySelectorAll("input").forEach(i => (i.value = ""));
        const sel = row.querySelector('select[name="visual_shot_type[]"]');
        if (sel) sel.value = "BROLL";
        return;
      }

      if (action === "gen-visual") {
        const sel  = row.querySelector('select[name="visual_shot_type[]"]');
        const what = row.querySelector('input[name="visual_what[]"]');
        const src  = row.querySelector('input[name="visual_source[]"]');

        const type = sel ? sel.value : "BROLL";

        if (what && !what.value.trim()) {
          what.value =
            type === "ARCHIVE"  ? "फाइल फुटेज / पुरानी क्लिप" :
type === "LOCATION" ? "लोकेशन शॉट / साइनबोर्ड / एरिया विजुअल" :
type === "GRAPHIC"  ? "टाइमलाइन / नंबर / मैप प्लेट" :
type === "SCREEN"   ? "वेबसाइट/दस्तावेज़ स्क्रीन" :
                        "B-roll (जांच/रिएक्शन/डिटेल शॉट)";

        }
        if (src && !src.value.trim()) src.value = "Reporter/Archive";
        return;
      }
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    validateGenerate();
    initBytesUI();
    initVisualsUI();
  });

  ;(function initPromptPreviewCopy() {
    const btn = document.getElementById("copy-prompt");
    const box = document.getElementById("prompt-preview");
    if (!btn || !box) return;

    btn.addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(box.value || "");
        if (typeof logLine === "function") logLine("Preview prompt copied âœ…");
      } catch {
        box.focus();
        box.select();
        document.execCommand("copy");
        if (typeof logLine === "function") logLine("Preview prompt copied (fallback) âœ…");
      }
    });
  })();
</script>

<script>
/* === Editorial Extraction : Suggestions Panel + Transcript Auto-Ingest (Clean V3) === */

  "use strict";

  // ---------------- utils ----------------
  function esc(s) {
    return String(s ?? "").replace(/[&<>"']/g, (m) => ({
      "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
    }[m]));
  }
  function norm(s) { return String(s ?? "").replace(/\s+/g, " ").trim(); }
  function normKey(s) {
    return norm(s).toLowerCase()
      .replace(/[â€œâ€"']/g, "")
      .replace(/[^\p{L}\p{N}\s]/gu, "")
      .replace(/\s+/g, " ")
      .trim();
  }

  // optional speakerâ†’designation map
  window.__NG_SPEAKER_MAP = window.__NG_SPEAKER_MAP || {
    "à¤•à¤¿à¤°à¤£ à¤°à¤¿à¤œà¤¿à¤œà¥‚": "à¤•à¥‡à¤‚à¤¦à¥à¤°à¥€à¤¯ à¤®à¤‚à¤¤à¥à¤°à¥€",
    "à¤œà¤¯à¤°à¤¾à¤® à¤°à¤®à¥‡à¤¶": "à¤•à¤¾à¤‚à¤—à¥à¤°à¥‡à¤¸ à¤¨à¥‡à¤¤à¤¾"
  };

  // ---------------- extraction helpers ----------------
  function guessSpeakerFromText(text) {
    const t = norm(text);

    // "à¤¨à¤¾à¤® (à¤ªà¤¦): à¤¬à¤¯à¤¾à¤¨..."
    const m2 = t.match(/^(.{2,40})\s*\((.{2,40})\)\s*[:ï¼š]\s*(.+)$/);
    if (m2) return { speaker: norm(m2[1]), designation: norm(m2[2]), text: norm(m2[3]) };

    // "à¤¨à¤¾à¤®: à¤¬à¤¯à¤¾à¤¨..."
    const m = t.match(/^([^:ï¼š]{2,40})\s*[:ï¼š]\s*(.+)$/);
    if (m) return { speaker: norm(m[1]), text: norm(m[2]) };

    // "à¤¨à¤¾à¤® à¤¨à¥‡ à¤•à¤¹à¤¾/à¤¬à¤¤à¤¾à¤¯à¤¾... (à¤•à¤¿) ..."
    const m3 = t.match(
      /^([^\s:ï¼š]{2,20}(?:\s+[^\s:ï¼š]{2,20}){0,2})\s+(?:à¤¨à¥‡\s+(?:à¤•à¤¹à¤¾|à¤¬à¥‹à¤²à¥‡|à¤¬à¤¤à¤¾à¤¯à¤¾|à¤†à¤°à¥‹à¤ª\s+à¤²à¤—à¤¾à¤¯à¤¾|à¤¦à¤¾à¤µà¤¾\s+à¤•à¤¿à¤¯à¤¾|à¤¤à¤‚à¤œ\s+à¤•à¤¸à¤¾)|à¤•à¤¾\s+à¤•à¤¹à¤¨à¤¾\s+à¤¹à¥ˆ)\s*(?:à¤•à¤¿\s*)?(.+)$/
    );
    if (m3) {
      const sp = norm(m3[1]);
      const rest = norm(m3[2] || "");
      if (sp && !/^(à¤‰à¤¨à¥à¤¹à¥‹à¤‚à¤¨à¥‡|à¤‰à¤¸à¤¨à¥‡|à¤¹à¤®à¤¨à¥‡|à¤†à¤ªà¤¨à¥‡|à¤‡à¤¨à¥à¤¹à¥‹à¤‚à¤¨à¥‡|à¤‰à¤¨à¤•à¤¾|à¤‰à¤¸à¤•à¤¾)$/u.test(sp)) {
        return { speaker: sp, text: rest || t };
      }
    }

    return { text: t };
  }

  function scoreLine(line) {
    const t = (line.text || "").trim();
    const len = t.length;
    let score = 0;

    if (len >= 18 && len <= 140) score += 3;
    else if (len >= 10 && len <= 220) score += 1.5;
    else if (len < 8) score -= 4;
    else score -= 0.2;

    if (line.speaker) score += 1.6;
    if (/[â€œâ€"']/.test(t)) score += 1.2;
    if (/[?!]/.test(t)) score += 0.4;

    if (/(à¤•à¤¹à¤¾|à¤¬à¥‹à¤²à¥‡|à¤¬à¤¤à¤¾à¤¯à¤¾|à¤¸à¥à¤ªà¤·à¥à¤Ÿ|à¤¸à¤¾à¤«|à¤œà¤µà¤¾à¤¬|à¤¤à¥ˆà¤¯à¤¾à¤°|à¤†à¤°à¥‹à¤ª|à¤¤à¤‚à¤œ|à¤¸à¤°à¤•à¤¾à¤°|à¤µà¤¿à¤ªà¤•à¥à¤·|à¤œà¤¾à¤‚à¤š|à¤¸à¤µà¤¾à¤²|à¤šà¥à¤¨à¤¾à¤µ|à¤¸à¤‚à¤¸à¤¦|à¤¦à¥‡à¤¶|à¤œà¤¨à¤¤à¤¾)/.test(t)) score += 2;
    if (/(à¤¨à¤¹à¥€à¤‚|à¤—à¤²à¤¤|à¤à¥‚à¤ |à¤¸à¤¬à¥‚à¤¤|à¤•à¤¾à¤°à¥à¤°à¤µà¤¾à¤ˆ|à¤®à¤¾à¤‚à¤—|à¤‡à¤¸à¥à¤¤à¥€à¤«à¤¾|à¤¹à¤®à¤²à¤¾|à¤¬à¤šà¤¾à¤µ)/.test(t)) score += 1;
    if (/[0-9à¥¦-à¥¯]/.test(t)) score += 0.6;

    if (/(à¤§à¤¨à¥à¤¯à¤µà¤¾à¤¦|à¤¨à¤®à¤¸à¥à¤•à¤¾à¤°|à¤¸à¥à¤µà¤¾à¤—à¤¤|à¤†à¤ª à¤¦à¥‡à¤– à¤°à¤¹à¥‡|à¤¦à¥‡à¤–à¤¿à¤|à¤¦à¥‹à¤¸à¥à¤¤à¥‹à¤‚|à¤šà¤²à¤¿à¤¯à¥‡|à¤…à¤¬ à¤¹à¤®)/.test(t)) score -= 4;

    return score;
  }

  function extractReverieText(root) {
    if (!root) return "";
    if (typeof root === "string") return root.trim();

    const cands = [
      root.display_text, root.text,
      root.result?.display_text, root.result?.text,
      root.output?.display_text, root.output?.text,
      root.data?.display_text, root.data?.text,
      root.response?.display_text, root.response?.text,
      root.success && root.text ? root.text : null
    ];
    for (const c of cands) if (typeof c === "string" && c.trim()) return c.trim();
    return "";
  }

  function mapArrToLines(arr) {
    const out = [];
    for (const it of arr || []) {
      let txt = "";
      if (typeof it === "string") txt = it;
      else if (it && typeof it === "object") {
        txt = it.text || it.transcript || it.utterance || it.sentence || it.content || it.line || "";
      }
      txt = norm(txt);
      if (!txt) continue;

      const g = guessSpeakerFromText(txt);
      let speaker = norm(g.speaker || it?.speaker || it?.name || "");
      let designation = norm(g.designation || it?.designation || it?.title || "");
      let text = norm(g.text || txt);

      if (speaker && !designation) designation = window.__NG_SPEAKER_MAP[speaker] || "";

      out.push({ speaker, designation, text });
    }
    return out;
  }

  function looksLikeTranscriptArr(arr) {
    let hits = 0, totalLen = 0;
    for (const it of arr || []) {
      const txt = (typeof it === "string")
        ? it
        : (it?.text || it?.transcript || it?.utterance || it?.sentence || it?.content || it?.line);
      if (typeof txt === "string" && txt.trim()) {
        hits++;
        totalLen += txt.trim().length;
      }
    }
    const avg = hits ? totalLen / hits : 0;
    return hits >= 2 && avg >= 10;
  }

  function collectCandidateLines(root, opts) {
    const maxNodes = Number(opts?.maxNodes || 9000);

    // Prefer full text
    const fullText = extractReverieText(root);
    if (fullText) {
      const normalized = String(fullText)
        .replace(/\r/g, "\n")
        .replace(/[ \t]+/g, " ")
        .replace(/\n{3,}/g, "\n\n")
        .replace(/([à¥¤.?!])\s+/g, "$1\n")
        .trim();

      const parts = normalized
        .split("\n")
        .map(s => (s || "").trim())
        .filter(s => s.length >= 12)
        .slice(0, 80);

      return parts.map(p => {
        const g = guessSpeakerFromText(p);
        const speaker = norm(g.speaker || "");
        const designation = norm(g.designation || (speaker ? (window.__NG_SPEAKER_MAP[speaker] || "") : ""));
        const text = norm(g.text || p);
        return { speaker, designation, text };
      });
    }

    // Direct arrays
    const directCandidates = [];
    if (Array.isArray(root?.segments)) directCandidates.push(root.segments);
    if (Array.isArray(root?.result?.segments)) directCandidates.push(root.result.segments);
    if (Array.isArray(root?.data?.segments)) directCandidates.push(root.data.segments);
    if (Array.isArray(root?.utterances)) directCandidates.push(root.utterances);
    if (Array.isArray(root?.sentences)) directCandidates.push(root.sentences);
    if (Array.isArray(root?.results)) directCandidates.push(root.results);

    for (const arr of directCandidates) {
      if (Array.isArray(arr) && looksLikeTranscriptArr(arr)) return mapArrToLines(arr);
    }

    // BFS scan for best transcript-like array
    const queue = [root];
    let nodes = 0;
    const arrays = [];

    while (queue.length && nodes < maxNodes) {
      const v = queue.shift();
      nodes++;
      if (!v) continue;

      if (Array.isArray(v)) {
        if (looksLikeTranscriptArr(v)) arrays.push(v);
        for (const it of v) if (it && typeof it === "object") queue.push(it);
        continue;
      }
      if (typeof v === "object") {
        for (const k in v) {
          if (!Object.prototype.hasOwnProperty.call(v, k)) continue;
          const it = v[k];
          if (it && typeof it === "object") queue.push(it);
        }
      }
    }

    return mapArrToLines(arrays[0] || []);
  }

  function pickBestLines(lines, min = 6, max = 10) {
    const seenText = new Set();
    const bestPerSpeaker = new Map();
    const rest = [];

    for (const ln of (lines || [])) {
      const tKey = normKey(ln.text);
      if (!tKey || tKey.length < 8) continue;
      if (seenText.has(tKey)) continue;
      seenText.add(tKey);

      const scored = { ...ln, __score: scoreLine(ln) };
      if (scored.__score < -2.5) continue;

      const sp = norm(scored.speaker);
      if (sp) {
        const prev = bestPerSpeaker.get(sp);
        if (!prev || scored.__score > prev.__score) bestPerSpeaker.set(sp, scored);
        else rest.push(scored);
      } else {
        rest.push(scored);
      }
    }

    const picked = Array.from(bestPerSpeaker.values()).sort((a, b) => b.__score - a.__score);
    rest.sort((a, b) => b.__score - a.__score);

    for (const r of rest) {
      if (picked.length >= max) break;
      picked.push(r);
    }
    return picked.slice(0, Math.max(min, Math.min(max, picked.length)));
  }

  // ---------------- BYTES helpers (used by push) ----------------
  function getAddByteButton() {
    return (
      document.getElementById("addByteBtn") ||
      document.getElementById("add-byte") ||
      document.querySelector('[data-action="add-byte"]')
    );
  }

  function getByteFields() {
    const wrap = document.getElementById("bytesWrap") || document;
    const speakers = [...wrap.querySelectorAll('input[name="byte_speaker[]"]')];
    const desigs   = [...wrap.querySelectorAll('input[name="byte_designation[]"]')];
    const texts    = [...wrap.querySelectorAll('textarea[name="byte_text[]"], input[name="byte_text[]"]')];
    return { wrap, speakers, desigs, texts };
  }

  function ensureByteRows(targetCount) {
    const addBtn = getAddByteButton();
    if (!addBtn) return;

    let safety = 40;
    while (safety-- > 0) {
      const { speakers } = getByteFields();
      if (speakers.length >= targetCount) break;

      if (typeof window.NG_addByteRow === "function") window.NG_addByteRow();
      else addBtn.click();
    }
  }

  function existingByteSet() {
    const { speakers, desigs, texts } = getByteFields();
    const set = new Set();
    const n = Math.max(speakers.length, desigs.length, texts.length);

    for (let i = 0; i < n; i++) {
      const sp = normKey(speakers[i]?.value || "");
      const ds = normKey(desigs[i]?.value || "");
      const tx = normKey(texts[i]?.value || "");
      if (sp || ds || tx) set.add(`${sp}|${ds}|${tx}`);
    }
    return set;
  }

  function findFirstEmptySlot() {
    const { speakers, desigs, texts } = getByteFields();
    const n = Math.max(speakers.length, desigs.length, texts.length);

    for (let i = 0; i < n; i++) {
      const sp = norm(speakers[i]?.value || "");
      const ds = norm(desigs[i]?.value || "");
      const tx = norm(texts[i]?.value || "");
      if (!sp && !ds && !tx) return i;
      if (!sp && !ds) return i;
    }
    return n;
  }

  function fillSlot(i, item) {
    ensureByteRows(i + 1);
    const f = getByteFields();
    if (f.speakers[i]) f.speakers[i].value = item?.speaker || "";
    if (f.desigs[i])   f.desigs[i].value   = item?.designation || "";
    if (f.texts[i])    f.texts[i].value    = item?.text || "";
  }

  // ---------------- UI init ----------------
function initEditorialExtraction() {
  if (window.__NG_EE_INIT_DONE) return;
  window.__NG_EE_INIT_DONE = true;

  const eeList  = document.getElementById("ee-list");
  const eeEmpty = document.getElementById("ee-empty");
  const btnPush = document.getElementById("ee-push");
  const btnClear= document.getElementById("ee-clear");

  if (!eeList || !btnPush || !btnClear) {
    console.warn("[EE] Missing ee-list/ee-push/ee-clear");
    return;
  }

  let suggestions = [];

  function showEmpty(on) {
    if (!eeEmpty) return;
    eeEmpty.style.display = on ? "block" : "none";
  }

  function updateButtons() {
    const total   = eeList.querySelectorAll('input[type="checkbox"][data-i]').length;
    const checked = eeList.querySelectorAll('input[type="checkbox"][data-i]:checked').length;
    btnPush.disabled  = (checked === 0);
    btnClear.disabled = (total === 0);
  }

  // --- Bytes helpers (bulletproof, DOM-driven) ---
  function bytesWrapEl() {
    return document.getElementById("bytesWrap") || document.getElementById("bytes-wrap");
  }

  function addByteButtonEl() {
    return (
      document.getElementById("addByteBtn") ||
      document.getElementById("add-byte") ||
      document.getElementById("addByte")
    );
  }

  function getByteInputs() {
    const wrap = bytesWrapEl();
    if (!wrap) return { sp: [], ds: [], tx: [] };
    const sp = Array.from(wrap.querySelectorAll('input[name="byte_speaker[]"]'));
    const ds = Array.from(wrap.querySelectorAll('input[name="byte_designation[]"]'));
    const tx = Array.from(wrap.querySelectorAll('textarea[name="byte_text[]"], input[name="byte_text[]"]'));
    return { sp, ds, tx };
  }

  function ensureByteRows(minRows) {
    let { sp, ds } = getByteInputs();
    let n = Math.max(sp.length, ds.length);
    let safety = 0;

    while (n < minRows && safety++ < 30) {
      if (typeof window.NG_addByteRow === "function") {
        window.NG_addByteRow();
      } else {
        const addBtn = addByteButtonEl();
        if (addBtn) addBtn.click();
        else break;
      }
      ({ sp, ds } = getByteInputs());
      n = Math.max(sp.length, ds.length);
    }
    return n;
  }

  function findFirstEmptySlot() {
    const { sp, ds } = getByteInputs();
    const n = Math.max(sp.length, ds.length);
    for (let i = 0; i < n; i++) {
      const a = (sp[i]?.value || "").trim();
      const b = (ds[i]?.value || "").trim();
      if (!a && !b) return i;
    }
    return n; // append
  }

  function normKeyLocal(s) {
    return (s || "")
      .toString()
      .trim()
      .replace(/\s+/g, " ")
      .toLowerCase();
  }

  function existingByteSet() {
    const set = new Set();
    const { sp, ds, tx } = getByteInputs();
    const n = Math.max(sp.length, ds.length, tx.length);
    for (let i = 0; i < n; i++) {
      const speaker = (sp[i]?.value || "").trim();
      const desig   = (ds[i]?.value || "").trim();
      const text    = (tx[i]?.value || "").trim();
      if (!speaker && !desig && !text) continue;
      set.add(`${normKeyLocal(speaker)}|${normKeyLocal(desig)}|${normKeyLocal(text)}`);
    }
    return set;
  }

  // âœ… return true/false
  function fillSlot(slotIndex, item) {
    ensureByteRows(slotIndex + 1);

    const { sp, ds, tx } = getByteInputs();
    if (!sp[slotIndex] || !ds[slotIndex]) return false;

    const speaker = (item?.speaker || "").toString().trim();
    const desig   = (item?.designation || "").toString().trim();
    const text    = (item?.text || "").toString().trim();

    if (!speaker || !desig) return false;

    const spWas = (sp[slotIndex].value || "").trim();
    const dsWas = (ds[slotIndex].value || "").trim();

    // don't overwrite
    if (spWas || dsWas) return false;

    sp[slotIndex].value = speaker;
    ds[slotIndex].value = desig;

    if (tx && tx[slotIndex] && !((tx[slotIndex].value || "").trim()) && text) {
      tx[slotIndex].value = text;
    }

    // trigger input events
    try { sp[slotIndex].dispatchEvent(new Event("input", { bubbles: true })); } catch(e){}
    try { ds[slotIndex].dispatchEvent(new Event("input", { bubbles: true })); } catch(e){}
    if (tx && tx[slotIndex]) { try { tx[slotIndex].dispatchEvent(new Event("input", { bubbles: true })); } catch(e){} }

    return true;
  }

  function render(list) {
    suggestions = Array.isArray(list) ? list : [];

    // âœ… keep suggestions in memory for pushToBytes
    window.__NG_EE_SUGGEST = suggestions;
    window.__NG_EE_SUGGESTIONS = suggestions; // backward alias

    eeList.innerHTML = "";

    if (!suggestions.length) {
      showEmpty(true);
      btnPush.disabled = true;
      btnClear.disabled = true;
      return;
    }

    showEmpty(false);

    suggestions.forEach((b, i) => {
      const speaker = esc(b.speaker || "Unknown");
      const desig   = esc(b.designation || "");
      const text    = esc(b.text || "");

      const card = document.createElement("label");
      card.style.cssText =
        "border:1px solid #ddd;border-radius:12px;padding:10px;display:block;margin:10px 0;cursor:pointer;";

      card.innerHTML = `
        <div style="display:flex;gap:10px;align-items:flex-start;">
          <input type="checkbox" data-i="${i}" style="margin-top:3px;">
          <div style="flex:1;">
            <div style="font-weight:700;">${speaker}</div>
            <div style="opacity:.75;font-size:12px;margin-top:2px;">${desig}</div>
            <div style="margin-top:8px;line-height:1.35;">${text}</div>
          </div>
        </div>
      `;
      eeList.appendChild(card);
    });

    updateButtons();
  }

  function clearAll() {
    render([]);
  }

  function getCheckedIndices() {
    return [...eeList.querySelectorAll('input[type="checkbox"][data-i]:checked')]
      .map(cb => Number(cb.getAttribute("data-i")))
      .filter(n => Number.isFinite(n) && n >= 0);
  }

  function pushToBytes() {
    const idxs = getCheckedIndices();
    if (!idxs.length) return;

    const dupeSet = existingByteSet();
    const pushedRun = new Set();
    let pushed = 0;

    for (const idx of idxs) {
      const item = suggestions[idx];
      if (!item) continue;

      const speaker = (item.speaker || "").toString().trim();
      const desig   = (item.designation || "").toString().trim();
      const text    = (item.text || "").toString().trim();

      const key = `${normKeyLocal(speaker)}|${normKeyLocal(desig)}|${normKeyLocal(text)}`;

      // âœ… no duplicates: already in bytes OR already pushed in this click
      if (dupeSet.has(key) || pushedRun.has(key)) continue;

      // find next empty slot and ensure rows
      const slot = findFirstEmptySlot();
      ensureByteRows(slot + 1);

      const ok = fillSlot(slot, { speaker, designation: desig, text });

      // âœ… only if filled successfully: uncheck + count + add to sets
      if (ok) {
        const cb = eeList.querySelector(`input[type="checkbox"][data-i="${idx}"]`);
        if (cb) cb.checked = false;

        dupeSet.add(key);
        pushedRun.add(key);
        pushed++;
      }
    }

    if (pushed) console.log("[EE] Pushed to Bytes:", pushed);
    updateButtons();
  }

  // bind once
  if (!window.__NG_EE_WIRED) {
    window.__NG_EE_WIRED = true;

    eeList.addEventListener("change", updateButtons);

    btnPush.addEventListener("click", (e) => {
      e.preventDefault();
      pushToBytes();
    });

    btnClear.addEventListener("click", (e) => {
      e.preventDefault();
      clearAll();
    });
  }

  // expose renderer
  window.NG_setEditorialSuggestions = render;

  // initial empty
  render([]);
  console.log("[EE] initEditorialExtraction READY");
}

  // ---------------- ingest + hook NG_TRANSCRIPT ----------------
  // ---------------- ingest NG_TRANSCRIPT -> Transcript Lines (Super Light) ----------------
  window.NG_ingestTranscript = function (reverieJsonOrText) {
    try {
      const raw = collectCandidateLines(reverieJsonOrText, { maxNodes: 9000 });
      const lines0 = (raw || []).map(x => {
        if (typeof x === "string") return x;
        if (!x) return "";
        return (x.text || x.display_text || x.utterance || x.line || x.value || "");
      });
      const lines = [];
      const seen = new Set();
      for (let i = 0; i < lines0.length && lines.length < 240; i++) {
        const t = String(lines0[i] || "").replace(/\s+/g, " ").trim();
        if (!t) continue;
        const k = t.toLowerCase();
        if (seen.has(k)) continue;
        seen.add(k);
        lines.push(t);
      }
      window.__NG_TLINES = lines;
      if (typeof window.NG_setTranscriptLines === "function") window.NG_setTranscriptLines(lines);
      console.log("[TL] Transcript -> lines:", lines.length);
      return lines;
    } catch (e) {
      console.error("[TL] ingest error:", e);
      return [];
    }
  };
  (function hookTranscriptSetter() {
    if (window.__NG_TRANSCRIPT_HOOKED) return;
    window.__NG_TRANSCRIPT_HOOKED = true;

    let _t = window.NG_TRANSCRIPT;
    let _lastSig = "";

    function sigOf(v) {
      try {
        if (v == null) return "";
        if (typeof v === "string") return "str:" + v.slice(0, 120);
        return "obj:" + JSON.stringify(v).slice(0, 240);
      } catch {
        return "unk";
      }
    }

    function ingestSoon(v, reason) {
      const sig = sigOf(v);
      if (!sig || sig === _lastSig) return;
      _lastSig = sig;

      setTimeout(() => {
        try {
          if (typeof window.NG_ingestTranscript === "function") window.NG_ingestTranscript(v);
        } catch (e) {
          console.error("[EE] ingest error:", e);
        }
      }, 0);

      console.log("[EE] NG_TRANSCRIPT ingest (" + reason + ")");
    }

    try {
      Object.defineProperty(window, "NG_TRANSCRIPT", {
        configurable: true,
        get: function () { return _t; },
        set: function (v) { _t = v; ingestSoon(v, "setter"); }
      });
    } catch (e) {
      console.warn("[EE] NG_TRANSCRIPT hook failed (non-configurable).", e);
    }

    if (_t) ingestSoon(_t, "boot");
  })();

  // ---------------- Transcript JSON Loader ----------------
  (function initTranscriptJsonLoader() {
    const LS_KEY = "NG_REVERIE_TRANSCRIPT_JSON_V1";
    function $(id){ return document.getElementById(id); }

    function extractTranscriptText(obj) {
      if (typeof obj === "string") return obj;

      if (obj && typeof obj.display_text === "string" && obj.display_text.trim()) return obj.display_text;
      if (obj && typeof obj.text === "string" && obj.text.trim()) return obj.text;

      const cands = [obj?.result, obj?.output, obj?.data, obj?.transcript, obj?.transcription].filter(Boolean);
      for (const c of cands) {
        if (typeof c?.display_text === "string" && c.display_text.trim()) return c.display_text;
        if (typeof c?.text === "string" && c.text.trim()) return c.text;
      }

      const segs =
        obj?.segments || obj?.result?.segments || obj?.output?.segments || obj?.data?.segments ||
        obj?.utterances || obj?.result?.utterances || obj?.items;

      if (Array.isArray(segs) && segs.length) {
        const parts = segs.map(s =>
          (typeof s?.display_text === "string" && s.display_text.trim()) ? s.display_text :
          (typeof s?.text === "string" && s.text.trim()) ? s.text :
          (typeof s?.utterance === "string" && s.utterance.trim()) ? s.utterance :
          ""
        ).filter(Boolean);
        if (parts.length) return parts.join("\n");
      }

      return "";
    }

    function loadFromTextarea() {
      const ta = $("ta-transcript-json");
      if (!ta) return;

      const raw = (ta.value || "").trim();
      if (!raw) return;

      try { localStorage.setItem(LS_KEY, raw); } catch {}

      let parsed;
      try { parsed = JSON.parse(raw); } catch { parsed = raw; }

      const text = extractTranscriptText(parsed) || (typeof parsed === "string" ? parsed : "");
      window.NG_TRANSCRIPT = text; // âœ… sets extracted text
      console.log("[TL] NG_TRANSCRIPT set. chars:", (text || "").length);
    }

    function boot() {
      const ta = $("ta-transcript-json");
      const btn = $("btn-load-transcript-json");

      try {
        const saved = localStorage.getItem(LS_KEY);
        if (ta && saved && !ta.value.trim()) ta.value = saved;
      } catch {}

      if (btn && !btn.__NG_BOUND) {
        btn.__NG_BOUND = true;
        btn.addEventListener("click", (e) => {
          e.preventDefault();
          loadFromTextarea();
        });
      }
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", boot, { once: true });
    } else {
      boot();
    }
})();  // âœ… close Transcript Loader IIFE


  // ---------------- export global + auto init ----------------
  window.initEditorialExtraction = initEditorialExtraction;

  // EE auto-init disabled (Super Light UI uses Transcript Lines -> Byte Draft -> Final Bytes)
  // If needed for legacy tests, call: window.initEditorialExtraction() manually in console.
  if (false) {
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initEditorialExtraction, { once: true });
    } else {
      initEditorialExtraction();
    }
  }


</script>
<script src="/ng_transcript_hook_patch.js"></script>
  <script src="/ng_latest_transcript_ui.js"></script>
<script>
/* NG_SUPERLIGHT_WIRING_V1: Transcript -> Lines -> Byte Draft -> Final Bytes */
(function(){
  function $(id){ return document.getElementById(id); }
  function qsa(sel, root){ try { return Array.from((root||document).querySelectorAll(sel)); } catch (e){ return []; } }

  // --- Transcript Lines renderer ---
  window.NG_setTranscriptLines = function(lines){
    var wrap=$("ng-lines-wrap");
    var st=$("ng-lines-status");
    if(!wrap) return;
    wrap.innerHTML="";
    var arr = Array.isArray(lines)? lines: [];
    if(st) st.textContent = arr.length ? ("Lines: "+arr.length) : "No lines yet";
    for(var i=0;i<arr.length;i++){
      var t=String(arr[i]||"").trim();
      if(!t) continue;
      var row=document.createElement("label");
      row.style.display="flex"; row.style.gap="10px"; row.style.alignItems="flex-start";
      row.style.padding="6px 8px"; row.style.border="1px solid #f1f1f1"; row.style.borderRadius="10px";
      var cb=document.createElement("input");
      cb.type="checkbox"; cb.setAttribute("data-i", String(i));
cb.setAttribute("data-ng-line", t);

      cb.style.marginTop="3px";
      var sp=document.createElement("span");
      sp.textContent=t; sp.style.fontSize="13px"; sp.style.lineHeight="1.35";
      row.appendChild(cb); row.appendChild(sp);
      wrap.appendChild(row);
    }
  };

  function getSelectedLines(){
    var wrap=$("ng-lines-wrap");
    var base = (window.__NG_TLINES && Array.isArray(window.__NG_TLINES)) ? window.__NG_TLINES : [];
    if(!wrap) return [];
    var idx = qsa("input[type=checkbox][data-i]:checked", wrap)
      .map(function(cb){ return parseInt(cb.getAttribute("data-i")||"-1",10); })
      .filter(function(n){ return n>=0; });
    var out=[];
    for(var k=0;k<idx.length;k++){
      var i=idx[k];
      var t=String(base[i]||"").trim();
      if(t) out.push(t);
    }
    return out;
  }

  function selectAll(on){
    var wrap=$("ng-lines-wrap"); if(!wrap) return;
    qsa("input[type=checkbox][data-i]", wrap).forEach(function(cb){ cb.checked=!!on; });
  }

  // --- Final Bytes helpers ---
  function bytesWrapEl(){ return document.getElementById("bytesWrap") || document.getElementById("bytes-wrap"); }
  function addByteBtn(){ return document.getElementById("addByteBtn") || document.getElementById("add-byte") || document.getElementById("addByte"); }

  function getByteInputs(){
    var wrap=bytesWrapEl();
    if(!wrap) return {sp:[], ds:[], tx:[]};
    var sp=qsa('input[name="byte_speaker[]"]', wrap);
    var ds=qsa('input[name="byte_designation[]"]', wrap);
    var tx=qsa('textarea[name="byte_text[]"], input[name="byte_text[]"]', wrap);
    return {sp:sp, ds:ds, tx:tx};
  }

  function ensureRows(min){
    var safety=0;
    while(safety++<20){
      var f=getByteInputs();
      var n=Math.max(f.sp.length, f.ds.length, f.tx.length);
      if(n>=min) return n;
      var b=addByteBtn(); if(b) b.click(); else break;
    }
    var f2=getByteInputs();
    return Math.max(f2.sp.length, f2.ds.length, f2.tx.length);
  }

  function findEmptySlot(){
    var f=getByteInputs();
    var n=Math.max(f.sp.length, f.ds.length, f.tx.length);
    for(var i=0;i<n;i++){
      var a=((f.sp[i]&&f.sp[i].value)||"").trim();
      var b=((f.ds[i]&&f.ds[i].value)||"").trim();
      var c=((f.tx[i]&&f.tx[i].value)||"").trim();
      if(!a && !b && !c) return i;
      if(!a && !b && c) return i;
    }
    return n;
  }

  function fillSlot(i, speaker, desig, text){
    ensureRows(i+1);
    var f=getByteInputs();
    if(f.sp[i]) f.sp[i].value = speaker||"";
    if(f.ds[i]) f.ds[i].value = desig||"";
    if(f.tx[i]) f.tx[i].value = text||"";
  }

  function makeDraftFromSelection(){
    var sel=getSelectedLines();
    var ta=$("ng-byte-draft-text");
    var st=$("ng-byte-draft-status");
    if(!ta) return;
    ta.value = sel.join(" ");
    if(st) st.textContent = sel.length ? ("Selected: "+sel.length) : "No lines selected";
  }

  function addToFinal(){
    var ta=$("ng-byte-draft-text");
    var t=(ta && ta.value || "").trim();
    var sp=($("ng-byte-draft-speaker") && $("ng-byte-draft-speaker").value || "").trim();
    var ds=($("ng-byte-draft-desig") && $("ng-byte-draft-desig").value || "").trim();
    var st=$("ng-byte-draft-status");
    if(!t){ if(st) st.textContent="Draft is empty"; return; }
    var i=findEmptySlot();
    fillSlot(i, sp, ds, t);
    if(st) st.textContent="Added to Final Bytes (row "+(i+1)+")";
  }

  function clearDraft(){
    var ta=$("ng-byte-draft-text"); if(ta) ta.value="";
    var st=$("ng-byte-draft-status"); if(st) st.textContent="";
  }

  function bind(){
    var a=$("ng-lines-selectall"); if(a && !a.__ng){ a.__ng=1; a.addEventListener("click", function(){ selectAll(true); }); }
    var c=$("ng-lines-clear"); if(c && !c.__ng){ c.__ng=1; c.addEventListener("click", function(){ selectAll(false); }); }
    var m=$("ng-make-byte"); if(m && !m.__ng){ m.__ng=1; m.addEventListener("click", function(){ makeDraftFromSelection(); }); }
    var f=$("ng-add-final"); if(f && !f.__ng){ f.__ng=1; f.addEventListener("click", function(){ addToFinal(); }); }
    var d=$("ng-clear-draft"); if(d && !d.__ng){ d.__ng=1; d.addEventListener("click", function(){ clearDraft(); }); }
  }

  if(document.readyState==="loading") document.addEventListener("DOMContentLoaded", bind, {once:true}); else bind();
})();
</script>
<script>
/* =========================
   Bytes JSON Button (V1)
   - Adds "Copy Bytes JSON" button inside #bytesWrap
   - Uses existing window.NG_getBytesJSON()
========================= */
(function initBytesJSONButton(){
  function $(id){ return document.getElementById(id); }

  function safeStringify(obj){
    try { return JSON.stringify(obj, null, 2); }
    catch(e){ return String(obj); }
  }

  function copyText(text){
    if (navigator && navigator.clipboard && typeof navigator.clipboard.writeText === "function") {
      return navigator.clipboard.writeText(text);
    }
    return new Promise(function(resolve){
      var ta = document.createElement("textarea");
      ta.value = text;
      ta.setAttribute("readonly", "readonly");
      ta.style.position = "fixed";
      ta.style.top = "-1000px";
      ta.style.left = "-1000px";
      document.body.appendChild(ta);
      ta.focus();
      ta.select();
      try { document.execCommand("copy"); } catch(e) {}
      document.body.removeChild(ta);
      resolve();
    });
  }
function ensureBytesJSONUI(){

    var wrap = document.getElementById("bytesWrap"); // If your HTML uses a different id, change it here.

    if (document.getElementById("bytesJSONBox")) return true;


    var box = document.createElement("div");
    box.id = "bytesJSONBox";
    box.style.margin = "10px 0";
    box.style.padding = "10px";
    box.style.border = "1px solid #e5e5e5";
    box.style.borderRadius = "10px";
    box.style.background = "#fafafa";

    var bar = document.createElement("div");
    bar.style.display = "flex";
    bar.style.gap = "8px";
    bar.style.alignItems = "center";
    bar.style.flexWrap = "wrap";

    var btn = document.createElement("button");
    btn.type = "button";
    btn.id = "btnBytesJSON";
    btn.textContent = "Copy Bytes JSON";
    btn.style.padding = "8px 10px";
    btn.style.cursor = "pointer";








    var hint = document.createElement("span");
    hint.id = "bytesJSONHint";
    hint.textContent = "";
    hint.style.fontSize = "12px";
    hint.style.opacity = "0.8";

    var out = document.createElement("textarea");
    out.id = "bytesJSONOut";
    out.readOnly = true;
    out.rows = 8;
    out.style.width = "100%";
    out.style.marginTop = "10px";
    out.style.display = "none";
    out.style.fontFamily = "ui-monospace, Menlo, Consolas, monospace";

    bar.appendChild(btn);
    // btnToggle removed
    bar.appendChild(hint);

    box.appendChild(bar);
    box.appendChild(out);

    wrap.insertBefore(box, wrap.firstChild);

    btn.addEventListener("click", function(){
      var getFn = window.NG_getBytesJSON;
      if (typeof getFn !== "function") {
        hint.textContent = "NG_getBytesJSON() not found";
        console.warn("[BYTES JSON] NG_getBytesJSON() not found");
        return;
      }

      var data = getFn();
      var json = safeStringify(data);

      out.value = json;
      out.style.display = "block";
      // toggle removed; keep output visible

      try { localStorage.setItem("NG_LAST_BYTES_JSON_V1", json); } catch(e) {}

      var old = btn.textContent;
      btn.textContent = "Copying...";

      copyText(json).then(function(){
        btn.textContent = "Copied";
        hint.textContent = "Copied to clipboard";
        setTimeout(function(){
          btn.textContent = old;
          hint.textContent = "";
        }, 1200);
      });
    });







    return true;
  }
if (typeof ensureDigiPackUI === "function") window.ensureDigiPackUI = ensureDigiPackUI;






  function boot(){
    var tries = 0;
    var t = setInterval(function(){
      tries++;
      if (ensureBytesJSONUI() || tries >= 20) clearInterval(t);

    }, 200);
  }

    // âœ… force-create Bytes JSON UI once
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", ensureBytesJSONUI, { once: true });
  } else {
    ensureBytesJSONUI();
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", boot);
  } else {
    boot();
  }
})();
</script>

<script>
/* =========================
   DIGI_PACK Draft + Library + Published (V1) â€” CLEAN REPLACE
   - Restores: Copy Bytes JSON, Save Draft, Library, Mark Published, New Story
   - Stores form + bytes JSON in localStorage
========================= */
(function initDigiPackDrafts(){
  var LS_DRAFTS   = "NG_DIGIPACK_DRAFTS_V1";
  var LS_CURRENT  = "NG_DIGIPACK_CURRENT_ID_V1";

  function $(id){ return document.getElementById(id); }

  function safeJSONParse(s, fallback){
    try { return JSON.parse(s); } catch(e){ return fallback; }
  }
  function safeJSONStringify(o, fallback){
    try { return JSON.stringify(o, null, 2); } catch(e){ return fallback || ""; }
  }
  function nowISO(){
    try { return new Date().toISOString(); } catch(e){ return String(Date.now()); }
  }

  function copyText(txt){
    txt = (txt == null) ? "" : String(txt);
    if (!txt) return false;

    if (navigator && navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(txt).catch(function(){});
      return true;
    }
    // fallback
    var ta = document.createElement("textarea");
    ta.value = txt;
    ta.style.position = "fixed";
    ta.style.left = "-9999px";
    document.body.appendChild(ta);
    ta.select();
    try { document.execCommand("copy"); } catch(e){}
    document.body.removeChild(ta);
    return true;
  }
function fillQuickViewV2(g){
  function pick(selList){
    for (var i=0;i<selList.length;i++){
      var el = document.querySelector(selList[i]);
      if (el) return el;
    }
    return null;
  }
  function toLines(v){
    if (!v) return [];
    if (Array.isArray(v)) return v.map(function(x){ return String(x || "").trim(); }).filter(Boolean);
    if (typeof v === "string") return v.split(/\n+/).map(function(s){ return s.trim(); }).filter(Boolean);
    return [String(v)];
  }

  var headline = (g.headline || "").trim();
  var dek      = (g.dek || "").trim();
  var bullets  = toLines(g.bullet_points);
  var vo       = toLines(g.vo_lines);
  var tags     = toLines(g.hashtags).join(" ");
  var caution  = (g.caution || "").trim();

  var out = "";
  if (headline) out += "Headline: " + headline + "\n";
  if (dek)      out += "Dek: " + dek + "\n";
  if (bullets.length){
    out += "Key Points:\n" + bullets.map(function(x){ return "- " + x; }).join("\n") + "\n";
  }
  if (vo.length){
    out += "VO Lines:\n" + vo.map(function(x){ return "â€¢ " + x; }).join("\n") + "\n";
  }
  if (tags)     out += "Hashtags: " + tags + "\n";
  if (caution)  out += "Caution: " + caution + "\n";

  // âœ… Try common Quick View targets (works even if your id differs)
  var qv = pick(["#quickView", "#quick-view", "#ta-quick-view", "#taQuickView", "textarea[name='quick_view']"]);
  if (qv){
    if ("value" in qv) qv.value = out.trim();
    else qv.textContent = out.trim();
  }
}

  function getDrafts(){
    return safeJSONParse(localStorage.getItem(LS_DRAFTS) || "[]", []);
  }
  function setDrafts(arr){
    localStorage.setItem(LS_DRAFTS, safeJSONStringify(arr, "[]"));
  }
  function getCurrentId(){
    return localStorage.getItem(LS_CURRENT) || "";
  }
  function setCurrentId(id){
    if (!id) localStorage.removeItem(LS_CURRENT);
    else localStorage.setItem(LS_CURRENT, id);
  }

  function formToObject(form){
    var out = {};
    if (!form) return out;

    var fd = new FormData(form);
    fd.forEach(function(v, k){
      // handle repeated fields
      if (out.hasOwnProperty(k)) {
        if (!Array.isArray(out[k])) out[k] = [out[k]];
        out[k].push(String(v));
      } else {
        out[k] = String(v);
      }
    });
    return out;
  }

  function getBytesJSON(){
    try {
      if (typeof window.NG_getBytesJSON === "function") {
        return window.NG_getBytesJSON(); // expected object
      }
    } catch(e){}
    return null;
  }

  function clearBytesUI(){
    try {
      // clear common bytes fields if present
      var sp = document.querySelectorAll('input[name="byte_speaker[]"]');
      var ds = document.querySelectorAll('input[name="byte_designation[]"]');
      var tx = document.querySelectorAll('input[name="byte_text[]"], textarea[name="byte_text[]"]');
      var i;
      for(i=0;i<sp.length;i++) sp[i].value = "";
      for(i=0;i<ds.length;i++) ds[i].value = "";
      for(i=0;i<tx.length;i++) tx[i].value = "";
    } catch(e){}
  }

  function clearForm(form){
    if (!form) return;
    try { form.reset(); } catch(e){}
    // also clear textareas explicitly (some UIs keep them)
    try {
      var tas = form.querySelectorAll("textarea");
      for (var i=0;i<tas.length;i++) tas[i].value = "";
    } catch(e){}
  }

  function ensureActionBar(){
    // If buttons already exist, don't duplicate. Just bind later.
    if ($("btn-copy-bytes-json") || $("btn-save-draft") || $("btn-open-library") || $("btn-mark-published") || $("btn-new-story")) {
      return;
    }

    var form = $("digi-pack-form");
    if (!form) return;

    var bar = document.createElement("div");
    bar.id = "ng-dp-actions";
    bar.style.display = "flex";
    bar.style.gap = "8px";
    bar.style.flexWrap = "wrap";
    bar.style.margin = "10px 0";
    bar.style.alignItems = "center";

    function mkBtn(id, label){
      var b = document.createElement("button");
      b.type = "button";
      b.id = id;
      b.textContent = label;
      b.style.padding = "8px 10px";
      b.style.border = "1px solid #999";
      b.style.borderRadius = "8px";
      b.style.cursor = "pointer";
      b.style.background = "#f7f7f7";
      return b;
    }

    bar.appendChild(mkBtn("btn-copy-bytes-json", "Copy Bytes JSON"));
    bar.appendChild(mkBtn("btn-save-draft", "Save Draft"));
    bar.appendChild(mkBtn("btn-open-library", "Library"));
    bar.appendChild(mkBtn("btn-mark-published", "Mark Published"));
    bar.appendChild(mkBtn("btn-new-story", "New Story"));

    // insert before form
    form.parentNode.insertBefore(bar, form);
  }

  function showLibraryModal(){
    var drafts = getDrafts();

    // overlay
    var ov = document.createElement("div");
    ov.id = "ng-dp-lib-ov";
    ov.style.position = "fixed";
    ov.style.left = "0";
    ov.style.top = "0";
    ov.style.right = "0";
    ov.style.bottom = "0";
    ov.style.background = "rgba(0,0,0,0.35)";
    ov.style.zIndex = "9999";
    ov.style.display = "flex";
    ov.style.alignItems = "center";
    ov.style.justifyContent = "center";
    ov.addEventListener("click", function(e){
      if (e && e.target === ov) document.body.removeChild(ov);
    });

    var box = document.createElement("div");
    box.style.width = "min(900px, 92vw)";
    box.style.maxHeight = "80vh";
    box.style.overflow = "auto";
    box.style.background = "#fff";
    box.style.borderRadius = "14px";
    box.style.padding = "14px";
    box.style.boxShadow = "0 10px 30px rgba(0,0,0,0.25)";

    var h = document.createElement("div");
    h.style.display = "flex";
    h.style.justifyContent = "space-between";
    h.style.alignItems = "center";

    var title = document.createElement("div");
    title.textContent = "Draft Library";
    title.style.fontWeight = "700";
    title.style.fontSize = "16px";

    var close = document.createElement("button");
    close.type = "button";
    close.textContent = "Close";
    close.style.padding = "6px 10px";
    close.style.border = "1px solid #999";
    close.style.borderRadius = "10px";
    close.style.cursor = "pointer";
    close.addEventListener("click", function(){ document.body.removeChild(ov); });

    h.appendChild(title);
    h.appendChild(close);

    var list = document.createElement("div");
    list.style.marginTop = "10px";

    if (!drafts.length) {
      var empty = document.createElement("div");
      empty.textContent = "No drafts saved yet.";
      empty.style.opacity = "0.8";
      list.appendChild(empty);
    } else {
      for (var i=0;i<drafts.length;i++){
        (function(d){
          var row = document.createElement("div");
          row.style.display = "flex";
          row.style.gap = "10px";
          row.style.alignItems = "center";
          row.style.border = "1px solid #ddd";
          row.style.borderRadius = "12px";
          row.style.padding = "10px";
          row.style.marginBottom = "8px";

          var meta = document.createElement("div");
          meta.style.flex = "1";
          meta.innerHTML =
            "<div style='font-weight:700'>" + (d.title || ("Draft " + d.id)) + "</div>" +
            "<div style='opacity:.75;font-size:12px'>Saved: " + (d.updated_at || d.created_at || "") +
            (d.status ? (" â€¢ " + d.status) : "") + "</div>";

          function btn(lbl){
            var b = document.createElement("button");
            b.type = "button";
            b.textContent = lbl;
            b.style.padding = "6px 10px";
            b.style.border = "1px solid #999";
            b.style.borderRadius = "10px";
            b.style.cursor = "pointer";
            return b;
          }

          var bLoad = btn("Load");
          bLoad.addEventListener("click", function(){
            var form = $("digi-pack-form");
            if (form && d.form) {
              // restore via name= keys
              Object.keys(d.form).forEach(function(k){
                var v = d.form[k];
                // support array fields
                if (Array.isArray(v)) {
                  var els = form.querySelectorAll('[name="'+k+'"]');
                  for (var j=0;j<els.length && j<v.length;j++){
                    try { els[j].value = String(v[j]); } catch(e){}
                  }
                } else {
                  var el = form.querySelector('[name="'+k+'"]');
                  if (el) { try { el.value = String(v); } catch(e){} }
                }
              });
            }
            setCurrentId(d.id || "");
            document.body.removeChild(ov);
            alert("Draft loaded.");
          });

          var bDel = btn("Delete");
          bDel.addEventListener("click", function(){
            var all = getDrafts();
            var kept = [];
            for (var x=0;x<all.length;x++){
              if (all[x] && all[x].id !== d.id) kept.push(all[x]);
            }
            setDrafts(kept);
            document.body.removeChild(ov);
            showLibraryModal();
          });

          row.appendChild(meta);
          row.appendChild(bLoad);
          row.appendChild(bDel);
          list.appendChild(row);
        })(drafts[i]);
      }
    }

    box.appendChild(h);
    box.appendChild(list);
    ov.appendChild(box);
    document.body.appendChild(ov);
  }

  function bindButtons(){
    var form = $("digi-pack-form");

    var btnCopy = $("btn-copy-bytes-json");
    if (btnCopy) btnCopy.addEventListener("click", function(){
      var bj = getBytesJSON();
      var txt = safeJSONStringify(bj || {}, "{}");
      copyText(txt);
      alert("Bytes JSON copied.");
    });

    var btnSave = $("btn-save-draft");
    if (btnSave) btnSave.addEventListener("click", function(){
      var drafts = getDrafts();
      var id = getCurrentId();
      var formObj = formToObject(form);
      var bytesObj = getBytesJSON();
      var title = (formObj.topic || formObj.Topic || formObj.title || formObj.headline || "").trim();
      if (!title) title = "Untitled Draft";

      var found = null;
      for (var i=0;i<drafts.length;i++){
        if (drafts[i] && drafts[i].id === id) { found = drafts[i]; break; }
      }
      if (!found) {
        id = "D" + Date.now();
        found = { id: id, created_at: nowISO() };
        drafts.unshift(found);
      }
      found.title = title;
      found.form = formObj;
      found.bytes = bytesObj;
      found.updated_at = nowISO();
      found.status = found.status || "draft";

      setDrafts(drafts);
      setCurrentId(id);
      alert("Draft saved.");
    });

    var btnLib = $("btn-open-library");
    if (btnLib) btnLib.addEventListener("click", function(){
      showLibraryModal();
    });

    var btnPub = $("btn-mark-published");
    if (btnPub) btnPub.addEventListener("click", function(){
      var drafts = getDrafts();
      var id = getCurrentId();
      if (!id) { alert("No current draft. Save first."); return; }
      for (var i=0;i<drafts.length;i++){
        if (drafts[i] && drafts[i].id === id) {
          drafts[i].status = "published";
          drafts[i].published_at = nowISO();
          drafts[i].updated_at = nowISO();
          setDrafts(drafts);
setCurrentId(drafts[i].id || drafts[i].uid || "");

          alert("Marked published.");
          return;
        }
      }
      alert("Draft not found. Save first.");
    });

    var btnNew = $("btn-new-story");
    if (btnNew) btnNew.addEventListener("click", function(){
      setCurrentId("");
      clearForm(form);
      clearBytesUI();
      alert("New story started.");
    });
  }

  function boot(){
    ensureActionBar();
    bindButtons();
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", boot, { once: true });
  } else {
    boot();
  }
})();
</script>

<script>
(function(){
  function esc(s){
    s = (s == null) ? "" : String(s);
    return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;");
  }

  function pickPack(data){
    if (data && data.digi_pack) return data.digi_pack;
    return data || {};
  }

  function ensureQuickBox(){
    var quick = document.getElementById("ngQuick");
    if (!quick) {
      quick = document.createElement("div");
      quick.id = "ngQuick";
      quick.style.border = "1px solid #ddd";
      quick.style.padding = "12px";
      quick.style.borderRadius = "10px";
      quick.style.margin = "12px 0";
      quick.style.background = "#fff";

      var where =
        document.getElementById("ngResponse") ||
        document.getElementById("ngStatus") ||
        document.body;

      where.insertAdjacentElement("beforebegin", quick);
    }

    var body = document.getElementById("ngQuickBody");
    if (!body) {
      quick.innerHTML =
        "<div style='font-weight:700; margin-bottom:8px;'>Quick View</div>" +
        "<div id='ngQuickBody' style='opacity:.75'>(no quick view)</div>";
      body = document.getElementById("ngQuickBody");
    }
    return body;
  }

  // âœ… GLOBAL: this is what your fetch-block will call
  window.renderQuickView = function(data){
    window.__NG_LAST_API_RESPONSE = data;

    var pack = pickPack(data);
    var web = pack.web || {};
    var video = pack.video || {};
    var social = pack.social || {};

    var body = ensureQuickBox();
    if (!body) return;

    body.innerHTML =
      "<div style='display:flex;gap:10px;flex-wrap:wrap;margin-bottom:8px;'>" +
        "<div><span style='opacity:.7'>Topic:</span> <b>" + esc(pack.topic||"") + "</b></div>" +
        "<div><span style='opacity:.7'>Angle:</span> <b>" + esc(pack.angle||"") + "</b></div>" +
        "<div><span style='opacity:.7'>Type:</span> <b>" + esc(pack.story_type||"") + "</b></div>" +
      "</div>" +

      "<div style='margin-top:10px;font-weight:700;'>WEB</div>" +
      "<div><b>Headline:</b> " + esc(web.headline||"") + "</div>" +
      "<div style='margin-top:4px;'><b>Dek:</b> " + esc(web.dek||"") + "</div>" +
      "<div style='margin-top:4px;'><b>Sources:</b> " + esc(web.sources||"") + "</div>" +

      "<div style='margin-top:10px;font-weight:700;'>VIDEO</div>" +
      "<div><b>Hook:</b> " + esc(video.hook||"") + "</div>" +

      "<div style='margin-top:10px;font-weight:700;'>SOCIAL</div>" +
      "<div><b>Caption:</b> " + esc(social.caption||"") + "</div>";
  };
})();
</script>
<script>
/* =========================
   New Story Reset Handler (V2 CLEAN)
   Fixes: script#7 Unexpected end of input
   Purpose: New Story -> clear form, bytes, previews, current draft id
========================= */
(function bindNewStoryOnce(){
  if (window.__NG_NEW_STORY_BOUND) return;
  window.__NG_NEW_STORY_BOUND = true;

  function qs(sel){ try { return document.querySelector(sel); } catch(e){ return null; } }
  function qsa(sel){ try { return document.querySelectorAll(sel); } catch(e){ return []; } }

  function clearControl(el){
    if (!el) return;
    try {
      if (el.type === "checkbox" || el.type === "radio") el.checked = false;
      else el.value = "";
    } catch(e){}
  }

  function clearBySelector(sel){
    var els = qsa(sel);
    for (var i=0;i<els.length;i++) clearControl(els[i]);
  }

  function clearDigiForm(){
    // IDs (if present)
    clearBySelector("#topic");
    clearBySelector("#angle");
    clearBySelector("#whatHappened");
    clearBySelector("#sources");
    clearBySelector("#background");

    // Common name= fields (if present)
    clearBySelector('input[name="topic"]');
    clearBySelector('input[name="angle"]');
    clearBySelector('textarea[name="what_happened"]');
    clearBySelector('textarea[name="sources"]');
    clearBySelector('textarea[name="background"]');

    // Transcript JSON textarea (if present)
    clearBySelector("#ta-transcript-json");

    // Previews / response panes
    var pre = document.getElementById("ngResponse");
    if (pre) pre.textContent = "(no response yet)";
    var qb = document.getElementById("ngQuickBody");
    if (qb) qb.innerHTML = "(no quick view)";
  }

  function clearBytesUI(){
    // If you already have a bytes reset helper, prefer it
    try {
      if (typeof window.NG_clearBytesUI === "function") { window.NG_clearBytesUI(); return; }
    } catch(e){}

    // Otherwise clear common bytes inputs
    clearBySelector('input[name="byte_speaker[]"]');
    clearBySelector('input[name="byte_designation[]"]');
    clearBySelector('input[name="byte_text[]"]');
    clearBySelector('textarea[name="byte_text[]"]');
  }

  function resetDraftState(){
    try { localStorage.removeItem("NG_DIGIPACK_CURRENT_ID_V1"); } catch(e){}
    try { localStorage.removeItem("NG_DP_FORM_SNAPSHOT_V1"); } catch(e){}
    window.__NG_LAST_API_RESPONSE = null;
  }

  function doNewStory(){
    clearDigiForm();
    clearBytesUI();
    resetDraftState();
    try { window.scrollTo(0,0); } catch(e){}
    try { console.log("[NG] New Story: cleared form + bytes + previews"); } catch(e){}
  }

  function findButtonFromTarget(t){
    var el = t;
    for (var i=0;i<6 && el;i++){
      if (el.tagName === "BUTTON") return el;
      el = el.parentNode;
    }
    return null;
  }

  function bindDirectButton(){
    // Prefer IDs used by your UI
    var btn =
      document.getElementById("btn-new-story") ||
      document.getElementById("newStoryBtn") ||
      document.getElementById("btnNewStory") ||
      null;

    if (btn && !btn.__ng_new_story_bound) {
      btn.__ng_new_story_bound = true;
      btn.addEventListener("click", function(e){
        try { if (e && e.preventDefault) e.preventDefault(); } catch(_e){}
        doNewStory();
      });
    }
  }

  // Capture click so it works even if button is injected later
  document.addEventListener("click", function(e){
    var t = e && e.target;
    if (!t) return;

    var btn = findButtonFromTarget(t);
    if (!btn) return;

    var id = btn.id || "";
    if (id === "btn-new-story" || id === "newStoryBtn" || id === "btnNewStory") {
      try { if (e && e.preventDefault) e.preventDefault(); } catch(_e){}
      doNewStory();
    }
  }, true);

  function boot(){
    bindDirectButton();
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", boot, { once: true });
  } else {
    boot();
  }

  // Expose manual rebind (optional)
  window.bindNewStoryOnce = function(){ try { bindDirectButton(); return true; } catch(e){ return false; } };

})();

/* === NG DigiPack Capture + SaveDraft Patch + Library Download FULL DIGIPACK (V2) === */
(function () {
  if (window.__NG_DIGIPACK_V2) {
    console.log("[NG_DIGIPACK_V2] already installed");
    return;
  }
  window.__NG_DIGIPACK_V2 = true;

  function safeStr(v) { return (v == null) ? "" : String(v); }
  function safeTrim(v) { return safeStr(v).replace(/^\s+|\s+$/g, ""); }
  function nowISO() { try { return new Date().toISOString(); } catch (e) { return ""; } }

  function lsGet(key, fallback) {
    try {
      var raw = localStorage.getItem(key);
      if (!raw) return fallback;
      return JSON.parse(raw);
    } catch (e) { return fallback; }
  }
  function lsSet(key, val) {
    try { localStorage.setItem(key, JSON.stringify(val)); return true; }
    catch (e) { return false; }
  }

  function slug(s) {
    s = safeTrim(s).toLowerCase();
    s = s.replace(/[^a-z0-9\u0900-\u097f]+/g, "_");
    s = s.replace(/^_+|_+$/g, "");
    return s || "story";
  }

  /* -----------------------------
     A) Capture last DigiPack reliably
     - Prefer response from /api/digi-pack (fetch wrapper)
     - Fallback: scan DOM for "FULL DIGIPACK"
  ------------------------------ */

  function normalizePack(obj) {
    if (!obj) return null;

    // if obj is already a string
    if (typeof obj === "string") {
      return { raw: obj, blocks: { full_digipack: obj }, source: "string", ts: nowISO() };
    }

    // pick likely locations
    var blocks =
      (obj && obj.blocks) ||
      (obj && obj.digipack && obj.digipack.blocks) ||
      (obj && obj.digipack) ||
      obj;

    var raw =
      (obj && obj.raw) ||
      (obj && obj.digipack && obj.digipack.raw) ||
      "";

    // if still no raw, stringify blocks
    if (!raw) {
      try { raw = JSON.stringify(blocks, null, 2); } catch (e) { raw = ""; }
    }

    return { raw: safeStr(raw), blocks: blocks || {}, source: "object", ts: nowISO() };
  }

  // Fetch wrapper: capture /api/digi-pack response JSON into window.NG_LAST_DIGIPACK*
  (function wrapFetch() {
    var _fetch = window.fetch;
    if (typeof _fetch !== "function") return;

    window.fetch = function (input, init) {
      var p = _fetch.apply(this, arguments);

      try {
        var url = "";
        if (typeof input === "string") url = input;
        else if (input && input.url) url = input.url;

        if (url && /\/api\/digi-pack\b/.test(url)) {
          p.then(function (res) {
            try {
              var clone = res.clone();
              clone.json().then(function (j) {
                var cap = normalizePack(j);
                if (!cap) return;
                window.NG_LAST_DIGIPACK = j;
                window.NG_LAST_DIGIPACK_CAP = cap;
                window.NG_LAST_DIGIPACK_TS = cap.ts;
                // convenience
                window.NG_LAST_DIGIPACK_RAW = cap.raw;
                console.log("[NG_DIGIPACK_V2] captured from fetch", {
                  rawLen: cap.raw ? cap.raw.length : 0
                });
              }).catch(function () {});
            } catch (e) {}
          }).catch(function () {});
        }
      } catch (e) {}

      return p;
    };

    console.log("[NG_DIGIPACK_V2] fetch wrapper installed");
  })();

  function pickText(selector) {
    var el = document.querySelector(selector);
    if (!el) return "";
    if (typeof el.value !== "undefined") return safeStr(el.value);
    return safeStr(el.textContent);
  }

  // Heuristic: find "FULL DIGIPACK" label and capture nearest pre/textarea block
  function captureFromDOMHeuristic() {
    var nodes = document.querySelectorAll("h1,h2,h3,h4,div,span,strong,b");
    var i, t;
    for (i = 0; i < nodes.length; i++) {
      t = safeTrim(nodes[i].textContent || "");
      if (!t) continue;
      if (t.toUpperCase().indexOf("FULL DIGIPACK") !== -1) {
        // try next sibling
        var sib = nodes[i].nextElementSibling;
        if (sib) {
          var cand = sib.querySelector ? sib.querySelector("pre,textarea") : null;
          if (cand) {
            var raw = safeTrim(pickText("pre,textarea"));
            if (raw) return { raw: raw, blocks: { full_digipack: raw }, source: "dom_heading", ts: nowISO() };
          }
          var raw2 = safeTrim(sib.textContent || "");
          if (raw2) return { raw: raw2, blocks: { full_digipack: raw2 }, source: "dom_heading_text", ts: nowISO() };
        }
        // try within same parent
        var p = nodes[i].parentNode;
        if (p && p.querySelector) {
          var cand2 = p.querySelector("pre,textarea");
          if (cand2) {
            var raw3 = safeTrim(cand2.value || cand2.textContent || "");
            if (raw3) return { raw: raw3, blocks: { full_digipack: raw3 }, source: "dom_parent", ts: nowISO() };
          }
        }
      }
    }

    // extra direct IDs (safe)
    var rawX =
      safeTrim(pickText("#full-digipack")) ||
      safeTrim(pickText("#digipack-raw")) ||
      safeTrim(pickText("#out-digipack")) ||
      "";

    if (rawX) return { raw: rawX, blocks: { full_digipack: rawX }, source: "dom_ids", ts: nowISO() };
    return null;
  }

  function captureDigiPackNow() {
    // Prefer fetch-captured pack (most reliable)
    if (window.NG_LAST_DIGIPACK_CAP && window.NG_LAST_DIGIPACK_CAP.raw) return window.NG_LAST_DIGIPACK_CAP;
    // Fallback: dom heuristic
    var domCap = captureFromDOMHeuristic();
    if (domCap && domCap.raw) return domCap;
    return null;
  }

  /* -----------------------------
     B) On Save Draft: patch NG_DRAFTS[last].story.digipack.raw/blocks
  ------------------------------ */

  function patchLastDraft(cap) {
    if (!cap) return false;

    var drafts = lsGet("NG_DRAFTS", []);
    if (!drafts || !drafts.length) return false;

    var idx = drafts.length - 1;
    var last = drafts[idx];
    if (!last) return false;

    if (!last.story) last.story = {};
    if (!last.story.digipack) last.story.digipack = {};

    last.story.digipack.raw = safeStr(cap.raw || "");
    last.story.digipack.blocks = cap.blocks || {};
    last.story.digipack.ts = cap.ts || nowISO();
    last.story.digipack.source = cap.source || "unknown";

    // helpful mirrors (old exporters often read these)
    last.story.full_digipack = safeStr(cap.raw || "");
    last.story.digipack_raw = safeStr(cap.raw || "");

    drafts[idx] = last;
    return lsSet("NG_DRAFTS", drafts);
  }

  document.addEventListener("click", function (e) {
    var t = e && e.target;
    if (!t) return;

    // recognize click on the Save Draft button or its children
    var btn = document.getElementById("btn-save-draft");
    if (!btn) return;
    if (!(t === btn || (btn.contains && btn.contains(t)))) return;

    var cap = captureDigiPackNow();
    window.__NG_PENDING_DIGIPACK = cap;

    // let app save draft first, then patch localStorage
    setTimeout(function () {
      var ok = patchLastDraft(window.__NG_PENDING_DIGIPACK);
      console.log("[NG_DIGIPACK_V2] SaveDraft patched =", ok, {
        hasCap: !!window.__NG_PENDING_DIGIPACK,
        rawLen: window.__NG_PENDING_DIGIPACK ? safeStr(window.__NG_PENDING_DIGIPACK.raw).length : 0,
        source: window.__NG_PENDING_DIGIPACK ? window.__NG_PENDING_DIGIPACK.source : ""
      });
    }, 350);
  }, true);

  window.NG_debugLastDraftDigipack = function () {
    var drafts = lsGet("NG_DRAFTS", []);
    var last = (drafts && drafts.length) ? drafts[drafts.length - 1] : null;
    var raw = "";
    if (last && last.story && last.story.digipack) raw = safeStr(last.story.digipack.raw);
    return { drafts: drafts.length, rawLen: raw.length, last: last };
  };

  /* -----------------------------
     C) Library Download TXT/JSON: export FULL DIGIPACK per selected story
     - Intercepts clicks on any "Download TXT/JSON" button/link inside Library
  ------------------------------ */

  function findSelectedDraftIndex() {
    // Common selection markers
    var sel =
      document.querySelector('[data-draft-index].selected') ||
      document.querySelector('[data-draft-idx].selected') ||
      document.querySelector('.draft-row.selected') ||
      document.querySelector('.draft-row.active') ||
      document.querySelector('[aria-selected="true"][data-draft-index]') ||
      document.querySelector('[aria-selected="true"][data-draft-idx]') ||
      null;

    if (sel) {
      var v = sel.getAttribute("data-draft-index");
      if (v == null) v = sel.getAttribute("data-draft-idx");
      var n = parseInt(v, 10);
      if (!isNaN(n)) return n;
    }

    // Common radio patterns
    var r =
      document.querySelector('input[type="radio"][name="draft_pick"]:checked') ||
      document.querySelector('input[type="radio"][name="ng_draft_pick"]:checked') ||
      document.querySelector('input[type="radio"][name*="draft"]:checked') ||
      null;

    if (r && r.value != null) {
      var n2 = parseInt(r.value, 10);
      if (!isNaN(n2)) return n2;
    }

    return null; // unknown
  }

  function getDraftByIndex(idxMaybe) {
    var drafts = lsGet("NG_DRAFTS", []);
    if (!drafts || !drafts.length) return null;
    var idx = idxMaybe;
    if (idx == null || idx < 0 || idx >= drafts.length) idx = drafts.length - 1;
    return drafts[idx] || null;
  }

  function ensureDraftHasDigipack(draft) {
    if (!draft) return draft;
    if (!draft.story) draft.story = {};
    if (!draft.story.digipack) draft.story.digipack = {};

    var raw = safeStr(draft.story.digipack.raw || draft.story.full_digipack || "");
    if (!raw) {
      // last fallback: current captured pack (NOT ideal, but better than empty)
      var cap = captureDigiPackNow();
      if (cap && cap.raw) {
        raw = cap.raw;
        draft.story.digipack.raw = raw;
        draft.story.digipack.blocks = cap.blocks || {};
        draft.story.digipack.ts = cap.ts || nowISO();
        draft.story.digipack.source = "fallback_current";
      }
    }
    return draft;
  }

  function makeTXT(draft) {
    draft = ensureDraftHasDigipack(draft);

    var story = draft && draft.story ? draft.story : {};
    var headline = safeTrim(story.headline || draft.headline || story.title || draft.title || "");
    var status = safeTrim(draft.status || story.status || "");
    var saved = safeTrim(draft.saved || draft.ts || draft.saved_at || "");

    var out = [];
    out.push("NEWSGENIE DIGIPACK");
    out.push("--------------------------------");
    out.push("Headline: " + (headline || "(no headline)"));
    if (status) out.push("Status: " + status);
    if (saved) out.push("Saved: " + saved);

    // Quotes/SOT if present
    var quotes = story.quotes || story.sot || story.sots || [];
    var qn = (quotes && quotes.length) ? quotes.length : 0;
    out.push("");
    out.push("QUOTES / SOT (" + qn + ")");
    if (!qn) out.push("(No SOT saved)");
    else {
      for (var i = 0; i < quotes.length; i++) {
        var q = quotes[i] || {};
        var line = "- " + safeTrim(q.speaker || q.name || "Speaker") + ": " + safeTrim(q.text || q.quote || "");
        out.push(line);
      }
    }

    out.push("");
    out.push("FULL DIGIPACK");
    out.push("--------------------------------");

    var raw = safeTrim(story.digipack && story.digipack.raw);
    if (!raw && story.digipack && story.digipack.blocks) {
      try { raw = JSON.stringify(story.digipack.blocks, null, 2); } catch (e) { raw = ""; }
    }
    out.push(raw || "(No generated pack saved yet. Generate outputs, then click Save Draft.)");

    return out.join("\n");
  }

  function makeJSON(draft) {
    draft = ensureDraftHasDigipack(draft);
    try { return JSON.stringify(draft, null, 2); }
    catch (e) { return JSON.stringify({ error: "stringify_failed" }); }
  }

  function downloadFile(filename, content, mime) {
    try {
      var blob = new Blob([content], { type: mime || "text/plain;charset=utf-8" });
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(function () {
        try { URL.revokeObjectURL(url); } catch (e) {}
        try { document.body.removeChild(a); } catch (e2) {}
      }, 200);
      return true;
    } catch (e) {
      console.warn("[NG_DIGIPACK_V2] download failed", e);
      return false;
    }
  }

  function isDownloadCandidate(el) {
    if (!el) return false;
    var tag = el.tagName;
    if (tag !== "BUTTON" && tag !== "A") return false;

    var id = (el.id || "").toLowerCase();
    var tx = (el.textContent || "").toLowerCase();

    // Must look like a download action
    if (id.indexOf("download") === -1 && tx.indexOf("download") === -1) return false;

    // Must mention txt/json somewhere
    if (tx.indexOf("txt") !== -1) return "txt";
    if (tx.indexOf("json") !== -1) return "json";
    if (id.indexOf("txt") !== -1) return "txt";
    if (id.indexOf("json") !== -1) return "json";

    return false;
  }

  // Intercept downloads in capture-phase so existing handler doesn't override
  document.addEventListener("click", function (e) {
    var t = e && e.target;
    if (!t) return;

    // climb up a few levels (svg/span inside button)
    var el = t, kind = false, i;
    for (i = 0; i < 5 && el && el !== document; i++) {
      kind = isDownloadCandidate(el);
      if (kind) break;
      el = el.parentNode;
    }
    if (!kind) return;

    // stop old handler and do our export
    if (e.preventDefault) e.preventDefault();
    if (e.stopImmediatePropagation) e.stopImmediatePropagation();
    if (e.stopPropagation) e.stopPropagation();

    var idx = findSelectedDraftIndex();
    var draft = getDraftByIndex(idx);

    if (!draft) {
      console.warn("[NG_DIGIPACK_V2] No drafts found for download");
      return;
    }

    var story = draft.story || {};
    var headline = safeTrim(story.headline || draft.headline || story.title || draft.title || "");
    var base = "NG_" + slug(headline) + "_" + safeStr((draft.saved || draft.ts || "").slice(0, 10));

    if (kind === "txt") {
      var txt = makeTXT(draft);
      downloadFile(base + "_DIGIPACK.txt", txt, "text/plain;charset=utf-8");
      console.log("[NG_DIGIPACK_V2] Download TXT exported", { idx: idx, rawLen: txt.length });
    } else {
      var js = makeJSON(draft);
      downloadFile(base + "_STORY.json", js, "application/json;charset=utf-8");
      console.log("[NG_DIGIPACK_V2] Download JSON exported", { idx: idx, jsonLen: js.length });
    }
  }, true);

  // Debug helper: lists download-like buttons currently in DOM
  window.NG_listDownloadButtons = function () {
    var els = Array.from(document.querySelectorAll("button,a"));
    var hits = [];
    for (var i = 0; i < els.length; i++) {
      var id = (els[i].id || "").toLowerCase();
      var tx = (els[i].textContent || "").toLowerCase();
      if ((id.indexOf("download") !== -1) || (tx.indexOf("download") !== -1)) {
        hits.push({ tag: els[i].tagName, id: els[i].id || "", text: safeTrim(els[i].textContent || "").slice(0, 80) });
      }
    }
    console.log(hits);
    return hits;
  };

  console.log("[NG_DIGIPACK_V2] ready");
})();

/* === NG Library UI: Download TXT/JSON + Preview + Load Auto-Scroll (V1) === */
(function () {
  if (window.__NG_LIBRARY_UI_V1) {
    console.log("[NG_LIBRARY_UI_V1] already installed");
    return;
  }
  window.__NG_LIBRARY_UI_V1 = true;

  function safeStr(v){ return (v==null) ? "" : String(v); }
  function safeTrim(s){ return safeStr(s).replace(/^\s+|\s+$/g,""); }
  function slug(s){
    s = safeTrim(s).toLowerCase().replace(/[^a-z0-9\u0900-\u097f]+/g,"_").replace(/^_+|_+$/g,"");
    return s || "story";
  }

  function lsGet(key, fb){
    try { var raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fb; }
    catch(e){ return fb; }
  }

  function downloadFile(filename, content, mime){
    try{
      var blob = new Blob([content], { type: mime || "text/plain;charset=utf-8" });
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click();
      setTimeout(function(){
        try{ URL.revokeObjectURL(url); }catch(e){}
        try{ document.body.removeChild(a); }catch(e2){}
      }, 200);
      return true;
    } catch(e){
      console.warn("[NG_LIBRARY_UI_V1] download failed", e);
      return false;
    }
  }

  function findSelectedIndex(){
    var sel =
      document.querySelector('[data-draft-index].selected') ||
      document.querySelector('[data-draft-idx].selected') ||
      document.querySelector('.draft-row.selected') ||
      document.querySelector('.draft-row.active') ||
      document.querySelector('[aria-selected="true"][data-draft-index]') ||
      document.querySelector('[aria-selected="true"][data-draft-idx]') ||
      document.querySelector('input[type="radio"][name*="draft"]:checked') ||
      null;

    if (!sel) return null;

    var v = null;
    if (sel.getAttribute) v = sel.getAttribute("data-draft-index") || sel.getAttribute("data-draft-idx");
    if (v == null && sel.value != null) v = sel.value;

    var n = parseInt(v, 10);
    return isNaN(n) ? null : n;
  }

  function getDraftByIndex(idx){
  var drafts = lsGet("NG_DIGIPACK_DRAFTS_V1", []);

    if (!drafts || !drafts.length) return { drafts: drafts, idx: null, draft: null };
    if (idx == null || idx < 0 || idx >= drafts.length) idx = drafts.length - 1;
    return { drafts: drafts, idx: idx, draft: drafts[idx] };
  }

  function makeTXT(draft){
  draft = ensureDraftHasDigipack(draft);   // <-- ADD THIS LINE
  var story = (draft && draft.story) ? draft.story : {};

    var headline = safeTrim(story.headline || draft.headline || story.title || draft.title || "");
    var status = safeTrim(draft.status || story.status || "");
    var saved  = safeTrim(draft.saved || draft.ts || draft.saved_at || "");

    var raw = "";
    if (story.digipack && story.digipack.raw) raw = safeStr(story.digipack.raw);
    if (!raw && story.full_digipack) raw = safeStr(story.full_digipack);

    var out = [];
    out.push("NEWSGENIE DIGIPACK");
    out.push("--------------------------------");
    out.push("Headline: " + (headline || "(no headline)"));
    if (status) out.push("Status: " + status);
    if (saved) out.push("Saved: " + saved);
    out.push("");
    out.push("FULL DIGIPACK");
    out.push("--------------------------------");
    out.push(raw || "(No generated pack saved yet. Generate outputs, then click Save Draft.)");
    return out.join("\n");
  }

  function ensureBar() {
    if (document.getElementById("ng-lib-bar")) return;

    var bar = document.createElement("div");
    bar.id = "ng-lib-bar";
    bar.style.position = "sticky";
    bar.style.top = "0";
    bar.style.zIndex = "999999";
    bar.style.background = "#111";
    bar.style.color = "#fff";
    bar.style.padding = "10px";
    bar.style.margin = "10px";
    bar.style.borderRadius = "10px";
    bar.style.fontFamily = "system-ui, sans-serif";
    bar.style.display = "flex";
    bar.style.gap = "8px";
    bar.style.alignItems = "center";
    bar.style.flexWrap = "wrap";

    bar.innerHTML = ''
      + '<b style="margin-right:6px">Library</b>'
      + '<button id="ng-lib-dl-txt" style="cursor:pointer;border:0;border-radius:8px;padding:6px 10px">Download TXT</button>'
      + '<button id="ng-lib-dl-json" style="cursor:pointer;border:0;border-radius:8px;padding:6px 10px">Download JSON</button>'
      + '<button id="ng-lib-preview" style="cursor:pointer;border:0;border-radius:8px;padding:6px 10px">Preview DIGIPACK</button>'
      + '<span id="ng-lib-status" style="opacity:.85;margin-left:6px"></span>'
      + '<pre id="ng-lib-pre" style="display:none;width:100%;max-height:220px;overflow:auto;background:#000;margin:8px 0 0 0;padding:10px;border-radius:10px"></pre>';

    // top of page is okay (works even if library is modal)
    document.body.insertBefore(bar, document.body.firstChild);

    function refreshStatus(){
      var idx = findSelectedIndex();
      var g = getDraftByIndex(idx);
      var st = document.getElementById("ng-lib-status");
      if (!st) return;
      if (!g.draft) { st.textContent = "No drafts found"; return; }
      var story = g.draft.story || {};
      var headline = safeTrim(story.headline || g.draft.headline || story.title || g.draft.title || "");
      var raw = "";
      if (story.digipack && story.digipack.raw) raw = safeStr(story.digipack.raw);
      if (!raw && story.full_digipack) raw = safeStr(story.full_digipack);
      st.textContent = "Drafts:" + g.drafts.length + " | idx:" + g.idx + " | rawLen:" + raw.length + (headline ? (" | " + headline.slice(0,40)) : "");
    }

    document.getElementById("ng-lib-dl-txt").onclick = function(){
      var idx = findSelectedIndex();
      var g = getDraftByIndex(idx);
      if (!g.draft) return alert("No drafts found");
      var story = g.draft.story || {};
      var headline = safeTrim(story.headline || g.draft.headline || story.title || g.draft.title || "");
      downloadFile("NG_" + slug(headline) + "_DIGIPACK.txt", makeTXT(g.draft), "text/plain;charset=utf-8");
      refreshStatus();
    };

    document.getElementById("ng-lib-dl-json").onclick = function(){
      var idx = findSelectedIndex();
      var g = getDraftByIndex(idx);
      if (!g.draft) return alert("No drafts found");
      var story = g.draft.story || {};
      var headline = safeTrim(story.headline || g.draft.headline || story.title || g.draft.title || "");
      downloadFile("NG_" + slug(headline) + "_STORY.json", JSON.stringify(g.draft, null, 2), "application/json;charset=utf-8");
      refreshStatus();
    };

    document.getElementById("ng-lib-preview").onclick = function(){
      var idx = findSelectedIndex();
      var g = getDraftByIndex(idx);
      if (!g.draft) return alert("No drafts found");
      var pre = document.getElementById("ng-lib-pre");
      if (!pre) return;
      pre.style.display = (pre.style.display === "none") ? "block" : "none";
      if (pre.style.display === "block") pre.textContent = makeTXT(g.draft);
      refreshStatus();
    };

    // keep status fresh when user clicks in library list
    document.addEventListener("click", function(){ setTimeout(refreshStatus, 50); }, true);
    refreshStatus();

     console.log("[NG_LIBRARY_UI_V1] bar injected");
  }

  // When Library opens, inject bar
  document.addEventListener("click", function(e){
    var t = e && e.target;
    if (!t) return;

    // Open Library button by id
    if (t.id === "btn-open-library" || (t.closest && t.closest("#btn-open-library"))) {
      setTimeout(ensureBar, 150);
      return;
    }

    // Any button/link with "Library" text (fallback)
    var tx = safeTrim(t.textContent || "").toLowerCase();
    if (tx && tx.indexOf("library") !== -1) {
      setTimeout(ensureBar, 150);
      return;
    }

    // Load button: after load, auto-scroll to main save button so user "sees" it
    if (tx === "load" || tx.indexOf(" load") !== -1) {
      setTimeout(function(){
        var b = document.getElementById("btn-save-draft");
        if (b && b.scrollIntoView) b.scrollIntoView({behavior:"smooth", block:"center"});
      }, 250);
    }
  }, true);

  console.log("[NG_LIBRARY_UI_V1] ready");
})();

/* === NG Segmented TXT Export + Main Segments Panel (V1) === */
(function () {
  if (window.__NG_SEGMENTED_V1) return;
  window.__NG_SEGMENTED_V1 = true;

  function safeStr(v){ return (v==null) ? "" : String(v); }
  function trim(s){ return safeStr(s).replace(/^\s+|\s+$/g,""); }
  function escHTML(s){
    s = safeStr(s);
    return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  }
  function slug(s){
    s = trim(s).toLowerCase().replace(/[^a-z0-9\u0900-\u097f]+/g,"_").replace(/^_+|_+$/g,"");
    return s || "story";
  }

  function lsGet(key, fb){
    try { var raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fb; }
    catch(e){ return fb; }
  }

  function downloadFile(filename, content, mime){
    try{
      var blob = new Blob([content], { type: mime || "text/plain;charset=utf-8" });
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click();
      setTimeout(function(){
        try{ URL.revokeObjectURL(url); }catch(e){}
        try{ document.body.removeChild(a); }catch(e2){}
      }, 200);
      return true;
    } catch(e){
      console.warn("[NG_SEGMENTED_V1] download failed", e);
      return false;
    }
  }

  // -------- Extract "generated" safely from response/draft/raw ----------
  function extractGeneratedFromAny(x){
    if (!x) return null;

    // if it's the full API response
    if (x.generated && (x.generated.headline || x.generated.dek || x.generated.web_article_500_600)) return x.generated;

    // if it's already generated-like
    if (x.headline || x.dek || x.web_article_500_600 || x.vo_lines || x.shot_plan) return x;

    return null;
  }

  function extractGeneratedFromDraft(draft){
    var story = (draft && draft.story) ? draft.story : {};
    var dp = story.digipack || {};

    // blocks may be generated or full response
    var g = extractGeneratedFromAny(dp.blocks) ||
            (dp.blocks && extractGeneratedFromAny(dp.blocks.generated)) ||
            null;

    if (g) return g;

    // try parse raw
    var raw = safeStr(dp.raw || story.full_digipack || "");
    if (raw) {
      try {
        var parsed = JSON.parse(raw);
        g = extractGeneratedFromAny(parsed) || (parsed && extractGeneratedFromAny(parsed.generated)) || null;
        if (g) return g;
      } catch(e) {}
    }
    return null;
  }

  // -------- Format as HUMAN text (segments) ----------
  function formatSegmentsText(g){
    if (!g) return "(No generated pack found. Generate then Save Draft.)";

    var out = [];
    out.push("DIGIPACK (SEGMENTS)");
    out.push("--------------------------------");

    // HEADLINE / DEK
    out.push("HEADLINE: " + trim(g.headline || ""));
    if (g.dek) out.push("DEK: " + trim(g.dek));

    // KEY POINTS
    var bp = Array.isArray(g.bullet_points) ? g.bullet_points : [];
    if (bp.length) {
      out.push("");
      out.push("KEY POINTS");
      out.push("--------------------------------");
      for (var i=0;i<bp.length;i++) out.push("- " + trim(bp[i]));
    }

    // WEB ARTICLE
    if (g.web_article_500_600) {
      out.push("");
      out.push("WEB ARTICLE (500â€“600)");
      out.push("--------------------------------");
      out.push(trim(g.web_article_500_600));
    }

    // VIDEO
    out.push("");
    out.push("VIDEO");
    out.push("--------------------------------");
    if (g.video_hook) out.push("HOOK: " + trim(g.video_hook));

    var vo = Array.isArray(g.vo_lines) ? g.vo_lines : [];
    if (vo.length) {
      out.push("");
      out.push("VO LINES");
      for (var j=0;j<vo.length;j++) out.push("â€¢ " + trim(vo[j]));
    }

    var sp = Array.isArray(g.shot_plan) ? g.shot_plan : [];
    if (sp.length) {
      out.push("");
      out.push("SHOT PLAN");
      for (var k=0;k<sp.length;k++){
        var s = sp[k] || {};
        out.push(
          (k+1)+". " +
          trim(s.shot_type || "") +
          (s.what_to_show ? (" | " + trim(s.what_to_show)) : "") +
          (s.notes ? (" | " + trim(s.notes)) : "")
        );
      }
    }

    // SOCIAL
    out.push("");
    out.push("SOCIAL");
    out.push("--------------------------------");
    if (g.social_caption) out.push("CAPTION: " + trim(g.social_caption));
    if (g.social_script_20_30) out.push("SCRIPT (20â€“30s): " + trim(g.social_script_20_30));

    var ht = Array.isArray(g.hashtags) ? g.hashtags.filter(Boolean) : [];
    if (ht.length) out.push("HASHTAGS: " + ht.map(trim).filter(Boolean).join(" "));

    // YOUTUBE (auto-derived, until backend adds dedicated keys)
    out.push("");
    out.push("YOUTUBE (AUTO)");
    out.push("--------------------------------");
    var ytTitle = trim(g.video_hook || g.headline || "");
    var ytDesc = trim(g.web_article_500_600 || "");
    if (ytDesc.length > 600) ytDesc = ytDesc.slice(0, 600) + "...";
    var ytTags = ht.length ? ht.map(function(x){return trim(x).replace(/^#/,"");}).join(", ") : "";

    out.push("TITLE: " + ytTitle);
    if (ytDesc) out.push("DESCRIPTION: " + ytDesc);
    if (ytTags) out.push("TAGS: " + ytTags);

    return out.join("\n");
  }

  // -------- MAIN PAGE: Segments Panel ----------
  function ensureMainPanel(){
    if (document.getElementById("ng-seg-panel")) return;

    var wrap = document.createElement("div");
    wrap.id = "ng-seg-panel";
    wrap.style.margin = "14px 0";
    wrap.style.padding = "12px";
    wrap.style.border = "1px solid #ddd";
    wrap.style.borderRadius = "12px";
    wrap.style.background = "#fafafa";
    wrap.innerHTML =
      '<div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:8px;">' +
      '  <b>DigiPack Segments</b>' +
      '  <button id="ng-seg-copy" style="cursor:pointer;border:0;border-radius:10px;padding:6px 10px;">Copy Segments</button>' +
      '  <span id="ng-seg-meta" style="opacity:.8"></span>' +
      '</div>' +
      '<pre id="ng-seg-pre" style="white-space:pre-wrap;background:#111;color:#fff;padding:10px;border-radius:10px;max-height:420px;overflow:auto;"></pre>';

    // Add near bottom, safe
    document.body.appendChild(wrap);

    document.getElementById("ng-seg-copy").onclick = function(){
      var txt = safeStr(document.getElementById("ng-seg-pre")?.textContent || "");
      try { navigator.clipboard.writeText(txt); } catch(e){}
    };
  }

  function renderMainFromLast(){
    var resp = window.NG_LAST_DIGIPACK || null;
    if (!resp) return;
    ensureMainPanel();
    var g = extractGeneratedFromAny(resp) || extractGeneratedFromAny(resp.generated) || null;
    var txt = formatSegmentsText(g);
    var pre = document.getElementById("ng-seg-pre");
    if (pre) pre.textContent = txt;

    var meta = document.getElementById("ng-seg-meta");
    if (meta) meta.textContent = "rawLen: " + (txt.length || 0);
  }

  // Watch for new generation (NG_LAST_DIGIPACK_TS is updated by your V2 wrapper)
  var lastTs = null;
  setInterval(function(){
    try{
      var ts = window.NG_LAST_DIGIPACK_TS || null;
      if (ts && ts !== lastTs) {
        lastTs = ts;
        renderMainFromLast();
      }
    } catch(e){}
  }, 400);

  // -------- LIBRARY BAR: override TXT/Preview to segmented text ----------
  function overrideLibraryBar(){
    var btnTxt = document.getElementById("ng-lib-dl-txt");
    var btnPrev = document.getElementById("ng-lib-preview");
    var btnJson = document.getElementById("ng-lib-dl-json");
    if (!btnTxt || !btnPrev || !btnJson) return false;

    function findSelectedIndex(){
      var sel =
        document.querySelector('[data-draft-index].selected') ||
        document.querySelector('[data-draft-idx].selected') ||
        document.querySelector('.draft-row.selected') ||
        document.querySelector('.draft-row.active') ||
        document.querySelector('[aria-selected="true"][data-draft-index]') ||
        document.querySelector('[aria-selected="true"][data-draft-idx]') ||
        document.querySelector('input[type="radio"][name*="draft"]:checked') ||
        null;
      if (!sel) return null;
      var v = null;
      if (sel.getAttribute) v = sel.getAttribute("data-draft-index") || sel.getAttribute("data-draft-idx");
      if (v == null && sel.value != null) v = sel.value;
      var n = parseInt(v,10);
      return isNaN(n) ? null : n;
    }

    function getDraft(){
      var drafts = lsGet("NG_DRAFTS", []);
      if (!drafts.length) return { drafts: drafts, idx: null, draft: null };
      var idx = findSelectedIndex();
      if (idx==null || idx<0 || idx>=drafts.length) idx = drafts.length-1;
      return { drafts: drafts, idx: idx, draft: drafts[idx] };
    }

    // TXT = segmented text
    btnTxt.onclick = function(){
      var g = getDraft();
      if (!g.draft) return alert("No drafts found");
      var gen = extractGeneratedFromDraft(g.draft);
      var txt = formatSegmentsText(gen);
      var story = g.draft.story || {};
      var headline = trim(story.headline || g.draft.headline || story.title || g.draft.title || "");
      downloadFile("NG_" + slug(headline) + "_DIGIPACK.txt", txt, "text/plain;charset=utf-8");
    };

    // Preview = show segmented text
    btnPrev.onclick = function(){
      var g = getDraft();
      if (!g.draft) return alert("No drafts found");
      var pre = document.getElementById("ng-lib-pre");
      if (!pre) return;
      pre.style.display = (pre.style.display === "none") ? "block" : "none";
      if (pre.style.display === "block") {
        var gen = extractGeneratedFromDraft(g.draft);
        pre.textContent = formatSegmentsText(gen);
      }
    };

    // JSON stays JSON (unchanged)
    btnJson.onclick = function(){
      var g = getDraft();
      if (!g.draft) return alert("No drafts found");
      var story = g.draft.story || {};
      var headline = trim(story.headline || g.draft.headline || story.title || g.draft.title || "");
      downloadFile("NG_" + slug(headline) + "_STORY.json", JSON.stringify(g.draft, null, 2), "application/json;charset=utf-8");
    };

    console.log("[NG_SEGMENTED_V1] Library bar overridden (TXT/Preview segmented)");
    return true;
  }

  // retry until library bar exists
  var tries = 0;
  var t = setInterval(function(){
    tries++;
    if (overrideLibraryBar() || tries > 60) clearInterval(t);
  }, 300);

  console.log("[NG_SEGMENTED_V1] ready");
})();



</script>
  



<!-- NG_PATCH: SEGMENTED_V2 -->
<script>
/* === NG Segmented Export + Main Segments Drawer (V2) === */
(function(){
  if (window.__NG_SEGMENTED_V2) return;
  window.__NG_SEGMENTED_V2 = true;

  function safeStr(v){ return (v==null) ? "" : String(v); }
  function trim(s){ return safeStr(s).replace(/^\\s+|\\s+$/g,""); }
  function arr(a){ return Array.isArray(a) ? a : []; }
  function slug(s){
    s = trim(s).toLowerCase().replace(/[^a-z0-9\\u0900-\\u097f]+/g,"_").replace(/^_+|_+$/g,"");
    return s || "story";
  }

  function lsGet(key, fb){
    try { var raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fb; }
    catch(e){ return fb; }
  }

  function downloadFile(filename, content, mime){
    try{
      var blob = new Blob([content], { type: mime || "text/plain;charset=utf-8" });
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click();
      setTimeout(function(){
        try{ URL.revokeObjectURL(url); }catch(e){}
        try{ document.body.removeChild(a); }catch(e2){}
      }, 200);
      return true;
    } catch(e){
      console.warn("[NG_SEGMENTED_V2] download failed", e);
      return false;
    }
  }

 function pickGenerated(obj){
  if (!obj) return null;

  // existing supported shapes
  if (obj.generated && (obj.generated.headline || obj.generated.web_article_500_600 || obj.generated.vo_lines)) return obj.generated;
  if (obj.headline || obj.web_article_500_600 || obj.vo_lines || obj.shot_plan) return obj;

  // ✅ NEW: wrapper shape { generated_text: "### WEB_ARTICLE ..."}
  if (typeof obj.generated_text === "string" && obj.generated_text.trim()) {
    var txt = String(obj.generated_text || "");

    function grab(name){
      // capture between headings ### NAME ... until next ### or end
      var re = new RegExp("###\\s*" + name + "\\s*\\n([\\s\\S]*?)(?=\\n###\\s*[A-Z][A-Z _]*\\s*\\n|$)", "i");
      var m = txt.match(re);
      return m ? String(m[1] || "").trim() : "";
    }

    var web = grab("WEB_ARTICLE");
    var video = grab("VIDEO");
    var ytd = grab("YOUTUBE DESCRIPTION");
    var social = grab("SOCIAL");

    var out = {};
    var hasAny = false;

    if (web) { out.web_article_500_600 = web; hasAny = true; }
    if (ytd) { out.youtube_description = ytd; hasAny = true; }

    // VIDEO parse
    if (video) {
      hasAny = true;

      var hookM = video.match(/HOOK:\s*(.+)/i);
      if (hookM) out.video_hook = String(hookM[1] || "").trim();

      var lines = [];
      var parts = video.split(/LINES:\s*/i);
      if (parts.length > 1) {
        var each = String(parts[1] || "").split(/\n/);
        for (var i=0; i<each.length; i++){
          var s = String(each[i] || "").replace(/^\s*\d+\)\s*/, "").trim();
          if (!s) continue;
          if (s.indexOf("###") === 0) break;
          lines.push(s);
        }
      }
      if (lines.length) {
        out.video_lines = lines;
        out.bullet_points = lines.slice(0, 6);
      }
      if (out.video_hook && !out.headline) out.headline = out.video_hook;
    }

    // SOCIAL parse
    if (social) {
      hasAny = true;

      var xm = social.match(/X:\s*([^\n]*)/i);
      if (xm) out.social_x = String(xm[1] || "").trim();

      var im = social.match(/INSTAGRAM:\s*([^\n]*)/i);
      if (im) out.social_instagram = String(im[1] || "").trim();
    }

    return hasAny ? out : null;
  }

  return null;
}

  function extractGeneratedFromDraft(draft){
    var story = (draft && draft.story) ? draft.story : {};
    var dp = story.digipack || {};
    var blocks = dp.blocks || null;

    var g = pickGenerated(blocks) || (blocks && pickGenerated(blocks.generated)) || null;
    if (g) return g;

    var raw = safeStr(dp.raw || story.full_digipack || "");
    if (raw) {
      try{
        var parsed = JSON.parse(raw);
        g = pickGenerated(parsed) || (parsed && pickGenerated(parsed.generated)) || null;
        if (g) return g;
      }catch(e){}
    }
    return null;
  }

  function formatSegments(gen){
    if (!gen) return "(No generated pack found. Generate then Save Draft.)";

    var out = [];
    out.push("DIGIPACK (SEGMENTS)");
    out.push("--------------------------------");

    if (gen.headline) out.push("HEADLINE: " + trim(gen.headline));
    if (gen.dek) out.push("DEK: " + trim(gen.dek));

    var bp = arr(gen.bullet_points).map(trim).filter(Boolean);
    if (bp.length){
      out.push("");
      out.push("KEY POINTS");
      out.push("--------------------------------");
      for (var i=0;i<bp.length;i++) out.push("- " + bp[i]);
    }

    if (gen.web_article_500_600){
      out.push("");
      out.push("WEB ARTICLE (500â€“600)");
      out.push("--------------------------------");
      out.push(trim(gen.web_article_500_600));
    }

    out.push("");
    out.push("VIDEO");
    out.push("--------------------------------");
    if (gen.video_hook) out.push("HOOK: " + trim(gen.video_hook));

    var vo = arr(gen.vo_lines).map(trim).filter(Boolean);
    if (vo.length){
      out.push("");
      out.push("VO LINES");
      for (var j=0;j<vo.length;j++) out.push("â€¢ " + vo[j]);
    }

    var sp = arr(gen.shot_plan);
    if (sp.length){
      out.push("");
      out.push("SHOT PLAN");
      for (var k=0;k<sp.length;k++){
        var s = sp[k] || {};
        out.push(
          (k+1)+". " + trim(s.shot_type||"") +
          (s.what_to_show ? (" | " + trim(s.what_to_show)) : "") +
          (s.notes ? (" | " + trim(s.notes)) : "")
        );
      }
    }

    out.push("");
    out.push("SOCIAL");
    out.push("--------------------------------");
    if (gen.social_caption) out.push("CAPTION: " + trim(gen.social_caption));
    if (gen.social_script_20_30) out.push("SCRIPT (20â€“30s): " + trim(gen.social_script_20_30));
    var ht = arr(gen.hashtags).map(trim).filter(Boolean);
    if (ht.length) out.push("HASHTAGS: " + ht.join(" "));

    out.push("");
    out.push("YOUTUBE (AUTO)");
    out.push("--------------------------------");
    var ytTitle = trim(gen.video_hook || gen.headline || "");
    var ytDesc  = trim(gen.web_article_500_600 || "");
    if (ytDesc.length > 600) ytDesc = ytDesc.slice(0,600) + "...";
    var ytTags = ht.length ? ht.map(function(x){ return trim(x).replace(/^#/, ""); }).filter(Boolean).join(", ") : "";
    out.push("TITLE: " + ytTitle);
    if (ytDesc) out.push("DESCRIPTION: " + ytDesc);
    if (ytTags) out.push("TAGS: " + ytTags);

    if (gen.caution && trim(gen.caution)) {
      out.push("");
      out.push("CAUTION");
      out.push("--------------------------------");
      out.push(trim(gen.caution));
    }

    return out.join("\\n");
  }

  // ---- MAIN PAGE: floating Segments drawer ----
  function ensureDrawer(){
    if (document.getElementById("ngSegBtnV2")) return;

    var btn = document.createElement("button");
    btn.id = "ngSegBtnV2";
    btn.textContent = "SEGMENTS";
    btn.style.cssText = "position:fixed;right:14px;bottom:14px;z-index:999999;padding:10px 12px;border:0;border-radius:12px;cursor:pointer;background:#111;color:#fff;font-family:system-ui;";
    document.body.appendChild(btn);

    var box = document.createElement("div");
    box.id = "ngSegBoxV2";
    box.style.cssText = "position:fixed;right:14px;bottom:58px;z-index:999999;width:560px;max-width:92vw;max-height:70vh;overflow:auto;background:#0b0b0b;color:#fff;border-radius:14px;padding:12px;display:none;font-family:system-ui;";
    box.innerHTML =
      '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">' +
      '<b>DigiPack Segments</b>' +
      '<div style="display:flex;gap:8px;align-items:center;">' +
      '<button id="ngSegCopyV2" style="cursor:pointer;border:0;border-radius:10px;padding:6px 10px;">Copy</button>' +
      '<button id="ngSegCloseV2" style="cursor:pointer;border:0;border-radius:10px;padding:6px 10px;">Close</button>' +
      '</div></div>' +
      '<pre id="ngSegPreV2" style="white-space:pre-wrap;margin:0;"></pre>';

    document.body.appendChild(box);

    function render(){
      var resp = window.NG_LAST_DIGIPACK || null;
      var gen = pickGenerated(resp) || (resp && pickGenerated(resp.generated)) || null;
      var pre = document.getElementById("ngSegPreV2");
      if (pre) pre.textContent = formatSegments(gen);
    }

    btn.onclick = function(){
      box.style.display = (box.style.display === "none") ? "block" : "none";
      if (box.style.display === "block") render();
    };
    document.getElementById("ngSegCloseV2").onclick = function(){ box.style.display = "none"; };
    document.getElementById("ngSegCopyV2").onclick = function(){
      try { navigator.clipboard.writeText(document.getElementById("ngSegPreV2").textContent || ""); } catch(e){}
    };

    var lastTs = null;
    setInterval(function(){
      var ts = window.NG_LAST_DIGIPACK_TS || null;
      if (ts && ts !== lastTs){
        lastTs = ts;
        if (box.style.display === "block") render();
      }
    }, 400);
  }

  // ---- LIBRARY: override Download TXT + Preview to segmented text ----
  function findSelectedIndex(){
    var sel =
      document.querySelector('[data-draft-index].selected') ||
      document.querySelector('[data-draft-idx].selected') ||
      document.querySelector('.draft-row.selected') ||
      document.querySelector('.draft-row.active') ||
      document.querySelector('[aria-selected="true"][data-draft-index]') ||
      document.querySelector('[aria-selected="true"][data-draft-idx]') ||
      document.querySelector('input[type="radio"][name*="draft"]:checked') ||
      null;

    if (!sel) return null;

    var v = null;
    if (sel.getAttribute) v = sel.getAttribute("data-draft-index") || sel.getAttribute("data-draft-idx");
    if (v == null && sel.value != null) v = sel.value;

    var n = parseInt(v,10);
    return isNaN(n) ? null : n;
  }

  function getDraft(){
    var drafts = lsGet("NG_DRAFTS", []);
    if (!drafts.length) return {drafts:drafts, idx:null, draft:null};
    var idx = findSelectedIndex();
    if (idx==null || idx<0 || idx>=drafts.length) idx = drafts.length-1;
    return {drafts:drafts, idx:idx, draft:drafts[idx]};
  }

  function overrideLibraryButtons(){
    var btnTxt  = document.getElementById("ng-lib-dl-txt");
    var btnPrev = document.getElementById("ng-lib-preview");
    var btnJson = document.getElementById("ng-lib-dl-json");
    if (!btnTxt || !btnPrev || !btnJson) return false;

    btnTxt.onclick = function(){
      var g = getDraft();
      if (!g.draft) return alert("No drafts found");
      var gen = extractGeneratedFromDraft(g.draft);
      var txt = formatSegments(gen);
      var story = g.draft.story || {};
      var headline = trim((gen && gen.headline) || story.headline || g.draft.headline || story.title || g.draft.title || "");
      downloadFile("NG_" + slug(headline) + "_DIGIPACK.txt", txt, "text/plain;charset=utf-8");
    };

    btnPrev.onclick = function(){
  var g = getDraft();
  if (!g.draft) return alert("No drafts found");
  var pre = document.getElementById("ng-lib-pre");
  if (!pre) return;

  pre.style.display = (pre.style.display === "none") ? "block" : "none";

  if (pre.style.display === "block") {
    var draft = g.draft;
    var gen = null;
    try { gen = extractGeneratedFromDraft(draft); } catch(e) { gen = null; }

    if (gen) {
      // existing segmented preview
      pre.textContent = (typeof formatSegmentsText === "function") ? formatSegmentsText(gen)
                     : (typeof formatSegments === "function") ? formatSegments(gen)
                     : JSON.stringify(gen, null, 2);
    } else {
      // ✅ fallback: show raw saved pack
      var story = (draft && draft.story) ? draft.story : {};
      var dp = story.digipack || {};
      var raw = dp.raw || story.full_digipack || "";
      pre.textContent = raw ? String(raw) : "(No generated pack saved yet. Generate outputs, then click Save Draft.)";
    }
  }
};


    // JSON stays JSON (no change)
    // btnJson remains whatever your library UI sets; we don't touch it.

    console.log("[NG_SEGMENTED_V2] Library TXT/Preview overridden");
    return true;
  }

  // init
  ensureDrawer();

  var tries = 0;
  var t = setInterval(function(){
    tries++;
    if (overrideLibraryButtons() || tries > 80) clearInterval(t);
  }, 300);

  console.log("[NG_SEGMENTED_V2] ready");
})();
</script>
<!-- /NG_PATCH: SEGMENTED_V2 -->


<!-- NG_PATCH: FORCE_DLTEXT_V2 -->
<script>
(function(){
  try {
    if (typeof window.__NG_FORCE_DLTEXT_HITS !== "number") window.__NG_FORCE_DLTEXT_HITS = 0;
  } catch(e) {}

(function(){
  if (window.__NG_FORCE_DLTEXT_V2) return;
  window.__NG_FORCE_DLTEXT_V2 = true;
  window.__NG_FORCE_DLTEXT_HITS = 0;

  function S(v){ return (v==null) ? "" : String(v); }
  function T(s){ return S(s).replace(/^\s+|\s+$/g,""); }
  function A(a){ return Array.isArray(a) ? a : []; }
  function slug(s){
    s = T(s).toLowerCase().replace(/[^a-z0-9\u0900-\u097f]+/g,"_").replace(/^_+|_+$/g,"");
    return s || "story";
  }

  function lsGet(key, fb){
if (key === "NG_DRAFTS") key = "NG_DIGIPACK_DRAFTS_V1";

    try { var raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fb; }
    catch(e){ return fb; }
  }

  function closestBtn(node){
    while(node && node !== document){
      var tn = (node.tagName || "").toUpperCase();
      if (tn === "BUTTON" || tn === "A") return node;
      node = node.parentNode;
    }
    return null;
  }

  function pickGenerated(obj){
    if (!obj) return null;
    if (obj.generated && (obj.generated.headline || obj.generated.web_article_500_600 || obj.generated.vo_lines)) return obj.generated;
    if (obj.headline || obj.web_article_500_600 || obj.vo_lines || obj.shot_plan) return obj;
    return null;
  }

  function extractGeneratedFromDraft(draft){
    var story = (draft && draft.story) ? draft.story : {};
    var dp = story.digipack || {};
    var blocks = dp.blocks || null;

    var g = pickGenerated(blocks) || (blocks && pickGenerated(blocks.generated)) || null;
    if (g) return g;

    var raw = S(dp.raw || story.full_digipack || "");
    if (raw) {
      try {
        var parsed = JSON.parse(raw);
        g = pickGenerated(parsed) || (parsed && pickGenerated(parsed.generated)) || null;
        if (g) return g;
      } catch(e) {}
    }
    return null;
  }

  function formatSegments(gen){
    if (!gen) return "(No generated pack found. Generate then Save Draft.)";
    var out = [];
    out.push("DIGIPACK (SEGMENTS)");
    out.push("--------------------------------");
    if (gen.headline) out.push("HEADLINE: " + T(gen.headline));
    if (gen.dek) out.push("DEK: " + T(gen.dek));

    var bp = A(gen.bullet_points).map(T).filter(Boolean);
    if (bp.length){
      out.push(""); out.push("KEY POINTS"); out.push("--------------------------------");
      for (var i=0;i<bp.length;i++) out.push("- " + bp[i]);
    }

    if (gen.web_article_500_600){
      out.push(""); out.push("WEB ARTICLE (500â€“600)"); out.push("--------------------------------");
      out.push(T(gen.web_article_500_600));
    }

    out.push(""); out.push("VIDEO"); out.push("--------------------------------");
    if (gen.video_hook) out.push("HOOK: " + T(gen.video_hook));

    var vo = A(gen.vo_lines).map(T).filter(Boolean);
    if (vo.length){
      out.push(""); out.push("VO LINES");
      for (var j=0;j<vo.length;j++) out.push("â€¢ " + vo[j]);
    }

    var sp = A(gen.shot_plan);
    if (sp.length){
      out.push(""); out.push("SHOT PLAN");
      for (var k=0;k<sp.length;k++){
        var s = sp[k] || {};
        out.push((k+1)+". "+T(s.shot_type||"")+(s.what_to_show?(" | "+T(s.what_to_show)):"")+(s.notes?(" | "+T(s.notes)):""));
      }
    }

    out.push(""); out.push("SOCIAL"); out.push("--------------------------------");
    if (gen.social_caption) out.push("CAPTION: " + T(gen.social_caption));
    if (gen.social_script_20_30) out.push("SCRIPT (20â€“30s): " + T(gen.social_script_20_30));
    var ht = A(gen.hashtags).map(T).filter(Boolean);
    if (ht.length) out.push("HASHTAGS: " + ht.join(" "));

    out.push(""); out.push("YOUTUBE (AUTO)"); out.push("--------------------------------");
    var ytTitle = T(gen.video_hook || gen.headline || "");
    var ytDesc  = T(gen.web_article_500_600 || "");
    if (ytDesc.length > 600) ytDesc = ytDesc.slice(0,600) + "...";
    var ytTags = ht.length ? ht.map(function(x){ return T(x).replace(/^#/,""); }).filter(Boolean).join(", ") : "";
    out.push("TITLE: " + ytTitle);
    if (ytDesc) out.push("DESCRIPTION: " + ytDesc);
    if (ytTags) out.push("TAGS: " + ytTags);

    return out.join("\n").replace(/\\n/g,"\n");
  }

  function getDraft(){
    var drafts = lsGet("NG_DRAFTS", []);
    if (!drafts.length) return {drafts:drafts, idx:null, draft:null};

    // best effort: selected row, else last
    var idx = null;
    var sel = document.querySelector('[data-draft-index].selected') ||
              document.querySelector('[data-draft-idx].selected') ||
              document.querySelector('[aria-selected="true"][data-draft-index]') ||
              document.querySelector('[aria-selected="true"][data-draft-idx]');
    if (sel && sel.getAttribute){
      var v = sel.getAttribute("data-draft-index") || sel.getAttribute("data-draft-idx");
      var n = parseInt(v,10);
      if (!isNaN(n)) idx = n;
    }
    if (idx==null || idx<0 || idx>=drafts.length) idx = drafts.length-1;

    return {drafts:drafts, idx:idx, draft:drafts[idx]};
  }

  function downloadTxt(){
    var g = getDraft();
    if (!g.draft) return alert("No drafts found");
    var gen = extractGeneratedFromDraft(g.draft);
    var txt = formatSegments(gen);

    var headline = (gen && gen.headline) ? T(gen.headline) : "story";
    var fname = "SEGMENTED__" + Date.now() + "__" + slug(headline) + ".txt";

    var blob = new Blob([txt], {type:"text/plain;charset=utf-8"});
    var url = URL.createObjectURL(blob);
    var a = document.createElement("a");
    a.href = url; a.download = fname;
    document.body.appendChild(a); a.click();
    setTimeout(function(){
      try{ URL.revokeObjectURL(url); }catch(e){}
      try{ document.body.removeChild(a); }catch(e2){}
    }, 200);

    console.log("[FORCE_DLTEXT_V2] downloaded", {fname: fname, idx: g.idx, headline: headline});
  }

  // âœ… WINDOW capture: cannot be blocked by document capture handlers
  window.addEventListener("click", function(e){
    var btn = closestBtn(e && e.target);
    if (!btn) return;

    var id = btn.id || "";
    var txt = T(btn.textContent || "").toLowerCase();

    var hasBar = !!document.getElementById("ng-lib-bar");
    var inBar = hasBar && (function(){
      var n = btn;
      while(n && n !== document){
        if (n.id === "ng-lib-bar") return true;
        n = n.parentNode;
      }
      return false;
    })();

    if (id === "ng-lib-dl-txt" || (inBar && txt === "download txt")) {
      window.__NG_FORCE_DLTEXT_HITS++;
      e.preventDefault();
      e.stopPropagation();
      if (e.stopImmediatePropagation) e.stopImmediatePropagation();
      downloadTxt();
    }
  }, true);

  console.log("[FORCE_DLTEXT_V2] installed");
})();

})();
</script>
<!-- /NG_PATCH: FORCE_DLTEXT_V2 -->







<!-- NG_PATCH: STORY_VIEW_V8 -->
<style>
  #ng-sv8-modal{display:none; position:fixed; inset:0; z-index:999999; background:rgba(0,0,0,.55);}
  #ng-sv8-card{background:#fff; width:min(1180px,96vw); height:min(92vh,96vh); margin:3vh auto; border-radius:14px; overflow:hidden;
    box-shadow:0 18px 60px rgba(0,0,0,.25); display:flex; flex-direction:column; font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial;}
  #ng-sv8-top{display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid #eee; background:#fafafa; gap:10px;}
  #ng-sv8-top strong{font-size:14px;}
  #ng-sv8-top .btn{padding:7px 10px; border:1px solid #ddd; border-radius:10px; background:#fff; font:600 12px/1 system-ui; cursor:pointer;}
  #ng-sv8-top .pill{padding:6px 10px; border:1px solid #ddd; border-radius:999px; background:#fff; font:600 11px/1 system-ui; color:#333;
    max-width:52vw; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
  #ng-sv8-body{padding:12px; overflow:auto;}
  .ng-sv8-seg{border:1px solid #eee; border-radius:12px; margin:10px 0; overflow:hidden;}
  .ng-sv8-seg h3{margin:0; padding:10px 12px; font-size:13px; background:#f6f6f6; border-bottom:1px solid #eee;}
  .ng-sv8-grid{display:grid; grid-template-columns:1fr; gap:10px; padding:10px 12px;}
  .ng-sv8-box{border:1px solid #eee; border-radius:12px; padding:10px; background:#fff;}
  .ng-sv8-box h4{margin:0 0 8px 0; font-size:12px; text-transform:uppercase; color:#444; display:flex; justify-content:space-between; align-items:center; gap:10px;}
  .ng-sv8-copy{padding:6px 8px; border:1px solid #ddd; border-radius:10px; background:#fff; cursor:pointer; font:600 11px/1 system-ui;}
  .ng-sv8-pre{white-space:pre-wrap; margin:0; font-family:ui-monospace, Menlo, Consolas, monospace; font-size:12px; line-height:1.35;}
  .ng-sv8-ul{margin:0; padding-left:18px;}
  .ng-sv8-ul li{margin:2px 0;}
  .ng-sv8-muted{color:#666; font-size:12px;}
  .ng-sv8-row{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
</style>

<div id="ng-sv8-modal">
  <div id="ng-sv8-card">
    <div id="ng-sv8-top">
      <div>
        <strong>Story View</strong>
        <div class="ng-sv8-muted" id="ng-sv8-status">V8 (Hook resp_* auto-drop)</div>
      </div>
      <div class="ng-sv8-row">
        <span class="pill" id="ng-sv8-source">Source: auto</span>
        <button class="btn" id="ng-sv8-refresh" type="button">Refresh</button>
        <button class="btn" id="ng-sv8-close" type="button">Close</button>
      </div>
    </div>
    <div id="ng-sv8-body"></div>
  </div>
</div>

<script>
(function(){
  if (window.__NG_STORY_VIEW_V8) return;
  window.__NG_STORY_VIEW_V8 = true;

  function qs(sel, root){ return (root||document).querySelector(sel); }
  function qsa(sel, root){ return Array.prototype.slice.call((root||document).querySelectorAll(sel)||[]); }
  function safe(s){ return (s==null) ? "" : String(s); }

  function deescapeMaybe(t){
    t = safe(t);
    if (t.indexOf("\\n") === -1) return t;
    var esc = (t.match(/\\n/g) || []).length;
    var real = (t.match(/\n/g) || []).length;
    if (esc >= 5 || real <= 1){
      return t.replace(/\\r\\n/g,"\n").replace(/\\n/g,"\n").replace(/\\t/g,"\t");
    }
    return t;
  }
  function norm(t){
    t = deescapeMaybe(t);
    return safe(t).replace(/\r\n/g,"\n").replace(/\r/g,"\n").trim();
  }

  function copyText(txt){
    txt = safe(txt);
    try{
      if (navigator && navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(txt).catch(function(){});
        return true;
      }
    }catch(e){}
    try{
      var ta=document.createElement("textarea");
      ta.value=txt; ta.style.position="fixed"; ta.style.left="-9999px";
      document.body.appendChild(ta); ta.select(); document.execCommand("copy");
      document.body.removeChild(ta); return true;
    }catch(e){}
    return false;
  }

  // Hide Preview Prompt section (clutter)
  (function hidePreviewPrompt(){
    try{
      var all=qsa("label,div,h3,h4,strong,span");
      for (var i=0;i<all.length;i++){
        var el=all[i], tx=safe(el && el.textContent ? el.textContent : "");
        if (tx.indexOf("Preview Prompt")!==-1){
          var p=el;
          for (var k=0;k<7;k++){
            if (!p || !p.parentElement) break;
            p=p.parentElement;
            if (p && p.tagName==="DIV" && safe(p.innerText||"").indexOf("Preview Prompt")!==-1){
              p.style.display="none"; return;
            }
          }
        }
      }
    }catch(e){}
  })();

  function isPlaceholder(t){
    t=safe(t);
    return (t.indexOf("No generated pack found")!==-1) || (t.indexOf("Generate then Save Draft")!==-1);
  }
  function isSeparatorLine(line){
    line = safe(line).trim();
    if (!line) return true;
    return (line.replace(/[-\s]/g,"") === "");
  }
  function cleanBlock(block){
    block = norm(block);
    if (!block) return "";
    var lines = block.split("\n");
    var out = [];
    var blank = 0;
    for (var i=0;i<lines.length;i++){
      var l = lines[i];
      if (isSeparatorLine(l)) { blank++; continue; }
      l = l.replace(/\s+$/,"");
      if (!l.trim()){
        blank++;
        if (blank<=1) out.push("");
        continue;
      }
      blank=0;
      out.push(l);
    }
    while(out.length && !out[0].trim()) out.shift();
    while(out.length && !out[out.length-1].trim()) out.pop();
    return out.join("\n").trim();
  }

  // âœ… Hook filter: resp_* is NOT a real hook
  function isBadHook(h){
    h = safe(h).trim();
    if (!h) return true;
    if (/^resp_[a-z0-9]{12,}$/i.test(h)) return true;
    if (/^resp-[a-z0-9]{12,}$/i.test(h)) return true;
    return false;
  }

  function firstSentenceNoHashtag(txt){
    txt = cleanBlock(txt);
    if (!txt) return "";
    // remove hashtags
    txt = txt.replace(/#\S+/g,"").replace(/\s{2,}/g," ").trim();
    if (!txt) return "";
    // take first sentence-ish
    var m = txt.match(/(.{1,120}?)([à¥¤.!?]|$)/);
    return m ? m[1].trim() : txt.slice(0,120).trim();
  }

  function extractHookAndCleanVideo(videoBlock){
    var v = norm(videoBlock);
    var hook = "";
    var lines = v.split("\n");
    var out = [];
    for (var i=0;i<lines.length;i++){
      var l = lines[i].trim();
      if (!l) continue;
      if (/^HOOK\s*:/i.test(l)){
        var h = l.replace(/^HOOK\s*:\s*/i,"").trim();
        if (!hook && h) hook = h;
        continue; // drop all HOOK lines from video body
      }
      if (isSeparatorLine(l)) continue;
      out.push(lines[i]);
    }
    var cleaned = cleanBlock(out.join("\n"));

    // âœ… If hook is resp_* etc, drop and auto-build from video
    if (isBadHook(hook)){
      hook = "";
      var auto = firstSentenceNoHashtag(cleaned);
      if (auto) hook = auto;
    }
    return { video: cleaned, hook: hook };
  }

  function parseBlocksFromText(txt){
    txt=norm(txt);

    function after(prefix){
      var i=txt.indexOf(prefix); if(i===-1) return "";
      return (txt.slice(i+prefix.length).split("\n")[0]||"").trim();
    }
    function between(start, nextArr){
      var i=txt.indexOf(start); if(i===-1) return "";
      var rest=txt.slice(i+start.length), cut=rest.length;
      for (var k=0;k<nextArr.length;k++){
        var j=rest.indexOf(nextArr[k]); if(j!==-1 && j<cut) cut=j;
      }
      return rest.slice(0,cut).trim();
    }
    function keypoints(block){
      block = norm(block);
      var lines = block.split("\n");
      var out=[];
      for (var i=0;i<lines.length;i++){
        var l = lines[i].trim();
        if (!l) continue;
        if (isSeparatorLine(l)) continue;
        l = l.replace(/^(\s*-\s*)+/, "");
        l = l.replace(/^[â€¢\u2022]\s*/,"").trim();
        if (!l) continue;
        if (isSeparatorLine(l)) continue;
        out.push(l);
      }
      out = out.filter(function(x){ return x && x.replace(/[-\s]/g,"")!==""; });
      return out;
    }

    var kpB = between("KEY POINTS",["WEB ARTICLE","VIDEO","SOCIAL","BYTES","FULL DIGIPACK"]);
    var wa  = between("WEB ARTICLE",["VIDEO","SOCIAL","BYTES","FULL DIGIPACK"]);
    var vd  = between("VIDEO",["SOCIAL","BYTES","FULL DIGIPACK"]);

    var webClean = cleanBlock(wa);
    var vidObj = extractHookAndCleanVideo(vd);

    var hook2 = after("HOOK:");
    if (isBadHook(vidObj.hook) && !isBadHook(hook2)) vidObj.hook = hook2;
    if (isBadHook(vidObj.hook)) vidObj.hook = "";

    return {
      headline: after("HEADLINE:"),
      dek: after("DEK:"),
      keypoints: kpB ? keypoints(kpB) : [],
      web: webClean,
      video: vidObj.video,
      hook: vidObj.hook
    };
  }

  function normalizeInput(raw){
    var t = safe(raw).trim();
    if (!t || isPlaceholder(t)) return {sec:{}};

    // JSON -> try minimal direct fields; else treat as text (already saved NG_LAST_PACK_TEXT in earlier versions)
    if (t[0]==="{" || t[0]==="["){
      try{
        var obj = JSON.parse(t);
        if (Array.isArray(obj) && obj.length) obj = obj[obj.length-1];
        // If JSON contains a pack-like string anywhere, stringify will still work with parser heuristics.
        return {sec: parseBlocksFromText(JSON.stringify(obj))};
      }catch(e){}
    }
    return {sec: parseBlocksFromText(t)};
  }

  function pickFromLocalStorage(){
    var keys = ["NG_LAST_PACK_TEXT","NG_LAST_DIGIPACK","NG_LAST_PACK","NG_DRAFTS","drafts","NG_LIBRARY","ng_library"];
    for (var i=0;i<keys.length;i++){
      try{
        var v = localStorage.getItem(keys[i]);
        if (v && !isPlaceholder(v) && v.length>40) return {text:v, source:"localStorage:"+keys[i]};
      }catch(e){}
    }
    try{
      var best=null, bestLen=0, bestK="";
      for (var j=0;j<localStorage.length;j++){
        var k=localStorage.key(j);
        if (!k || !/digipack|pack|draft|library/i.test(k)) continue;
        var vv=localStorage.getItem(k);
        if (vv && !isPlaceholder(vv) && vv.length>bestLen){ best=vv; bestLen=vv.length; bestK=k; }
      }
      if (best) return {text:best, source:"localStorage:scan:"+bestK};
    }catch(e){}
    return null;
  }

  function pickFromDOM(){
    var nodes=qsa("textarea").concat(qsa("pre")).concat(qsa("code"));
    var best=null, bestLen=0;
    for (var i=0;i<nodes.length;i++){
      var n=nodes[i];
      var t=(n && n.tagName==="TEXTAREA") ? safe(n.value) : safe(n && n.textContent ? n.textContent : "");
      if (!t || isPlaceholder(t)) continue;
      if (t.length>bestLen){ best=t; bestLen=t.length; }
    }
    if (best) return {text:best, source:"DOM:best"};
    return null;
  }

  function box(title, content, asList){
    var wrap=document.createElement("div"); wrap.className="ng-sv8-box";
    var h=document.createElement("h4");
    var l=document.createElement("span"); l.textContent=title;
    var b=document.createElement("button"); b.className="ng-sv8-copy"; b.type="button"; b.textContent="Copy";
    b.addEventListener("click", function(){
      var txt = asList ? (content||[]).join("\n") : safe(content);
      copyText(txt);
      b.textContent="Copied"; setTimeout(function(){ b.textContent="Copy"; }, 600);
    }, false);
    h.appendChild(l); h.appendChild(b); wrap.appendChild(h);

    if (asList){
      var ul=document.createElement("ul"); ul.className="ng-sv8-ul";
      for (var i=0;i<(content||[]).length;i++){ var li=document.createElement("li"); li.textContent=content[i]; ul.appendChild(li); }
      wrap.appendChild(ul);
    } else {
      var pre=document.createElement("pre"); pre.className="ng-sv8-pre"; pre.textContent=safe(content||""); wrap.appendChild(pre);
    }
    return wrap;
  }

  function render(rawText, src){
    var body=qs("#ng-sv8-body"); if(!body) return;
    body.innerHTML="";

    var r = normalizeInput(rawText||"");
    var s = r.sec || {};

    var card=document.createElement("div"); card.className="ng-sv8-seg";
    var h3=document.createElement("h3"); h3.textContent="STORY"; card.appendChild(h3);

    var grid=document.createElement("div"); grid.className="ng-sv8-grid";
    grid.appendChild(box("Headline", s.headline||"", false));
    grid.appendChild(box("Dek", s.dek||"", false));
    grid.appendChild(box("Key Points", s.keypoints||[], true));
    grid.appendChild(box("Web Article", s.web||"", false));
    grid.appendChild(box("Video", s.video||"", false));
    if (s.hook) grid.appendChild(box("Hook", s.hook, false)); // only if meaningful

    card.appendChild(grid);
    body.appendChild(card);

    qs("#ng-sv8-source").textContent = "Source: " + (src||"auto");
    qs("#ng-sv8-status").textContent = "Updated @ " + new Date().toLocaleTimeString() + " (V8 hook fixed)";
  }

  function openModal(){ var m=qs("#ng-sv8-modal"); if(m) m.style.display="block"; }
  function closeModal(){ var m=qs("#ng-sv8-modal"); if(m) m.style.display="none"; }

  function refresh(){
    var picked = pickFromLocalStorage() || pickFromDOM() || {text:"", source:"none"};
    render(picked.text||"", picked.source||"none");
  }

  qs("#ng-sv8-close") && qs("#ng-sv8-close").addEventListener("click", closeModal, false);
  qs("#ng-sv8-refresh") && qs("#ng-sv8-refresh").addEventListener("click", refresh, false);

  var modal=qs("#ng-sv8-modal");
  modal && modal.addEventListener("click", function(e){ if(e && e.target===modal) closeModal(); }, false);

  document.addEventListener("click", function(e){
    var t=e && e.target ? e.target : null;
    if(!t) return;
    var el=t;
    for (var i=0;i<5;i++){
      if(!el) break;
      var tx=safe(el.textContent||el.value||"").trim();
      if (tx==="SEGMENTS"){
        try{ e.preventDefault(); }catch(_){}
        try{ e.stopPropagation(); }catch(_){}
        try{ e.stopImmediatePropagation(); }catch(_){}
        openModal(); refresh(); return;
      }
      el=el.parentElement;
    }
  }, true);

  console.log("[STORY_VIEW_V8] ready");
})();
</script>
<!-- /NG_PATCH: STORY_VIEW_V8 -->

<script>
(function(){
  if (window.__NG_STORYVIEW_V9_INSTALLED) return;
  window.__NG_STORYVIEW_V9_INSTALLED = true;

  // 1) Capture /api/digi-pack response + request into localStorage
  var _fetch = window.fetch;
  if (typeof _fetch === "function") {
    window.fetch = function(input, init){
      var url = "";
      try { url = (typeof input === "string") ? input : (input && input.url) ? input.url : ""; } catch(e) {}
      var isDP = url && (url.indexOf("/api/digi-pack") !== -1);
      var reqBody = null;
      try { reqBody = init && init.body ? String(init.body) : null; } catch(e) {}

      return _fetch.apply(this, arguments).then(function(res){
        if (isDP) {
          try {
            var clone = res.clone();
            clone.json().then(function(j){
              try { localStorage.setItem("NG_LAST_DIGIPACK_RESP_V3", JSON.stringify(j)); } catch(e) {}
              if (reqBody) { try { localStorage.setItem("NG_LAST_DIGIPACK_REQ_V3", reqBody); } catch(e) {} }
            }).catch(function(){});
          } catch(e) {}
        }
        return res;
      });
    };
  }

  function normalizeHeadings(s){
    s = String(s || "");
    s = s.replace(/^\s*###\s+WEB_ARTICLE\s*$/gm, "### WEB_ARTICLE");
    s = s.replace(/^\s*###\s+VIDEO\s*$/gm, "### VIDEO");
    s = s.replace(/^\s*###\s+YOUTUBE\s*$/gm, "### YOUTUBE");
s = s.replace(/^\s*###\s+YOUTUBE\s+DESCRIPTION\s*$/gm, "### YOUTUBE");

    s = s.replace(/^\s*###\s+SOCIAL\s*$/gm, "### SOCIAL");
// âœ… Quick View heading normalization (robust)
s = s.replace(/^\s*###\s+QUICK\s+VIEW\s*$/gmi, "### QUICK_VIEW");
s = s.replace(/^\s*##\s+QUICK\s+VIEW\s*$/gmi,  "### QUICK_VIEW");
s = s.replace(/^\s*###\s+QUICKVIEW\s*$/gmi,     "### QUICK_VIEW");

    return s;
  }

  function section(all, head){
    all = normalizeHeadings(all);
var headRe = String(head || "").trim().replace(/[-\/\\^$*+?.()|[\]{}]/g, "\\$&").replace(/[_\s]+/g, "[_\\s]+");

    var re = new RegExp("^\\s*###\\s+" + headRe + "\\s*\\n([\\s\\S]*?)(?=^\\s*###\\s+|(?![\\s\\S]))", "m");

    var m = all.match(re);
    return m ? String(m[1]).trim() : "";
  }

  function getLastResp(){
    try { return JSON.parse(localStorage.getItem("NG_LAST_DIGIPACK_RESP_V3") || "null"); } catch(e) { return null; }
  }
  function getLastReqTopic(){
    try {
      var raw = localStorage.getItem("NG_LAST_DIGIPACK_REQ_V3") || "";
      var j = JSON.parse(raw);
      var p = j && j.prompt ? String(j.prompt) : "";
      // p is itself JSON string
      var k = JSON.parse(p);
      return (k && (k.topic || k.headline || k.title)) ? String(k.topic || k.headline || k.title) : "";
    } catch(e) { return ""; }
  }

  // 2) UI: Floating button + overlay
  function el(tag, attrs){
    var e = document.createElement(tag);
    if (attrs) {
      for (var k in attrs) {
        if (!attrs.hasOwnProperty(k)) continue;
        if (k === "style") e.style.cssText = attrs[k];
        else if (k === "text") e.textContent = attrs[k];
        else e.setAttribute(k, attrs[k]);
      }
    }
    return e;
  }

  var btn = el("button", {
    id: "btn-storyview-v9",
    text: "Story View V9",
    style: "position:fixed;right:16px;bottom:16px;z-index:99999;padding:10px 12px;border:1px solid #333;border-radius:10px;background:#111;color:#fff;cursor:pointer;font:14px/1.2 system-ui;"
  });

  var overlay = el("div", {
    id: "ng-storyview-v9-overlay",
    style: "display:none;position:fixed;inset:0;z-index:99998;background:rgba(0,0,0,0.72);"
  });

  var panel = el("div", {
    style: "position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:min(1100px,92vw);height:min(92vh,860px);background:#fff;border-radius:14px;overflow:hidden;display:flex;flex-direction:column;"
  });

  var header = el("div", { style: "padding:10px 12px;background:#0f172a;color:#fff;display:flex;align-items:center;gap:10px;" });
  var title = el("div", { text: "Story View V9 (Text Fields)", style: "font-weight:700;" });
  var hint  = el("div", { text: "Raw hidden by default â€¢ Pulls last /api/digi-pack response automatically", style: "opacity:.85;font-size:12px;margin-left:8px;" });
  var close = el("button", { text: "Close", style: "margin-left:auto;padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.4);background:transparent;color:#fff;cursor:pointer;" });

  header.appendChild(title); header.appendChild(hint); header.appendChild(close);

  var body = el("div", { style: "padding:12px;overflow:auto;display:grid;grid-template-columns:1fr 1fr;gap:12px;" });

  function block(label){
    var wrap = el("div", { style: "display:flex;flex-direction:column;gap:6px;" });
    var lab  = el("div", { text: label, style: "font-weight:700;font-size:13px;" });
    var ta   = el("textarea", { style: "width:100%;min-height:160px;resize:vertical;padding:10px;border:1px solid #cbd5e1;border-radius:10px;font:13px/1.35 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;" });
    wrap.appendChild(lab); wrap.appendChild(ta);
    return { wrap: wrap, ta: ta };
  }

  var qh = block("QUICK VIEW â€¢ HEADLINE");
  qh.ta.style.minHeight = "70px";
  var qb = block("QUICK VIEW â€¢ BULLETS (2â€“4)");
  qb.ta.style.minHeight = "110px";

  var wa = block("WEB_ARTICLE (500â€“600 words)");
  var vd = block("VIDEO (HOOK + 8â€“12 lines)");
  var yt = block("YOUTUBE (Title/Desc/Tags/Hashtags)");
  var so = block("SOCIAL (X/IG/FB/WA)");

  var raw = block("RAW OUTPUT (hidden by default)");
  raw.ta.style.minHeight = "140px";

  var toggleRaw = el("button", {
    text: "Show Raw",
    style: "padding:8px 10px;border-radius:10px;border:1px solid #cbd5e1;background:#f8fafc;cursor:pointer;width:max-content;"
  });
  raw.wrap.insertBefore(toggleRaw, raw.wrap.children[1]);
  raw.ta.style.display = "none";

  toggleRaw.addEventListener("click", function(){
    var on = (raw.ta.style.display !== "none");
    raw.ta.style.display = on ? "none" : "block";
    toggleRaw.textContent = on ? "Show Raw" : "Hide Raw";
  });

  body.appendChild(qh.wrap);
  body.appendChild(qb.wrap);
  body.appendChild(wa.wrap);
  body.appendChild(vd.wrap);
  body.appendChild(yt.wrap);
  body.appendChild(so.wrap);
  body.appendChild(raw.wrap);

  panel.appendChild(header);
  panel.appendChild(body);
  overlay.appendChild(panel);

  function fillFromLast(){
    var resp = getLastResp();
    var topic = getLastReqTopic();

    var txt = resp && resp.generated_text ? String(resp.generated_text) : "";
    txt = normalizeHeadings(txt);

    var web = section(txt, "WEB_ARTICLE");
    var vid = section(txt, "VIDEO");
    var ytb = section(txt, "YOUTUBE");
    var soc = section(txt, "SOCIAL");

    // Quick view heuristics
    var headline = topic || (web ? web.split("\n")[0].trim() : "");
    if (headline && headline.length > 110) headline = headline.slice(0, 110) + "â€¦";

    var bullets = "";
    if (vid) {
      var lines = vid.split("\n").map(function(s){ return s.trim(); }).filter(Boolean);
      var picks = [];
      for (var i=0;i<lines.length;i++){
        if (/^(\(?\d+\)?[.)])\s+/.test(lines[i])) picks.push(lines[i].replace(/^(\(?\d+\)?[.)])\s+/, ""));
        if (picks.length >= 4) break;
      }
      bullets = picks.join("\n");
    }
    if (!bullets && web) {
      var s1 = web.split("à¥¤");
      bullets = (s1.slice(0,4).join("à¥¤") + (s1.length>4 ? "à¥¤" : "")).replace(/\n+/g," ").trim();
    }

    qh.ta.value = headline || "";
    qb.ta.value = bullets || "";

    wa.ta.value = web || "";
    vd.ta.value = vid || "";
    yt.ta.value = ytb || "";
    so.ta.value = soc || "";
    raw.ta.value = (resp ? JSON.stringify(resp, null, 2) : "");
  }

  btn.addEventListener("click", function(){
    fillFromLast();
    overlay.style.display = "block";
  });
  close.addEventListener("click", function(){ overlay.style.display = "none"; });

  document.addEventListener("keydown", function(e){
    if (e && e.key === "Escape") overlay.style.display = "none";
  });

  document.body.appendChild(btn);
  document.body.appendChild(overlay);
})();
</script>

<script>
// [NG_LASTPACK_CAPTURE_V1]
(function(){
  if (window.__NG_LASTPACK_CAPTURE_V1) return;
  window.__NG_LASTPACK_CAPTURE_V1 = true;

  function ngTopic(){
    try{
      var el = document.getElementById("topic")
        || document.querySelector("input[name='topic']")
        || document.querySelector("textarea[name='topic']");
      return String((el && ("value" in el)) ? el.value : "").trim();
    }catch(e){ return ""; }
  }

  function deepFind(x){
    if (!x) return "";
    if (typeof x === "string") return (x.indexOf("###") >= 0) ? x : "";
    if (typeof x !== "object") return "";
    var best = "", k, t, i;
    if (Array.isArray && Array.isArray(x)){
      for (i=0;i<x.length;i++){
        t = deepFind(x[i]);
        if (t && t.length > best.length) best = t;
      }
      return best;
    }
    for (k in x){
      if (!Object.prototype.hasOwnProperty.call(x,k)) continue;
      t = deepFind(x[k]);
      if (t && t.length > best.length) best = t;
    }
    return best;
  }

  function packFromObj(obj){
  try{
    if (!obj || typeof obj !== "object") return "";

    // common nesting
    var root = obj;
    if (obj.data   && typeof obj.data   === "object") root = obj.data;
    if (obj.result && typeof obj.result === "object") root = obj.result;
    if (obj.outputs&& typeof obj.outputs=== "object") root = obj.outputs;

    // if server already gives a pack-like string
    if (typeof root.pack === "string" && root.pack.indexOf("###") >= 0) return root.pack;
    if (typeof root.text === "string" && root.text.indexOf("###") >= 0) return root.text;

    function get(o, keys){
      for (var i=0;i<keys.length;i++){
        var k = keys[i];
        if (o && o[k] != null && String(o[k]).trim() !== "") return String(o[k]);
      }
      return "";
    }

    // try many key variants
    var qv  = get(root, ["QUICK_VIEW","quick_view","quickView","quickview","qv","quick"]);
    var wa  = get(root, ["WEB_ARTICLE","web_article","webArticle","web","article","web_text","webText"]);
    var vid = get(root, ["VIDEO","video","video_script","videoScript","video_text","videoText"]);
    var yt  = get(root, ["YOUTUBE","youtube","youtube_description","youtubeDescription","youtube_text","youtubeText","ytb"]);
    var soc = get(root, ["SOCIAL","social","social_post","socialPost","social_text","socialText","soc"]);

    function add(head, txt){
      txt = String(txt || "").trim();
      return txt ? ("### " + head + "\n" + txt) : "";
    }

    // fallback quick view from web article top
    if (!String(qv||"").trim() && String(wa||"").trim()){
      qv = String(wa).trim().split(/\n+/).slice(0,4).join("\n").trim();
    }

    var parts = [];
    var a = add("QUICK_VIEW", qv); if (a) parts.push(a);
    a = add("WEB_ARTICLE", wa);    if (a) parts.push(a);
    a = add("VIDEO", vid);         if (a) parts.push(a);
    a = add("YOUTUBE", yt);        if (a) parts.push(a);
    a = add("SOCIAL", soc);        if (a) parts.push(a);

    return parts.join("\n\n") + "\n";
  } catch(e){ return ""; }
}

function findPackText(text){
  text = String(text || "");
  if (text.indexOf("###") >= 0) return text;

  if (text && (text.charAt(0)==="{" || text.charAt(0)==="[")){
    try {
      var obj = JSON.parse(text);
      var found = deepFind(obj);
      if (found) return found;

      var built = packFromObj(obj);
      if (built) return built;
    } catch(e){}
  }
  return "";
}

function store(raw){
    raw = String(raw || "");
    if (!raw || raw.length < 200) return;
    window.NG_LAST_RAW  = raw;
    window.NG_LAST_META = { ts: new Date().toISOString(), topic: ngTopic() };
    try { localStorage.setItem("NG_LAST_RAW", raw); } catch(e){}
    try { localStorage.setItem("NG_LAST_META", JSON.stringify(window.NG_LAST_META)); } catch(e){}
    console.log("[NG_LASTPACK_CAPTURE_V1] stored", { len: raw.length, topic: window.NG_LAST_META.topic });
  }

  var _f = window.fetch;
  if (typeof _f === "function"){
    window.fetch = function(input, init){
      var url = "";
      try { url = (typeof input === "string") ? input : (input && input.url) ? input.url : ""; } catch(e){}
      var p = _f.apply(this, arguments);

      if (!url || url.indexOf("/api/digi-pack") < 0) return p;

      return p.then(function(res){
        try{
          var c = res.clone();
          c.text().then(function(t){
            var raw = findPackText(t);
            if (raw) store(raw);
            else console.log("[NG_LASTPACK_CAPTURE_V1] no-pack-in-response", { textLen: (t||"").length });
          }).catch(function(){});
        }catch(e){}
        return res;
      });
    };
  }

  console.log("[NG_LASTPACK_CAPTURE_V1] installed");
})();
</script>

<!-- NG_TEXT_FIX_FINAL_START -->
<script>
(function(){
  function looksMojibake(s){ return /à¤|à¥|Ã.|â€|Â.|ðŸ/.test(s||""); }
  var W = {8364:128,8218:130,402:131,8222:132,8230:133,8224:134,8225:135,710:136,8240:137,352:138,8249:139,338:140,381:142,8216:145,8217:146,8220:147,8221:148,8226:149,8211:150,8212:151,732:152,8482:153,353:154,8250:155,339:156,382:158,376:159};

  function shouldSkipEl(el){
    if(!el) return false;
    var tag = (el.tagName||"").toLowerCase();
    return tag === "script" || tag === "style" || tag === "template";
  }
  function bytesFromWin1252String(s){
    var bytes = [];
    for(var i=0;i<s.length;i++){
      var cp = s.charCodeAt(i);
      if(cp <= 255) bytes.push(cp & 255);
      else if(W[cp] != null) bytes.push(W[cp]);
      else return null;
    }
    return bytes;
  }
  function decodeWin1252MojibakeToUtf8(s){
    try{
      var b = bytesFromWin1252String(s);
      if(!b) return s;
      return new TextDecoder("utf-8").decode(new Uint8Array(b));
    }catch(e){ return s; }
  }
  function fixStr(s){
    s = (s == null) ? "" : String(s);
    if(!looksMojibake(s)) return s;
    var out = decodeWin1252MojibakeToUtf8(s);
    if(out === s){
      try { out = decodeURIComponent(escape(s)); } catch(e2) {}
    }
    return out;
  }
  function fixTextNode(tn){
    if(!tn || tn.nodeType !== 3) return 0;
    var s = tn.nodeValue || "";
    if(!looksMojibake(s)) return 0;
    var p = tn.parentElement;
    if(shouldSkipEl(p)) return 0;
    var ns = fixStr(s);
    if(ns !== s){ tn.nodeValue = ns; return 1; }
    return 0;
  }
  function fixAttrs(el){
    if(!el || el.nodeType !== 1) return 0;
    if(shouldSkipEl(el)) return 0;
    var attrs = ["placeholder","title","aria-label","value"];
    var k = 0;
    for(var i=0;i<attrs.length;i++){
      if(el.hasAttribute && el.hasAttribute(attrs[i])){
        var v = el.getAttribute(attrs[i]);
        if(looksMojibake(v)){
          var nv = fixStr(v);
          if(nv !== v){ el.setAttribute(attrs[i], nv); k++; }
        }
      }
    }
    return k;
  }
  function fixSubtree(root){
    var fixed = 0;
    if(!root) return fixed;
    if(root.nodeType === 1) fixed += fixAttrs(root);

    try{
      var w = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, null, false);
      var n;
      while((n = w.nextNode())) fixed += fixTextNode(n);
    }catch(e){}

    if(root.querySelectorAll){
      var all = root.querySelectorAll("*");
      for(var j=0;j<all.length;j++) fixed += fixAttrs(all[j]);
    }
    return fixed;
  }
  function setTopicPlaceholder(){
    var topic = document.getElementById("topic") || document.querySelector('input[name="topic"]') || null;
    if(!topic){
      var labs = document.querySelectorAll("label");
      for(var i=0;i<labs.length && !topic;i++){
        var lt = (labs[i].textContent || "").toLowerCase();
        if(lt.indexOf("topic") >= 0 || lt.indexOf("टॉपिक") >= 0){
          var fid = labs[i].getAttribute("for");
          if(fid) topic = document.getElementById(fid);
          if(!topic && labs[i].parentNode) topic = labs[i].parentNode.querySelector("input,textarea");
        }
      }
    }
    if(topic){ topic.setAttribute("placeholder", "उदाहरण: संसद प्रदूषण विवाद"); return 1; }
    return 0;
  }
  function fixReverieHint(){
    var nodes = document.querySelectorAll("body *");
    for(var i=0;i<nodes.length;i++){
      var e = nodes[i];
      if(!e || e.children.length) continue;
      var t = e.textContent || "";
      if(t.indexOf("Reverie") >= 0 || t.indexOf("रेवेरी") >= 0){
        e.textContent = "Reverie output JSON यहाँ पेस्ट करें (display_text या text)। Load करने पर localStorage में सेव होगा।";
        return 1;
      }
    }
    return 0;
  }

  function applyOnce(){
    var fixed = { textOrAttrs:0, title:0, topicPH:0, reverie:0 };
    try{
      var tt = document.title || "";
      var nt = fixStr(tt);
      if(nt !== tt){ document.title = nt; fixed.title++; }
    }catch(e){}
    fixed.textOrAttrs += fixSubtree(document.body);
    fixed.topicPH = setTopicPlaceholder();
    fixed.reverie = fixReverieHint();

    window.NG_copy = function(x){
      try{
        var txt = (typeof x === "string") ? x : JSON.stringify(x, null, 2);
        if(typeof copy === "function"){ copy(txt); console.log("[NG_copy] copied"); return true; }
        if(navigator.clipboard && navigator.clipboard.writeText){
          navigator.clipboard.writeText(txt).then(function(){ console.log("[NG_copy] copied"); }).catch(function(){});
          return true;
        }
      }catch(e){}
      console.warn("[NG_copy] copy() नहीं मिला—manual copy करें।");
      return false;
    };

    window.NG_mojibakeCount = function(){
      var bad = 0;
      var w = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT, null, false);
      var n;
      while((n=w.nextNode())){
        var s = n.nodeValue || "";
        if(!looksMojibake(s)) continue;
        var p = n.parentElement;
        if(shouldSkipEl(p)) continue;
        bad++;
      }
      console.log("[NG_mojibakeCount] =", bad);
      return bad;
    };

    console.log("[NG_TEXT_FIX_FINAL] applied", fixed);
    return fixed;
  }

  function startObserver(){
    try{
      if(window.__NG_TEXT_FIX_OBS && window.__NG_TEXT_FIX_OBS.disconnect) window.__NG_TEXT_FIX_OBS.disconnect();
      var obs = new MutationObserver(function(muts){
        var total = 0;
        for(var i=0;i<muts.length;i++){
          var m = muts[i];
          if(m.type === "characterData") total += fixTextNode(m.target);
          else if(m.type === "childList"){
            var add = m.addedNodes || [];
            for(var a=0;a<add.length;a++){
              var node = add[a];
              if(node.nodeType === 3) total += fixTextNode(node);
              else if(node.nodeType === 1) total += fixSubtree(node);
            }
          }
        }
        if(total) console.log("[NG_TEXT_FIX_FINAL] observer fixed =", total);
      });
      obs.observe(document.body, { subtree:true, childList:true, characterData:true });
      window.__NG_TEXT_FIX_OBS = obs;
      console.log("[NG_TEXT_FIX_FINAL] observer ON");
      return true;
    }catch(e){
      console.warn("[NG_TEXT_FIX_FINAL] observer failed", e);
      return false;
    }
  }

  function burstRescan(){
    var n = 0;
    var t = setInterval(function(){
      n++;
      var fixed = fixSubtree(document.body);
      if(fixed) console.log("[NG_TEXT_FIX_FINAL] burst fixed =", fixed);
      if(n >= 20) clearInterval(t);
    }, 500);
  }

  window.addEventListener("load", function(){
    setTimeout(function(){
      applyOnce();
      startObserver();
      burstRescan();
    }, 60);
  });
})();
</script>
<!-- NG_TEXT_FIX_FINAL_END -->

<!-- NG_PUBLISH_FIX_V1_START -->
<script>
(function(){
  // goal: published items should still be "selectable story" for download/preview

  function getDraftsSafe(){
    try{
      var d = (typeof getDrafts === "function") ? getDrafts() : null;
      return Array.isArray(d) ? d : [];
    }catch(e){ return []; }
  }

  function getCurrentIdSafe(){
    try{
      if (typeof getCurrentId === "function") return String(getCurrentId() || "");
    }catch(e){}
    // fallback (if your app stores current id differently)
    return String(window.__NG_CURRENT_ID || "");
  }

  function findSelectedAnyIndex(){
    var drafts = getDraftsSafe();
    var cid = getCurrentIdSafe();
    if (cid){
      for (var i=0;i<drafts.length;i++){
        var it = drafts[i] || {};
        if (it.id === cid || it.uid === cid) return i;
      }
    }
    return drafts.length ? (drafts.length - 1) : -1;
  }

  // Override: return ANY status (draft or published)
  window.findSelectedDraftIndex = function(){
    return findSelectedAnyIndex();
  };

  window.getDraftByIndex = function(idx){
    var drafts = getDraftsSafe();
    if (typeof idx !== "number") idx = findSelectedAnyIndex();
    if (idx < 0 || idx >= drafts.length) idx = drafts.length ? (drafts.length - 1) : -1;
    var draft = (idx >= 0) ? drafts[idx] : null;
    return { drafts: drafts, idx: idx, draft: draft };
  };

  window.getDraft = function(){
    return window.getDraftByIndex(findSelectedAnyIndex());
  };

  console.log("[NG_PUBLISH_FIX_V1] enabled (downloads/previews work for published too)");
})();
</script>
<!-- NG_PUBLISH_FIX_V1_END -->
<!-- NG_PUBLISH_SELECT_FIX_V2_START -->
<script>
(function(){
  if (window.__NG_PUBLISH_SELECT_FIX_V2) return;
  window.__NG_PUBLISH_SELECT_FIX_V2 = true;

  function safeDrafts(){
    try {
      var d = (typeof getDrafts === "function") ? getDrafts() : [];
      return Array.isArray(d) ? d : [];
    } catch(e){ return []; }
  }

  function safeCurrentId(){
    try { return (typeof getCurrentId === "function") ? String(getCurrentId() || "") : ""; }
    catch(e){ return ""; }
  }

  function pickIndexAny(){
    var drafts = safeDrafts();
    if (!drafts.length) return -1;

    var cid = safeCurrentId();
    if (cid){
      for (var i=0;i<drafts.length;i++){
        var it = drafts[i] || {};
        if (it.id === cid || it.uid === cid) return i;
      }
    }
    // fallback: last item (draft OR published)
    return drafts.length - 1;
  }

  // ✅ selection functions: do NOT filter by status
  window.findSelectedIndex = function(){ return pickIndexAny(); };
  window.findSelectedDraftIndex = function(){ return pickIndexAny(); };

  // ✅ getDraftByIndex: always return wrapper g with g.draft (even if published)
  window.getDraftByIndex = function(idx){
    var drafts = safeDrafts();
    if (typeof idx !== "number") idx = pickIndexAny();
    if (idx < 0 || idx >= drafts.length) idx = drafts.length ? (drafts.length - 1) : -1;

    var d = (idx >= 0) ? drafts[idx] : null;
    if (!d) return { drafts: drafts, idx: idx, draft: null };

    // wrapper: keeps old code working without circular JSON
    var g = Object.create(d);
    g.draft = d;
    g.drafts = drafts;
    g.idx = idx;
    return g;
  };

  window.getDraft = function(){
    return window.getDraftByIndex(pickIndexAny());
  };

  // ✅ StoryView fallback: Headline/Dek/Key Points fill if missing
  if (typeof window.extractGeneratedFromDraft === "function" && !window.__NG_EXTRACT_FALLBACK_V2){
    var _ex = window.extractGeneratedFromDraft;window.extractGeneratedFromDraft = function(draft){
  var gen = _ex(draft) || {};
  var story = (draft && draft.story) || {};
  var dp = story.digipack || {};
  var raw = dp.raw || story.full_digipack || "";

  // helper: pull section from generated_text
  function grab(txt, name){
    if (!txt) return "";
    var re = new RegExp("###\\s*" + name + "\\s*\\n([\\s\\S]*?)(?=\\n###\\s*[A-Z][A-Z _]*\\s*\\n|$)", "i");
    var m = String(txt).match(re);
    return m ? String(m[1] || "").trim() : "";
  }

  // ✅ If gen is empty but we have wrapper JSON with generated_text, parse it
  try{
    if ((!gen || Object.keys(gen).length === 0) && raw && raw.trim().charAt(0) === "{"){
      var parsed = JSON.parse(raw);
      if (parsed && typeof parsed.generated_text === "string") {
        var txt = parsed.generated_text;

        var web = grab(txt, "WEB_ARTICLE");
        var video = grab(txt, "VIDEO");
        var ytd = grab(txt, "YOUTUBE DESCRIPTION");

        if (web && !gen.web_article_500_600) gen.web_article_500_600 = web;
        if (ytd && !gen.youtube_description) gen.youtube_description = ytd;

        if (video){
          // HOOK
          var hm = video.match(/HOOK:\s*(.+)/i);
          if (hm && !gen.video_hook) gen.video_hook = String(hm[1]||"").trim();

          // LINES
          var lines = [];
          var parts = video.split(/LINES:\s*/i);
          if (parts.length > 1){
            var each = String(parts[1]||"").split(/\n/);
            for (var i=0;i<each.length;i++){
              var s = String(each[i]||"").replace(/^\s*\d+\)\s*/,"").trim();
              if (!s) continue;
              if (s.indexOf("###") === 0) break;
              lines.push(s);
            }
          }
          if (lines.length && !Array.isArray(gen.lines)) gen.lines = lines;
        }
      }
    }
  }catch(e){}

  // headline/dek fallback
  if (!gen.headline) gen.headline = story.headline || draft.headline || story.title || draft.title || gen.video_hook || "";
  if (!gen.dek) gen.dek = story.dek || story.summary || story.description || "";

  // key points fallback
  if (!gen.key_points){
    if (Array.isArray(story.key_points) && story.key_points.length) {
      gen.key_points = story.key_points;
    } else if (Array.isArray(gen.lines) && gen.lines.length) {
      gen.key_points = gen.lines.slice(0,6).map(function(x){ return String(x||"").trim(); }).filter(Boolean);
    }
  }

  return gen;
};

    window.__NG_EXTRACT_FALLBACK_V2 = true;
  }

  console.log("[NG_PUBLISH_SELECT_FIX_V2] applied", { total: safeDrafts().length, idx: pickIndexAny() });
})();
</script>
<!-- NG_PUBLISH_SELECT_FIX_V2_END -->
<!-- NG_PATCH: STORYVIEW_FORCE_FILL_V1 -->
<script>
(function(){
  if (window.__NG_STORYVIEW_FORCE_FILL_V1) return;
  window.__NG_STORYVIEW_FORCE_FILL_V1 = true;

  function getGen(){
    try{
      var arr = JSON.parse(localStorage.getItem("NG_DRAFTS")||"[]");
      if (!arr || !arr.length) return null;
      var d = arr[arr.length-1] || {};
      var g = (((d.story||{}).digipack||{}).blocks||{}).generated || null;
      return g;
    }catch(e){ return null; }
  }

  function A(x){
    return Array.isArray(x) ? x.map(function(v){return String(v||"").trim();}).filter(Boolean) : [];
  }

  function setField(ov, label, val){
    if (!ov) return false;
    label = String(label||"").toLowerCase();

    var nodes = ov.querySelectorAll("div,span,strong,b,h3,h4,label");
    for (var i=0;i<nodes.length;i++){
      var t = (nodes[i].textContent||"").replace(/\s+/g," ").trim().toLowerCase();
      if (!t) continue;
      if (t.length > 80) continue;                 // avoid big blocks
      if (t.indexOf(label) === -1) continue;       // matches "Headline Copy"

      // try nearest container
      var box = nodes[i].parentNode || nodes[i];
      var out = box.querySelector("textarea,pre,div[contenteditable='true']");
      if (!out){
        // try next sibling
        var n = box.nextElementSibling;
        if (n && n.querySelector) out = n.querySelector("textarea,pre,div[contenteditable='true']");
      }
      if (!out){
        // last resort: any pre/textarea after this node
        var all = ov.querySelectorAll("textarea,pre");
        if (all && all.length) out = all[Math.min(i, all.length-1)];
      }

      if (out){
        if (out.tagName === "TEXTAREA") out.value = String(val||"");
        else out.textContent = String(val||"");
        return true;
      }
    }
    return false;
  }

  function fill(){
    var ov = document.getElementById("ng-storyview-v9-overlay");
    if (!ov || ov.style.display === "none") return false;

    var g = getGen();
    if (!g) return false;

    var headline = g.headline || g.video_hook || "";
    var dek = g.dek || "";
    var kp = A(g.key_points || g.bullet_points || g.lines).slice(0,6);
    var kpText = kp.length ? kp.map(function(x){return "- "+x;}).join("\n") : "";
    var web = g.web_article_500_600 || g.web_article || "";

    var lines = A(g.lines || g.vo_lines);
    var videoText = "";
    if (g.video_hook) videoText += "HOOK: " + g.video_hook + "\n";
    if (lines.length) videoText += "LINES:\n" + lines.map(function(x,idx){return (idx+1)+") "+x;}).join("\n");

    setField(ov,"headline", headline);
    setField(ov,"dek", dek);
    setField(ov,"key points", kpText);
    setField(ov,"web article", web);
    setField(ov,"video", videoText);

    return true;
  }

  document.addEventListener("click", function(e){
    var t = e && e.target;
    var id = (t && t.id) ? t.id : "";
    if (id === "btn-storyview-v9") {
      setTimeout(fill, 80);
      setTimeout(fill, 250);
    }
  }, true);

  setInterval(fill, 800);
  console.log("[STORYVIEW_FORCE_FILL_V1] installed");
})();
</script>
<!-- /NG_PATCH: STORYVIEW_FORCE_FILL_V1 -->
<!-- NG_DRAFT_SELECT_FIX_V1_START -->
<script>
(function(){
  try{
    var DRAFTS_KEY   = "NG_DIGIPACK_DRAFTS_V1";
    var SEL_IDX_KEY  = "NG_DIGIPACK_SELECTED_IDX_V1";
    var SEL_ID_KEY   = "NG_DIGIPACK_SELECTED_ID_V1";

    // If your app already uses any "selected idx" keys, we will update them ONLY if they already exist.
    var MIRROR_KEYS = [
      "NG_DIGIPACK_DRAFT_IDX",
      "NG_DRAFT_IDX",
      "NG_DRAFT_SELECTED_IDX",
      "NG_SELECTED_DRAFT_IDX"
    ];

    function safeJSONParse(s, fallback){
      try { return JSON.parse(s); } catch(e){ return fallback; }
    }

    function readDrafts(){
      var raw = "";
      try { raw = localStorage.getItem(DRAFTS_KEY) || "[]"; } catch(e){ raw = "[]"; }
      var arr = safeJSONParse(raw, []);
      return Array.isArray(arr) ? arr : [];
    }

    function toTime(v){
      if (v == null) return NaN;
      if (typeof v === "number") return v;
      if (typeof v === "string") {
        var n = parseFloat(v);
        if (isFinite(n) && String(n) === v.replace(/\s+/g,"")) return n;
        var t = Date.parse(v);
        return isFinite(t) ? t : NaN;
      }
      try {
        var t2 = Date.parse(String(v));
        return isFinite(t2) ? t2 : NaN;
      } catch(e){}
      return NaN;
    }

    function getDraftId(d, i){
      if (!d) return "i:" + i;
      // Prefer explicit ids if present
      var id = d.id || d.uid || d.key || d._id || d.draft_id;
      if (id != null && id !== "") return String(id);

      // Otherwise build a stable-ish fingerprint
      var t = toTime(d.saved || d.ts || d.updated || d.created || d.time || d.last_saved);
      var h = d.headline || (d.story && d.story.headline) || "";
      return "fp:" + (isFinite(t) ? String(t) : "na") + "|" + String(h).slice(0,80);
    }

    function findIdxById(drafts, id){
      if (!id) return -1;
      for (var i=0;i<drafts.length;i++){
        if (getDraftId(drafts[i], i) === id) return i;
      }
      return -1;
    }

    function findLatestIdx(drafts){
      if (!drafts || !drafts.length) return -1;
      var bestIdx = drafts.length - 1;
      var bestT = -Infinity;

      for (var i=0;i<drafts.length;i++){
        var d = drafts[i];
        var t = toTime(d && (d.saved || d.ts || d.updated || d.created || d.time || d.last_saved));
        if (isFinite(t) && t > bestT){
          bestT = t;
          bestIdx = i;
        }
      }
      return bestIdx;
    }

    function getStoredIdx(){
      var s = null;
      try { s = localStorage.getItem(SEL_IDX_KEY); } catch(e){ s = null; }
      var idx = parseInt(s, 10);
      return isFinite(idx) ? idx : -1;
    }

    function setStoredIdx(idx, drafts){
      try { localStorage.setItem(SEL_IDX_KEY, String(idx)); } catch(e){}

      // Store selected "id" too (more robust if array order changes)
      try {
        var id = (drafts && drafts[idx]) ? getDraftId(drafts[idx], idx) : "";
        if (id) localStorage.setItem(SEL_ID_KEY, id);
      } catch(e){}

      // Mirror into any legacy keys only if they already exist
      for (var i=0;i<MIRROR_KEYS.length;i++){
        var k = MIRROR_KEYS[i];
        try {
          if (localStorage.getItem(k) !== null) localStorage.setItem(k, String(idx));
        } catch(e){}
      }

      window.__NG_ACTIVE_DRAFT_IDX = idx;
      window.__NG_ACTIVE_DRAFT = (drafts && drafts[idx]) ? drafts[idx] : null;
    }

    function triggerChange(el){
      try{
        var ev = new Event("change", { bubbles: true });
        el.dispatchEvent(ev);
      }catch(e){
        try{
          var ev2 = document.createEvent("Event");
          ev2.initEvent("change", true, true);
          el.dispatchEvent(ev2);
        }catch(e2){}
      }
    }

    function syncUIToIdx(idx){
      // Best-effort UI sync: select dropdown / radio / data-idx element
      var sel =
        document.querySelector("#draft-select") ||
        document.querySelector("#draftSelect") ||
        document.querySelector("select[name='draftSelect']") ||
        document.querySelector("select[name*='draft']") ||
        document.querySelector("select[id*='draft']");

      if (sel && sel.options && sel.options.length){
        if (idx >= 0 && idx < sel.options.length){
          sel.selectedIndex = idx;
          triggerChange(sel);
          return true;
        }
      }

      var radios = document.querySelectorAll("input[type='radio'][name*='draft']");
      if (radios && radios.length){
        if (idx >= 0 && idx < radios.length){
          radios[idx].checked = true;
          triggerChange(radios[idx]);
          return true;
        }
      }

      var item =
        document.querySelector("[data-draft-idx='"+idx+"']") ||
        document.querySelector("[data-idx='"+idx+"']");
      if (item && item.click){
        item.click();
        return true;
      }
      return false;
    }

    function ensureSelection(forceSyncUI){
      var drafts = readDrafts();
      if (!drafts.length){
        window.__NG_ACTIVE_DRAFT_IDX = -1;
        window.__NG_ACTIVE_DRAFT = null;
        return null;
      }

      var idx = getStoredIdx();

      // If we have stored ID, prefer it (handles reorder after Mark Published etc.)
      var selId = null;
      try { selId = localStorage.getItem(SEL_ID_KEY); } catch(e){ selId = null; }
      if (selId){
        var byId = findIdxById(drafts, selId);
        if (byId >= 0) idx = byId;
      }

      if (!(idx >= 0 && idx < drafts.length)){
        idx = findLatestIdx(drafts);
      }
      if (!(idx >= 0 && idx < drafts.length)) idx = drafts.length - 1;

      setStoredIdx(idx, drafts);
      if (forceSyncUI) syncUIToIdx(idx);

      return drafts[idx];
    }

    function findButton(el){
      var n = el, k = 0;
      while(n && k < 6){
        if (n.tagName === "BUTTON" || n.tagName === "A" || (n.getAttribute && n.getAttribute("role")==="button")){
          return n;
        }
        n = n.parentNode; k++;
      }
      return null;
    }

    function isDraftActionButton(btn){
      if (!btn) return false;
      var id = (btn.id || "").toLowerCase();
      var txt = (btn.textContent || "").toLowerCase();

      // known ids (from your earlier logs + common guesses)
      if (
        id === "btn-open-library" ||
        id === "btn-save-draft" ||
        id === "btn-mark-published" ||
        id === "btn-preview-digipack" ||
        id === "btn-download-json" ||
        id === "btn-download-txt" ||
        id.indexOf("download") >= 0 ||
        id.indexOf("preview") >= 0 ||
        id.indexOf("library") >= 0
      ) return true;

      // fallback by visible text
      if (
        txt.indexOf("download") >= 0 ||
        txt.indexOf("preview") >= 0 ||
        txt.indexOf("library") >= 0 ||
        txt.indexOf("save draft") >= 0 ||
        txt.indexOf("mark published") >= 0
      ) return true;

      return false;
    }

    function extractIdxFromClick(t){
      var n = t, k = 0;
      while(n && k < 7){
        // dataset
        if (n.dataset){
          if (n.dataset.draftIdx != null) {
            var a = parseInt(n.dataset.draftIdx, 10);
            if (isFinite(a)) return a;
          }
          if (n.dataset.idx != null) {
            var b = parseInt(n.dataset.idx, 10);
            if (isFinite(b)) return b;
          }
        }

        // radio value as idx
        if (n.tagName === "INPUT" && (n.type || "").toLowerCase() === "radio"){
          var v = parseInt(n.value, 10);
          if (isFinite(v)) return v;
        }

        // id pattern e.g., draft-2 / draft_2 / draftItem2
        var id = n.id || "";
        var m = /draft[^0-9]*([0-9]+)/i.exec(id);
        if (m && m[1] != null){
          var c = parseInt(m[1], 10);
          if (isFinite(c)) return c;
        }

        n = n.parentNode; k++;
      }
      return null;
    }

    // 1) Always ensure a valid selection before draft actions (Download/Preview/Library etc.)
    document.addEventListener("click", function(e){
      var btn = findButton(e.target);
      if (btn && isDraftActionButton(btn)){
        ensureSelection(false);

        var id = (btn.id || "").toLowerCase();
        var txt = (btn.textContent || "").toLowerCase();

        // After state-mutating actions, re-sync selection with UI
        if (id === "btn-save-draft" || id === "btn-mark-published" ||
            txt.indexOf("save draft") >= 0 || txt.indexOf("mark published") >= 0){
          setTimeout(function(){ ensureSelection(true); }, 250);
        }

        // When opening library, auto-select and sync UI quickly
        if (id === "btn-open-library" || txt.indexOf("library") >= 0){
          setTimeout(function(){ ensureSelection(true); }, 60);
        }
        return;
      }

      // 2) If user clicked a draft item in library, persist idx
      var idx = extractIdxFromClick(e.target);
      if (idx != null){
        var drafts = readDrafts();
        if (idx >= 0 && idx < drafts.length){
          setStoredIdx(idx, drafts);
        }
      }
    }, true);

    // 3) Persist selection if a draft <select> changes
    document.addEventListener("change", function(e){
      var t = e.target;
      if (!t) return;
      if (t.tagName === "SELECT"){
        var id = (t.id || "").toLowerCase();
        var name = (t.name || "").toLowerCase();
        if (id.indexOf("draft") >= 0 || name.indexOf("draft") >= 0){
          var idx = t.selectedIndex;
          var drafts = readDrafts();
          if (idx >= 0 && idx < drafts.length){
            setStoredIdx(idx, drafts);
          }
        }
      }
    }, true);

    // Expose helper for quick manual test
    window.NG_getSelectedDraftV1 = function(){
      return ensureSelection(false);
    };

    // Bootstrap: set selection early (no UI click forced)
    if (document.readyState === "loading"){
      document.addEventListener("DOMContentLoaded", function(){
        ensureSelection(false);
        console.log("[NG_DRAFT_SELECT_FIX_V1] ready", { drafts: readDrafts().length, idx: getStoredIdx() });
      });
    } else {
      ensureSelection(false);
      console.log("[NG_DRAFT_SELECT_FIX_V1] ready", { drafts: readDrafts().length, idx: getStoredIdx() });
    }

  }catch(err){
    console.warn("[NG_DRAFT_SELECT_FIX_V1] failed", err);
  }
})();
</script>
<!-- NG_DRAFT_SELECT_FIX_V1_END -->
<!-- NG_DRAFTS_MIRROR_V1_START -->
<script>
(function(){
  try{
    var A = "NG_DIGIPACK_DRAFTS_V1";
    var B = "NG_DRAFTS"; // legacy key some UI parts may read

    function get(k){ try{return localStorage.getItem(k);}catch(e){return null;} }
    function set(k,v){ try{localStorage.setItem(k,v);}catch(e){} }

    function isNonEmptyArr(raw){
      try{ var x = JSON.parse(raw||"[]"); return Array.isArray(x) && x.length>0; }catch(e){ return false; }
    }

    function syncOnce(){
      var a = get(A);
      var b = get(B);

      // If legacy is empty but new has drafts -> copy new -> legacy
      if (isNonEmptyArr(a) && !isNonEmptyArr(b)) set(B, a);

      // (optional) if new is empty but legacy has drafts -> copy legacy -> new
      if (!isNonEmptyArr(a) && isNonEmptyArr(b)) set(A, b);
    }

    // run now + after key actions
    syncOnce();
    document.addEventListener("click", function(e){
      var t = e && e.target;
      if (!t) return;
      var id = (t.id||"").toLowerCase();
      var txt = (t.textContent||"").toLowerCase();

      // trigger sync around actions likely to show "No drafts found"
      if (id.indexOf("download")>=0 || id.indexOf("preview")>=0 || id.indexOf("library")>=0 ||
          id.indexOf("save")>=0 || id.indexOf("published")>=0 ||
          txt.indexOf("download")>=0 || txt.indexOf("preview")>=0 || txt.indexOf("library")>=0 ||
          txt.indexOf("save draft")>=0 || txt.indexOf("mark published")>=0) {
        syncOnce();
        setTimeout(syncOnce, 120);
      }
    }, true);

    console.log("[NG_DRAFTS_MIRROR_V1] ready");
  }catch(err){
    console.warn("[NG_DRAFTS_MIRROR_V1] failed", err);
  }
})();
</script>
<!-- NG_DRAFTS_MIRROR_V1_END -->
<!-- NG_DRAFT_LIBRARY_STABLE_V2_START -->
<script>
(function(){
  if (window.__NG_DRAFT_LIBRARY_STABLE_V2) return;
  window.__NG_DRAFT_LIBRARY_STABLE_V2 = true;

  var PRIMARY_KEY  = "NG_DIGIPACK_DRAFTS_V1";
  var LEGACY_KEYS  = ["NG_DRAFTS", "NG_DIGIPACK_DRAFTS_V1_BACKUP", "NG_DIGIPACK_DRAFTS"]; // harmless extras

  var SEL_IDX_KEY  = "NG_DIGIPACK_SELECTED_IDX_V1";
  var SEL_ID_KEY   = "NG_DIGIPACK_SELECTED_ID_V1";

  function jparse(s, fb){ try{ return JSON.parse(s); } catch(e){ return fb; } }
  function lget(k){ try{ return localStorage.getItem(k); } catch(e){ return null; } }
  function lset(k,v){ try{ localStorage.setItem(k, v); } catch(e){} }

  function isNonEmptyArr(raw){
    var a = jparse(raw || "[]", []);
    return Array.isArray(a) && a.length > 0;
  }

  function readDraftsAny(){
    var rawP = lget(PRIMARY_KEY);
    if (isNonEmptyArr(rawP)) return jparse(rawP, []);
    for (var i=0;i<LEGACY_KEYS.length;i++){
      var raw = lget(LEGACY_KEYS[i]);
      if (isNonEmptyArr(raw)) return jparse(raw, []);
    }
    return [];
  }

  function syncDraftKeys(){
    var rawP = lget(PRIMARY_KEY);
    // If primary has drafts, copy to legacy if legacy empty
    if (isNonEmptyArr(rawP)){
      for (var i=0;i<LEGACY_KEYS.length;i++){
        var k = LEGACY_KEYS[i];
        var rawL = lget(k);
        if (!isNonEmptyArr(rawL)) lset(k, rawP);
      }
      // also mirror to NG_DRAFTS (most important)
      var rawD = lget("NG_DRAFTS");
      if (!isNonEmptyArr(rawD)) lset("NG_DRAFTS", rawP);
      return;
    }

    // If primary empty but NG_DRAFTS has drafts, restore back
    var rawD2 = lget("NG_DRAFTS");
    if (isNonEmptyArr(rawD2) && !isNonEmptyArr(rawP)) lset(PRIMARY_KEY, rawD2);
  }

  function toTime(v){
    if (v == null) return NaN;
    if (typeof v === "number") return v;
    var t = Date.parse(String(v));
    return isFinite(t) ? t : NaN;
  }

  function getDraftId(d, i){
    if (!d) return "i:" + i;
    var id = d.id || d.uid || d.key || d._id || d.draft_id;
    if (id != null && id !== "") return String(id);
    var t = toTime(d.saved || d.ts || d.updated || d.created || d.created_at || d.time);
    var h = d.title || d.headline || (d.story && d.story.headline) || "";
    return "fp:" + (isFinite(t)?String(t):"na") + "|" + String(h).slice(0,80);
  }

  function findIdxById(drafts, id){
    if (!id) return -1;
    for (var i=0;i<drafts.length;i++){
      if (getDraftId(drafts[i], i) === id) return i;
    }
    return -1;
  }

  function latestIdx(drafts){
    if (!drafts.length) return -1;
    var bi = drafts.length-1, bt = -Infinity;
    for (var i=0;i<drafts.length;i++){
      var d = drafts[i];
      var t = toTime(d && (d.saved || d.ts || d.updated || d.created || d.created_at || d.time));
      if (isFinite(t) && t > bt){ bt=t; bi=i; }
    }
    return bi;
  }

  function getStoredIdx(){
    var s = lget(SEL_IDX_KEY);
    var n = parseInt(s, 10);
    return isFinite(n) ? n : -1;
  }

  function setStored(idx, drafts){
    lset(SEL_IDX_KEY, String(idx));
    var id = (drafts && drafts[idx]) ? getDraftId(drafts[idx], idx) : "";
    if (id) lset(SEL_ID_KEY, id);
    window.__NG_ACTIVE_DRAFT_IDX = idx;
    window.__NG_ACTIVE_DRAFT = (drafts && drafts[idx]) ? drafts[idx] : null;
  }

  function ensureSelection(){
    syncDraftKeys();
    var drafts = readDraftsAny();
    if (!drafts.length){
      window.__NG_ACTIVE_DRAFT_IDX = -1;
      window.__NG_ACTIVE_DRAFT = null;
      return null;
    }

    // Prefer stored ID if present
    var selId = lget(SEL_ID_KEY);
    var idx = -1;
    if (selId) idx = findIdxById(drafts, selId);

    // else stored idx
    if (!(idx >= 0 && idx < drafts.length)){
      idx = getStoredIdx();
    }

    // fallback: latest
    if (!(idx >= 0 && idx < drafts.length)){
      idx = latestIdx(drafts);
    }
    if (!(idx >= 0 && idx < drafts.length)) idx = 0;

    setStored(idx, drafts);
    return drafts[idx];
  }

  function isActionTarget(t){
    if (!t) return false;
    var b = t.closest ? t.closest("button,a,[role='button']") : null;
    var id = (b && b.id ? b.id : (t.id||"")).toLowerCase();
    var txt = ((b && b.textContent) ? b.textContent : (t.textContent||"")).toLowerCase();
    return (
      id.indexOf("download")>=0 || id.indexOf("preview")>=0 || id.indexOf("library")>=0 ||
      id.indexOf("save")>=0 || id.indexOf("published")>=0 ||
      txt.indexOf("download")>=0 || txt.indexOf("preview")>=0 || txt.indexOf("library")>=0 ||
      txt.indexOf("save draft")>=0 || txt.indexOf("mark published")>=0
    );
  }

  function extractIdx(t){
    var n=t, k=0;
    while(n && k<7){
      if (n.dataset){
        if (n.dataset.draftIdx != null){
          var a = parseInt(n.dataset.draftIdx,10); if (isFinite(a)) return a;
        }
        if (n.dataset.idx != null){
          var b = parseInt(n.dataset.idx,10); if (isFinite(b)) return b;
        }
      }
      if (n.tagName==="INPUT" && String(n.type||"").toLowerCase()==="radio"){
        var v = parseInt(n.value,10); if (isFinite(v)) return v;
      }
      n = n.parentNode; k++;
    }
    return null;
  }

  // ✅ KEY FIX: window capture => runs before document-capture handlers
  window.addEventListener("click", function(e){
    // Always keep keys + selection sane for anything draft-related
    if (isActionTarget(e.target)){
      ensureSelection();
      // post-mutate resync (Save/Mark Published)
      setTimeout(ensureSelection, 120);
      setTimeout(ensureSelection, 320);
    } else {
      // if clicked a draft item (idx) in library list
      var idx = extractIdx(e.target);
      if (idx != null){
        var drafts = readDraftsAny();
        if (idx>=0 && idx<drafts.length) setStored(idx, drafts);
      }
    }
  }, true);

  // bootstrap
  if (document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", function(){
      ensureSelection();
      console.log("[NG_DRAFT_LIBRARY_STABLE_V2] ready", {
        primary: (jparse(lget(PRIMARY_KEY)||"[]",[])).length,
        legacy: (jparse(lget("NG_DRAFTS")||"[]",[])).length,
        idx: lget(SEL_IDX_KEY),
        id: lget(SEL_ID_KEY)
      });
    });
  } else {
    ensureSelection();
    console.log("[NG_DRAFT_LIBRARY_STABLE_V2] ready", {
      primary: (jparse(lget(PRIMARY_KEY)||"[]",[])).length,
      legacy: (jparse(lget("NG_DRAFTS")||"[]",[])).length,
      idx: lget(SEL_IDX_KEY),
      id: lget(SEL_ID_KEY)
    });
  }

  // helper
  window.NG_getSelectedDraftV2 = ensureSelection;

})();
</script>
<!-- NG_DRAFT_LIBRARY_STABLE_V2_END -->
<!-- NG_ENSURE_DRAFT_HAS_DIGIPACK_V1_START -->
<script>
(function(){
  try{
    // avoid re-install
    if (window.ensureDraftHasDigipack) {
      console.log("[NG_ENSURE_DRAFT_HAS_DIGIPACK_V1] already present");
      return;
    }

    var PRIMARY_KEY = "NG_DIGIPACK_DRAFTS_V1";
    var LEGACY_KEY  = "NG_DRAFTS";
    var SEL_IDX_KEY = "NG_DIGIPACK_SELECTED_IDX_V1";
    var SEL_ID_KEY  = "NG_DIGIPACK_SELECTED_ID_V1";

    function jparse(s, fb){ try { return JSON.parse(s||""); } catch(e){ return fb; } }
    function lget(k){ try { return localStorage.getItem(k); } catch(e){ return null; } }
    function lset(k,v){ try { localStorage.setItem(k, v); } catch(e){} }

    function readDrafts(){
      var raw = lget(PRIMARY_KEY);
      var arr = jparse(raw, null);
      if (Array.isArray(arr) && arr.length) return { key: PRIMARY_KEY, arr: arr };

      raw = lget(LEGACY_KEY);
      arr = jparse(raw, null);
      if (Array.isArray(arr) && arr.length) return { key: LEGACY_KEY, arr: arr };

      return { key: PRIMARY_KEY, arr: [] };
    }

    function getDraftId(d, i){
      if (!d) return "i:"+i;
      return String(d.id || d.uid || d.key || d._id || d.draft_id || ("i:"+i));
    }

    function pickSelectedDraft(){
      var pack = readDrafts();
      var drafts = pack.arr || [];
      if (!drafts.length) return { pack: pack, idx: -1, draft: null };

      var selId = lget(SEL_ID_KEY);
      var i;

      if (selId){
        for (i=0;i<drafts.length;i++){
          if (getDraftId(drafts[i], i) === selId) {
            return { pack: pack, idx: i, draft: drafts[i] };
          }
        }
      }

      var idx = parseInt(lget(SEL_IDX_KEY), 10);
      if (!(idx >= 0 && idx < drafts.length)) idx = 0;

      return { pack: pack, idx: idx, draft: drafts[idx] };
    }

    function ensureObj(x){ return (x && typeof x === "object") ? x : {}; }
    function ensureArr(x){ return Array.isArray(x) ? x : []; }
    function str(x){ return (x == null) ? "" : String(x); }

    function normalizeGeneratedFromDraft(draft){
      // pull from most likely places
      var headline = str(draft.headline || (draft.form && draft.form.headline) || draft.title || "");
      var web      = str(draft.web_article || draft.webArticle || (draft.form && draft.form.web_article) || (draft.form && draft.form.webArticle) || "");
      var video    = str(draft.video || (draft.form && draft.form.video) || "");

      var kp = draft.key_points || (draft.form && draft.form.key_points) || (draft.form && draft.form.keyPoints);
      var lines = draft.lines || (draft.form && draft.form.lines);

      return {
        headline: headline,
        key_points: ensureArr(kp),
        lines: ensureArr(lines),
        web_article: web,
        video: video
      };
    }

    // ✅ This is what makeTXT expects to exist
    window.ensureDraftHasDigipack = function(draftMaybe){
      var picked = null;

      // if called without args, pick from storage selection
      if (!draftMaybe) {
        picked = pickSelectedDraft();
        draftMaybe = picked.draft;
      }

      if (!draftMaybe) {
        console.warn("[ensureDraftHasDigipack] no draft found");
        return null;
      }

      // Find dp container
      var dp =
        draftMaybe.dp ||
        draftMaybe.digipack ||
        draftMaybe.digi_pack ||
        draftMaybe.pack ||
        draftMaybe.generated ||
        ensureObj(draftMaybe.dp);

      dp = ensureObj(dp);
      dp.blocks = ensureObj(dp.blocks);

      // Normalize dp.blocks.generated
      var g = dp.blocks.generated;

      // Sometimes stored as generated_text or as a JSON string
      if (!g && dp.blocks.generated_text) g = dp.blocks.generated_text;
      if (!g && draftMaybe.generated_text) g = draftMaybe.generated_text;
      if (!g && draftMaybe.form && draftMaybe.form.generated_text) g = draftMaybe.form.generated_text;

      if (typeof g === "string") {
        var parsed = jparse(g, null);
        g = parsed || { text: g };
      }

      if (!g || typeof g !== "object") {
        g = normalizeGeneratedFromDraft(draftMaybe);
      } else {
        // top-up missing fields
        if (!g.headline) g.headline = str(draftMaybe.headline || (draftMaybe.form && draftMaybe.form.headline) || draftMaybe.title || "");
        if (!g.web_article) g.web_article = str(draftMaybe.web_article || (draftMaybe.form && draftMaybe.form.web_article) || "");
        if (!g.video) g.video = str(draftMaybe.video || (draftMaybe.form && draftMaybe.form.video) || "");
        if (!Array.isArray(g.key_points)) g.key_points = ensureArr(draftMaybe.key_points || (draftMaybe.form && draftMaybe.form.key_points));
        if (!Array.isArray(g.lines)) g.lines = ensureArr(draftMaybe.lines || (draftMaybe.form && draftMaybe.form.lines));
      }

      dp.blocks.generated = g;

      // write back to draft (so rest of code sees it)
      draftMaybe.dp = dp;

      // persist back to storage (so next click never breaks)
      try{
        var pack = picked ? picked.pack : readDrafts();
        var drafts = pack.arr || [];
        var idx = picked ? picked.idx : -1;

        if (idx >= 0 && idx < drafts.length) {
          drafts[idx] = draftMaybe;
          lset(pack.key, JSON.stringify(drafts));
          // keep legacy mirror in sync (safe)
          if (pack.key === PRIMARY_KEY && lget(LEGACY_KEY) != null) lset(LEGACY_KEY, JSON.stringify(drafts));
          if (pack.key === LEGACY_KEY && lget(PRIMARY_KEY) != null) lset(PRIMARY_KEY, JSON.stringify(drafts));
        }
      }catch(e){}

      return dp;
    };

    console.log("[NG_ENSURE_DRAFT_HAS_DIGIPACK_V1] installed ✓", {
      hasFn: (typeof window.ensureDraftHasDigipack === "function")
    });

  }catch(err){
    console.warn("[NG_ENSURE_DRAFT_HAS_DIGIPACK_V1] failed", err);
  }
})();
</script>
<!-- NG_ENSURE_DRAFT_HAS_DIGIPACK_V1_END -->

<!-- NG_ENSURE_DRAFT_HAS_DIGIPACK_V2_START -->
<script>
(function(){
  try{
    var PRIMARY_KEY = "NG_DIGIPACK_DRAFTS_V1";
    var LEGACY_KEY  = "NG_DRAFTS";
    var SEL_IDX_KEY = "NG_DIGIPACK_SELECTED_IDX_V1";
    var SEL_ID_KEY  = "NG_DIGIPACK_SELECTED_ID_V1";

    function jparse(s, fb){ try { return JSON.parse(s); } catch(e){ return fb; } }
    function lget(k){ try { return localStorage.getItem(k); } catch(e){ return null; } }
    function lset(k,v){ try { localStorage.setItem(k, v); } catch(e){} }
    function isObj(x){ return x && typeof x === "object" && !Array.isArray(x); }
    function isArr(x){ return Array.isArray(x); }
    function str(x){ return (x==null) ? "" : String(x); }

    function readDrafts(){
      var raw = lget(PRIMARY_KEY);
      var arr = jparse(raw||"[]", []);
      if (Array.isArray(arr) && arr.length) return { key: PRIMARY_KEY, arr: arr };

      raw = lget(LEGACY_KEY);
      arr = jparse(raw||"[]", []);
      if (Array.isArray(arr) && arr.length) return { key: LEGACY_KEY, arr: arr };

      return { key: PRIMARY_KEY, arr: [] };
    }

    function getDraftId(d, i){
      if (!d) return "i:"+i;
      return String(d.id || d.uid || d.key || d._id || d.draft_id || ("i:"+i));
    }

    function pickSelectedDraft(){
      var pack = readDrafts();
      var drafts = pack.arr || [];
      if (!drafts.length) return { pack: pack, idx: -1, draft: null };

      var selId = lget(SEL_ID_KEY);
      if (selId){
        for (var i=0;i<drafts.length;i++){
          if (getDraftId(drafts[i], i) === selId) return { pack: pack, idx: i, draft: drafts[i] };
        }
      }

      var idx = parseInt(lget(SEL_IDX_KEY), 10);
      if (!(idx >= 0 && idx < drafts.length)) idx = 0;
      return { pack: pack, idx: idx, draft: drafts[idx] };
    }

    function scoreGen(g){
      if (!isObj(g)) return 0;
      var s = 0;
      if (str(g.headline).trim()) s += 2;
      if (isArr(g.key_points) && g.key_points.length) s += 3;
      if (isArr(g.lines) && g.lines.length) s += 3;
      if (str(g.web_article).trim().length > 200) s += 4;
      if (str(g.video).trim()) s += 1;
      return s;
    }

    function normalize(g){
      if (typeof g === "string"){
        // maybe JSON string
        var parsed = jparse(g, null);
        if (parsed) g = parsed;
        else return { headline:"", key_points:[], lines:[], web_article:"", video:"" };
      }
      if (!isObj(g)) return { headline:"", key_points:[], lines:[], web_article:"", video:"" };

      var out = {
        headline: str(g.headline || g.title || ""),
        key_points: isArr(g.key_points) ? g.key_points : (isArr(g.keyPoints) ? g.keyPoints : (isArr(g.KEY_POINTS) ? g.KEY_POINTS : [])),
        lines: isArr(g.lines) ? g.lines : (isArr(g.LINES) ? g.LINES : []),
        web_article: str(g.web_article || g.webArticle || g.article || g.web || ""),
        video: str(g.video || g.video_script || g.social_video || "")
      };
      return out;
    }

    function deepScanForGenerated(root){
      // returns best candidate object
      var best = null, bestScore = 0;

      var seen = new Set();
      var stack = [{ v: root, p: "$" }];

      function consider(candidate){
        var g = normalize(candidate);
        var sc = scoreGen(g);
        if (sc > bestScore){
          bestScore = sc;
          best = g;
        }
      }

      while(stack.length){
        var cur = stack.pop();
        var v = cur.v;

        if (!v) continue;

        // handle strings that might be JSON
        if (typeof v === "string"){
          if (v.length > 20 && (v[0] === "{" || v[0] === "[")){
            var parsed = jparse(v, null);
            if (parsed && typeof parsed === "object") {
              // push parsed to scan deeper
              stack.push({ v: parsed, p: cur.p + "::<json>" });
            }
          }
          continue;
        }

        if (!isObj(v) && !isArr(v)) continue;
        if (seen.has(v)) continue;
        seen.add(v);

        // candidate patterns
        if (isObj(v)){
          // direct hit: looks like generated pack
          if ("headline" in v || "web_article" in v || "key_points" in v || "lines" in v ||
              "webArticle" in v || "keyPoints" in v || "LINES" in v || "KEY_POINTS" in v) {
            consider(v);
          }

          // common nested hits
          if (v.blocks && isObj(v.blocks)){
            if (v.blocks.generated) consider(v.blocks.generated);
            if (v.blocks.generated_text) consider(v.blocks.generated_text);
          }
          if (v.dp && isObj(v.dp)){
            if (v.dp.blocks && isObj(v.dp.blocks)){
              if (v.dp.blocks.generated) consider(v.dp.blocks.generated);
              if (v.dp.blocks.generated_text) consider(v.dp.blocks.generated_text);
            }
          }

          // heuristic: long article-like strings
          for (var k in v){
            if (!Object.prototype.hasOwnProperty.call(v,k)) continue;
            var vv = v[k];
            if (typeof vv === "string" && vv.trim().length > 600 && /web|article|story|copy|body/i.test(k)){
              consider({ web_article: vv });
            }
          }

          for (var k2 in v){
            if (!Object.prototype.hasOwnProperty.call(v,k2)) continue;
            stack.push({ v: v[k2], p: cur.p + "." + k2 });
          }
        } else if (isArr(v)){
          for (var i=0;i<v.length;i++){
            stack.push({ v: v[i], p: cur.p + "["+i+"]" });
          }
        }
      }

      return best; // already normalized
    }

    // ✅ override / define
    window.ensureDraftHasDigipack = function(draftMaybe){
      var picked = null;

      if (!draftMaybe){
        picked = pickSelectedDraft();
        draftMaybe = picked.draft;
      }
      if (!draftMaybe){
        console.warn("[ensureDraftHasDigipack V2] no draft");
        return null;
      }

      // locate dp container
      var dp = (draftMaybe.dp && isObj(draftMaybe.dp)) ? draftMaybe.dp :
               (draftMaybe.digipack && isObj(draftMaybe.digipack)) ? draftMaybe.digipack :
               (draftMaybe.digi_pack && isObj(draftMaybe.digi_pack)) ? draftMaybe.digi_pack :
               {};

      if (!isObj(dp)) dp = {};
      if (!isObj(dp.blocks)) dp.blocks = {};

      // best source: existing dp.blocks.generated (if already filled)
      var current = normalize(dp.blocks.generated || dp.blocks.generated_text || null);
      var curScore = scoreGen(current);

      // deep scan whole draft for best candidate
      var best = deepScanForGenerated(draftMaybe);
      var bestScore = scoreGen(best);

      // choose best
      var chosen = (bestScore > curScore) ? best : current;

      // final top-ups from obvious fields
      if (!chosen.headline) chosen.headline = str(draftMaybe.headline || (draftMaybe.form && draftMaybe.form.headline) || draftMaybe.title || "");
      if (!chosen.web_article) chosen.web_article = str(draftMaybe.web_article || (draftMaybe.form && draftMaybe.form.web_article) || "");
      if (!chosen.video) chosen.video = str(draftMaybe.video || (draftMaybe.form && draftMaybe.form.video) || "");
      if (!isArr(chosen.key_points)) chosen.key_points = [];
      if (!isArr(chosen.lines)) chosen.lines = [];

      dp.blocks.generated = chosen;
      draftMaybe.dp = dp;

      // persist back
      try{
        var pack = picked ? picked.pack : readDrafts();
        var drafts = pack.arr || [];
        var idx = picked ? picked.idx : -1;
        if (idx >= 0 && idx < drafts.length){
          drafts[idx] = draftMaybe;
          lset(pack.key, JSON.stringify(drafts));
          // keep both keys synced if present
          if (pack.key === PRIMARY_KEY) lset(LEGACY_KEY, JSON.stringify(drafts));
          if (pack.key === LEGACY_KEY) lset(PRIMARY_KEY, JSON.stringify(drafts));
        }
      }catch(e){}

      return dp;
    };

    console.log("[NG_ENSURE_DRAFT_HAS_DIGIPACK_V2] installed ✓");
  }catch(err){
    console.warn("[NG_ENSURE_DRAFT_HAS_DIGIPACK_V2] failed", err);
  }
})();
</script>
<!-- NG_ENSURE_DRAFT_HAS_DIGIPACK_V2_END -->
<!-- NG_ENSURE_DRAFT_HAS_DIGIPACK_V3_START -->
<script>
(function(){
  try{
    var PRIMARY_KEY = "NG_DIGIPACK_DRAFTS_V1";
    var LEGACY_KEY  = "NG_DRAFTS";
    var SEL_IDX_KEY = "NG_DIGIPACK_SELECTED_IDX_V1";
    var SEL_ID_KEY  = "NG_DIGIPACK_SELECTED_ID_V1";

    function jparse(s, fb){ try { return JSON.parse(s); } catch(e){ return fb; } }
    function lget(k){ try { return localStorage.getItem(k); } catch(e){ return null; } }
    function lset(k,v){ try { localStorage.setItem(k, v); } catch(e){} }
    function isObj(x){ return x && typeof x === "object" && !Array.isArray(x); }
    function isArr(x){ return Array.isArray(x); }
    function str(x){ return (x==null) ? "" : String(x); }

    function readDrafts(){
      var raw = lget(PRIMARY_KEY);
      var arr = jparse(raw||"[]", []);
      if (Array.isArray(arr) && arr.length) return { key: PRIMARY_KEY, arr: arr };

      raw = lget(LEGACY_KEY);
      arr = jparse(raw||"[]", []);
      if (Array.isArray(arr) && arr.length) return { key: LEGACY_KEY, arr: arr };

      return { key: PRIMARY_KEY, arr: [] };
    }

    function getDraftId(d, i){
      if (!d) return "i:"+i;
      return String(d.id || d.uid || d.key || d._id || d.draft_id || ("i:"+i));
    }

    function pickSelectedDraft(){
      var pack = readDrafts();
      var drafts = pack.arr || [];
      if (!drafts.length) return { pack: pack, idx: -1, draft: null };

      var selId = lget(SEL_ID_KEY);
      if (selId){
        for (var i=0;i<drafts.length;i++){
          if (getDraftId(drafts[i], i) === selId) return { pack: pack, idx: i, draft: drafts[i] };
        }
      }

      var idx = parseInt(lget(SEL_IDX_KEY), 10);
      if (!(idx >= 0 && idx < drafts.length)) idx = 0;
      return { pack: pack, idx: idx, draft: drafts[idx] };
    }

    function normalizeGen(g){
      if (typeof g === "string"){
        var parsed = jparse(g, null);
        g = parsed || { text: g };
      }
      if (!isObj(g)) g = {};
      return {
        headline: str(g.headline || g.title || ""),
        key_points: isArr(g.key_points) ? g.key_points : (isArr(g.keyPoints)?g.keyPoints:[]),
        lines: isArr(g.lines) ? g.lines : (isArr(g.LINES)?g.LINES:[]),
        web_article: str(g.web_article || g.webArticle || g.article || g.web || g.body || g.copy || ""),
        video: str(g.video || g.video_script || g.videoScript || g.social_video || "")
      };
    }

    function scanLongStrings(root, minLen){
      // returns best long string + its path
      var best = { path: "", len: 0, text: "" };
      var seen = new Set();
      var stack = [{ v: root, p: "$" }];

      function consider(s, p){
        s = str(s);
        var L = s.trim().length;
        if (L >= (minLen||400) && L > best.len){
          best = { path: p, len: L, text: s };
        }
      }

      while(stack.length){
        var cur = stack.pop();
        var v = cur.v;

        if (v == null) continue;

        if (typeof v === "string"){
          // if JSON-like string, try parse & continue
          var t = v.trim();
          if (t.length > 20 && (t[0]==="{" || t[0]==="[")){
            var parsed = jparse(t, null);
            if (parsed && (typeof parsed === "object")) stack.push({ v: parsed, p: cur.p + "::<json>" });
          }
          consider(v, cur.p);
          continue;
        }

        if (!isObj(v) && !isArr(v)) continue;
        if (seen.has(v)) continue;
        seen.add(v);

        if (isArr(v)){
          for (var i=0;i<v.length;i++){
            stack.push({ v: v[i], p: cur.p + "["+i+"]" });
          }
          // also: if it's array of strings, join as article candidate
          var allStr = true, j="";
          for (var jx=0;jx<v.length;jx++){
            if (typeof v[jx] !== "string") { allStr=false; break; }
          }
          if (allStr && v.length){
            j = v.join("\n\n");
            consider(j, cur.p + "::<join>");
          }
          continue;
        }

        // object: push children
        for (var k in v){
          if (!Object.prototype.hasOwnProperty.call(v,k)) continue;
          stack.push({ v: v[k], p: cur.p + "." + k });
        }
      }
      return best;
    }

    // helper: attempt common candidate paths explicitly (fast)
    function tryCommonWebArticle(d){
      var cands = [
        d.web_article, d.webArticle, d.article, d.body, d.copy,
        d.form && (d.form.web_article || d.form.webArticle || d.form.article || d.form.body),
        d.dp && d.dp.web_article,
        d.dp && d.dp.blocks && (d.dp.blocks.web_article || d.dp.blocks.webArticle || d.dp.blocks.article || d.dp.blocks.body || d.dp.blocks.copy),
        d.dp && d.dp.blocks && d.dp.blocks.generated_text,
        d.dp && d.dp.blocks && d.dp.blocks.generated
      ];
      for (var i=0;i<cands.length;i++){
        var v = cands[i];
        if (typeof v === "string" && v.trim().length > 200) return v;
        if (isObj(v)){
          var g = normalizeGen(v);
          if (g.web_article && g.web_article.trim().length > 200) return g.web_article;
        }
      }
      return "";
    }

    // ✅ override
    window.ensureDraftHasDigipack = function(draftMaybe){
      var picked = null;
      if (!draftMaybe){
        picked = pickSelectedDraft();
        draftMaybe = picked.draft;
      }
      if (!draftMaybe){
        console.warn("[ensureDraftHasDigipack V3] no draft");
        return null;
      }

      var dp = (draftMaybe.dp && isObj(draftMaybe.dp)) ? draftMaybe.dp : {};
      if (!isObj(dp.blocks)) dp.blocks = {};

      // current candidate
      var cur = normalizeGen(dp.blocks.generated || dp.blocks.generated_text || null);

      // fill missing headline etc.
      if (!cur.headline) cur.headline = str(draftMaybe.headline || (draftMaybe.form && draftMaybe.form.headline) || draftMaybe.title || "");
      if (!isArr(cur.key_points)) cur.key_points = [];
      if (!isArr(cur.lines)) cur.lines = [];

      // web_article: 1) common keys, 2) scan any long string in whole draft
      if (!cur.web_article || cur.web_article.trim().length < 200){
        var direct = tryCommonWebArticle(draftMaybe);
        if (direct && str(direct).trim().length > 200){
          cur.web_article = str(direct);
        } else {
          var best = scanLongStrings(draftMaybe, 400);
          // guard: don't accidentally pick huge JSON dumps—prefer "natural text"
          if (best && best.len >= 400 && best.text && best.text.indexOf("{") !== 0){
            cur.web_article = best.text;
            cur.__web_article_from = best.path; // debug aid
          }
        }
      }

      // video: try common
      if (!cur.video){
        cur.video = str(
          draftMaybe.video ||
          (draftMaybe.form && draftMaybe.form.video) ||
          (dp.blocks && (dp.blocks.video || dp.blocks.video_script || dp.blocks.videoScript)) ||
          ""
        );
      }

      dp.blocks.generated = cur;
      draftMaybe.dp = dp;

      // persist back to storage
      try{
        var pack = picked ? picked.pack : readDrafts();
        var drafts = pack.arr || [];
        var idx = picked ? picked.idx : -1;
        if (idx >= 0 && idx < drafts.length){
          drafts[idx] = draftMaybe;
          lset(pack.key, JSON.stringify(drafts));
          // keep both keys synced if present
          lset(PRIMARY_KEY, JSON.stringify(drafts));
          lset(LEGACY_KEY, JSON.stringify(drafts));
        }
      }catch(e){}

      return dp;
    };

    // Diagnostic: show top long strings paths (top 5)
    window.NG_diagLongStrings = function(){
      var picked = pickSelectedDraft();
      var d = picked.draft;
      if (!d) return [];
      var results = [];
      var seen = new Set();
      var stack = [{ v:d, p:"$" }];
      while(stack.length){
        var cur = stack.pop(), v=cur.v;
        if (v==null) continue;
        if (typeof v === "string"){
          var L = v.trim().length;
          if (L >= 400){
            results.push({ path: cur.p, len: L, head: v.trim().slice(0,80) });
          }
          continue;
        }
        if (typeof v !== "object") continue;
        if (seen.has(v)) continue;
        seen.add(v);
        if (Array.isArray(v)){
          for (var i=0;i<v.length;i++) stack.push({ v:v[i], p:cur.p+"["+i+"]" });
        } else {
          for (var k in v){
            if (!Object.prototype.hasOwnProperty.call(v,k)) continue;
            stack.push({ v:v[k], p:cur.p+"."+k });
          }
        }
      }
      results.sort(function(a,b){ return b.len - a.len; });
      return results.slice(0,5);
    };

    console.log("[NG_ENSURE_DRAFT_HAS_DIGIPACK_V3] installed ✓");
  }catch(err){
    console.warn("[NG_ENSURE_DRAFT_HAS_DIGIPACK_V3] failed", err);
  }
})();
</script>
<!-- NG_ENSURE_DRAFT_HAS_DIGIPACK_V3_END -->
<!-- NG_ENSURE_DRAFT_HAS_DIGIPACK_V4_START -->
<script>
(function(){
  try{
    var PRIMARY_KEY = "NG_DIGIPACK_DRAFTS_V1";
    var LEGACY_KEY  = "NG_DRAFTS";
    var SEL_IDX_KEY = "NG_DIGIPACK_SELECTED_IDX_V1";
    var SEL_ID_KEY  = "NG_DIGIPACK_SELECTED_ID_V1";

    function jparse(s, fb){ try { return JSON.parse(s); } catch(e){ return fb; } }
    function lget(k){ try { return localStorage.getItem(k); } catch(e){ return null; } }
    function lset(k,v){ try { localStorage.setItem(k, v); } catch(e){} }
    function isObj(x){ return x && typeof x === "object" && !Array.isArray(x); }
    function isArr(x){ return Array.isArray(x); }
    function str(x){ return (x==null) ? "" : String(x); }

    function readDrafts(){
      var raw = lget(PRIMARY_KEY);
      var arr = jparse(raw||"[]", []);
      if (Array.isArray(arr) && arr.length) return { key: PRIMARY_KEY, arr: arr };
      raw = lget(LEGACY_KEY);
      arr = jparse(raw||"[]", []);
      if (Array.isArray(arr) && arr.length) return { key: LEGACY_KEY, arr: arr };
      return { key: PRIMARY_KEY, arr: [] };
    }

    function getDraftId(d, i){
      if (!d) return "i:"+i;
      return String(d.id || d.uid || d.key || d._id || d.draft_id || ("i:"+i));
    }

    function pickSelectedDraft(){
      var pack = readDrafts();
      var drafts = pack.arr || [];
      if (!drafts.length) return { pack: pack, idx: -1, draft: null };

      var selId = lget(SEL_ID_KEY);
      if (selId){
        for (var i=0;i<drafts.length;i++){
          if (getDraftId(drafts[i], i) === selId) return { pack: pack, idx: i, draft: drafts[i] };
        }
      }
      var idx = parseInt(lget(SEL_IDX_KEY), 10);
      if (!(idx >= 0 && idx < drafts.length)) idx = 0;
      return { pack: pack, idx: idx, draft: drafts[idx] };
    }

    function normalizeGen(g){
      if (typeof g === "string"){
        var parsed = jparse(g, null);
        g = parsed || { text: g };
      }
      if (!isObj(g)) g = {};
      return {
        headline: str(g.headline || g.title || ""),
        key_points: isArr(g.key_points) ? g.key_points : (isArr(g.keyPoints)?g.keyPoints:[]),
        lines: isArr(g.lines) ? g.lines : (isArr(g.LINES)?g.LINES:[]),
        web_article: str(g.web_article || g.webArticle || g.article || g.web || g.body || g.copy || ""),
        video: str(g.video || g.video_script || g.videoScript || g.social_video || "")
      };
    }

    function findLongestWebInObj(root){
      var best = "";
      var seen = new Set();
      var stack = [root];
      while(stack.length){
        var v = stack.pop();
        if (v == null) continue;
        if (typeof v === "string"){
          var t = v.trim();
          if (t.length > best.length && t.length > 200) best = v;
          continue;
        }
        if (typeof v !== "object") continue;
        if (seen.has(v)) continue;
        seen.add(v);

        if (isArr(v)){
          for (var i=0;i<v.length;i++) stack.push(v[i]);
        } else {
          // direct-key preference
          var directKeys = ["web_article","webArticle","article","web","body","copy"];
          for (var k=0;k<directKeys.length;k++){
            var dk = directKeys[k];
            if (typeof v[dk] === "string" && v[dk].trim().length > best.length) best = v[dk];
          }
          // generated blocks preference
          if (v.blocks && isObj(v.blocks)){
            if (v.blocks.generated) stack.push(v.blocks.generated);
            if (v.blocks.generated_text) stack.push(v.blocks.generated_text);
          }
          for (var key in v){
            if (Object.prototype.hasOwnProperty.call(v,key)) stack.push(v[key]);
          }
        }
      }
      return best;
    }

    function tryParseAnyJSON(text){
      var t = str(text).trim();
      if (!t) return null;

      // 1) plain json
      if (t[0] === "{" || t[0] === "["){
        var o1 = jparse(t, null);
        if (o1) return o1;
      }
      // 2) extract {...} inside noisy text
      var a = t.indexOf("{");
      var b = t.lastIndexOf("}");
      if (a >= 0 && b > a){
        var sub = t.slice(a, b+1);
        var o2 = jparse(sub, null);
        if (o2) return o2;
      }
      return null;
    }

    function looksLikeJsonDump(s){
      s = str(s);
      if (!s) return false;
      var sample = s.slice(0, 1200);
      // lots of '":' usually indicates JSON-ish dump
      var hits = (sample.match(/"\s*:/g) || []).length;
      return hits >= 6;
    }

    function collectLongStrings(root, minLen){
      var out = [];
      var seen = new Set();
      var stack = [{v:root,p:"$"}];
      while(stack.length){
        var cur = stack.pop();
        var v = cur.v;
        if (v == null) continue;

        if (typeof v === "string"){
          var L = v.trim().length;
          if (L >= (minLen||400)) out.push({ path: cur.p, len: L, text: v });
          continue;
        }
        if (typeof v !== "object") continue;
        if (seen.has(v)) continue;
        seen.add(v);

        if (isArr(v)){
          for (var i=0;i<v.length;i++) stack.push({v:v[i], p: cur.p+"["+i+"]"});
        } else {
          for (var k in v){
            if (Object.prototype.hasOwnProperty.call(v,k)) stack.push({v:v[k], p: cur.p+"."+k});
          }
        }
      }
      out.sort(function(a,b){ return b.len - a.len; });
      return out;
    }

    // ✅ OVERRIDE ensureDraftHasDigipack
    window.ensureDraftHasDigipack = function(draftMaybe){
      var picked = null;
      if (!draftMaybe){
        picked = pickSelectedDraft();
        draftMaybe = picked.draft;
      }
      if (!draftMaybe){
        console.warn("[ensureDraftHasDigipack V4] no draft");
        return null;
      }

      var dp = (draftMaybe.dp && isObj(draftMaybe.dp)) ? draftMaybe.dp : {};
      if (!isObj(dp.blocks)) dp.blocks = {};

      var cur = normalizeGen(dp.blocks.generated || dp.blocks.generated_text || null);

      // top-up basics
      if (!cur.headline) cur.headline = str(draftMaybe.headline || (draftMaybe.form && draftMaybe.form.headline) || draftMaybe.title || "");
      if (!isArr(cur.key_points)) cur.key_points = [];
      if (!isArr(cur.lines)) cur.lines = [];

      // ✅ Fill web_article robustly
      if (!cur.web_article || cur.web_article.trim().length < 200){
        // 1) try common direct object search
        var fromObj = findLongestWebInObj(draftMaybe);
        if (fromObj && fromObj.trim().length > 200 && !looksLikeJsonDump(fromObj)){
          cur.web_article = fromObj;
          cur.__web_article_from = "__obj_scan__";
        } else {
          // 2) try long strings list, parse JSON dumps if needed
          var cands = collectLongStrings(draftMaybe, 400);
          for (var i=0;i<cands.length;i++){
            var s = cands[i].text;
            // a) if json-ish, parse and extract web text from parsed
            if (looksLikeJsonDump(s) || (str(s).trim()[0] === "{") || (str(s).trim()[0] === "[")){
              var parsed = tryParseAnyJSON(s);
              if (parsed){
                var wa = findLongestWebInObj(parsed);
                if (wa && wa.trim().length > 200){
                  cur.web_article = wa;
                  cur.__web_article_from = cands[i].path + "::<parsed>";
                  break;
                }
              }
              // if parse fails, continue to next
              continue;
            }
            // b) plain long text candidate
            if (s && s.trim().length > 200){
              cur.web_article = s;
              cur.__web_article_from = cands[i].path;
              break;
            }
          }
        }
      }

      // video (optional)
      if (!cur.video){
        cur.video = str(draftMaybe.video || (draftMaybe.form && draftMaybe.form.video) || "");
      }

      dp.blocks.generated = cur;
      draftMaybe.dp = dp;

      // persist back
      try{
        var pack = picked ? picked.pack : readDrafts();
        var drafts = pack.arr || [];
        var idx = picked ? picked.idx : -1;
        if (idx >= 0 && idx < drafts.length){
          drafts[idx] = draftMaybe;
          lset(pack.key, JSON.stringify(drafts));
          // keep primary+legacy synced (safe in your setup)
          lset(PRIMARY_KEY, JSON.stringify(drafts));
          lset(LEGACY_KEY, JSON.stringify(drafts));
        }
      }catch(e){}

      return dp;
    };

    console.log("[NG_ENSURE_DRAFT_HAS_DIGIPACK_V4] installed ✓");
  }catch(err){
    console.warn("[NG_ENSURE_DRAFT_HAS_DIGIPACK_V4] failed", err);
  }
})();
</script>
<!-- NG_ENSURE_DRAFT_HAS_DIGIPACK_V4_END -->

<!-- NG_STORYVIEW_DEDUP_V1 -->
<script>
(function(){
  try{
    if (window.__NG_STORYVIEW_DEDUP_V1) return;
    window.__NG_STORYVIEW_DEDUP_V1 = true;

    function dedup(tag){
      try{
        var roots = [];
        var a = document.querySelector("#ng-storyview"); if (a) roots.push(a);
        var b = document.querySelector("#storyview");    if (b) roots.push(b);
        var c = document.querySelector("#storyView");    if (c) roots.push(c);
        var more = document.querySelectorAll('div[id*="storyview" i],section[id*="storyview" i],aside[id*="storyview" i],main[id*="storyview" i]');
        for (var i=0;i<more.length;i++) roots.push(more[i]);

        // unique
        var uniq = [];
        for (var j=0;j<roots.length;j++){
          if (uniq.indexOf(roots[j]) === -1) uniq.push(roots[j]);
        }
        if (uniq.length <= 1) return { tag: tag, found: uniq.length, changed: false };

        function z(el){
          var v = parseInt(getComputedStyle(el).zIndex, 10);
          return isFinite(v) ? v : 0;
        }
        function area(el){
          var r = el.getBoundingClientRect();
          return Math.max(0,r.width) * Math.max(0,r.height);
        }
        function visible(el){
          var cs = getComputedStyle(el);
          return cs.display !== "none" && cs.visibility !== "hidden" && cs.opacity !== "0";
        }
        function score(el){
          return (visible(el) ? 1e12 : 0) + (z(el)*1e6) + area(el);
        }

        uniq.sort(function(x,y){ return score(y) - score(x); });
        var keep = uniq[0];

        for (var k=0;k<uniq.length;k++){
          var el = uniq[k];
          if (el === keep) continue;
          el.style.setProperty("display","none","important");
          el.style.setProperty("visibility","hidden","important");
          el.style.setProperty("pointer-events","none","important");
          el.setAttribute("data-ng-hidden-dup-storyview","1");
        }

        var out = { tag: tag, found: uniq.length, kept_id: keep ? keep.id : "", changed: true };
        console.log("[NG_STORYVIEW_DEDUP_V1]", out);
        return out;
      }catch(e){
        console.warn("[NG_STORYVIEW_DEDUP_V1] dedup error", e);
      }
    }

    // Run on load
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", function(){ dedup("domcontentloaded"); }, { once:true });
    } else {
      setTimeout(function(){ dedup("ready"); }, 50);
    }

    // Run when storyview open button is clicked (covers re-renders)
    document.addEventListener("click", function(ev){
      var t = ev.target;
      if (!t) return;
      var btn = (t.closest && t.closest("#btn-storyview-v9, #btn-open-storyview, button[id*='storyview'], [id*='storyview'][role='button']")) || null;
      if (!btn) return;
      setTimeout(function(){ dedup("storyview_click_60ms"); }, 60);
      setTimeout(function(){ dedup("storyview_click_350ms"); }, 350);
      setTimeout(function(){ dedup("storyview_click_900ms"); }, 900);
    }, true);

    // Manual trigger
    window.NG_storyViewDedupNow = function(){ return dedup("manual"); };

    console.log("[NG_STORYVIEW_DEDUP_V1] installed ✓");
  }catch(e){
    console.warn("[NG_STORYVIEW_DEDUP_V1] install error", e);
  }
})();
</script>
<!-- /NG_STORYVIEW_DEDUP_V1 -->
<!-- NG_AUTORUN_SEGMENTS_V2 -->
<script>
(function(){
  try{
    if (window.__NG_AUTORUN_SEGMENTS_V2) return;
    window.__NG_AUTORUN_SEGMENTS_V2 = true;

    function findStoryPanels(){
      var panels = [];
      var more = document.querySelectorAll('div[id*="storyview" i],section[id*="storyview" i],aside[id*="storyview" i],main[id*="storyview" i]');
      for (var i=0;i<more.length;i++){
        var el = more[i];
        if (!el || !el.querySelector) continue;
        if (!el.querySelector("textarea")) continue;
        panels.push(el);
      }
      // prefer overlay panel if present
      panels.sort(function(a,b){
        var ao = /overlay/i.test(a.id||"") ? 1 : 0;
        var bo = /overlay/i.test(b.id||"") ? 1 : 0;
        return bo-ao;
      });
      return panels;
    }

    function findTA(){
      var panels = findStoryPanels();
      for (var i=0;i<panels.length;i++){
        var ta = panels[i].querySelector("textarea");
        if (ta) return ta;
      }
      // fallback biggest textarea
      var arr = Array.prototype.slice.call(document.querySelectorAll("textarea"));
      arr.sort(function(a,b){ return (b.clientWidth*b.clientHeight)-(a.clientWidth*a.clientHeight); });
      return arr[0] || null;
    }

    function normalizeRaw(raw){
      raw = String(raw || "");
      // remove trailing "\" artifacts if present
      raw = raw.replace(/\r/g,"")
               .replace(/[ \t]*\\\s*\n/g,"\n")
               .replace(/\\n/g,"\n")
               .replace(/[ \t]*\\$/gm,"");
      return raw;
    }

    function run(tag){
      try{
        var raw0 = localStorage.getItem("NG_LAST_RAW") || "";
        var raw  = normalizeRaw(raw0);
        if (raw !== raw0) { try{ localStorage.setItem("NG_LAST_RAW", raw); }catch(e){} }

        var ta  = findTA();
        var seg = document.getElementById("ngSegBtnV2");

        if (ta && raw.length > 200){
          if (ta.value !== raw) ta.value = raw;
          ta.dispatchEvent(new Event("input",  { bubbles:true }));
          ta.dispatchEvent(new Event("change", { bubbles:true }));
        }

        if (seg) seg.click();

        var out = { tag: tag, rawLen: raw.length, taFound: !!ta, taLen: ta ? ta.value.length : 0, segBtnFound: !!seg };
        console.log("[NG_AUTORUN_SEGMENTS_V2]", out);
        return out;
      }catch(e){
        console.warn("[NG_AUTORUN_SEGMENTS_V2] run error", e);
      }
    }

    // run whenever StoryView open button is clicked
    document.addEventListener("click", function(ev){
      var t = ev.target;
      if (!t) return;
      var btn = (t.closest && t.closest("#btn-storyview-v9, #btn-open-storyview, button[id*='storyview']")) || null;
      if (!btn) return;

      // allow UI render time
      setTimeout(function(){ run("storyview_click_80ms"); }, 80);
      setTimeout(function(){ run("storyview_click_350ms"); }, 350);
      setTimeout(function(){ run("storyview_click_900ms"); }, 900);
    }, true);

    // manual trigger
    window.NG_autoSegmentsNow = function(){ return run("manual"); };

    console.log("[NG_AUTORUN_SEGMENTS_V2] installed ✓");
  }catch(e){
    console.warn("[NG_AUTORUN_SEGMENTS_V2] install error", e);
  }
})();
</script>
<!-- /NG_AUTORUN_SEGMENTS_V2 -->
  <!-- (बाकी existing scripts as-is रहने दें) -->
<script>
/* NG_FINAL_BYTES_BRIDGE_V1_START */
(function(){
  function $(id){return document.getElementById(id);}
  function visible(el){
    try{ return !!(el && (el.offsetParent!==null || el.getClientRects().length)); }
    catch(e){ return !!el; }
  }
  function updateFinalCount(n){
    try{
      var bs = Array.prototype.slice.call(document.querySelectorAll('#bytesWrap b'));
      for(var i=0;i<bs.length;i++){
        if((bs[i].textContent||'').indexOf('Final Bytes')!==-1){
          bs[i].textContent = 'Final Bytes • ' + n;
          break;
        }
      }
    }catch(e){}
  }

  window.NG_addFinalByte = function(payload){
    payload = payload || {};
    var txt = String(payload.text||'').trim();
    if(!txt) return false;

    var speaker = String(payload.speaker||'').trim();
    var designation = String(payload.designation||payload.desig||'').trim();

    var addBtn = $('addByteBtn');
    var manual = $('ng-manual-bytes'); if(manual) manual.style.display='block';

    if(addBtn) addBtn.click();

    var root = $('bytesWrap') || document;

    function pickTargets(){
      var ignore = {'ng-byte-default-speaker':1,'ng-byte-default-desig':1,'ng-byte-draft-speaker':1,'ng-byte-draft-desig':1,'ng-byte-draft-text':1};
      var inputs = Array.prototype.slice.call(root.querySelectorAll('input[type="text"]')).filter(function(el){
        return el && !ignore[el.id] && visible(el);
      });
      var tas = Array.prototype.slice.call(root.querySelectorAll('textarea')).filter(function(el){
        return el && el.id!=='ng-byte-draft-text' && visible(el);
      });
      var ta = tas.length ? tas[tas.length-1] : null;
      var in1 = inputs.length>=2 ? inputs[inputs.length-2] : (inputs.length?inputs[0]:null);
      var in2 = inputs.length>=2 ? inputs[inputs.length-1] : null;
      return {speaker: in1, designation: in2, text: ta};
    }

    setTimeout(function(){
      try{
        var t = pickTargets();
        if(t.speaker && speaker) t.speaker.value = speaker;
        if(t.designation && designation) t.designation.value = designation;
        if(t.text) t.text.value = txt;

        var sink = $('bytesJSONOut');
        var arr = [];
        if(sink && sink.value && sink.value.trim()){
          try{ arr = JSON.parse(sink.value); if(!Array.isArray(arr)) arr=[]; } catch(e){ arr=[]; }
        }
        arr.push({speaker: speaker, designation: designation, text: txt});
        if(sink) sink.value = JSON.stringify(arr, null, 2);

        updateFinalCount(arr.length);
      }catch(e){
        console.warn('[NG] NG_addFinalByte fill failed', e);
      }
    }, 80);

    return true;
  };

  console.log('[NG] NG_addFinalByte bridge ready');
})();
/* NG_FINAL_BYTES_BRIDGE_V1_END */
</script>
</body>
<!-- NG_PATCH_START: AUTORUN_KILL_V1 -->
<script>
(function AUTORUN_KILL_V1(){
  if (window.__NG_AUTORUN_KILL_V1__) return;
  window.__NG_AUTORUN_KILL_V1__ = true;

  const _log = console.log.bind(console);
  console.log = (...a) => {
    try {
      if (typeof a[0] === "string" && a[0].startsWith("[NG_AUTORUN_SEGMENTS_V2]")) return;
    } catch {}
    return _log(...a);
  };

  const _setTimeout = window.setTimeout.bind(window);
  window.setTimeout = function(fn, delay, ...rest){
    const d = Number(delay);
    if (d === 80 || d === 350 || d === 900) {
      let stack = "";
      try { stack = (new Error()).stack || ""; } catch {}
      if (/NG_AUTORUN_SEGMENTS_V2|AUTORUN_SEGMENTS/i.test(stack)) {
        return 0;
      }
    }
    return _setTimeout(fn, delay, ...rest);
  };

  _log("[AUTORUN_KILL_V1] installed");
})();
</script>
<!-- NG_PATCH_END: AUTORUN_KILL_V1 -->
<!-- NG_PATCH_START: NG_LIBRARY_DRAFT_PICKER_V1 -->
<script>
(function NG_LIBRARY_DRAFT_PICKER_V1(){
  if (window.__NG_LIBRARY_DRAFT_PICKER_V1__) return;
  window.__NG_LIBRARY_DRAFT_PICKER_V1__ = true;

  const LS = {
    drafts: "NG_DRAFTS",
    selIdx: "NG_DIGIPACK_SELECTED_IDX",
    curId:  "NG_DIGIPACK_CURRENT_ID"
  };

  const t = (el)=>((el && el.textContent)?el.textContent:"").trim();

  function readDrafts(){
    try {
      const s = localStorage.getItem(LS.drafts);
      const j = s ? JSON.parse(s) : [];
      return Array.isArray(j) ? j : [];
    } catch { return []; }
  }

  function setLS(k,v){ try{ localStorage.setItem(k, String(v)); }catch{} }

  function applyFormFallback(form){
    if (!form || typeof form !== "object") return false;
    const els = Array.from(document.querySelectorAll("input,textarea,select"));
    const byKey = new Map();
    for (const el of els){
      const key = el.name || el.id;
      if (!key) continue;
      if (!byKey.has(key)) byKey.set(key, []);
      byKey.get(key).push(el);
    }
    for (const key of Object.keys(form)){
      const val = form[key];
      const targets = byKey.get(key);
      if (!targets) continue;
      for (const el of targets){
        const type = (el.type || "").toLowerCase();
        try{
          if (type === "checkbox") el.checked = !!val;
          else if (type === "radio") el.checked = (String(el.value) === String(val));
          else el.value = Array.isArray(val) ? (val[0] ?? "") : String(val ?? "");
          el.dispatchEvent(new Event("input", {bubbles:true}));
          el.dispatchEvent(new Event("change",{bubbles:true}));
        }catch{}
      }
    }
    return true;
  }

  function applyForm(form){
    try {
      if (window.__NG_DASH__ && typeof window.__NG_DASH__.applyForm === "function") {
        return window.__NG_DASH__.applyForm(form);
      }
    } catch {}
    return applyFormFallback(form);
  }

  function loadByIdx(idx){
    const drafts = readDrafts();
    const i = Number(idx);
    if (!Number.isFinite(i) || i < 0 || i >= drafts.length) return false;
    const d = drafts[i] || {};
    const ok = applyForm(d.form || {});
    if (d.id) setLS(LS.curId, d.id);
    setLS(LS.selIdx, i);
    console.log("✅ DASH: Loaded draft", { idx:i, id:d.id, title:d.title, status:d.status, formApplied: !!ok });
    return true;
  }

  function findLibraryBar(){
    // find a container that has Download TXT and Download JSON buttons
    const btns = Array.from(document.querySelectorAll("button"));
    const bTxt = btns.find(b => /download\s*txt/i.test(t(b)));
    if (!bTxt) return null;

    let p = bTxt;
    for (let k=0; k<10 && p; k++){
      if (p.querySelectorAll){
        const inside = Array.from(p.querySelectorAll("button")).map(x => t(x));
        const hasTxt  = inside.some(s => /download\s*txt/i.test(s));
        const hasJson = inside.some(s => /download\s*json/i.test(s));
        if (hasTxt && hasJson) return p;
      }
      p = p.parentElement;
    }
    return bTxt.parentElement;
  }

  function ensureUI(){
    const bar = findLibraryBar();
    if (!bar) return;

    if (bar.querySelector("#ngDraftPickerV1")) return;

    const wrap = document.createElement("div");
    wrap.style.cssText = "display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:8px;";

    const label = document.createElement("div");
    label.textContent = "Draft:";
    label.style.cssText = "font-size:12px; opacity:0.85;";

    const sel = document.createElement("select");
    sel.id = "ngDraftPickerV1";
    sel.style.cssText = "padding:6px 10px; border-radius:10px; border:1px solid #2b2f33; background:#0b0d0f; color:#e8eaed;";

    const btnLoad = document.createElement("button");
    btnLoad.type = "button";
    btnLoad.textContent = "Load";
    btnLoad.style.cssText = "padding:6px 10px; border-radius:10px; border:1px solid #2b2f33; background:#171a1d; color:#e8eaed; cursor:pointer;";

    const btnRef = document.createElement("button");
    btnRef.type = "button";
    btnRef.textContent = "Refresh List";
    btnRef.style.cssText = btnLoad.style.cssText;

    function fill(){
      const drafts = readDrafts();
      let cur = "";
      try { cur = localStorage.getItem(LS.selIdx) || ""; } catch {}
      sel.innerHTML = "";
      drafts.forEach((d, i) => {
        const opt = document.createElement("option");
        const title = (d && d.title) ? String(d.title) : "Untitled";
        const st = (d && d.status) ? String(d.status) : "draft";
        opt.value = String(i);
        opt.textContent = `${i}: ${title} [${st}]`;
        if (String(i) === String(cur)) opt.selected = true;
        sel.appendChild(opt);
      });
      if (!drafts.length) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "(No drafts found)";
        sel.appendChild(opt);
      }
    }

    btnLoad.addEventListener("click", () => loadByIdx(sel.value), false);
    sel.addEventListener("change", () => loadByIdx(sel.value), false);
    btnRef.addEventListener("click", fill, false);

    wrap.appendChild(label);
    wrap.appendChild(sel);
    wrap.appendChild(btnLoad);
    wrap.appendChild(btnRef);

    bar.appendChild(wrap);
    fill();
  }

  ensureUI();
  new MutationObserver(ensureUI).observe(document.documentElement, { childList:true, subtree:true });

  console.log("[NG_LIBRARY_DRAFT_PICKER_V1] installed");
})();
</script>
<!-- NG_PATCH_END: NG_LIBRARY_DRAFT_PICKER_V1 -->
<!-- NG_PATCH_START: NG_STANDARD_UI_TOGGLE_V1 -->
<style id="ng-std-ui-style-v1">
  .ng-std-hidden { display: none !important; }
  #ng-std-ui-toggle-root {
    position: fixed;
    top: 12px;
    right: 12px;
    z-index: 2147483000;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    user-select: none;
  }
  #ng-std-ui-toggle-root .ngpill {
    display: flex;
    gap: 6px;
    align-items: center;
    padding: 8px;
    border-radius: 999px;
    background: rgba(20,20,20,0.78);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.25);
  }
  #ng-std-ui-toggle-root .nglbl {
    font-size: 12px;
    color: rgba(255,255,255,0.82);
    padding: 0 6px;
  }
  #ng-std-ui-toggle-root button {
    border: 0;
    border-radius: 999px;
    padding: 6px 10px;
    font-size: 12px;
    cursor: pointer;
    background: rgba(255,255,255,0.14);
    color: rgba(255,255,255,0.92);
  }
  #ng-std-ui-toggle-root button:hover { background: rgba(255,255,255,0.20); }
  #ng-std-ui-toggle-root button.active {
    background: rgba(255,255,255,0.92);
    color: rgba(0,0,0,0.85);
  }
</style>

<script id="ng-std-ui-toggle-v1">
(function () {
  const TAG = "NG_STANDARD_UI_TOGGLE_V1";
  if (window.__NG_STANDARD_UI_TOGGLE_V1) {
    console.log(`[${TAG}] already installed`);
    return;
  }

  const KEY = "NG_STD_UI_MODE_V1";
  const DEFAULT_MODE = "simple"; // change to "advanced" if you ever want default advanced
  const HIDE_CLASS = "ng-std-hidden";
  const ROOT_ID = "ng-std-ui-toggle-root";

  const RX = {
    transcript: /(load\s*transcript|transcript\s*json|reverie)/i,
    bytes: /(copy\s*bytes\s*json|\bbytes\b|quotes\s*\/\s*sot|\bsot\b)/i,
    visuals: /(\bvisuals\b|b-?roll|\bshot\b|\bsrt\b|web\s*,\s*video)/i,
    logs: /(\blogs\b|debug\s*log|console\s*log)/i,
    storyview: /(story\s*view)/i,
  };

  function log(...a){ console.log(`[${TAG}]`, ...a); }
  function warn(...a){ console.warn(`[${TAG}]`, ...a); }

  function getMode(){
    const v = (localStorage.getItem(KEY) || "").toLowerCase();
    return (v === "advanced" || v === "simple") ? v : DEFAULT_MODE;
  }

  function setMode(mode){
    mode = String(mode || "").toLowerCase();
    if (mode !== "simple" && mode !== "advanced") mode = DEFAULT_MODE;
    localStorage.setItem(KEY, mode);
    applyMode();
  }

  function safeText(el){
    try {
      return (el && el.textContent ? el.textContent : "").replace(/\s+/g, " ").trim();
    } catch { return ""; }
  }

  function qsa(sel){
    try { return Array.from(document.querySelectorAll(sel)); }
    catch { return []; }
  }

  function pickBlock(el){
    // choose a reasonably local container to hide
    let cur = el;
    for (let i = 0; i < 10 && cur && cur !== document.body; i++) {
      if (cur.id === ROOT_ID) return null;
      if (cur.closest && cur.closest("#" + ROOT_ID)) return null;

      if (cur.matches && cur.matches("fieldset,section,details,article")) return cur;

      // common “group” containers
      if (cur.matches && cur.matches(".card,.panel,.box,.block,.group,.wrap,.container")) return cur;

      // div with some identity and form controls inside
      if (cur.tagName === "DIV" && (cur.id || cur.className)) {
        const n = cur.querySelectorAll ? cur.querySelectorAll("input,textarea,select,button").length : 0;
        if (n >= 1) return cur;
      }
      cur = cur.parentElement;
    }
    return el && el.parentElement ? el.parentElement : el;
  }

  function hideEl(el, reason){
    if (!el) return;
    if (el.id === ROOT_ID) return;
    if (el.closest && el.closest("#" + ROOT_ID)) return;
    if (el === document.body || el === document.documentElement) return;

    el.classList.add(HIDE_CLASS);
    el.setAttribute("data-ng-std-hidden", "1");
    if (reason) el.setAttribute("data-ng-std-reason", reason);
  }

  function showEl(el){
    if (!el) return;
    el.classList.remove(HIDE_CLASS);
    el.removeAttribute("data-ng-std-hidden");
    el.removeAttribute("data-ng-std-reason");
  }

  function findHeaderHits(regex){
    const sel = "h1,h2,h3,h4,h5,h6,legend,label,summary,button,p,small,strong";
    return qsa(sel).filter(el => {
      if (el.id === ROOT_ID) return false;
      if (el.closest && el.closest("#" + ROOT_ID)) return false;
      const t = safeText(el);
      if (!t) return false;
      // avoid matching huge blocks
      if (t.length > 220) return false;
      return regex.test(t);
    });
  }

  function collectSimpleTargets(){
    const targets = new Set();

    function addBlockFrom(el, reason){
      const b = pickBlock(el);
      if (!b) return;
      if (b === document.body || b === document.documentElement) return;
      if (b.closest && b.closest("#" + ROOT_ID)) return;
      b.__ngStdReason = reason;
      targets.add(b);
    }

    // Transcript targets: headings + common ids/names
    findHeaderHits(RX.transcript).forEach(el => addBlockFrom(el, "transcript"));
    qsa('textarea[id*="reverie" i],textarea[name*="reverie" i],textarea[id*="transcript" i],textarea[name*="transcript" i]')
      .forEach(el => addBlockFrom(el, "transcript"));

    // Bytes targets: known field names + headings/buttons
    qsa('input[name="byte_speaker[]"],input[name="byte_designation[]"],textarea[name="byte_text[]"],textarea[name="byte_text"],input[name="byte_time[]"],input[name="byte_time"]')
      .forEach(el => addBlockFrom(el, "bytes"));
    findHeaderHits(RX.bytes).forEach(el => addBlockFrom(el, "bytes"));

    // Visuals targets: headings + name/id hints
    findHeaderHits(RX.visuals).forEach(el => addBlockFrom(el, "visuals"));
    qsa('textarea[id*="visual" i],textarea[name*="visual" i],input[id*="visual" i],input[name*="visual" i],textarea[id*="srt" i],textarea[name*="srt" i],textarea[id*="shot" i],textarea[name*="shot" i],textarea[id*="broll" i],textarea[name*="broll" i]')
      .forEach(el => addBlockFrom(el, "visuals"));

    // Logs targets: headings + id/class contains log/debug (pre/textarea/div)
    findHeaderHits(RX.logs).forEach(el => addBlockFrom(el, "logs"));
    qsa('pre[id*="log" i],pre[class*="log" i],textarea[id*="log" i],textarea[class*="log" i],div[id*="debug" i],div[class*="debug" i],div[id*="log" i],div[class*="log" i]')
      .forEach(el => addBlockFrom(el, "logs"));

    // Story View (Debug): hide buttons/links + any open panel-like node
    qsa("button,a").filter(el => RX.storyview.test(safeText(el))).forEach(el => {
      // hide the control itself (not the whole page)
      targets.add(el);
      el.__ngStdReason = "storyview_btn";
    });

    // attempt to catch the floating Story View panel when open
    // heuristic: contains "Story View" + "Updated @" + "Close"
    qsa('div,section,details').forEach(el => {
      if (el.id === ROOT_ID) return;
      if (el.closest && el.closest("#" + ROOT_ID)) return;
      const t = safeText(el);
      if (!t || t.length < 30 || t.length > 2500) return;
      if (RX.storyview.test(t) && /updated\s*@/i.test(t) && /\bclose\b/i.test(t)) {
        addBlockFrom(el, "storyview_panel");
      }
    });

    return Array.from(targets);
  }

  function ensureToggleUI(){
    if (document.getElementById(ROOT_ID)) return;

    const root = document.createElement("div");
    root.id = ROOT_ID;

    root.innerHTML = `
      <div class="ngpill">
        <span class="nglbl">UI</span>
        <button type="button" data-ng-mode="simple">Simple</button>
        <button type="button" data-ng-mode="advanced">Advanced</button>
      </div>
    `;

    root.addEventListener("click", (e) => {
      const btn = e.target && e.target.closest ? e.target.closest("button[data-ng-mode]") : null;
      if (!btn) return;
      setMode(btn.getAttribute("data-ng-mode"));
    });

    (document.body || document.documentElement).appendChild(root);
  }

  function paintActive(mode){
    const root = document.getElementById(ROOT_ID);
    if (!root) return;
    qsa(`#${ROOT_ID} button[data-ng-mode]`).forEach(b => {
      const m = b.getAttribute("data-ng-mode");
      if (m === mode) b.classList.add("active");
      else b.classList.remove("active");
    });
  }

  function showAllPreviouslyHidden(){
    qsa('[data-ng-std-hidden="1"]').forEach(showEl);
  }

  let pending = false;
  function scheduleApply(){
    if (pending) return;
    pending = true;
    setTimeout(() => { pending = false; applyMode(); }, 120);
  }

  function applyMode(){
    ensureToggleUI();

    const mode = getMode();
    document.documentElement.setAttribute("data-ng-std-ui", mode);
    paintActive(mode);

    // First: restore everything we hid
    showAllPreviouslyHidden();

    if (mode === "simple") {
      const t = collectSimpleTargets();
      t.forEach(el => hideEl(el, el.__ngStdReason || ""));
      log("mode=simple", "hiddenCount=", t.length);
    } else {
      log("mode=advanced", "simple targets visible");
    }
  }

  // public helpers for console
  window.__NG_STANDARD_UI_TOGGLE_V1 = {
    tag: TAG,
    key: KEY,
    getMode,
    setMode,
    applyMode,
    rescan: applyMode,
    debugScan: () => {
      const t = collectSimpleTargets();
      log("debugScan targets:", t.map(x => ({
        tag: x.tagName,
        id: x.id || "",
        cls: (x.className && String(x.className).slice(0, 120)) || "",
        reason: x.__ngStdReason || ""
      })));
      return t;
    }
  };

  // run now
  function boot(){
    try { applyMode(); }
    catch (e) { warn("boot error", e); }
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", boot, { once: true });
  } else {
    boot();
  }

  // keep it working for dynamically injected panels (Story View etc.)
  try {
    const mo = new MutationObserver(() => {
      if (getMode() === "simple") scheduleApply();
    });
    mo.observe(document.documentElement, { childList: true, subtree: true });
  } catch (e) {
    warn("MutationObserver failed", e);
  }

  log("installed ✓", { default: DEFAULT_MODE, key: KEY });
})();
</script>
<!-- NG_PATCH_END: NG_STANDARD_UI_TOGGLE_V1 -->
<!-- NG_PATCH_START: NG_STD_SECTION_IDS_V1 -->
<style>
  /* Enforce Simple mode purely by IDs (deterministic) */
  html[data-ng-std-ui="simple"] #ng-sec-transcript,
  html[data-ng-std-ui="simple"] #ng-sec-bytes,
  html[data-ng-std-ui="simple"] #ng-sec-visuals,
  html[data-ng-std-ui="simple"] #ng-sec-logs,
  html[data-ng-std-ui="simple"] #ng-btn-storyview,
  html[data-ng-std-ui="simple"] #ng-panel-storyview {
    display: none !important;
  }
</style>

<script>
(function(){
  const TAG = "NG_STD_SECTION_IDS_V1";
  if (window.__NG_STD_SECTION_IDS_V1) return;

  const RX = {
    addByte: /add\s*byte/i,
    addVisual: /add\s*visual/i,
    reverie: /reverie/i,
    reverieLine: /reverie\s*output\s*json/i,
    pasteJson: /paste\s*json\s*here/i,
    storyView: /story\s*view/i,
    updatedAt: /updated\s*@/i,
    close: /\bclose\b/i,
    editorial: /editorial\s*extraction/i,
    status: /\bstatus\b/i,
    log: /^log$/i
  };

  const IDS = {
    transcript: "ng-sec-transcript",
    bytes: "ng-sec-bytes",
    visuals: "ng-sec-visuals",
    logs: "ng-sec-logs",
    storyBtn: "ng-btn-storyview",
    storyPanel: "ng-panel-storyview"
  };

  function norm(s){ return String(s||"").replace(/\s+/g," ").trim(); }
  function qsa(sel){ try { return Array.from(document.querySelectorAll(sel)); } catch { return []; } }

  function findByButton(rx){
    const btns = qsa("button,[role='button'],a");
    return btns.find(b => rx.test(norm(b.textContent)));
  }

  function findByText(rx){
    const nodes = qsa("div,span,p,strong,b,small,label,h1,h2,h3,h4,h5,h6,summary,legend");
    return nodes.find(n => {
      const t = norm(n.textContent);
      return t && t.length <= 200 && rx.test(t);
    });
  }

  function pickCard(startEl, mustHaveRx){
    if (!startEl) return null;
    let cur = startEl;
    for (let i=0; i<18 && cur && cur !== document.body; i++){
      const t = norm(cur.textContent);
      // avoid picking the whole page/root
      const tooBig =
        /newsgenie/i.test(t) ||
        /what happened/i.test(t) ||
        /sources\s*\/\s*references/i.test(t) ||
        /background/i.test(t) ||
        /generate\s*digi_pack/i.test(t);

      if (!tooBig) {
        if (!mustHaveRx || mustHaveRx.test(t)) {
          // container-ish check
          const btnCount = cur.querySelectorAll ? cur.querySelectorAll("button").length : 0;
          const hasTitle = cur.querySelector && cur.querySelector("h1,h2,h3,h4,strong,b,div,span");
          if (btnCount >= 1 || hasTitle) return cur;
        }
      }
      cur = cur.parentElement;
    }
    return null;
  }

  function setId(el, id){
    if (!el) return false;
    if (el.id && el.id !== id) return false;     // don't clobber existing IDs
    if (!el.id) el.id = id;
    el.setAttribute("data-ng-sec", id);
    return true;
  }

  function ensureIDs(){
    // Bytes section: find "+ Add Byte" button -> pick card containing "Bytes"
    const btnByte = findByButton(RX.addByte);
    const cardByte = pickCard(btnByte, /bytes/i);
    setId(cardByte, IDS.bytes);

    // Visuals section: find "+ Add Visual" button -> pick card containing "Visuals"
    const btnVis = findByButton(RX.addVisual);
    const cardVis = pickCard(btnVis, /visuals/i);
    setId(cardVis, IDS.visuals);

    // Transcript/Reverie section: detect by text line or placeholder-like text
    const t1 = findByText(RX.reverieLine) || findByText(RX.pasteJson) || findByText(RX.reverie);
    const cardTr = pickCard(t1, RX.reverie);
    setId(cardTr, IDS.transcript);

    // Story View button id (separate)
    const storyBtn = findByButton(RX.storyView);
    if (storyBtn && !storyBtn.id) storyBtn.id = IDS.storyBtn;

    // Logs / Editorial extraction section
    const ed = findByText(RX.editorial) || findByText(RX.status) || findByText(RX.log);
    const cardLog = pickCard(ed, /(editorial|status|log)/i);
    setId(cardLog, IDS.logs);

    // Story View floating panel when open (looks like: "Story View" + "Updated @" + "Close")
    qsa("div,section,article").forEach(el => {
      if (el.id === IDS.storyPanel) return;
      const t = norm(el.textContent);
      if (!t || t.length < 40 || t.length > 2500) return;
      if (RX.storyView.test(t) && RX.updatedAt.test(t) && RX.close.test(t)) {
        if (!el.id) el.id = IDS.storyPanel;
      }
    });
  }

  function boot(){
    ensureIDs();
    try {
      new MutationObserver(() => ensureIDs())
        .observe(document.documentElement, { childList:true, subtree:true });
    } catch(e){}
    console.log("[" + TAG + "] installed ✓");
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", boot, { once:true });
  } else {
    boot();
  }

  window.__NG_STD_SECTION_IDS_V1 = {
    tag: TAG,
    ensure: ensureIDs,
    dump: () => ({
      transcript: !!document.getElementById(IDS.transcript),
      bytes: !!document.getElementById(IDS.bytes),
      visuals: !!document.getElementById(IDS.visuals),
      logs: !!document.getElementById(IDS.logs),
      storyBtn: !!document.getElementById(IDS.storyBtn),
      storyPanel: !!document.getElementById(IDS.storyPanel),
    })
  };
})();
</script>
<!-- NG_PATCH_END: NG_STD_SECTION_IDS_V1 -->
<!-- NG_PATCH_START: NG_STD_SECTION_IDS_FIX_V1 -->
<script>
(function(){
  const TAG = "NG_STD_SECTION_IDS_FIX_V1";
  if (window.__NG_STD_SECTION_IDS_FIX_V1) return;

  const base = window.__NG_STD_SECTION_IDS_V1;
  if (!base) {
    console.warn("[" + TAG + "] base NG_STD_SECTION_IDS_V1 not found");
    return;
  }

  const IDS = {
    transcript: "ng-sec-transcript",
    bytes: "ng-sec-bytes",
    visuals: "ng-sec-visuals",
    logs: "ng-sec-logs",
    storyBtn: "ng-btn-storyview",
    storyPanel: "ng-panel-storyview"
  };

  const RX = {
    addByte: /add\s*byte/i,
    addVisual: /add\s*visual/i,
    storyView: /story\s*view/i,        // catches "Story View V9"
    editorial: /editorial\s*extraction/i,
    discard: /discard/i,
    clearSug: /clear\s*suggestions/i,
    pushToBytes: /push\s*selected\s*to\s*bytes/i,
    status: /\bstatus\b/i,
    logWord: /^log$/i
  };

  function norm(s){ return String(s||"").replace(/\s+/g," ").trim(); }
  function qsa(sel){ try { return Array.from(document.querySelectorAll(sel)); } catch { return []; } }

  function findClickable(rx){
    // scan common clickable candidates (not only <button>)
    const nodes = qsa("button,a,[role='button'],[onclick],div,span");
    for (const el of nodes){
      const t = norm(el.textContent);
      if (!t || t.length > 80) continue;
      if (rx.test(t)) return el;
    }
    return null;
  }

  function pickCardFrom(startEl){
    if (!startEl) return null;
    let cur = startEl;
    for (let i=0; i<20 && cur && cur !== document.body; i++){
      const t = norm(cur.textContent);

      // avoid grabbing whole form/page
      const tooBig =
        /newsgenie/i.test(t) ||
        /what happened/i.test(t) ||
        /sources\s*\/\s*references/i.test(t) ||
        /background/i.test(t) ||
        /generate\s*digi_pack/i.test(t);

      if (!tooBig && cur.querySelectorAll) {
        // a section/card usually has at least 1 control
        const controls = cur.querySelectorAll("input,textarea,select,button").length;
        if (controls >= 1) return cur;
      }
      cur = cur.parentElement;
    }
    return null;
  }

  function setId(el, id){
    if (!el) return false;
    if (el.id && el.id !== id) return false;
    if (!el.id) el.id = id;
    el.setAttribute("data-ng-sec", id);
    return true;
  }

  // FIXED ensure: stronger anchors for visuals/logs/storyBtn
  function ensureFix(){
    // Visuals: anchor = "+ Add Visual"
    const addVis = findClickable(RX.addVisual);
    const visCard = pickCardFrom(addVis);
    setId(visCard, IDS.visuals);

    // Logs: anchors = "Editorial Extraction" OR "Discard" OR "Clear suggestions" OR "Push selected to Bytes" OR "Status" OR "Log"
    const logAnchor =
      findClickable(RX.editorial) ||
      findClickable(RX.discard) ||
      findClickable(RX.clearSug) ||
      findClickable(RX.pushToBytes) ||
      findClickable(RX.status) ||
      findClickable(RX.logWord);

    const logCard = pickCardFrom(logAnchor);
    setId(logCard, IDS.logs);

    // Story View button: anchor = "Story View"
    const sv = findClickable(RX.storyView);
    if (sv) setId(sv, IDS.storyBtn);

    // Story View floating panel (when open): already handled by base, but re-check quickly
    qsa("div,section,article").forEach(el => {
      const t = norm(el.textContent);
      if (!t || t.length < 40 || t.length > 2500) return;
      if (RX.storyView.test(t) && /updated\s*@/i.test(t) && /\bclose\b/i.test(t)) {
        if (!el.id) el.id = IDS.storyPanel;
      }
    });
  }

  // wrap base.ensure() so FIX runs every time too
  const origEnsure = base.ensure;
  base.ensure = function(){
    try { origEnsure && origEnsure(); } catch(e){}
    try { ensureFix(); } catch(e){ console.warn("[" + TAG + "]", e); }
  };

  // run now + keep watching
  base.ensure();
  try {
    new MutationObserver(() => base.ensure())
      .observe(document.documentElement, { childList:true, subtree:true });
  } catch(e){}

  window.__NG_STD_SECTION_IDS_FIX_V1 = { tag: TAG };
  console.log("[" + TAG + "] installed ✓");
})();
</script>
<!-- NG_PATCH_END: NG_STD_SECTION_IDS_FIX_V1 -->
<!-- NG_PATCH_START: NG_STD_STORYBTN_BIND_V2 -->
<script>
(function(){
  const TAG = "NG_STD_STORYBTN_BIND_V2";
  if (window.__NG_STD_STORYBTN_BIND_V2) return;

  const TARGET_ID = "ng-btn-storyview";
  const ATTR = "data-ng-storybtn";

  const base = window.__NG_STD_SECTION_IDS_V1;

  function norm(s){ return String(s||"").replace(/\s+/g," ").trim(); }
  function isClickable(el){
    if (!el || !el.tagName) return false;
    const tag = el.tagName.toUpperCase();
    if (tag === "BUTTON" || tag === "A" || tag === "SUMMARY" || tag === "LABEL") return true;
    const role = el.getAttribute && el.getAttribute("role");
    if (role && role.toLowerCase() === "button") return true;
    if (el.hasAttribute && (el.hasAttribute("onclick") || el.hasAttribute("tabindex"))) return true;
    return false;
  }

  function closestClickable(el){
    let cur = el;
    for (let i=0; i<18 && cur && cur !== document.body; i++){
      if (isClickable(cur)) return cur;
      cur = cur.parentElement;
    }
    return null;
  }

  function findByTextNode(){
    const root = document.body || document.documentElement;
    if (!root) return null;

    const tw = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, {
      acceptNode(node){
        const t = norm(node.nodeValue);
        if (!t) return NodeFilter.FILTER_REJECT;
        const low = t.toLowerCase();
        // catch "Story View", "StoryView", "Story View V9" etc.
        if (/(story\s*view|storyview)/i.test(low)) return NodeFilter.FILTER_ACCEPT;
        return NodeFilter.FILTER_REJECT;
      }
    });

    let n;
    while ((n = tw.nextNode())) {
      const parent = n.parentElement;
      if (!parent) continue;

      // prefer the smallest meaningful clickable ancestor
      const clickEl = closestClickable(parent) || parent;
      const txt = (norm(clickEl.textContent) + " " +
                   norm(clickEl.getAttribute?.("aria-label")) + " " +
                   norm(clickEl.getAttribute?.("title"))).toLowerCase();

      if (!/(story\s*view|storyview)/i.test(txt)) {
        // if ancestor lost the phrase, keep climbing a bit
        const up = closestClickable(clickEl.parentElement);
        if (up) return up;
      }
      return clickEl;
    }
    return null;
  }

  function bind(){
    // already bound?
    if (document.getElementById(TARGET_ID)) return true;

    const el = findByTextNode();
    if (!el) return false;

    // Always mark attribute (deterministic selector)
    try { el.setAttribute(ATTR, "1"); } catch(e){}

    // Set ID only if safe (no existing id)
    if (!el.id) {
      el.id = TARGET_ID;
    } else {
      // don't clobber existing id; attribute is enough
    }

    // Patch dump() so storyBtn reflects attribute too
    if (base && base.dump && !base.__dumpPatchedStoryBtnV2) {
      const origDump = base.dump.bind(base);
      base.dump = function(){
        const d = origDump();
        const byId = !!document.getElementById(TARGET_ID);
        const byAttr = !!document.querySelector("[" + ATTR + "='1']");
        d.storyBtn = byId || byAttr;
        return d;
      };
      base.__dumpPatchedStoryBtnV2 = true;
    }

    console.log("[" + TAG + "] bound ✓", { tag: el.tagName, id: el.id || "(kept)", hasAttr: el.hasAttribute(ATTR) });
    return true;
  }

  function boot(){
    // try now and keep retrying (because StoryView control may appear only in Advanced)
    bind();
    let tries = 0;
    const timer = setInterval(() => {
      tries++;
      if (bind() || tries > 120) clearInterval(timer);
    }, 150);

    try {
      new MutationObserver(() => bind())
        .observe(document.documentElement, { childList:true, subtree:true });
    } catch(e){}
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", boot, { once:true });
  } else {
    boot();
  }

  window.__NG_STD_STORYBTN_BIND_V2 = { tag: TAG, bind };
})();
</script>
<!-- NG_PATCH_END: NG_STD_STORYBTN_BIND_V2 -->


<!-- NG_PATCH_START: LIBBAR_NO_OVERLAY_V2 -->
<script>
(function LIBBAR_NO_OVERLAY_V2(){
  if (window.__NG_LIBBAR_NO_OVERLAY_V2__) return;
  window.__NG_LIBBAR_NO_OVERLAY_V2__ = true;

  const TAG = "[LIBBAR_NO_OVERLAY_V2]";

  function t(el){ return ((el && el.textContent) ? el.textContent : "").trim(); }

  function findLibraryBar(){
    // find a container that has Download TXT and Download JSON buttons
    const btns = Array.from(document.querySelectorAll("button"));
    const bTxt = btns.find(b => /download\s*txt/i.test(t(b)));
    if (!bTxt) return null;

    let p = bTxt;
    for (let i=0; i<10 && p; i++){
      if (p.querySelectorAll){
        const inside = Array.from(p.querySelectorAll("button")).map(x => t(x));
        const hasTxt  = inside.some(s => /download\s*txt/i.test(s));
        const hasJson = inside.some(s => /download\s*json/i.test(s));
        if (hasTxt && hasJson) return p;
      }
      p = p.parentElement;
    }
    return bTxt.parentElement;
  }

  function isInside(el, parent){
    try { return !!(el && parent && parent.contains(el)); } catch { return false; }
  }

  function toggleMainLibraryButton(excludeBar){
    const all = Array.from(document.querySelectorAll("button"));
    const cand = all.find(b => t(b) === "Library" && !isInside(b, excludeBar));
    if (cand && typeof cand.click === "function") { cand.click(); return true; }
    return false;
  }

  function ensureSpacer(bar){
    let sp = document.getElementById("ngLibBarSpacer");
    const h = Math.ceil((bar.getBoundingClientRect().height || 0));
    if (!sp) {
      sp = document.createElement("div");
      sp.id = "ngLibBarSpacer";
      sp.style.cssText = "width:100%; height:0px;";
      (document.body || document.documentElement).prepend(sp);
    }
    sp.style.height = (h > 0 ? h : 56) + "px";
  }

  function removeSpacer(){
    const sp = document.getElementById("ngLibBarSpacer");
    if (sp) sp.remove();
  }

  function injectClose(bar){
    if (bar.querySelector('button[data-ng-libbar-close="1"]')) return;

    const closeBtn = document.createElement("button");
    closeBtn.type = "button";
    closeBtn.textContent = "Close";
    closeBtn.setAttribute("data-ng-libbar-close","1");
    closeBtn.style.cssText =
      "padding:6px 10px; border-radius:10px; border:1px solid #2b2f33; " +
      "background:#171a1d; color:#e8eaed; cursor:pointer; margin-left:8px;";

    closeBtn.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      bar.style.setProperty("display","none","important");
      removeSpacer();
      toggleMainLibraryButton(bar);
      console.log("✅ LIBBAR CLOSED");
    }, true);

    bar.appendChild(closeBtn);
  }

  function makeNonOverlay(bar){
    // Try to force STICKY (best)
    bar.style.setProperty("position", "sticky", "important");
    bar.style.setProperty("top", "0px", "important");
    bar.style.setProperty("left", "0px", "important");
    bar.style.setProperty("right", "0px", "important");
    bar.style.setProperty("z-index", "9999", "important");
    bar.style.setProperty("box-sizing", "border-box", "important");
    bar.style.setProperty("background", "rgba(11,13,15,0.95)", "important");
    bar.style.setProperty("backdrop-filter", "blur(6px)", "important");
    bar.style.setProperty("padding", "8px", "important");
    bar.style.setProperty("border-radius", "14px", "important");
    bar.style.setProperty("margin", "8px", "important");
    bar.style.setProperty("transform", "translateZ(0)", "important");

    injectClose(bar);

    // If some script still keeps it FIXED, add spacer so it never covers content
    setTimeout(() => {
      try {
        const pos = getComputedStyle(bar).position;
        if (pos === "fixed") ensureSpacer(bar);
        else removeSpacer();
      } catch {}
    }, 0);
  }

  function apply(){
    const bar = findLibraryBar();
    if (!bar) return;
    makeNonOverlay(bar);
  }

  apply();
  new MutationObserver(apply).observe(document.documentElement, { childList:true, subtree:true });
  // extra safety: if other scripts re-override after a delay
  setInterval(apply, 500);

  console.log(TAG, "installed");
})();
</script>
<!-- NG_PATCH_END: LIBBAR_NO_OVERLAY_V2 -->



<!-- NG_PATCH_START: STORYVIEW_SWAP_FIX_V7CLEAN -->
<script>
(function STORYVIEW_SWAP_FIX_V7CLEAN(){
  if (window.__NG_SV_FIX_V7CLEAN_INSTALLED__) return;
  window.__NG_SV_FIX_V7CLEAN_INSTALLED__ = true;

  const SEG_IDS = ["ngSegBtnV2", "ng-seg-copy"];

  function killSegments(){
    for (const id of SEG_IDS) {
      const el = document.getElementById(id);
      if (el) el.remove();
    }
  }

  function ensureStoryBtn(){
    const b = document.getElementById("btn-storyview-v9");
    if (!b) return null;
    b.type = "button";
    b.style.setProperty("pointer-events", "auto", "important");
    b.style.setProperty("z-index", "2147483647", "important");
    return b;
  }

  function safeGetLS(key){
    try { return localStorage.getItem(key); } catch { return null; }
  }

  function collectStoryText(){
    const keys = [
      "NG_DRAFTS",
      "NG_DRAFTS_V2",
      "NG_LASTPACK_CAPTURE_V1",
      "NG_LASTPACK",
      "NG_TRANSCRIPT",
      "NG_TRANSCRIPT_JSON",
      "NG_LAST_API_DIGIPACK",
      "NG_DIGIPACK_LAST"
    ];

    const found = [];
    for (const k of keys) {
      const v = safeGetLS(k);
      if (v && String(v).length) found.push({ k, len: String(v).length, v });
    }

    try {
      const extra = [];
      for (let i=0; i<localStorage.length && extra.length<6; i++){
        const k = localStorage.key(i);
        if (!k) continue;
        if (/draft|digipack|storyview|transcript/i.test(k) && !keys.includes(k)){
          const v = safeGetLS(k);
          if (v && String(v).length) extra.push({ k, len: String(v).length, v });
        }
      }
      found.push(...extra);
    } catch {}

    const main = found.slice().sort((a,b)=>b.len-a.len)[0];
    const header = [
      "NewsGenie Story View (FIX) — fallback modal",
      "Time: " + new Date().toISOString(),
      "Found keys: " + (found.map(x => `${x.k}(${x.len})`).join(", ") || "NONE"),
      "",
      main ? `Showing: ${main.k} (len=${main.len})` : "No saved story/draft data found in localStorage."
    ].join("\n");

    return header + "\n\n" + (main ? String(main.v) : "");
  }

  function restoreLibraryBestEffort(){
    const ids = ["btn-open-library", "btn-open-lib", "btn-library", "btnOpenLibrary", "btn-open-library-v2"];
    for (const id of ids) {
      const el = document.getElementById(id);
      if (el && typeof el.click === "function") { el.click(); return true; }
    }
    const b = [...document.querySelectorAll("button")].find(x => /library/i.test((x.textContent||"").trim()));
    if (b && typeof b.click === "function") { b.click(); return true; }
    return false;
  }

  function ensureModal(){
    let m = document.getElementById("ngSvFixModal");
    if (m) return m;

    m = document.createElement("div");
    m.id = "ngSvFixModal";
    m.style.cssText = [
      "position:fixed",
      "inset:0",
      "display:none",
      "background:rgba(0,0,0,0.55)",
      "z-index:2147483646"
    ].join(";");

    const panel = document.createElement("div");
    panel.style.cssText = [
      "position:absolute",
      "left:24px",
      "right:24px",
      "top:24px",
      "bottom:24px",
      "background:#101214",
      "color:#e8eaed",
      "border-radius:14px",
      "box-shadow:0 10px 30px rgba(0,0,0,0.6)",
      "padding:12px",
      "overflow:hidden",
      "font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial"
    ].join(";");

    const bar = document.createElement("div");
    bar.style.cssText = "display:flex; gap:8px; align-items:center; justify-content:space-between; padding:6px 4px 10px 4px;";

    const title = document.createElement("div");
    title.textContent = "Story View (FIX)";
    title.style.cssText = "font-weight:700; font-size:14px;";

    const btns = document.createElement("div");
    btns.style.cssText = "display:flex; gap:8px; align-items:center;";

    const mkBtn = (txt) => {
      const b = document.createElement("button");
      b.textContent = txt;
      b.type = "button";
      b.style.cssText = "padding:6px 10px; border-radius:10px; border:1px solid #2b2f33; background:#171a1d; color:#e8eaed; cursor:pointer;";
      return b;
    };

    const bRefresh = mkBtn("Refresh");
    const bCopy    = mkBtn("Copy");
    const bClose   = mkBtn("Close");

    btns.appendChild(bRefresh);
    btns.appendChild(bCopy);
    btns.appendChild(bClose);

    bar.appendChild(title);
    bar.appendChild(btns);

    const pre = document.createElement("pre");
    pre.id = "ngSvFixBody";
    pre.style.cssText = [
      "white-space:pre-wrap",
      "word-break:break-word",
      "margin:0",
      "height:calc(100% - 44px)",
      "overflow:auto",
      "padding:10px",
      "border-radius:12px",
      "background:#0b0d0f",
      "border:1px solid #2b2f33",
      "font-size:12px",
      "line-height:1.35"
    ].join(";");

    panel.appendChild(bar);
    panel.appendChild(pre);
    m.appendChild(panel);

    (document.body || document.documentElement).appendChild(m);

    const fill = () => { pre.textContent = collectStoryText(); };

    bRefresh.onclick = () => { fill(); console.log("✅ FIX REFRESH"); };

    bCopy.onclick = async () => {
      try {
        await navigator.clipboard.writeText(pre.textContent || "");
        console.log("✅ FIX COPIED");
      } catch(e) {
        const ta = document.createElement("textarea");
        ta.value = pre.textContent || "";
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
        console.log("✅ FIX COPIED (fallback)");
      }
    };

    bClose.onclick = () => {
      try { m.style.setProperty("display","none","important"); } catch {}
      try { m.remove(); } catch {}
      console.log("✅ FIX CLOSED (removed)");
      restoreLibraryBestEffort();
    };

    m.addEventListener("click", (e) => { if (e.target === m) bClose.onclick(); });

    fill();
    console.log("[SV_FIX_V7] ngSvFixModal created");
    return m;
  }

  function openModal(){
    const m = ensureModal();
    m.style.setProperty("display", "block", "important");
    m.style.setProperty("visibility", "visible", "important");
    m.style.setProperty("opacity", "1", "important");
    return true;
  }

  function isStoryViewHit(ev){
    const b = ensureStoryBtn();
    if (!b) return false;

    const path = ev.composedPath ? ev.composedPath() : [];
    if (ev.target === b || path.includes(b)) return true;

    const r = b.getBoundingClientRect();
    const x = ev.clientX, y = ev.clientY;
    return (x >= r.left && x <= r.right && y >= r.top && y <= r.bottom);
  }

  // V7 one-shot + click-block
  let __ng_sv_lastHit = 0;

  function onSVPointer(ev){
    if (!ev || !ev.isTrusted) return;
    if (!isStoryViewHit(ev)) return;

    const t = Date.now();
    if (t - __ng_sv_lastHit < 600) {
      ev.preventDefault();
      ev.stopImmediatePropagation();
      return;
    }
    __ng_sv_lastHit = t;

    killSegments();
    ensureStoryBtn();
    openModal();
    console.log("✅ FIX OPEN (V7)");

    ev.preventDefault();
    ev.stopImmediatePropagation();
  }

  function onSVClickBlock(ev){
    if (!ev || !ev.isTrusted) return;
    if (Date.now() - __ng_sv_lastHit > 800) return;
    if (!isStoryViewHit(ev)) return;

    ev.preventDefault();
    ev.stopImmediatePropagation();
  }

  // IMPORTANT: install EARLY by placing this block right after <body>
  window.addEventListener("pointerdown", onSVPointer, true);
  window.addEventListener("click", onSVClickBlock, true);

  // Keep stable after refresh / reinserts
  const mo = new MutationObserver(() => { killSegments(); ensureStoryBtn(); });
  mo.observe(document.documentElement, { childList: true, subtree: true });

  killSegments();
  ensureStoryBtn();
  console.log("[SV_FIX_V7] installed");
})();
</script> 
<!-- NG_PATCH_END: STORYVIEW_SWAP_FIX_V7CLEAN -->
<script>
/* NG_REVERIE_BUTTONS_V1 */
(function () {
  if (window.__NG_REVERIE_BUTTONS_V1__) return;
  window.__NG_REVERIE_BUTTONS_V1__ = true;

  const byId = (id) => document.getElementById(id);

  function setHint(msg) {
    const el = byId("transcript-load-hint");
    if (el) el.textContent = msg || "";
  }

  function setTA(txt) {
    const ta = byId("ta-transcript-json");
    if (!ta) return false;
    ta.value = String(txt || "");
    ta.dispatchEvent(new Event("input", { bubbles: true }));
    ta.dispatchEvent(new Event("change", { bubbles: true }));
    return true;
  }

  function clickLoad() {
    const btn = byId("btn-load-transcript-json");
    if (btn) btn.click();
  }

  async function onPaste() {
    const ta = byId("ta-transcript-json");
    if (!ta) {
      console.warn("[NG_REVERIE_BUTTONS_V1] textarea missing");
      return;
    }

    if (!(window.isSecureContext && navigator.clipboard && navigator.clipboard.readText)) {
      console.warn("[NG_REVERIE_BUTTONS_V1] Clipboard API unavailable. (Use https/localhost; permission needed)");
      ta.focus();
      setHint("Clipboard unavailable — paste manually.");
      return;
    }

    try {
      const txt = await navigator.clipboard.readText();
      if (!txt || !txt.trim()) {
        setHint("Clipboard empty.");
        return;
      }
      setTA(txt);
      setHint("Pasted ✓  (Loading…)");
      clickLoad();
    } catch (e) {
      console.warn("[NG_REVERIE_BUTTONS_V1] clipboard read failed", e);
      setHint("Clipboard read failed — paste manually.");
      ta.focus();
    }
  }

  function onImportClick() {
    const fin = byId("file-transcript-json");
    if (fin) fin.click();
  }

  function onFileChange(ev) {
    const fin = ev && ev.target;
    const file = fin && fin.files && fin.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function () {
      const txt = String(reader.result || "");
      setTA(txt);
      setHint("File loaded ✓  (Loading…)");
      clickLoad();
      fin.value = "";
    };
    reader.onerror = function () {
      console.warn("[NG_REVERIE_BUTTONS_V1] file read failed");
      setHint("File read failed.");
      fin.value = "";
    };
    reader.readAsText(file);
  }

  function install() {
    const btnPaste = byId("btn-paste-transcript-json");
    const btnImport = byId("btn-import-transcript-json");
    const fin = byId("file-transcript-json");

    if (btnPaste && !btnPaste.dataset.ngWired) {
      btnPaste.addEventListener("click", onPaste);
      btnPaste.dataset.ngWired = "1";
    }
    if (btnImport && !btnImport.dataset.ngWired) {
      btnImport.addEventListener("click", onImportClick);
      btnImport.dataset.ngWired = "1";
    }
    if (fin && !fin.dataset.ngWired) {
      fin.addEventListener("change", onFileChange);
      fin.dataset.ngWired = "1";
    }

    console.log("[NG_REVERIE_BUTTONS_V1] installed ✓", {
      paste: !!btnPaste,
      import: !!btnImport,
      file: !!fin,
      ta: !!byId("ta-transcript-json"),
      loadBtn: !!byId("btn-load-transcript-json")
    });
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", install);
  } else {
    install();
  }
})();
</script>
<script>
/* NG_UI_HEALTHCHECK_V1 */
window.__NG_UI_HEALTHCHECK__ = function () {
  const qsa = (sel) => Array.from(document.querySelectorAll(sel));
  const byId = (id) => document.getElementById(id);

  const ids = [
    "btn-generate",
    "btn-save-draft",
    "btn-open-library",
    "btn-mark-published",
    "btn-new-story",

    "ng-reverie-block",
    "btn-load-transcript-json",
    "btn-clear-transcript-json",
    "btn-paste-transcript-json",
    "btn-import-transcript-json",
    "file-transcript-json",
    "ta-transcript-json",
    "transcript-load-hint"
  ];

  const out = {
    ok: true,
    ts: new Date().toISOString(),
    dom: {},
    duplicates: {},
    buttons: {},
    localStorage: {},
    patches: Array.isArray(window.__NG_PATCHES__) ? window.__NG_PATCHES__.slice() : [],
    notes: []
  };

  // DOM + duplicate id counts
  ids.forEach((id) => {
    const nodes = qsa(`[id="${id}"]`);
    out.duplicates[id] = nodes.length;
    out.dom[id] = { present: nodes.length > 0, count: nodes.length };

    const el = nodes[0];
    if (el && el.tagName === "BUTTON") {
      out.buttons[id] = {
        disabled: !!el.disabled,
        wired: (el.dataset && el.dataset.ngWired) ? "yes" : "",
        text: (el.textContent || "").trim().slice(0, 40)
      };
    }
  });

  // localStorage check
  const lsKeys = ["NG_TRANSCRIPT", "NG_REVERIE_TEXT", "NG_DRAFTS", "NG_LASTPACK"];
  lsKeys.forEach((k) => {
    const v = localStorage.getItem(k);
    if (v == null) {
      out.localStorage[k] = { present: false };
      return;
    }
    let isJSON = false, parsed = null;
    try { parsed = JSON.parse(v); isJSON = true; } catch (e) {}

    const row = { present: true, bytes: String(v).length, isJSON };

    if (k === "NG_TRANSCRIPT") {
      // NG_TRANSCRIPT may be string OR JSON depending on your bridge
      if (isJSON && parsed && typeof parsed === "object") {
        const t = parsed.transcript || parsed.display_text || parsed.text || "";
        if (typeof t === "string" && t) {
          row.transcriptLen = t.length;
          row.transcriptStart = t.slice(0, 40);
        }
        row.keys = Object.keys(parsed).slice(0, 20);
      } else {
        const t = String(v || "");
        row.transcriptLen = t.length;
        row.transcriptStart = t.slice(0, 40);
      }
    }

    out.localStorage[k] = row;
  });

  // minimal required ids
  ["btn-load-transcript-json", "ta-transcript-json"].forEach((id) => {
    if (!byId(id)) out.ok = false;
  });

  // duplicates warning
  Object.entries(out.duplicates).forEach(([id, count]) => {
    if (count > 1) out.notes.push(`Duplicate id="${id}" x${count}`);
  });

  console.log("[NG_UI_HEALTHCHECK]", out);
  try {
    console.table(Object.entries(out.buttons).map(([id, v]) => ({
      id, disabled: v.disabled, wired: v.wired, text: v.text
    })));
  } catch (e) {}

  return out;
};
</script>
<script>
/* NG_SAVEDRAFT_LASTPACK_BRIDGE_V1 */
(function () {
  if (window.__NG_SAVEDRAFT_LASTPACK_BRIDGE_V1__) return;
  window.__NG_SAVEDRAFT_LASTPACK_BRIDGE_V1__ = true;

  const byId = (id) => document.getElementById(id);

  function pickLastResp() {
    const keys = [
      "NG_LAST_DIGIPACK_RESP_V3",
      "NG_LAST_DIGIPACK_RESP",
      "NG_LASTPACK"
    ];
    for (const k of keys) {
      let v = "";
      try { v = localStorage.getItem(k) || ""; } catch (e) {}
      if (String(v).trim()) return { key: k, val: String(v) };
    }
    return null;
  }

  function normalizeToJSONText(v) {
    const s = String(v || "").trim();
    if (!s) return "";
    if (s[0] === "{" || s[0] === "[") return s;
    return JSON.stringify({ ok: true, raw: s });
  }

  function mirrorForSaveDraft() {
    const pick = pickLastResp();
    if (!pick) {
      console.warn("[NG_SAVEDRAFT_LASTPACK_BRIDGE_V1] no last response found");
      return;
    }
    const jsonText = normalizeToJSONText(pick.val);
    if (!jsonText) {
      console.warn("[NG_SAVEDRAFT_LASTPACK_BRIDGE_V1] empty last response");
      return;
    }

    try {
      localStorage.setItem("NG_LASTPACK", jsonText);
      localStorage.setItem("NG_LASTPACK_CAPTURE", jsonText);
      localStorage.setItem("NG_LASTPACK_TS", new Date().toISOString());
    } catch (e) {
      console.error("[NG_SAVEDRAFT_LASTPACK_BRIDGE_V1] localStorage set failed", e);
      return;
    }

    console.log("[NG_SAVEDRAFT_LASTPACK_BRIDGE_V1] mirrored", {
      from: pick.key,
      len: jsonText.length
    });
  }

  function install() {
    const btn = byId("btn-save-draft");
    if (!btn) {
      console.warn("[NG_SAVEDRAFT_LASTPACK_BRIDGE_V1] btn-save-draft not found");
      return;
    }
    btn.addEventListener("click", mirrorForSaveDraft, true);
    console.log("[NG_SAVEDRAFT_LASTPACK_BRIDGE_V1] armed ✓");
  }

  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", install);
  else install();
})();
</script>
<script>
/* NG_AUTORESTORE_LAST_DRAFT_V1 */
(function () {
  if (window.__NG_AUTORESTORE_LAST_DRAFT_V1__) return;
  window.__NG_AUTORESTORE_LAST_DRAFT_V1__ = true;

  const byId = (id) => document.getElementById(id);

  function setHint(msg) {
    const el = byId("transcript-load-hint");
    if (el) el.textContent = msg || "";
  }

  function lsGet(k) { try { return localStorage.getItem(k); } catch (e) { return null; } }

  function readDrafts() {
    const keys = ["NG_DIGIPACK_DRAFTS_V1", "NG_DIGIPACK_DRAFTS"];
    for (const k of keys) {
      const v = lsGet(k);
      if (!v) continue;
      try {
        const arr = JSON.parse(v);
        if (Array.isArray(arr) && arr.length) return { key: k, arr };
      } catch (e) {}
    }
    return null;
  }

  function getCurrentSel() {
    const id = (lsGet("NG_DIGIPACK_CURRENT_ID") || lsGet("NG_DIGIPACK_CURRENT_ID_V1") || "").trim();
    const idxStr = (lsGet("NG_DIGIPACK_SELECTED_IDX") || lsGet("NG_DIGIPACK_SELECTED_IDX_V1") || "").trim();
    const idxNum = Number(idxStr);
    return { id, idx: Number.isFinite(idxNum) ? idxNum : null };
  }

  function pickDraft(drafts, sel) {
    if (!drafts || !drafts.length) return null;

    if (sel && sel.id) {
      const hit = drafts.find(d => String((d && d.id) || "") === sel.id);
      if (hit) return hit;
    }
    if (sel && sel.idx != null && sel.idx >= 0 && sel.idx < drafts.length) {
      return drafts[sel.idx];
    }
    return drafts[0] || null;
  }

  function getAny(obj, keys) {
    for (const k of keys) {
      if (obj && obj[k] != null && String(obj[k]).trim() !== "") return obj[k];
    }
    return "";
  }

  function setField(id, val) {
    const el = byId(id);
    if (!el) return false;

    // Don’t overwrite if user already typed something after refresh
    if (String(el.value || "").trim()) return true;

    el.value = (val == null) ? "" : String(val);
    el.dispatchEvent(new Event("input", { bubbles: true }));
    el.dispatchEvent(new Event("change", { bubbles: true }));
    return true;
  }

  function restoreOnce() {
    const draftsObj = readDrafts();
    if (!draftsObj) {
      setHint("Drafts not found in localStorage.");
      return { ok: false, reason: "no_drafts" };
    }

    const sel = getCurrentSel();
    const draft = pickDraft(draftsObj.arr, sel);
    if (!draft) {
      setHint("No draft to restore.");
      return { ok: false, reason: "no_pick" };
    }

    const topic = getAny(draft, ["topic", "headline", "title"]);
    const platform = getAny(draft, ["platform"]);
    const angle = getAny(draft, ["angle"]);
    const storyType = getAny(draft, ["storyType", "story_type", "type"]);
    const whatHappened = getAny(draft, ["whatHappened", "what_happened"]);
    const sources = getAny(draft, ["sources", "source", "references", "refs"]);
    const background = getAny(draft, ["background", "context"]);

    const filled = {
      topic: setField("topic", topic),
      platform: setField("platform", platform),
      angle: setField("angle", angle),
      storyType: setField("storyType", storyType),
      whatHappened: setField("whatHappened", whatHappened),
      sources: setField("sources", sources),
      background: setField("background", background)
    };

    setHint(`Draft restored: ${draft.id || "(no id)"}`);
    console.log("[NG_AUTORESTORE_LAST_DRAFT_V1] restored ✓", { sel, draftId: draft.id, filled, from: draftsObj.key });
    return { ok: true, sel, draftId: draft.id, filled, from: draftsObj.key };
  }

  function install() {
    let tries = 0;
    const maxTries = 12;

    const tick = () => {
      tries++;
      const hasCore = !!(byId("topic") && byId("whatHappened") && byId("sources") && byId("storyType"));
      if (hasCore) {
        restoreOnce();
        return;
      }
      if (tries >= maxTries) {
        console.warn("[NG_AUTORESTORE_LAST_DRAFT_V1] fields not ready after retries");
        return;
      }
      setTimeout(tick, 150);
    };

    setTimeout(tick, 150);
  }

  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", install);
  else install();
})();
</script>
<!-- NG_HEALTH_PILL_V1_START -->
<div id="ngHealthPill" style="position:fixed;right:10px;bottom:10px;z-index:999999;font:12px/1.2 Arial,sans-serif;padding:6px 10px;border-radius:999px;border:1px solid #999;background:#f4f4f4;box-shadow:0 2px 10px rgba(0,0,0,.08);">
HEALTH: …
</div>
<script>
(function(){
  var pill = document.getElementById("ngHealthPill");
  function set(ok, txt){
    pill.textContent = txt;
    pill.style.background = ok ? "#eaffea" : "#ffecec";
    pill.style.borderColor = ok ? "#2a9d3a" : "#cc2b2b";
  }
  async function poll(){
    try{
      var r = await fetch("/api/health", { cache:"no-store" });
      if(!r.ok) throw new Error("HTTP "+r.status);
      var j = await r.json();
      set(true, "HEALTH: OK • " + (j.boot_ts || ""));
    }catch(e){
      set(false, "HEALTH: DOWN");
    }
    setTimeout(poll, 2000);
  }
  poll();
})();
</script>
<!-- NG_HEALTH_PILL_V1_END -->
<!-- NG_CRASH_GUARD_V1_START -->
<div id="ngCrashOverlay" style="display:none;position:fixed;inset:0;z-index:999998;background:rgba(0,0,0,.6);">
  <div style="position:absolute;left:50%;top:14%;transform:translateX(-50%);width:min(760px,92vw);background:#fff;border:1px solid #ddd;border-radius:14px;padding:12px 12px;font:14px/1.35 Arial,sans-serif;">
    <b>NewsGenie Crash Guard</b>
    <div style="margin-top:8px;">UI में error आया है। नीचे diagnostics copy करके भेज दें।</div>
    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;">
      <button id="ngCrashReload" style="padding:8px 10px;border:1px solid #999;border-radius:10px;background:#fff;cursor:pointer;">Reload</button>
      <button id="ngCrashCopy" style="padding:8px 10px;border:1px solid #999;border-radius:10px;background:#fff;cursor:pointer;">Copy Diagnostics</button>
      <button id="ngCrashHide" style="padding:8px 10px;border:1px solid #999;border-radius:10px;background:#fff;cursor:pointer;">Hide</button>
    </div>
    <pre id="ngCrashPre" style="margin-top:10px;background:#f7f7f7;padding:10px;border-radius:10px;overflow:auto;max-height:280px;">{}</pre>
  </div>
</div>

<script>
(function(){
  var ov = document.getElementById("ngCrashOverlay");
  var pre = document.getElementById("ngCrashPre");
  var btnR = document.getElementById("ngCrashReload");
  var btnC = document.getElementById("ngCrashCopy");
  var btnH = document.getElementById("ngCrashHide");

  function nowISO(){ return new Date().toISOString(); }
  function safeStr(x){
    try { return (x && x.stack) ? String(x.stack) : String(x); } catch(e){ return "unknown"; }
  }
  function getArr(k){ try { return JSON.parse(localStorage.getItem(k)||"[]"); } catch(e){ return []; } }
  function setArr(k,a){ try { localStorage.setItem(k, JSON.stringify(a.slice(-50))); } catch(e){} }

  var KEY = "NG_LAST_ERRORS_V1";
  var errs = getArr(KEY);

  function showOverlay(payload){
    try{
      ov.style.display = "block";
      pre.textContent = JSON.stringify(payload, null, 2);
      localStorage.setItem("NG_LAST_DIAG_V1", pre.textContent);
    }catch(e){}
  }

  function record(kind, errLike){
    var e = { ts: nowISO(), kind: kind, msg: safeStr(errLike) };
    errs.push(e); errs = errs.slice(-50);
    setArr(KEY, errs);
    showOverlay({
      ts: nowISO(),
      url: location.href,
      ua: navigator.userAgent,
      lastErrors: errs
    });
  }

  window.addEventListener("error", function(ev){
    record("error", ev.error || ev.message || "error");
  });

  window.addEventListener("unhandledrejection", function(ev){
    record("unhandledrejection", ev.reason || "promise");
  });

  // restore last diag (useful next day)
  try{
    var saved = localStorage.getItem("NG_LAST_DIAG_V1");
    if(saved && saved.length > 10) pre.textContent = saved;
  }catch(e){}

  btnR.onclick = function(){ location.reload(); };
  btnH.onclick = function(){ ov.style.display = "none"; };
  btnC.onclick = async function(){
    var txt = pre.textContent || "";
    try { await navigator.clipboard.writeText(txt); alert("Diagnostics copied"); }
    catch(e){ alert("Copy failed"); }
  };
})();
</script>
<!-- NG_CRASH_GUARD_V1_END -->
<script>
/* ===== NG_UI_FREEZE_GUARD_V1 START ===== */
(function(){
  const _fetch = window.fetch.bind(window);

  const GUARD = window.__NG_GUARD__ = {
    inflight: 0,
    lastErr: null,
    hardTimer: null,
    timeoutMs: 60000,
    retryOnce: true,
    btnIds: ["btn-generate","btnGenerate","btn-bytes","btnBytes","btn-visuals","btnVisuals"],
  };

  function $(id){ return document.getElementById(id); }
  function setButtonsDisabled(disabled){
    GUARD.btnIds.forEach(id => { const b=$(id); if(b) b.disabled = !!disabled; });
  }

  function armHardUnfreeze(){
    clearTimeout(GUARD.hardTimer);
    GUARD.hardTimer = setTimeout(() => {
      if (GUARD.inflight > 0) {
        console.warn("[NG_UI_GUARD] hard-unfreeze", { inflight: GUARD.inflight, lastErr: GUARD.lastErr });
        GUARD.inflight = 0;
        setButtonsDisabled(false);
      }
    }, GUARD.timeoutMs + 2000);
  }

  function combineSignals(sigA, sigB){
    if (!sigA) return sigB;
    if (!sigB) return sigA;
    const ac = new AbortController();
    const onAbort = () => ac.abort(sigA.reason || sigB.reason || "aborted");
    sigA.addEventListener("abort", onAbort, { once:true });
    sigB.addEventListener("abort", onAbort, { once:true });
    return ac.signal;
  }

  async function guardedFetch(input, init = {}) {
    const url = (typeof input === "string") ? input : (input && input.url) || "";
    const isNG = /\/api\/(digi-pack|bytes|visuals)\b/i.test(url);

    if (!isNG) return _fetch(input, init);

    if (GUARD.inflight > 0) throw new Error("NG_BUSY_inflight");

    GUARD.inflight++;
    setButtonsDisabled(true);
    armHardUnfreeze();

    const ac = new AbortController();
    const t = setTimeout(() => ac.abort("ui_timeout"), GUARD.timeoutMs);
    const mergedSignal = combineSignals(init.signal, ac.signal);

    const doOnce = async () => _fetch(input, { ...init, signal: mergedSignal });

    try {
      let res = await doOnce();
      if (GUARD.retryOnce && (res.status === 429 || res.status >= 500)) {
        console.warn("[NG_UI_GUARD] retry once", { url, status: res.status });
        await new Promise(r => setTimeout(r, 800));
        res = await doOnce();
      }
      return res;
    } catch (e) {
      GUARD.lastErr = e;
      console.error("[NG_UI_GUARD] fetch fail", e);
      throw e;
    } finally {
      clearTimeout(t);
      GUARD.inflight = Math.max(0, GUARD.inflight - 1);
      if (GUARD.inflight === 0) setButtonsDisabled(false);
    }
  }

  window.fetch = guardedFetch;

  window.__NG_GUARD_STATUS__ = () => ({
    inflight: GUARD.inflight,
    lastErr: GUARD.lastErr ? String(GUARD.lastErr) : null,
    timeoutMs: GUARD.timeoutMs
  });

  window.addEventListener("unhandledrejection", () => { setButtonsDisabled(false); GUARD.inflight = 0; });
  window.addEventListener("error", () => { setButtonsDisabled(false); GUARD.inflight = 0; });

  console.log("[NG_UI_FREEZE_GUARD_V1] installed", window.__NG_GUARD_STATUS__());
})();
 /* ===== NG_UI_FREEZE_GUARD_V1 END ===== */
</script>


<script>
/* ===== NG_CLEARUI_FIX_V2 START ===== */
window.clearUI = function clearUI(){
  try {
    const form = document.getElementById("digi-pack-form");
    const root = form || document.body;

    let clearedInputs = 0, clearedTextareas = 0, resetSelects = 0;

    // Clear inputs (including inputs without type attribute)
    root.querySelectorAll("input").forEach(el => {
if (el.id === "file-transcript-json") return;



      const t = String(el.type || "").toLowerCase(); // default becomes "text" in browser, but keep safe
      if (["button","submit","reset","checkbox","radio","file","hidden"].includes(t)) return;

      // If input is missing type, browser reports "text" anyway; we still clear
      el.value = "";
      clearedInputs++;

      el.dispatchEvent(new Event("input", { bubbles: true }));
      el.dispatchEvent(new Event("change", { bubbles: true }));
    });

    // Clear all textareas
    root.querySelectorAll("textarea").forEach(el => {
if (el.id === "ta-transcript-json") return;

      el.value = "";
      clearedTextareas++;

      el.dispatchEvent(new Event("input", { bubbles: true }));
      el.dispatchEvent(new Event("change", { bubbles: true }));
    });

    // Reset selects
    root.querySelectorAll("select").forEach(sel => {
      if (sel.options && sel.options.length) {
        sel.selectedIndex = 0;
        resetSelects++;
        sel.dispatchEvent(new Event("change", { bubbles: true }));
      }
    });

    console.log("[NG_CLEARUI_FIX_V2] cleared", { clearedInputs, clearedTextareas, resetSelects });
  } catch (e) {
    console.error("[NG_CLEARUI_FIX_V2] failed", e);
  }
};
/* ===== NG_CLEARUI_FIX_V2 END ===== */
</script>

<script>
/* ===== NG_CLEAR_BTN_DIRTY_GUARD_V1 START ===== */
(function(){
  function getRoot(){
    return document.getElementById("digi-pack-form") || document.body;
  }

  function findClearButtons(){
    // 1) Best: button that calls clearUI
    let btns = Array.from(document.querySelectorAll('button[onclick*="clearUI"]'));
    if (btns.length) return btns;

    // 2) Fallback: text/id contains clear/क्लियर
    btns = Array.from(document.querySelectorAll("button")).filter(b => {
      const t = (b.textContent || "").trim();
      const id = (b.id || "");
      return /clear/i.test(id) || /clear|क्लियर/i.test(t);
    });
    return btns;
  }

  function isDirty(){
    const root = getRoot();

    // inputs
    for (const el of root.querySelectorAll("input")) {
      const t = String(el.type || "").toLowerCase();
      if (["button","submit","reset","checkbox","radio","file","hidden"].includes(t)) continue;
      if (String(el.value || "").trim()) return true;
    }

    // textareas
    for (const el of root.querySelectorAll("textarea")) {
      if (String(el.value || "").trim()) return true;
    }

    // selects (non-default)
    for (const sel of root.querySelectorAll("select")) {
      const v = String(sel.value || "").trim();
      if (v) return true;
    }

    // contenteditable / textbox-like
    for (const ed of root.querySelectorAll('[contenteditable=""],[contenteditable="true"],[role="textbox"]')) {
      if (String(ed.textContent || "").trim()) return true;
    }

    return false;
  }

  function updateClearButtons(){
    const dirty = isDirty();
    const btns = findClearButtons();
    btns.forEach(b => { b.disabled = !dirty; });
    window.__NG_CLEAR_DIRTY_STATUS__ = { dirty, clearBtnCount: btns.length, ts: new Date().toISOString() };
  }

  // Wrap clearUI so after clearing, button disables again
  if (typeof window.clearUI === "function" && !window.__NG_CLEARUI_WRAPPED__) {
    window.__NG_CLEARUI_WRAPPED__ = true;
    const _old = window.clearUI;
    window.clearUI = function(){
      const r = _old.apply(this, arguments);
      setTimeout(updateClearButtons, 0);
      return r;
    };
  }

  // Live updates on typing/changes
  const root = getRoot();
  root.addEventListener("input", updateClearButtons, true);
  root.addEventListener("change", updateClearButtons, true);

  // Initial
  setTimeout(updateClearButtons, 0);
  console.log("[NG_CLEAR_BTN_DIRTY_GUARD_V1] installed");
})();
 /* ===== NG_CLEAR_BTN_DIRTY_GUARD_V1 END ===== */
</script>
<style>
/* ===== NG_TRANSCRIPT_READABLE_V1 START ===== */
#file-transcript-json{
  display:block;
  width:100% !important;
  max-width:100% !important;
  box-sizing:border-box;
  margin: 6px 0 10px 0;
}

#ta-transcript-json{
  display:block;
  width:100% !important;
  max-width:100% !important;
  min-width:100% !important;
  flex: 1 1 100% !important;     /* in case parent is flex */
  box-sizing:border-box;

  height: 280px !important;
  min-height: 220px;

  font-size: 14px !important;
  line-height: 1.5 !important;
  padding: 10px 12px;

  white-space: pre-wrap;
  overflow: auto;
  resize: vertical;
}
/* ===== NG_TRANSCRIPT_READABLE_V1 END ===== */
</style>
<script>
/* ===== NG_TRANSCRIPT_PERSIST_V1 START ===== */
(function(){
  const KEY = "NG_TRANSCRIPT_CACHE_V1";
  const taId = "ta-transcript-json";
  const fileId = "file-transcript-json";

  function getTA(){ return document.getElementById(taId); }
  function saveNow(text){
    try{
      const payload = { ts: new Date().toISOString(), text: String(text||"") };
      localStorage.setItem(KEY, JSON.stringify(payload));
      return true;
    }catch(e){
      console.warn("[NG_TRANSCRIPT_PERSIST_V1] save failed", e);
      return false;
    }
  }
  function loadCache(){
    try{
      const raw = localStorage.getItem(KEY);
      if(!raw) return null;
      const obj = JSON.parse(raw);
      if(obj && typeof obj.text === "string") return obj;
    }catch(e){}
    return null;
  }

  // Debounced autosave on typing/paste
  let tmr = null;
  function armAutosave(){
    const ta = getTA();
    if(!ta) return;
    ta.addEventListener("input", () => {
      clearTimeout(tmr);
      tmr = setTimeout(() => saveNow(ta.value), 400);
    }, { passive:true });
  }

  // If file import exists, hook change → save after a short delay
  function hookFile(){
    const fi = document.getElementById(fileId);
    if(!fi) return;
    fi.addEventListener("change", () => {
      setTimeout(() => {
        const ta = getTA();
        if(ta && ta.value) saveNow(ta.value);
      }, 250);
    });
  }

  async function tryFetchLatest(){
    // Optional: pull latest transcript from worker memory if available
    try{
      const res = await fetch("/api/transcript/latest", { method:"GET" });
      if(!res.ok) return null;
      const j = await res.json().catch(()=>null);
      const txt = j && (j.text || (j.latest && j.latest.text));
      return (typeof txt === "string" && txt.trim()) ? txt : null;
    }catch(e){
      return null;
    }
  }

  async function restoreOnLoad(){
    const ta = getTA();
    if(!ta) return;

    // 1) server latest (if any)
    const latest = await tryFetchLatest();
    if(latest){
      ta.value = latest;
      saveNow(latest);
      console.log("[NG_TRANSCRIPT_PERSIST_V1] restored from /api/transcript/latest", latest.length);
      return;
    }

    // 2) local cache
    const c = loadCache();
    if(c && c.text && !ta.value){
      ta.value = c.text;
      console.log("[NG_TRANSCRIPT_PERSIST_V1] restored from localStorage", c.text.length, c.ts);
    }
  }

  window.__NG_TRANSCRIPT_PERSIST_STATUS__ = () => {
    const c = loadCache();
    return { key: KEY, cachedLen: c?.text?.length||0, cachedTs: c?.ts||null };
  };

  document.addEventListener("DOMContentLoaded", () => {
    armAutosave();
    hookFile();
    restoreOnLoad();
    console.log("[NG_TRANSCRIPT_PERSIST_V1] installed");
  });
})();
 /* ===== NG_TRANSCRIPT_PERSIST_V1 END ===== */
</script>
<script>
/* ===== NG_EDITORIAL_EXTRACTION_BIND_V1 START ===== */
(function(){
  if (window.__NG_EE_BIND_V1__) return;
  window.__NG_EE_BIND_V1__ = true;

  const IDS = {
    list: "ee-list",
    empty: "ee-empty",
    push: "ee-push",
    clear: "ee-clear",
    taTranscript: "ta-transcript-json"
  };

  function $(id){ return document.getElementById(id); }

  function getTranscriptText(){
    const ta = $(IDS.taTranscript);
    const v = (ta && typeof ta.value === "string") ? ta.value : "";
    if (v.trim()) return v;

    // fallback: localStorage cache from NG_TRANSCRIPT_PERSIST_V1
    try{
      const raw = localStorage.getItem("NG_TRANSCRIPT_CACHE_V1");
      if (raw){
        const obj = JSON.parse(raw);
        if (obj && typeof obj.text === "string") return obj.text;
      }
    }catch(e){}
    return "";
  }

  // Simple local heuristic extractor (no API, no tokens)
  function extractSuggestions(text, max=12){
  const raw = String(text || "").replace(/\r/g, "\n").trim();
  if (!raw) return [];

  // 1) lines + sentence-ish split (works if punctuation exists)
  const lines = raw.split(/\n+/).map(s => s.trim()).filter(Boolean);

  let pieces = [];
  for (const line of lines) {
    // split by danda/!/? if present; else keep line
    const segs = line.split(/[।!?]+/g).map(s => s.trim()).filter(Boolean);
    if (segs.length > 1) pieces.push(...segs);
    else pieces.push(line);
  }

  pieces = pieces.map(s => s.replace(/\s+/g, " ").trim()).filter(Boolean);

  // allow wider length range
  let cand = pieces.filter(s => s.length >= 12 && s.length <= 220);

  // 2) Fallback: if still nothing, make fixed-size chunks from whole text
  if (!cand.length) {
    const txt = raw.replace(/\s+/g, " ").trim();
    const chunkLen = 110;

    let start = 0;
    while (start < txt.length && cand.length < max) {
      let end = Math.min(txt.length, start + chunkLen);

      // break on space near end to keep words intact
      let brk = txt.lastIndexOf(" ", end);
      if (brk <= start + 40) brk = end; // avoid too-small chunks

      const chunk = txt.slice(start, brk).trim();
      if (chunk) cand.push(chunk);

      start = brk;
    }
  }

  // de-dup + cap
  const seen = new Set();
  const out = [];
  for (const s of cand) {
    const key = s.toLowerCase();
    if (seen.has(key)) continue;
    seen.add(key);
    out.push(s);
    if (out.length >= max) break;
  }
  return out;
}


  function setEmptyVisible(on){
    const empty = $(IDS.empty);
    if (empty) empty.style.display = on ? "block" : "none";
  }

  function setPushEnabled(){
    const push = $(IDS.push);
    const list = $(IDS.list);
    if (!push || !list) return;
    const anyChecked = !!list.querySelector('input[type="checkbox"]:checked');
    push.disabled = !anyChecked;
  }

  function renderList(items){
    const list = $(IDS.list);
    if (!list) return;

    list.innerHTML = "";
    if (!items || !items.length){
      setEmptyVisible(true);
      setPushEnabled();
      return;
    }

    setEmptyVisible(false);

    items.forEach((txt, i) => {
      const row = document.createElement("div");
      row.style.display = "flex";
      row.style.gap = "8px";
      row.style.alignItems = "flex-start";
      row.style.padding = "6px 0";
      row.style.borderBottom = "1px dashed #ddd";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.style.marginTop = "3px";
      cb.addEventListener("change", setPushEnabled);

      const span = document.createElement("div");
      span.textContent = txt;
      span.style.flex = "1";

      row.appendChild(cb);
      row.appendChild(span);
      list.appendChild(row);
    });

    setPushEnabled();
  }

  function ensureExtractButton(){
    const list = $(IDS.list);
    if (!list) return null;

    // place button just above list
    let btn = document.getElementById("ee-extract");
    if (btn) return btn;

    btn = document.createElement("button");
    btn.id = "ee-extract";
    btn.type = "button";
    btn.textContent = "Extract from Transcript";
    btn.style.margin = "8px 0";
    btn.style.padding = "8px 10px";
    btn.style.border = "1px solid #999";
    btn.style.borderRadius = "8px";
    btn.style.cursor = "pointer";
    btn.style.background = "#f7f7f7";

    btn.addEventListener("click", () => {
      const tr = getTranscriptText();
      const items = extractSuggestions(tr, 12);
      renderList(items);
      window.__NG_EE_LAST__ = { ts: new Date().toISOString(), transcriptLen: tr.length, items: items.length };
      console.log("[NG_EE] extracted", window.__NG_EE_LAST__);
    });

    list.parentNode.insertBefore(btn, list);
    return btn;
  }

  function findBytesTextarea(){
    // try common ids first
    const candIds = ["ta-bytes","bytes","bytesText","ng-bytes","taBytes"];
    for (const id of candIds){
      const el = document.getElementById(id);
      if (el && el.tagName === "TEXTAREA") return el;
    }
    // fallback: panel containing "Bytes (Speaker + Designation)"
    const panel = [...document.querySelectorAll(".panel, fieldset, section, div")]
      .find(x => /Bytes\s*\(Speaker/i.test(x.textContent || ""));
    if (!panel) return null;
    return panel.querySelector("textarea");
  }

  function bindButtons(){
    const push = $(IDS.push);
    const clear = $(IDS.clear);
    const list = $(IDS.list);

    if (clear && !clear.__ngBound){
      clear.__ngBound = true;
      clear.addEventListener("click", () => {
        if (list) list.innerHTML = "";
        setEmptyVisible(true);
        if (push) push.disabled = true;
        window.__NG_EE_LAST__ = { ts: new Date().toISOString(), cleared: true };
        console.log("[NG_EE] cleared");
      });
    }

    if (push && !push.__ngBound){
      push.__ngBound = true;
      push.addEventListener("click", () => {
        const list = $(IDS.list);
        if (!list) return;

        const picked = [...list.querySelectorAll('input[type="checkbox"]')]
          .map((cb) => ({ cb, text: cb?.parentElement?.querySelector("div")?.textContent || "" }))
          .filter(x => x.cb.checked && x.text.trim())
          .map(x => x.text.trim());

        if (!picked.length) { push.disabled = true; return; }

        const ta = findBytesTextarea();
        const payload = picked.map((s,i)=>`${i+1}) ${s}`).join("\n");

        if (ta){
          const pre = (ta.value || "").trim();
          ta.value = (pre ? (pre + "\n\n") : "") + "SUGGESTED_BYTES:\n" + payload + "\n";
          ta.dispatchEvent(new Event("input", { bubbles:true }));
          ta.dispatchEvent(new Event("change", { bubbles:true }));
          console.log("[NG_EE] pushed to bytes textarea", { count: picked.length });
        } else {
          if (typeof copy === "function") copy(payload);
          console.log("[NG_EE] bytes textarea not found; copied to clipboard", { count: picked.length });
        }

        push.disabled = true;
      });
    }

    setPushEnabled();
  }

  function init(){
    ensureExtractButton();
    bindButtons();

    // auto-extract once if transcript already present
    const tr = getTranscriptText();
    if (tr && tr.trim().length > 50){
      const items = extractSuggestions(tr, 12);
      renderList(items);
      window.__NG_EE_LAST__ = { ts: new Date().toISOString(), auto: true, transcriptLen: tr.length, items: items.length };
      console.log("[NG_EE] auto-extracted", window.__NG_EE_LAST__);
    } else {
      setEmptyVisible(true);
    }
  }

  window.__NG_EE_STATUS__ = () => {
    const list = $(IDS.list);
    const tr = getTranscriptText();
    const checked = list ? list.querySelectorAll('input[type="checkbox"]:checked').length : 0;
    const total = list ? list.querySelectorAll('input[type="checkbox"]').length : 0;
    return { transcriptLen: tr.length, itemsTotal: total, itemsChecked: checked, last: window.__NG_EE_LAST__ || null };
  };

  document.addEventListener("DOMContentLoaded", init);
  console.log("[NG_EDITORIAL_EXTRACTION_BIND_V1] installed");
})();
 /* ===== NG_EDITORIAL_EXTRACTION_BIND_V1 END ===== */
</script>
<script>
(() => {
  // Wait-until-ready installer (so it won't silently exit)
  if (window.__NG_BYTES_FINAL_V2_BOOT__) return;
  window.__NG_BYTES_FINAL_V2_BOOT__ = true;

  const norm = (s) => String(s ?? "").replace(/\s+/g, " ").trim();

  function findBytesWrap() {
    return (
      document.getElementById("bytesWrap") ||
      document.querySelector('#ng-sec-bytes, [data-ng-sec="bytes"]') ||
      (() => {
        const h = Array.from(document.querySelectorAll("b,h3,h4,div,span"))
          .find(el => /Bytes\s*\(Speaker/i.test(el.textContent || ""));
        return h?.closest(".panel") || h?.parentElement || null;
      })()
    );
  }

  function findBytesOutTA() {
    return document.getElementById("bytesJSONOut");
  }

  function findEeList() {
    return (
      document.getElementById("ee-list") ||
      document.querySelector("[data-ng-ee-list]") ||
      document.querySelector("#ng-sec-ee, #ng-sec-editorial-extraction, #editorialExtraction") ||
      null
    );
  }

  function bootInstall() {
  const __ngFail = (why, extra) => {
    try { console.warn("[NG_BYTES_FINAL_V2][bootInstall fail]", why, extra || ""); } catch(e) {}
    return false;
  };

  try {
    const dbg = {
      hasWrap: !!document.getElementById("bytesWrap"),
      hasOut:  !!document.getElementById("bytesJSONOut"),
      wrapTag: document.getElementById("bytesWrap")?.tagName,
      outTag:  document.getElementById("bytesJSONOut")?.tagName,
      outType: document.getElementById("bytesJSONOut")?.type
    };
    console.log("[NG_BYTES_FINAL_V2][bootInstall dbg]", dbg);
  } catch (e) {}

    if (window.__NG_BYTES_FINAL_V2__) return;
    const bytesWrap = findBytesWrap();
    const bytesOutTA = findBytesOutTA();
    if (!bytesWrap || !bytesOutTA) return false;

    window.__NG_BYTES_FINAL_V2__ = true;

    // ---- store (array OR {bytes:[]}) ----
    function loadStore() {
      const raw = String(bytesOutTA.value || "").trim();
      if (!raw) return { mode: "array", arr: [], obj: null };
      try {
        const p = JSON.parse(raw);
        if (Array.isArray(p)) return { mode: "array", arr: p, obj: null };
        if (p && typeof p === "object") {
          if (!Array.isArray(p.bytes)) p.bytes = [];
          return { mode: "obj", arr: p.bytes, obj: p };
        }
      } catch {}
      return { mode: "array", arr: [], obj: null };
    }

    function saveStore(mode, arr, obj) {
      const out = (mode === "obj" && obj) ? (obj.bytes = arr, obj) : arr;
      bytesOutTA.value = JSON.stringify(out, null, 2);
      bytesOutTA.dispatchEvent(new Event("input", { bubbles: true }));
      bytesOutTA.dispatchEvent(new Event("change", { bubbles: true }));
      try { localStorage.setItem("NG_BYTES", JSON.stringify(out)); } catch {}
    }

    function extractJsonish(str) {
  const s = norm(str);
  if (!/^[\[{]/.test(s) || !s.includes('"text"')) return null;
  try {
    const p = JSON.parse(s);
    const o = Array.isArray(p) ? p[0] : p;
    if (!o || typeof o !== "object") return null;
    return {
      speaker: norm(o.speaker || o.name || ""),
      designation: norm(o.designation || o.desig || ""),
      one_line: norm(o.text || o.one_line || o.quote || "")
    };
  } catch { return null; }
}

function cleanObj(x) {
  // string case: could be "{...}" OR "[{...}]"
  if (typeof x === "string") {
    const ex = extractJsonish(x);
    if (ex && ex.one_line) return ex;
    return { speaker: "", designation: "", one_line: norm(x) };
  }

  // array case inside store (rare)
  if (Array.isArray(x)) {
    const o = x[0];
    if (o && typeof o === "object") {
      return {
        speaker: norm(o.speaker || o.name || ""),
        designation: norm(o.designation || o.desig || ""),
        one_line: norm(o.text || o.one_line || o.quote || "")
      };
    }
    return { speaker: "", designation: "", one_line: norm(String(x)) };
  }

  // object case
  const speaker = norm(x?.speaker || x?.name || "");
  const designation = norm(x?.designation || x?.desig || "");
  const one_line = norm(x?.one_line || x?.text || x?.quote || x?.line || "");
  return { speaker, designation, one_line };
}


    function keyOf(o) {
      const c = cleanObj(o);
      return norm(`${c.speaker}||${c.designation}||${c.one_line}`).toLowerCase();
    }

    // ---- renderer: single clean box inside Bytes panel ----
    let box = document.getElementById("ng-final-bytes-clean");
    if (!box) {
      box = document.createElement("div");
      box.id = "ng-final-bytes-clean";
      box.style.cssText = "margin:10px 0;padding:10px;border:1px solid #ddd;border-radius:12px;background:#fff";
      bytesWrap.appendChild(box);
    }

    function renderFinal() {
      const st = loadStore();
      const arr = (st.arr || []).map(cleanObj);
      box.innerHTML =
        `<div style="font-weight:700;margin-bottom:6px;">Final Bytes • ${arr.length}</div>` +
        (arr.length ? arr.map((b,i) => `
          <div style="margin:8px 0;padding:10px;border:1px solid #eee;border-radius:12px;">
            <div style="font-weight:700;">${norm(b.speaker || "(speaker?)")} ${b.designation ? "(" + norm(b.designation) + ")" : ""}</div>
            <div style="margin-top:6px;">${norm(b.one_line || "")}</div>
          </div>
        `).join("") : `<div style="opacity:.7;">(No bytes yet)</div>`);
    }

    // ---- EE selection → bytes store ----
    function parseSuggestion(t) {
  t = norm(t);

  // Handle "{...}" OR "[{...}]" coming from Reverie/EE
  if (/^[\[{]/.test(t) && t.includes('"text"')) {
    try {
      const p = JSON.parse(t);
      const o = Array.isArray(p) ? p[0] : p;
      return {
        speaker: norm(o?.speaker || o?.name || ""),
        designation: norm(o?.designation || o?.desig || ""),
        one_line: norm(o?.text || o?.one_line || o?.quote || "")
      };
    } catch {}
  }

  let m = t.match(/^(.{2,80}?)(?:\s*\((.{2,160}?)\)|\s*,\s*(.{2,160}?))\s*:\s*(.+)$/);
  if (m) return { speaker: norm(m[1]), designation: norm(m[2] || m[3]), one_line: norm(m[4]) };

  m = t.match(/^(.{2,80}?)\s*:\s*(.+)$/);
  if (m) return { speaker: norm(m[1]), designation: "", one_line: norm(m[2]) };

  return { speaker: "", designation: "", one_line: t };
}

    function getSelectedEeItems() {
      const list = findEeList();
      if (!list) return [];
      const checked = Array.from(list.querySelectorAll('input[type="checkbox"]:checked'));
      return checked.map(cb => {
        const row = cb.closest("div,li") || cb.parentElement;
        const txt = norm(cb.dataset?.text || row?.innerText || row?.textContent || "");
        return parseSuggestion(txt);
      }).filter(x => x.one_line);
    }

    const eePushBtn =
      document.getElementById("ee-push") ||
      Array.from(document.querySelectorAll("button")).find(b => /push selected/i.test(norm(b.textContent).toLowerCase())) ||
      null;

    if (eePushBtn && !eePushBtn.__NG_FINAL_V2__) {
      eePushBtn.__NG_FINAL_V2__ = true;
      eePushBtn.addEventListener("click", () => {
        const items = getSelectedEeItems();
        if (!items.length) return;

        const st = loadStore();
        const arr = (st.arr || []).map(cleanObj);
        const seen = new Set(arr.map(keyOf));
        let added = 0;

        items.map(cleanObj).forEach(it => {
          const k = keyOf(it);
          if (!k.replace(/\|/g,"").trim()) return;
          if (seen.has(k)) return;
          arr.push(it); seen.add(k); added++;
        });

        saveStore(st.mode, arr, st.obj);
        renderFinal();
// Clear visible Text/Quote box if it got JSON dumped
const visTA = Array.from(bytesWrap.querySelectorAll("textarea"))
  .find(z => z !== bytesOutTA && z.offsetParent !== null);
if (visTA && /^[\[{]/.test(norm(visTA.value)) && visTA.value.includes('"text"')) visTA.value = "";

        console.log("[NG_BYTES_FINAL_V2] pushed", { selected: items.length, added, total: arr.length });
      }, true);
    }

    const showBtn = Array.from(bytesWrap.querySelectorAll("button"))
      .find(b => norm(b.textContent).toLowerCase() === "show") || null;

    if (showBtn && !showBtn.__NG_FINAL_V2__) {
      showBtn.__NG_FINAL_V2__ = true;
      showBtn.addEventListener("click", () => renderFinal(), true);
    }

    renderFinal();
    console.log("[NG_BYTES_FINAL_V2] installed ✅", { hasBytesOut: true, hasBytesWrap: true });
    return true;
  }

 // Poll until bytesWrap + bytesJSONOut exist, then attempt install
let tries = 0;
const MAX_TRIES = 120; // 24 seconds @200ms

const t = setInterval(() => {
  tries++;

  const hasWrap = !!document.getElementById("bytesWrap");
  const hasOut  = !!document.getElementById("bytesJSONOut");

  let ok = false;

  // Only call bootInstall when required nodes exist
  if (hasWrap && hasOut) {
    try {
      ok = !!bootInstall();
    } catch (e) {
      console.warn("[NG_BYTES_FINAL_V2] bootInstall threw", e);
      ok = false;
    }
  }

  if (ok) {
    clearInterval(t);
    return;
  }

  if (tries >= MAX_TRIES) {
    clearInterval(t);
    if (!hasWrap || !hasOut) {
      console.warn("[NG_BYTES_FINAL_V2] not installed (missing nodes)", { hasWrap, hasOut });
    } else {
      console.warn("[NG_BYTES_FINAL_V2] not installed (bootInstall returned false even though nodes exist)", { hasWrap, hasOut });
    }
  }
}, 200);

// Try once on DOM ready + load (safe)
document.addEventListener("DOMContentLoaded", () => {
  try { bootInstall(); } catch (e) {}
});
window.addEventListener("load", () => {
  try { bootInstall(); } catch (e) {}
});
})();

</script>
<script>
(() => {
  if (window.__NG_EE_NORM_V1__) return;
  window.__NG_EE_NORM_V1__ = true;

  const norm = (s) => String(s ?? "").replace(/\s+/g, " ").trim();

  function findEeList() {
    return (
      document.getElementById("ee-list") ||
      document.querySelector("[data-ng-ee-list]") ||
      document.querySelector("#ng-sec-ee, #ng-sec-editorial-extraction, #editorialExtraction") ||
      null
    );
  }

  function pickRowForCb(cb, list) {
    // Try common row containers first
    let row = cb.closest("[data-ee-row], .ee-row, .ee-item, li");
    if (row) return row;

    // Fallback: climb until the container is inside list and doesn't contain multiple checkboxes
    row = cb.parentElement;
    while (row && row !== list) {
      const c = row.querySelectorAll?.('input[type="checkbox"]').length || 0;
      if (c === 1) return row;
      row = row.parentElement;
    }
    return cb.parentElement || null;
  }

  function normalizeOnce() {
    const list = findEeList();
    if (!list) return;

    const cbs = Array.from(list.querySelectorAll('input[type="checkbox"]'));
    if (!cbs.length) return;

    cbs.forEach(cb => {
      const row = pickRowForCb(cb, list);
      if (!row || row.dataset.ngEeNorm === "1") return;

      // Capture readable text BEFORE we rewrite row DOM
function eeCleanText(raw) {
  const s = norm(raw);
  if (!/^[\[{]/.test(s) || !s.includes('"text"')) return s;
  try {
    const p = JSON.parse(s);
    const o = Array.isArray(p) ? p[0] : p;
    return norm(o?.text || s);
  } catch {
    return s;
  }
}
function eeCleanText(raw) {
  const s0 = String(raw ?? "");
  const s = s0.replace(/\s+/g, " ").trim();

  // Fast exit
  if (!s.includes('"text"')) return s;

  // Try to extract a JSON substring from inside mixed text
  const iObj = s.indexOf("{");
  const iArr = s.indexOf("[");
  let i = -1;
  if (iObj >= 0 && iArr >= 0) i = Math.min(iObj, iArr);
  else i = (iObj >= 0 ? iObj : iArr);

  if (i >= 0) {
    const jsonish = s.slice(i).trim();
    // First try JSON.parse
    try {
      const p = JSON.parse(jsonish);
      const o = Array.isArray(p) ? p[0] : p;
      const t = String(o?.text ?? "").replace(/\s+/g, " ").trim();
      if (t) return t;
    } catch {}
  }

  // Fallback: regex extract "text":"...."
  const m = s.match(/"text"\s*:\s*"([^"]+)"/);
  if (m && m[1]) {
    return m[1].replace(/\\n/g, " ").replace(/\s+/g, " ").trim();
  }

  return s;
}

     const rawText = eeCleanText(row.innerText || row.textContent || "");


      if (!rawText) return;

      // Store clean text for your push logic
      cb.dataset.text = rawText;

      // Rewrite row to: [checkbox] [single span text]
      const span = document.createElement("span");
      span.className = "ng-ee-text";
// Force-clean: if rawText still contains JSONish, extract "text"
let showText = rawText;
if (showText.includes('"text"')) {
  try {
    const i = Math.min(
      showText.indexOf("{") >= 0 ? showText.indexOf("{") : 1e9,
      showText.indexOf("[") >= 0 ? showText.indexOf("[") : 1e9
    );
    if (i < 1e9) {
      const p = JSON.parse(showText.slice(i).trim());
      const o = Array.isArray(p) ? p[0] : p;
      if (o && o.text) showText = String(o.text).replace(/\s+/g, " ").trim();
    }
  } catch {}
}
span.textContent = showText;

      span.style.cssText = "display:block;white-space:normal;word-break:break-word;line-height:1.35;";

      // Keep checkbox state intact
      cb.checked = !!cb.checked;

      row.replaceChildren(cb, span);
      row.style.cssText = "display:flex;gap:10px;align-items:flex-start;margin:8px 0;";
      row.dataset.ngEeNorm = "1";

      if (cb.disabled) row.style.opacity = "0.6";
    });
  }

  // Run now
  normalizeOnce();

  // Keep fixing when EE list updates (after Extract)
  const obs = new MutationObserver(() => {
    // small debounce
    clearTimeout(window.__NG_EE_NORM_T__);
    window.__NG_EE_NORM_T__ = setTimeout(normalizeOnce, 50);
  });

  const list0 = findEeList();
  if (list0) obs.observe(list0, { childList: true, subtree: true });

  // Also retry in case EE list appears later
  let tries = 0;
  const t = setInterval(() => {
    tries++;
    normalizeOnce();
    if (findEeList() || tries > 80) clearInterval(t);
  }, 200);

  console.log("[NG_EE_NORM_V1] installed ✅");
})();
</script>
<script>
(() => {
  if (window.__NG_EE_COLLAPSE_V1__) return;
  window.__NG_EE_COLLAPSE_V1__ = true;

  const norm = (s) => String(s ?? "").replace(/\s+/g, " ").trim();

  function findEeList() {
    return (
      document.getElementById("ee-list") ||
      document.querySelector("[data-ng-ee-list]") ||
      document.querySelector("#ng-sec-ee, #ng-sec-editorial-extraction, #editorialExtraction") ||
      null
    );
  }

  function getEeRows(list) {
    const cbs = Array.from(list.querySelectorAll('input[type="checkbox"]'));
    const rows = [];
    const seen = new Set();
    for (const cb of cbs) {
      const row = cb.closest("div,li") || cb.parentElement;
      if (!row) continue;
      if (seen.has(row)) continue;
      seen.add(row);
      // prefer dataset.text set by your EE normalizer (if present)
      const txt = norm(cb.dataset?.text || row.innerText || row.textContent || "");
      rows.push({ cb, row, txt });
    }
    return rows;
  }

  function scoreText(t) {
    // simple heuristic: medium length + punctuation
    const w = norm(t).split(" ").filter(Boolean).length;
    let s = 0;
    if (w >= 8 && w <= 24) s += 3;
    if (w >= 5 && w <= 30) s += 1;
    if (w > 45) s -= 3;
    if (w < 4) s -= 2;
    if (/[।!?]/.test(t)) s += 1;
    return s;
  }

  function install() {
    const list = findEeList();
    if (!list) return false;

    const host = list.parentElement || list;
    if (!host) return false;

    // avoid duplicating toolbar
    let bar = host.querySelector("#ng-ee-toolbar-v1");
    if (!bar) {
      bar = document.createElement("div");
      bar.id = "ng-ee-toolbar-v1";
      bar.style.cssText = "display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0;padding:8px;border:1px solid #ddd;border-radius:10px;background:#fff;";
      bar.innerHTML = `
        <span style="font-weight:700;">EE View:</span>
        <button type="button" id="ng-ee-show8" style="padding:6px 10px;border:1px solid #999;border-radius:999px;background:#fff;cursor:pointer;">Show 8</button>
        <button type="button" id="ng-ee-showall" style="padding:6px 10px;border:1px solid #999;border-radius:999px;background:#fff;cursor:pointer;">Show All</button>
        <button type="button" id="ng-ee-best3" style="padding:6px 10px;border:1px solid #999;border-radius:999px;background:#fff;cursor:pointer;">Select Best 3</button>
        <button type="button" id="ng-ee-clear" style="padding:6px 10px;border:1px solid #999;border-radius:999px;background:#fff;cursor:pointer;">Clear</button>
        <input id="ng-ee-filter" placeholder="Filter text…" style="padding:6px 10px;border:1px solid #bbb;border-radius:999px;min-width:220px;"/>
        <span id="ng-ee-count" style="opacity:.75;"></span>
      `;
      host.insertBefore(bar, list);
    }

    let limit = 8;
    let mode = "limit"; // limit | all
    let filter = "";

    function apply() {
      const rows = getEeRows(list);
      const f = norm(filter).toLowerCase();

      // filter first
      const visible = [];
      rows.forEach((r) => {
        const hit = !f || r.txt.toLowerCase().includes(f);
        if (!hit) {
          r.row.style.display = "none";
          return;
        }
        visible.push(r);
      });

      // collapse (only on filtered list)
      visible.forEach((r, i) => {
        r.row.style.display = (mode === "all" || i < limit) ? "" : "none";
      });

      const shown = visible.filter((r, i) => (mode === "all" || i < limit)).length;
      const countEl = bar.querySelector("#ng-ee-count");
      if (countEl) countEl.textContent = `Showing ${shown}/${visible.length} (filtered), total ${rows.length}`;
    }

    bar.querySelector("#ng-ee-show8").onclick = () => { mode = "limit"; limit = 8; apply(); };
    bar.querySelector("#ng-ee-showall").onclick = () => { mode = "all"; apply(); };
    bar.querySelector("#ng-ee-clear").onclick = () => {
      const rows = getEeRows(list);
      rows.forEach(r => { if (!r.cb.disabled) r.cb.checked = false; });
      apply();
    };

    bar.querySelector("#ng-ee-best3").onclick = () => {
  const f = norm(filter).toLowerCase();

  // Directly use the real checkboxes inside EE list (more reliable)
  const cbs = Array.from(list.querySelectorAll('input[type="checkbox"]'))
    .filter(cb => !cb.disabled)
    .filter(cb => cb.offsetParent !== null); // visible only

  // Build candidates with best available text
  const cand = cbs.map(cb => {
    const row = cb.closest("div,li") || cb.parentElement;
    const txt = norm(cb.dataset?.text || row?.innerText || row?.textContent || "");
    return { cb, txt, sc: scoreText(txt) };
  }).filter(x => x.txt);

  // If a text filter exists, apply it here too
  const cand2 = f ? cand.filter(x => x.txt.toLowerCase().includes(f)) : cand;

  // Clear previous checks (optional but makes it predictable)
  cand2.forEach(x => { x.cb.checked = false; });

  // Pick top 3 by score
  cand2.sort((a,b) => b.sc - a.sc);
  cand2.slice(0,3).forEach(x => { x.cb.checked = true; });

  apply();
};


    const inp = bar.querySelector("#ng-ee-filter");
    inp.oninput = () => {
  const v = norm(inp.value);

  // अगर user सिर्फ number लिखे (जैसे 3, 8, 12) तो उसे Show-N मानो
  if (/^\d{1,2}$/.test(v)) {
    mode = "limit";
    limit = Math.max(1, Math.min(50, parseInt(v, 10)));
    filter = "";
    // input खाली कर दें ताकि user confuse न हो
    inp.value = "";
    apply();
    return;
  }

  // वरना normal text filter
  filter = v;
  mode = "all";
  apply();
};

    // run once + watch updates
    apply();
    const obs = new MutationObserver(() => setTimeout(apply, 50));
    obs.observe(list, { childList:true, subtree:true });

    console.log("[NG_EE_COLLAPSE_V1] installed ✅");
    return true;
  }

  // wait for EE to exist
  let tries = 0;
  const t = setInterval(() => {
    tries++;
    if (install() || tries > 80) clearInterval(t);
  }, 200);
})();
</script>
<script>
(() => {
  if (window.__NG_EE_DISPLAY_CLEAN_V1__) return;
  window.__NG_EE_DISPLAY_CLEAN_V1__ = true;

  const norm = (s) => String(s ?? "").replace(/\s+/g, " ").trim();

  function extractTextField(mixed) {
    const s = norm(mixed);
    if (!s.includes('"text"')) return s;

    // Try JSON.parse from first { or [
    const iObj = s.indexOf("{");
    const iArr = s.indexOf("[");
    let i = -1;
    if (iObj >= 0 && iArr >= 0) i = Math.min(iObj, iArr);
    else i = (iObj >= 0 ? iObj : iArr);

    if (i >= 0) {
      const jsonish = s.slice(i).trim();
      try {
        const p = JSON.parse(jsonish);
        const o = Array.isArray(p) ? p[0] : p;
        const t = norm(o?.text || "");
        if (t) return t;
      } catch {}
    }

    // Loose scan: read after "text":" until next unescaped quote
    const k = s.indexOf('"text"');
    if (k >= 0) {
      const c = s.indexOf(":", k);
      if (c >= 0) {
        let q = s.indexOf('"', c);
        if (q >= 0) {
          q++;
          let out = "";
          for (let j = q; j < s.length; j++) {
            const ch = s[j];
            if (ch === '"' && s[j - 1] !== "\\") break;
            out += ch;
          }
          out = norm(out.replace(/\\n/g, " "));
          if (out) return out;
        }
      }
    }

    return s;
  }

  function cleanEE() {
    const list =
      document.getElementById("ee-list") ||
      document.querySelector("[data-ng-ee-list]") ||
      document.querySelector("#ng-sec-ee, #ng-sec-editorial-extraction, #editorialExtraction");

    if (!list) return;

    const cbs = Array.from(list.querySelectorAll('input[type="checkbox"]'));
    for (const cb of cbs) {
      const row = cb.closest("div,li") || cb.parentElement;
      if (!row) continue;

      // Find the main text container near checkbox (avoid buttons)
      const textEl =
        row.querySelector(".ee-text") ||
        row.querySelector("label") ||
        Array.from(row.querySelectorAll("div,span,p")).find(x => x !== cb && norm(x.textContent).length > 5) ||
        row;

      const raw = norm(cb.dataset?.text || textEl?.textContent || row.innerText || "");
      const cleaned = extractTextField(raw);

      // Update dataset for push logic
      cb.dataset.text = cleaned;

      // Update visible text (so JSON disappears)
      if (textEl && cleaned && cleaned !== norm(textEl.textContent)) {
        textEl.textContent = cleaned;
      }
    }
  }

  // Debounced observer (avoid hang)
  let timer = null;
  function schedule() {
    if (timer) return;
    timer = setTimeout(() => { timer = null; cleanEE(); }, 120);
  }

  // Initial run
  schedule();

  // Watch only top-level changes (less CPU)
  const target =
    document.getElementById("ee-list") ||
    document.querySelector("[data-ng-ee-list]") ||
    document.querySelector("#ng-sec-ee, #ng-sec-editorial-extraction, #editorialExtraction");

  if (target) {
    const obs = new MutationObserver(schedule);
    obs.observe(target, { childList: true }); // no subtree -> less lag
  }

  console.log("[NG_EE_DISPLAY_CLEAN_V1] installed ✅");
})();
</script>
<script>
/* NG_EE_LIMIT_WIRE_STEP2A_START */
(function () {
  const LS_KEY = "NG_EE_LIMIT_CFG";

  const byId = (id) => document.getElementById(id);
  const qa = (sel) => Array.from(document.querySelectorAll(sel));

  function eeRowFromCheckbox(cb) {
    // Try to hide the most reasonable "row" container
    return (
      cb.closest("[data-ee-item]") ||
      cb.closest(".ee-item") ||
      cb.closest(".ee-row") ||
      cb.closest("label") ||
      cb.closest("div")
    );
  }

  function eeGetRows() {
    const list = byId("ee-list");
    if (!list) return [];
    const cbs = qa("#ee-list input[type='checkbox']");
    const rows = [];
    for (const cb of cbs) {
      const row = eeRowFromCheckbox(cb);
      if (row && !rows.includes(row)) rows.push(row);
    }
    return rows;
  }

  function eeGuessSpeaker(row) {
    // Prefer explicit dataset if present
    const ds = row && row.dataset ? (row.dataset.eeSpeaker || row.dataset.speaker || "") : "";
    if (ds && ds.trim()) return ds.trim();

    // Try any common speaker element
    const sp =
      row.querySelector?.("[data-ee-speaker], .ee-speaker, .speaker, .spk, b") || null;
    const t = sp ? sp.textContent.trim() : "";
    if (t && t.length <= 40) return t;

    // Fallback: prefix before ':' in first 25 chars
    const full = (row.textContent || "").replace(/\s+/g, " ").trim();
    const idx = full.indexOf(":");
    if (idx > 0 && idx < 25) return full.slice(0, idx).trim();

    return "__ALL__";
  }

  function eeUpdateStatus(msg) {
    const el = byId("ee-limit-status");
    if (el) el.textContent = msg || "";
  }

  function eeApplyLimit(limitVal) {
    const rows = eeGetRows();
    // show all first
    for (const r of rows) r.style.display = "";

    if (limitVal === "all") {
      return { total: rows.length, hidden: 0, groups: 0 };
    }

    const N = parseInt(limitVal, 10);
    if (!N || N < 1) {
      return { total: rows.length, hidden: 0, groups: 0 };
    }

    const groups = new Map();
    for (const r of rows) {
      const k = eeGuessSpeaker(r);
      if (!groups.has(k)) groups.set(k, []);
      groups.get(k).push(r);
    }

    let hidden = 0;
    for (const arr of groups.values()) {
      arr.forEach((r, i) => {
        if (i >= N) {
          r.style.display = "none";
          hidden++;
        }
      });
    }
    return { total: rows.length, hidden, groups: groups.size };
  }

  function loadCfg() {
    try {
      return JSON.parse(localStorage.getItem(LS_KEY) || "{}") || {};
    } catch (e) {
      return {};
    }
  }

  function saveCfg(cfg) {
    try {
      localStorage.setItem(LS_KEY, JSON.stringify(cfg || {}));
    } catch (e) {}
  }
function eeBuildSpeakerAccordion(limitVal) {
  const list = byId("ee-list");
  if (!list) return;

  // If already grouped once, unwrap back to original rows
  const existingGroups = qa("#ee-list .ee-spk-group");
  if (existingGroups.length) {
    const rows = [];
    existingGroups.forEach(g => {
      qa(".ee-item-row", g).forEach(r => rows.push(r));
    });
    list.innerHTML = "";
    rows.forEach(r => list.appendChild(r));
  }

  const rows = eeGetRows();
  if (!rows.length) return;

  // normalize: tag each row so we can re-find it later safely
  rows.forEach((r) => {
    r.classList.add("ee-item-row");
  });

  // group
  const groups = new Map();
  for (const r of rows) {
    const k = eeGuessSpeaker(r);
    if (!groups.has(k)) groups.set(k, []);
    groups.get(k).push(r);
  }

  // rebuild list DOM into groups
  list.innerHTML = "";

  const N = (limitVal === "all") ? Infinity : (parseInt(limitVal, 10) || 3);

  for (const [speaker, arr] of groups.entries()) {
if (!arr || !arr.length) continue;

    const g = document.createElement("div");
    g.className = "ee-spk-group";
    g.style.cssText = "border:1px solid #e3e3e3;border-radius:12px;padding:10px;margin:10px 0;background:#fff;";

    const header = document.createElement("div");
    header.className = "ee-spk-header";
    header.style.cssText = "display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:8px;";

    const left = document.createElement("div");
    left.style.cssText = "font-weight:800;font-size:13px;";
    const raw = (speaker || "").trim();

// Clean garbage-like labels such as [""] or ["name"]
let cleaned = raw.replace(/^\[\s*["']?/, "").replace(/["']?\s*\]$/, "").trim();

// Treat unknown/empty as no-speaker
const isUnknown = (!cleaned || cleaned === "__ALL__" || cleaned.toLowerCase() === "speaker");

left.textContent = isUnknown
  ? `Lines (${arr.length})`
  : `${cleaned} — ${arr.length} lines`;


    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "ee-spk-toggle";
    btn.style.cssText = "padding:6px 10px;border:1px solid #999;border-radius:999px;background:#f7f7f7;cursor:pointer;font-size:12px;";
    btn.textContent = (arr.length > N) ? `Show more` : `All shown`;
    btn.disabled = !(arr.length > N);

    header.appendChild(left);
    header.appendChild(btn);

    const body = document.createElement("div");
    body.className = "ee-spk-body";
    body.style.cssText = "display:flex;flex-direction:column;gap:10px;";

    // append rows and collapse beyond N
    arr.forEach((r, idx) => {
      body.appendChild(r);
      r.style.display = (idx < N) ? "" : "none";
      r.dataset.eeSpkCollapsed = (idx < N) ? "0" : "1";
    });

    btn.addEventListener("click", () => {
      const collapsed = btn.getAttribute("data-collapsed") !== "0"; // default collapsed=true
      if (collapsed) {
        // expand
        arr.forEach(r => { r.style.display = ""; r.dataset.eeSpkCollapsed = "0"; });
        btn.textContent = "Show less";
        btn.setAttribute("data-collapsed", "0");
      } else {
        // collapse back to N
        arr.forEach((r, idx) => {
          r.style.display = (idx < N) ? "" : "none";
          r.dataset.eeSpkCollapsed = (idx < N) ? "0" : "1";
        });
        btn.textContent = "Show more";
        btn.setAttribute("data-collapsed", "1");
      }
    });

    g.appendChild(header);
    g.appendChild(body);
    list.appendChild(g);
  }
}

function eeHideLegacyViewUI() {
  const list = byId("ee-list");
  if (!list) return;

  const panel = list.closest(".panel") || list.parentElement || document;

  const candidates = Array.from(panel.querySelectorAll("*"));
  const eeViewRow = candidates.find(el => {
    const t = (el.textContent || "").replace(/\s+/g, " ").trim();
    return t.includes("EE View:") && el.querySelector && el.querySelector("button");
  });
  if (eeViewRow) eeViewRow.style.display = "none";

  const legacyStatus = candidates.find(el => {
    const t = (el.textContent || "").replace(/\s+/g, " ").trim();
    return t.includes("(filtered)") && t.includes("Showing") && !el.closest("#ee-limit-bar");
  });
  if (legacyStatus) legacyStatus.style.display = "none";
}


  function init() {
    const sel = byId("ee-limit-select");
    const btnApply = byId("ee-limit-apply");
    const btnReset = byId("ee-limit-reset");
    const btnBestEach = byId("ee-best3-each");

    if (!sel || !btnApply || !btnReset || !btnBestEach) return;

    const cfg = Object.assign({ limit: "3", applied: false }, loadCfg());

    // restore dropdown
    const v = String(cfg.limit || "3");
    sel.value = (v === "all" || v === "3" || v === "5" || v === "8") ? v : "3";

    function applyNow() {
      cfg.limit = sel.value;
      cfg.applied = true;
      const stat = eeApplyLimit(cfg.limit);
eeBuildSpeakerAccordion(cfg.limit);
eeHideLegacyViewUI();


      eeUpdateStatus(`Showing ${stat.total - stat.hidden}/${stat.total} (speakers ${stat.groups || 1})`);
      saveCfg(cfg);
    }

    function resetNow() {
      cfg.applied = false;
      eeApplyLimit("all");
eeBuildSpeakerAccordion("all");
eeHideLegacyViewUI();


      eeUpdateStatus("");
      saveCfg(cfg);
    }

    btnApply.addEventListener("click", applyNow);
    btnReset.addEventListener("click", resetNow);

    // Best-3-each wiring next step
    function eeGetCheckbox(row) {
  return row.querySelector?.("input[type='checkbox']") || null;
}

function eeGetScore(row) {
  // Try common patterns: data-score, data-ee-score, [data-score], or "(score: 12)" text
  const d = row && row.dataset ? (row.dataset.eeScore || row.dataset.score || "") : "";
  if (d && !isNaN(+d)) return +d;

  const dsEl = row.querySelector?.("[data-ee-score],[data-score]") || null;
  if (dsEl) {
    const v = dsEl.getAttribute("data-ee-score") || dsEl.getAttribute("data-score");
    if (v && !isNaN(+v)) return +v;
  }

  const txt = (row.textContent || "");
  const m = txt.match(/score\s*[:=]\s*(\d+(\.\d+)?)/i);
  if (m && !isNaN(+m[1])) return +m[1];

  return null;
}

function eeBest3EachSpeaker() {
  const rows = eeGetRows();

  // group rows by speaker
  const groups = new Map();
  for (const r of rows) {
    // ignore hidden rows? (we will still consider hidden rows to avoid missing good ones)
    const k = eeGuessSpeaker(r);
    if (!groups.has(k)) groups.set(k, []);
    groups.get(k).push(r);
  }

  let totalChecked = 0;
  let speakers = 0;

  for (const [k, arr] of groups.entries()) {
    speakers++;

    // Sort by score desc if any score exists, else keep original order
    const scored = arr.map(r => ({ r, s: eeGetScore(r) }));
    const hasAnyScore = scored.some(x => typeof x.s === "number");

    if (hasAnyScore) {
      scored.sort((a, b) => {
        const sa = (typeof a.s === "number") ? a.s : -Infinity;
        const sb = (typeof b.s === "number") ? b.s : -Infinity;
        return sb - sa;
      });
    }

    const top3 = (hasAnyScore ? scored.map(x => x.r) : arr).slice(0, 3);

    for (const r of top3) {
      const cb = eeGetCheckbox(r);
      if (cb && !cb.checked && !cb.disabled) {
        cb.checked = true;
        // trigger change if UI listens
        cb.dispatchEvent(new Event("change", { bubbles: true }));
        totalChecked++;
      }
    }
  }

  eeUpdateStatus(`Best3 each speaker ✓ (ticked +${totalChecked}, speakers ${speakers})`);
}

btnBestEach.addEventListener("click", function () {
  try {
    eeBest3EachSpeaker();
  } catch (e) {
    console.error("[NG_EE_BEST3_EACH] failed", e);
    eeUpdateStatus("Best3 each speaker failed (see console)");
  }
});
// --- NG_SIMPLE_UI_LOCK: hide auto/legacy EE controls ---
try {
  // Hide the auto-best button we added (manual-only lock)
  const bestEach = byId("ee-best3-each");
  if (bestEach) bestEach.style.display = "none";

  // Also hide its space if needed (optional)
  // (No need to hide the whole limit bar; keep dropdown Apply/Reset)

  // Hide legacy EE View row + legacy filtered status (if present)
  eeHideLegacyViewUI && eeHideLegacyViewUI();
} catch (e) {
  console.warn("[NG_SIMPLE_UI_LOCK] failed", e);
}

// --- NG_FORCE_HIDE_LEGACY_EE_VIEW (no helper needed) ---
try {
  const eeList = byId("ee-list");
  const root = (eeList && (eeList.closest(".panel") || eeList.parentElement)) || document;

  const els = Array.from(root.querySelectorAll("*"));
  for (const el of els) {
    const t = (el.textContent || "").replace(/\s+/g, " ").trim();

    // Hide the legacy "EE View:" button strip
    if (t.includes("EE View:") && el.querySelector && el.querySelector("button")) {
      el.style.display = "none";
    }

    // Hide legacy status line like "Showing 8/12 (filtered), total 12"
    if (t.includes("(filtered)") && t.includes("Showing") && !el.closest("#ee-limit-bar")) {
      el.style.display = "none";
    }
  }
} catch (e) {
  console.warn("[NG_FORCE_HIDE_LEGACY_EE_VIEW] failed", e);
}
// --- NG_PERSIST_HIDE_LEGACY_EE_VIEW (keeps hiding after Extract) ---
function ngEEForceHideLegacyUI() {
  try {
    const eeList = byId("ee-list");
    const root = (eeList && (eeList.closest(".panel") || eeList.parentElement)) || document;

    // always hide auto-best button (manual-only)
    const bestEach = byId("ee-best3-each");
    if (bestEach) bestEach.style.display = "none";

    const els = Array.from(root.querySelectorAll("*"));
    for (const el of els) {
      const t = (el.textContent || "").replace(/\s+/g, " ").trim();

      // Hide legacy "EE View:" strip
      if (t.includes("EE View:") && el.querySelector && el.querySelector("button")) {
        el.style.display = "none";
      }

      // Hide legacy filtered status line
      if (t.includes("(filtered)") && t.includes("Showing") && !el.closest("#ee-limit-bar")) {
        el.style.display = "none";
      }
    }
  } catch (e) {
    console.warn("[ngEEForceHideLegacyUI] failed", e);
  }
}

// run once now
ngEEForceHideLegacyUI();

// observe EE area so if legacy UI reappears after Extract, it gets hidden again
try {
  const eeList = byId("ee-list");
  const watchRoot = (eeList && (eeList.closest(".panel") || eeList.parentElement)) || document.body;

  let __ngEEHideTimer = null;
  const kick = () => {
    clearTimeout(__ngEEHideTimer);
    __ngEEHideTimer = setTimeout(ngEEForceHideLegacyUI, 60);
  };

  const obs = new MutationObserver(kick);
  obs.observe(watchRoot, { childList: true, subtree: true });

  // also kick once after a short delay (covers late render)
  setTimeout(kick, 150);
} catch (e) {
  console.warn("[NG_PERSIST_HIDE_LEGACY_EE_VIEW] observer failed", e);
}


    // auto-apply if previously applied
    if (cfg.applied) applyNow();
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", init);
  } else {
    init();
  }
})();
 /* NG_EE_LIMIT_WIRE_STEP2A_END */
</script>
<script>
/* NG_FINAL_BYTES_BRIDGE_V1_START */
(function(){
  function $(id){return document.getElementById(id);}
  function visible(el){
    try{ return !!(el && (el.offsetParent!==null || el.getClientRects().length)); }
    catch(e){ return !!el; }
  }
  function updateFinalCount(n){
    try{
      var bs = Array.prototype.slice.call(document.querySelectorAll('#bytesWrap b'));
      for(var i=0;i<bs.length;i++){
        if((bs[i].textContent||'').indexOf('Final Bytes')!==-1){
          bs[i].textContent = 'Final Bytes • ' + n;
          break;
        }
      }
    }catch(e){}
  }

  window.NG_addFinalByte = function(payload){
    payload = payload || {};
    var txt = String(payload.text||'').trim();
    if(!txt) return false;

    var speaker = String(payload.speaker||'').trim();
    var designation = String(payload.designation||payload.desig||'').trim();

    var addBtn = $('addByteBtn');
    var manual = $('ng-manual-bytes'); if(manual) manual.style.display='block';

    if(addBtn) addBtn.click();

    var root = $('bytesWrap') || document;

    function pickTargets(){
      var ignore = {'ng-byte-default-speaker':1,'ng-byte-default-desig':1,'ng-byte-draft-speaker':1,'ng-byte-draft-desig':1,'ng-byte-draft-text':1};
      var inputs = Array.prototype.slice.call(root.querySelectorAll('input[type="text"]')).filter(function(el){
        return el && !ignore[el.id] && visible(el);
      });
      var tas = Array.prototype.slice.call(root.querySelectorAll('textarea')).filter(function(el){
        return el && el.id!=='ng-byte-draft-text' && visible(el);
      });
      var ta = tas.length ? tas[tas.length-1] : null;
      var in1 = inputs.length>=2 ? inputs[inputs.length-2] : (inputs.length?inputs[0]:null);
      var in2 = inputs.length>=2 ? inputs[inputs.length-1] : null;
      return {speaker: in1, designation: in2, text: ta};
    }

    setTimeout(function(){
      try{
        var t = pickTargets();
        if(t.speaker && speaker) t.speaker.value = speaker;
        if(t.designation && designation) t.designation.value = designation;
        if(t.text) t.text.value = txt;

        var sink = $('bytesJSONOut');
        var arr = [];
        if(sink && sink.value && sink.value.trim()){
          try{ arr = JSON.parse(sink.value); if(!Array.isArray(arr)) arr=[]; } catch(e){ arr=[]; }
        }
        arr.push({speaker: speaker, designation: designation, text: txt});
        if(sink) sink.value = JSON.stringify(arr, null, 2);

        updateFinalCount(arr.length);
      }catch(e){
        console.warn('[NG] NG_addFinalByte fill failed', e);
      }
    }, 80);

    return true;
  };

  console.log('[NG] NG_addFinalByte bridge ready');
})();
/* NG_FINAL_BYTES_BRIDGE_V1_END */
</script>
</body>
</html>




















<script>
/* NG_PATCH_START: INBOX_SUMMARY_GUARD_V1 */
(function(){
  function fix(){
    var s = document.querySelector('#ng-transcript-inbox-details summary');
    if(!s) return;
    var want = 'Transcript Inbox';
    var cur = (s.textContent||'').trim();
    if(cur.indexOf('Transcript Inbox') === -1 && cur.indexOf('Transcript Inbox') === -1){
      s.textContent = 'Transcript Inbox';
} else {
  // normalize stray quotes/spaces
      s.textContent = 'Transcript Inbox';
}
  }
  if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', fix, {once:true});
  else fix();
  window.addEventListener('load', function(){ setTimeout(fix, 0); }, {once:true});
})();
/* NG_PATCH_END: INBOX_SUMMARY_GUARD_V1 */
</script>
<script>
/* NG_TRANSCRIPT_WIRE_V1_START */
(function () {
  function $(id) { return document.getElementById(id); }

  const ta = $('ta-transcript-json');
  const st = $('ng-latest-transcript-status');

  if (!ta || !st) {
    console.warn('[NG] transcript wire: missing textarea/status', { ta: !!ta, st: !!st });
    return;
  }

  function safeJsonParse(s) { try { return JSON.parse(s); } catch (e) { return null; } }

  function pickText(obj) {
    if (obj == null) return '';
    if (typeof obj === 'string') return obj;
    if (Array.isArray(obj)) {
      return obj.map(pickText).filter(Boolean).join('\n');
    }
    if (typeof obj === 'object') {
      const keys = ['display_text', 'displayText', 'text', 'transcript', 'raw_text', 'rawText', 'final_text', 'finalText'];
      for (const k of keys) {
        if (typeof obj[k] === 'string' && obj[k].trim()) return obj[k];
      }
      const nests = ['data', 'result', 'latest', 'payload'];
      for (const n of nests) {
        if (obj[n]) {
          const t = pickText(obj[n]);
          if (t) return t;
        }
      }
      if (Array.isArray(obj.segments)) {
        return obj.segments.map(seg => (seg && (seg.text || seg.display_text)) || '').filter(Boolean).join('\n');
      }
    }
    return '';
  }

  function extractTranscriptText(raw) {
    const s = (raw || '').trim();
    if (!s) return '';
    if ((s.startsWith('{') && s.endsWith('}')) || (s.startsWith('[') && s.endsWith(']'))) {
      const j = safeJsonParse(s);
      if (j !== null) {
        const t = pickText(j).trim();
        if (t) return t;
      }
    }
    return s; // treat as plain text transcript
  }

  function fallbackSplitIntoLines(text) {
    const t = (text || '').replace(/\r/g, '').trim();
    if (!t) return [];
    let parts = t.split('\n').map(x => x.trim()).filter(Boolean);
    if (parts.length <= 1) {
      parts = t.split(/(?<=[।!?])\s+|(?<=\.)\s+/).map(x => x.trim()).filter(Boolean);
    }
    const out = [];
    for (const p of parts) {
      if (p.length <= 180) { out.push(p); continue; }
      let cur = '';
      for (const w of p.split(/\s+/)) {
        if (!cur) cur = w;
        else if ((cur + ' ' + w).length <= 180) cur += ' ' + w;
        else { out.push(cur); cur = w; }
      }
      if (cur) out.push(cur);
    }
    return out;
  }

  function applyFromTextarea(reason) {
    const raw = ta.value || '';
    const transcriptText = extractTranscriptText(raw);

    if (!transcriptText) {
      window.NG_TRANSCRIPT = '';
      st.textContent = 'Empty (no transcript)';
      st.style.opacity = '.75';
      if (typeof window.NG_setTranscriptLines === 'function') window.NG_setTranscriptLines([]);
      return;
    }

    window.NG_TRANSCRIPT = transcriptText;

    const splitter = (typeof window.splitIntoLines === 'function') ? window.splitIntoLines : fallbackSplitIntoLines;
    const lines = splitter(transcriptText);

    if (typeof window.NG_setTranscriptLines === 'function') window.NG_setTranscriptLines(lines);

    st.textContent = `Loaded: ${transcriptText.length} chars · ${lines.length} lines` + (reason ? ` · ${reason}` : '');
    st.style.opacity = '.9';
  }

  // manual test hook
  window.NG_applyTranscriptFromTextarea = applyFromTextarea;

  // Debounced apply on user paste/type
  let tmr = null;
  ta.addEventListener('input', () => {
    clearTimeout(tmr);
    tmr = setTimeout(() => applyFromTextarea('typed/pasted'), 250);
  });

  // Watch programmatic changes (Refresh Latest etc.)
  let lastSeen = ta.value || '';
  setInterval(() => {
    const now = ta.value || '';
    if (now !== lastSeen) {
      lastSeen = now;
      applyFromTextarea('updated');
    }
  }, 600);

  // After loader button clicks, re-apply shortly after (lets existing handler finish)
  const btnIds = [
    'btn-load-transcript-json',
    'btn-paste-transcript-json',
    'btn-refresh-latest-transcript',
    'btn-import-transcript-json'
  ];

  btnIds.forEach(id => {
    const b = $(id);
    if (!b) return;
    // capture=true so we definitely schedule, but we do NOT block existing handlers
    b.addEventListener('click', () => {
      setTimeout(() => applyFromTextarea(id), 120);
      setTimeout(() => applyFromTextarea(id), 1200);
    }, true);
  });

  // initial apply
  setTimeout(() => applyFromTextarea('init'), 50);
})();
/* NG_TRANSCRIPT_WIRE_V1_END */
</script>
<script>
/* NG_BYTES_FROM_LINES_WIRE_V1_START */
(function () {
  function $(id){ return document.getElementById(id); }

  const wrap = $('ng-lines-wrap');
  const draftArea = $('ng-byte-draft-area');
  const draftText = $('ng-byte-draft-text');
  const draftSp = $('ng-byte-draft-speaker');
  const draftDes = $('ng-byte-draft-desig');
  const defSp = $('ng-byte-default-speaker');
  const defDes = $('ng-byte-default-desig');
  const btnMake = $('ng-make-byte');
  const btnAdd = $('ng-add-final');
  const btnClear = $('ng-clear-draft');
  const st = $('ng-byte-draft-status');

  if(!wrap || !draftArea || !draftText || !btnMake || !btnAdd){
    console.warn('[NG] bytes-from-lines: missing elements', {
      wrap:!!wrap, draftArea:!!draftArea, draftText:!!draftText, btnMake:!!btnMake, btnAdd:!!btnAdd
    });
    return;
  }

  function getSelectedLines(){
    const items = wrap.querySelectorAll('input[type="checkbox"][data-ng-line]');
    const out = [];
    items.forEach(cb => { if(cb.checked) out.push(cb.getAttribute('data-ng-line')||''); });
    return out.map(s => (s||'').trim()).filter(Boolean);
  }

  function showDraft(){
    draftArea.style.display = 'block';
  }

  function setStatus(msg){
    if(st) st.textContent = msg || '';
  }

  function fillDraftFromSelection(){
    const lines = getSelectedLines();
    if(!lines.length){
      showDraft();
      setStatus('No lines selected.');
      return;
    }
    showDraft();
    draftText.value = lines.join('\n');
    setStatus('Draft created from selection: ' + lines.length + ' line(s).');
  }

  // Keep draft live-updated when selection changes (lightweight)
  let tmr=null;
  wrap.addEventListener('change', (e) => {
    const t = e.target;
    if(!(t && t.matches && t.matches('input[type="checkbox"][data-ng-line]'))) return;
    clearTimeout(tmr);
    tmr=setTimeout(() => {
      const lines = getSelectedLines();
      if(lines.length){
        showDraft();
        draftText.value = lines.join('\n');
        setStatus('Selection updated: ' + lines.length + ' line(s).');
      } else {
        setStatus('Selection cleared.');
      }
    }, 120);
  });

  btnMake.addEventListener('click', () => fillDraftFromSelection());

  if(btnClear){
    btnClear.addEventListener('click', () => {
      draftText.value = '';
      if(draftSp) draftSp.value = '';
      if(draftDes) draftDes.value = '';
      setStatus('Draft cleared.');
    });
  }

  // Add to Final Bytes (uses existing bytes system if available)
  btnAdd.addEventListener('click', () => {
    showDraft();

    const txt = (draftText.value||'').trim();
    if(!txt){
      setStatus('Draft is empty.');
      return;
    }

    const speaker = ((draftSp && draftSp.value) || (defSp && defSp.value) || '').trim();
    const desig   = ((draftDes && draftDes.value) || (defDes && defDes.value) || '').trim();

    // Preferred path: if your app exposes a function to add bytes, use it
    if(typeof window.NG_addFinalByte === 'function'){
      window.NG_addFinalByte({ speaker, designation: desig, text: txt });
      setStatus('Added to Final Bytes (via NG_addFinalByte).');
      return;
    }

    // Fallback: push into bytes JSON sink if present (minimal non-breaking)
    const sink = $('bytesJSONOut');
    try{
      let arr = [];
      if(sink && sink.value && sink.value.trim()){
        arr = JSON.parse(sink.value);
        if(!Array.isArray(arr)) arr = [];
      }
      arr.push({ speaker, designation: desig, text: txt });
      if(sink) sink.value = JSON.stringify(arr, null, 2);
      setStatus('Added to Final Bytes (fallback JSON sink).');
    } catch(e){
      console.warn('[NG] add-final fallback failed', e);
      setStatus('Failed to add to Final Bytes (see console).');
    }
  });

  // expose helper for manual test
  window.NG_makeDraftFromSelection = fillDraftFromSelection;

  console.log('[NG] bytes-from-lines wired');
})();
 /* NG_BYTES_FROM_LINES_WIRE_V1_END */
</script>
<script>
/* NG_FINAL_BYTES_BRIDGE_V1_START */
(function(){
  function $(id){return document.getElementById(id);}
  function visible(el){
    try{ return !!(el && (el.offsetParent!==null || el.getClientRects().length)); }
    catch(e){ return !!el; }
  }
  function updateFinalCount(n){
    try{
      var bs = Array.prototype.slice.call(document.querySelectorAll('#bytesWrap b'));
      for(var i=0;i<bs.length;i++){
        if((bs[i].textContent||'').indexOf('Final Bytes')!==-1){
          bs[i].textContent = 'Final Bytes • ' + n;
          break;
        }
      }
    }catch(e){}
  }

  window.NG_addFinalByte = function(payload){
    payload = payload || {};
    var txt = String(payload.text||'').trim();
    if(!txt) return false;

    var speaker = String(payload.speaker||'').trim();
    var designation = String(payload.designation||payload.desig||'').trim();

    var addBtn = $('addByteBtn');
    var manual = $('ng-manual-bytes'); if(manual) manual.style.display='block';

    if(addBtn) addBtn.click();

    var root = $('bytesWrap') || document;

    function pickTargets(){
      var ignore = {'ng-byte-default-speaker':1,'ng-byte-default-desig':1,'ng-byte-draft-speaker':1,'ng-byte-draft-desig':1,'ng-byte-draft-text':1};
      var inputs = Array.prototype.slice.call(root.querySelectorAll('input[type="text"]')).filter(function(el){
        return el && !ignore[el.id] && visible(el);
      });
      var tas = Array.prototype.slice.call(root.querySelectorAll('textarea')).filter(function(el){
        return el && el.id!=='ng-byte-draft-text' && visible(el);
      });
      var ta = tas.length ? tas[tas.length-1] : null;
      var in1 = inputs.length>=2 ? inputs[inputs.length-2] : (inputs.length?inputs[0]:null);
      var in2 = inputs.length>=2 ? inputs[inputs.length-1] : null;
      return {speaker: in1, designation: in2, text: ta};
    }

    setTimeout(function(){
      try{
        var t = pickTargets();
        if(t.speaker && speaker) t.speaker.value = speaker;
        if(t.designation && designation) t.designation.value = designation;
        if(t.text) t.text.value = txt;

        var sink = $('bytesJSONOut');
        var arr = [];
        if(sink && sink.value && sink.value.trim()){
          try{ arr = JSON.parse(sink.value); if(!Array.isArray(arr)) arr=[]; } catch(e){ arr=[]; }
        }
        arr.push({speaker: speaker, designation: designation, text: txt});
        if(sink) sink.value = JSON.stringify(arr, null, 2);

        updateFinalCount(arr.length);
      }catch(e){
        console.warn('[NG] NG_addFinalByte fill failed', e);
      }
    }, 80);

    return true;
  };

  console.log('[NG] NG_addFinalByte bridge ready');
})();
/* NG_FINAL_BYTES_BRIDGE_V1_END */
</script>
</body>
</html>











